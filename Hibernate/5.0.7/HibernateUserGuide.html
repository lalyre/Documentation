<!--?xml version="1.0" encoding="UTF-8" standalone="no"?-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Hibernate User Guide</title><link rel="stylesheet" type="text/css" href="Hibernate%20User%20Guide_files/hibernate-single.css"><meta name="generator" content="DocBook XSL Stylesheets V1.76.1"><meta xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" http-equiv="Content-Type" content="text/html; charset=UTF-8"></head><body><div class="book" title="Hibernate User Guide"><div class="titlepage"><div><p xmlns:d="http://docbook.org/ns/docbook" id="title"><a href="http://www.hibernate.org/" class="site_href"><strong>Hibernate.org</strong></a><a href="http://hibernate.org/Documentation/DocumentationOverview" class="doc_href"><strong>Community Documentation</strong></a></p><div><h1 class="title"><a id="d5e1">Hibernate User Guide</a></h1></div><div><h2 class="subtitle"><a id="d5e1">Hibernate - Relational Persistence for Idiomatic Java</a></h2></div><div><div class="authorgroup"><a id="d5e1">
            </a><div class="author"><a id="d5e1"></a><h3 class="author"><a id="d5e1">
                <span class="orgname"></span></a><a class="ulink" href="http://hibernate.org/">The Hibernate Team</a>
            </h3></div>
            <div class="othercredit"><h3 class="othercredit">
                <span class="orgname"><a class="ulink" href="http://design.jboss.org/">The JBoss Visual Design Team</a></span>
            </h3></div>
        </div></div><div><p class="releaseinfo">5.0.7.Final</p></div><div><p class="copyright">Copyright © 2011 Red Hat, Inc.</p></div><div><p class="pubdate">2016-01-13</p></div></div><hr></div><div class="toc"><p><strong>Table of Contents</strong></p><dl><dt><span class="preface"><a href="#preface">Preface</a></span></dt><dt><span class="chapter"><a href="#architecture">1. Architecture</a></span></dt><dd><dl><dt><span class="section"><a href="#architecture-overview">1.1. Overview</a></span></dt><dt><span class="section"><a href="#architecture-current-session">1.2. Contextual sessions</a></span></dt></dl></dd><dt><span class="chapter"><a href="#domainmodel">2. Domain Model</a></span></dt><dd><dl><dt><span class="section"><a href="#domainmodel-pojo">2.1. POJO Domain Models</a></span></dt><dd><dl><dt><span class="section"><a href="#domainmodel-pojo-constructor">2.1.1. Implement a no-argument constructor</a></span></dt><dt><span class="section"><a href="#domainmodel-pojo-identifier">2.1.2. Provide identifier attribute(s)</a></span></dt><dt><span class="section"><a href="#domainmodel-pojo-final">2.1.3. Prefer non-final classes</a></span></dt><dt><span class="section"><a href="#domainmodel-pojo-accessors">2.1.4. Declare getters and setters for persistent attributes</a></span></dt><dt><span class="section"><a href="#domainmodel-pojo-equalshashcode">2.1.5. Implementing <code class="literal">equals()</code> and <code class="literal">hashCode()</code></a></span></dt></dl></dd><dt><span class="section"><a href="#domainmodel-dynamic">2.2. Dynamic models</a></span></dt></dl></dd><dt><span class="chapter"><a href="#bootstrap">3. Bootstrap</a></span></dt><dd><dl><dt><span class="section"><a href="#bootstrap-native">3.1. Native Bootstrapping</a></span></dt><dd><dl><dt><span class="section"><a href="#bootstrap-native-registry">3.1.1. Building the ServiceRegistry</a></span></dt><dt><span class="section"><a href="#bootstrap-native-metadata">3.1.2. Building the Metadata</a></span></dt><dt><span class="section"><a href="#bootstrap-native-sessionfactory">3.1.3. Building the SessionFactory</a></span></dt></dl></dd><dt><span class="section"><a href="#bootstrap-jpa">3.2. JPA Bootstrapping</a></span></dt><dd><dl><dt><span class="section"><a href="#bootstrap-jpa-compliant">3.2.1. JPA-compliant bootstrapping</a></span></dt><dt><span class="section"><a href="#bootstrap-jpa-hibernate">3.2.2. Proprietary 2-phase bootstrapping</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#pc">4. Persistence Contexts</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e344">4.1. Making entities persistent</a></span></dt><dt><span class="section"><a href="#d5e367">4.2. Deleting entities</a></span></dt><dt><span class="section"><a href="#d5e379">4.3. Obtain an entity reference without initializing its data</a></span></dt><dt><span class="section"><a href="#d5e388">4.4. Obtain an entity with its data initialized</a></span></dt><dt><span class="section"><a href="#d5e396">4.5. Obtain an entity by natural-id</a></span></dt><dt><span class="section"><a href="#d5e423">4.6. Refresh entity state</a></span></dt><dt><span class="section"><a href="#d5e434">4.7. Modifying managed/persistent state</a></span></dt><dt><span class="section"><a href="#d5e441">4.8. Working with detached data</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e445">4.8.1. Reattaching detached data</a></span></dt><dt><span class="section"><a href="#d5e465">4.8.2. Merging detached data</a></span></dt></dl></dd><dt><span class="section"><a href="#d5e476">4.9. Checking persistent state</a></span></dt><dt><span class="section"><a href="#d5e493">4.10. Accessing Hibernate APIs from JPA</a></span></dt></dl></dd><dt><span class="chapter"><a href="#database">5. Database access</a></span></dt><dd><dl><dt><span class="section"><a href="#database-connectionprovider">5.1. ConnectionProvider</a></span></dt><dd><dl><dt><span class="section"><a href="#database-connectionprovider-datasource">5.1.1. Using DataSources</a></span></dt><dt><span class="section"><a href="#database-connectionprovider-c3p0">5.1.2. Using c3p0</a></span></dt><dt><span class="section"><a href="#database-connectionprovider-proxool">5.1.3. Using Proxool</a></span></dt><dt><span class="section"><a href="#database-connectionprovider-hikari">5.1.4. Using Hikari</a></span></dt><dt><span class="section"><a href="#database-connectionprovider-drivermanager">5.1.5. Using Hibernate's built-in (and unsupported) pooling</a></span></dt><dt><span class="section"><a href="#database-connectionprovider-provided">5.1.6. User-provided Connections</a></span></dt><dt><span class="section"><a href="#database-connectionprovider-isolation">5.1.7. ConnectionProvider support for transaction isolation setting</a></span></dt></dl></dd><dt><span class="section"><a href="#database-dialect">5.2. Database Dialect</a></span></dt></dl></dd><dt><span class="chapter"><a href="#transactions">6. Transactions and concurrency control</a></span></dt><dd><dl><dt><span class="section"><a href="#transactions-physical">6.1. Physical Transactions</a></span></dt><dd><dl><dt><span class="section"><a href="#transactions-physical-jtaplatform">6.1.1. JTA configuration</a></span></dt></dl></dd><dt><span class="section"><a href="#transactions-api">6.2. Hibernate Transaction API</a></span></dt><dt><span class="section"><a href="#d5e1005">6.3. Transactional patterns (and anti-patterns)</a></span></dt><dd><dl><dt><span class="section"><a href="#session-per-operation">6.3.1. Session-per-operation anti-pattern</a></span></dt><dt><span class="section"><a href="#session-per-request">6.3.2. Session-per-request pattern</a></span></dt><dt><span class="section"><a href="#long-conversations">6.3.3. Conversations</a></span></dt><dt><span class="section"><a href="#d5e1098">6.3.4. Session-per-application</a></span></dt></dl></dd><dt><span class="section"><a href="#transactions-basics-issues">6.4. Common issues</a></span></dt></dl></dd><dt><span class="chapter"><a href="#jndi">7. JNDI</a></span></dt><dt><span class="chapter"><a href="#d5e1141">8. Locking</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e1161">8.1. Optimistic</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e1177">8.1.1. Dedicated version number</a></span></dt><dt><span class="section"><a href="#d5e1240">8.1.2. Timestamp</a></span></dt></dl></dd><dt><span class="section"><a href="#d5e1289">8.2. Pessimistic</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e1294">8.2.1. The <code class="classname">LockMode</code> class</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#fetching">9. Fetching</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e1367">9.1. The basics</a></span></dt><dt><span class="section"><a href="#d5e1418">9.2. Applying fetch strategies</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e1428">9.2.1. No fetching</a></span></dt><dt><span class="section"><a href="#d5e1440">9.2.2. Dynamic fetching via queries</a></span></dt><dt><span class="section"><a href="#d5e1449">9.2.3. Dynamic fetching via profiles</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#batch">10. Batching</a></span></dt><dd><dl><dt><span class="section"><a href="#batch-jdbcbatch">10.1. JDBC batching</a></span></dt></dl></dd><dt><span class="chapter"><a href="#caching">11. Caching</a></span></dt><dd><dl><dt><span class="section"><a href="#caching-config">11.1. Configuring second-level caching</a></span></dt><dd><dl><dt><span class="section"><a href="#caching-config-provider">11.1.1. RegionFactory</a></span></dt><dt><span class="section"><a href="#caching-config-behavior">11.1.2. Caching behavior</a></span></dt></dl></dd><dt><span class="section"><a href="#caching-management">11.2. Managing the Cached Data</a></span></dt></dl></dd><dt><span class="chapter"><a href="#events">12. Interceptors and events</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e1559">12.1. Interceptors</a></span></dt><dt><span class="section"><a href="#d5e1578">12.2. Native Event system</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e1599">12.2.1. Hibernate declarative security</a></span></dt></dl></dd><dt><span class="section"><a href="#d5e1611">12.3. JPA Callbacks</a></span></dt></dl></dd><dt><span class="chapter"><a href="#hql">13. HQL and JPQL</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e1698">13.1. Case Sensitivity</a></span></dt><dt><span class="section"><a href="#d5e1710">13.2. Statement types</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e1726">13.2.1. Select statements</a></span></dt><dt><span class="section"><a href="#d5e1739">13.2.2. Update statements</a></span></dt><dt><span class="section"><a href="#d5e1774">13.2.3. Delete statements</a></span></dt><dt><span class="section"><a href="#d5e1784">13.2.4. Insert statements</a></span></dt></dl></dd><dt><span class="section"><a href="#hql-from-clause">13.3. The <code class="literal">FROM</code> clause</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e1821">13.3.1. Identification variables</a></span></dt><dt><span class="section"><a href="#d5e1828">13.3.2. Root entity references</a></span></dt><dt><span class="section"><a href="#d5e1852">13.3.3. Explicit joins</a></span></dt><dt><span class="section"><a href="#d5e1895">13.3.4. Implicit joins (path expressions)</a></span></dt><dt><span class="section"><a href="#hql-collection-valued-associations">13.3.5. Collection member references</a></span></dt><dt><span class="section"><a href="#d5e1965">13.3.6. Polymorphism</a></span></dt></dl></dd><dt><span class="section"><a href="#hql-expressions">13.4. Expressions</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e1984">13.4.1. Identification variable</a></span></dt><dt><span class="section"><a href="#d5e1988">13.4.2. Path expressions</a></span></dt><dt><span class="section"><a href="#d5e1992">13.4.3. Literals</a></span></dt><dt><span class="section"><a href="#d5e2018">13.4.4. Parameters</a></span></dt><dt><span class="section"><a href="#d5e2041">13.4.5. Arithmetic</a></span></dt><dt><span class="section"><a href="#d5e2063">13.4.6. Concatenation (operation)</a></span></dt><dt><span class="section"><a href="#d5e2074">13.4.7. Aggregate functions</a></span></dt><dt><span class="section"><a href="#hql-exp-functions">13.4.8. Scalar functions</a></span></dt><dt><span class="section"><a href="#hql-collection-expressions">13.4.9. Collection-related expressions</a></span></dt><dt><span class="section"><a href="#hql-entity-type-exp">13.4.10. Entity type</a></span></dt><dt><span class="section"><a href="#d5e2273">13.4.11. CASE expressions</a></span></dt></dl></dd><dt><span class="section"><a href="#hql-select-clause">13.5. The <code class="literal">SELECT</code> clause</a></span></dt><dt><span class="section"><a href="#hql-conditional-expressions">13.6. Predicates</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e2335">13.6.1. Relational comparisons</a></span></dt><dt><span class="section"><a href="#d5e2350">13.6.2. Nullness predicate</a></span></dt><dt><span class="section"><a href="#d5e2356">13.6.3. Like predicate</a></span></dt><dt><span class="section"><a href="#d5e2378">13.6.4. Between predicate</a></span></dt><dt><span class="section"><a href="#d5e2384">13.6.5. In predicate</a></span></dt><dt><span class="section"><a href="#d5e2409">13.6.6. Exists predicate</a></span></dt><dt><span class="section"><a href="#d5e2412">13.6.7. Empty collection predicate</a></span></dt><dt><span class="section"><a href="#d5e2419">13.6.8. Member-of collection predicate</a></span></dt><dt><span class="section"><a href="#d5e2426">13.6.9. NOT predicate operator</a></span></dt><dt><span class="section"><a href="#d5e2430">13.6.10. AND predicate operator</a></span></dt><dt><span class="section"><a href="#d5e2434">13.6.11. OR predicate operator</a></span></dt></dl></dd><dt><span class="section"><a href="#hql-where-clause">13.7. The <code class="literal">WHERE</code> clause</a></span></dt><dt><span class="section"><a href="#hql-grouping">13.8. Grouping</a></span></dt><dt><span class="section"><a href="#hql-ordering">13.9. Ordering</a></span></dt><dt><span class="section"><a href="#hql-api">13.10. Query API</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e2482">13.10.1. Hibernate Query API</a></span></dt><dt><span class="section"><a href="#d5e2552">13.10.2. JPA Query API</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#criteria">14. Criteria</a></span></dt><dd><dl><dt><span class="section"><a href="#querycriteria-typedquery">14.1. Typed criteria queries</a></span></dt><dd><dl><dt><span class="section"><a href="#querycriteria-typedquery-entity">14.1.1. Selecting an entity</a></span></dt><dt><span class="section"><a href="#querycriteria-typedquery-expression">14.1.2. Selecting an expression</a></span></dt><dt><span class="section"><a href="#querycriteria-typedquery-multiselect">14.1.3. Selecting multiple values</a></span></dt><dt><span class="section"><a href="#querycriteria-typedquery-construct">14.1.4. Selecting a wrapper</a></span></dt></dl></dd><dt><span class="section"><a href="#querycriteria-tuple">14.2. Tuple criteria queries</a></span></dt><dt><span class="section"><a href="#querycriteria-from">14.3. FROM clause</a></span></dt><dd><dl><dt><span class="section"><a href="#querycriteria-from-root">14.3.1. Roots</a></span></dt><dt><span class="section"><a href="#querycriteria-from-join">14.3.2. Joins</a></span></dt><dt><span class="section"><a href="#querycriteria-from-fetch">14.3.3. Fetches</a></span></dt></dl></dd><dt><span class="section"><a href="#querycriteria-path">14.4. Path expressions</a></span></dt><dt><span class="section"><a href="#querycriteria-param">14.5. Using parameters</a></span></dt></dl></dd><dt><span class="chapter"><a href="#querynative">15. Native SQL Queries</a></span></dt><dd><dl><dt><span class="section"><a href="#querynative-creating">15.1. Using a <code class="literal">SQLQuery</code></a></span></dt><dd><dl><dt><span class="section"><a href="#d5e2834">15.1.1. Scalar queries</a></span></dt><dt><span class="section"><a href="#d5e2858">15.1.2. Entity queries</a></span></dt><dt><span class="section"><a href="#d5e2876">15.1.3. Handling associations and collections</a></span></dt><dt><span class="section"><a href="#d5e2889">15.1.4. Returning multiple entities</a></span></dt><dt><span class="section"><a href="#d5e2981">15.1.5. Returning non-managed entities</a></span></dt><dt><span class="section"><a href="#d5e2993">15.1.6. Handling inheritance</a></span></dt><dt><span class="section"><a href="#d5e2996">15.1.7. Parameters</a></span></dt></dl></dd><dt><span class="section"><a href="#querysql-namedqueries">15.2. Named SQL queries</a></span></dt><dd><dl><dt><span class="section"><a href="#propertyresults">15.2.1. Using return-property to explicitly specify column/alias
      names</a></span></dt><dt><span class="section"><a href="#sp_query">15.2.2. Using stored procedures for querying</a></span></dt></dl></dd><dt><span class="section"><a href="#querysql-cud">15.3. Custom SQL for create, update and delete</a></span></dt><dt><span class="section"><a href="#querysql-load">15.4. Custom SQL for loading</a></span></dt></dl></dd><dt><span class="chapter"><a href="#d5e3197">16. Multi-tenancy</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e3199">16.1. What is multi-tenancy?</a></span></dt><dt><span class="section"><a href="#d5e3202">16.2. Multi-tenant data approaches</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e3208">16.2.1. Separate database</a></span></dt><dt><span class="section"><a href="#d5e3217">16.2.2. Separate schema</a></span></dt><dt><span class="section"><a href="#d5e3234">16.2.3. Partitioned (discriminator) data</a></span></dt></dl></dd><dt><span class="section"><a href="#d5e3243">16.3. Multi-tenancy in Hibernate</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e3272">16.3.1. <code class="interfacename">MultiTenantConnectionProvider</code></a></span></dt><dt><span class="section"><a href="#d5e3297">16.3.2. <code class="interfacename">CurrentTenantIdentifierResolver</code></a></span></dt><dt><span class="section"><a href="#d5e3322">16.3.3. Caching</a></span></dt><dt><span class="section"><a href="#d5e3325">16.3.4. Odds and ends</a></span></dt></dl></dd><dt><span class="section"><a href="#d5e3329">16.4. Strategies for <code class="interfacename">MultiTenantConnectionProvider</code> implementors</a></span></dt></dl></dd><dt><span class="chapter"><a href="#d5e3340">17. OSGi</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e3347">17.1. OSGi Specification and Environment</a></span></dt><dt><span class="section"><a href="#d5e3362">17.2. hibernate-osgi</a></span></dt><dt><span class="section"><a href="#d5e3365">17.3. features.xml</a></span></dt><dt><span class="section"><a href="#d5e3376">17.4. QuickStarts/Demos</a></span></dt><dt><span class="section"><a href="#osgi-managed-jpa">17.5. Container-Managed JPA</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e3385">17.5.1. Enterprise OSGi JPA Container</a></span></dt><dt><span class="section"><a href="#d5e3393">17.5.2. persistence.xml</a></span></dt><dt><span class="section"><a href="#d5e3398">17.5.3. DataSource</a></span></dt><dt><span class="section"><a href="#d5e3412">17.5.4. Bundle Package Imports</a></span></dt><dt><span class="section"><a href="#d5e3422">17.5.5. Obtaining an EntityManger</a></span></dt></dl></dd><dt><span class="section"><a href="#osgi-unmanaged-jpa">17.6. Unmanaged JPA</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e3434">17.6.1. persistence.xml</a></span></dt><dt><span class="section"><a href="#d5e3439">17.6.2. Bundle Package Imports</a></span></dt><dt><span class="section"><a href="#d5e3455">17.6.3. Obtaining an EntityMangerFactory</a></span></dt></dl></dd><dt><span class="section"><a href="#osgi-unmanaged-native">17.7. Unmanaged Native</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e3468">17.7.1. Bundle Package Imports</a></span></dt><dt><span class="section"><a href="#d5e3487">17.7.2. Obtaining an SessionFactory</a></span></dt></dl></dd><dt><span class="section"><a href="#d5e3497">17.8. Optional Modules</a></span></dt><dt><span class="section"><a href="#d5e3501">17.9. Extension Points</a></span></dt><dt><span class="section"><a href="#d5e3525">17.10. Caveats</a></span></dt></dl></dd><dt><span class="chapter"><a href="#d5e3548">18. Envers</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e3554">18.1. Basics</a></span></dt><dt><span class="section"><a href="#envers-configuration">18.2. Configuration</a></span></dt><dt><span class="section"><a href="#d5e3717">18.3. Additional mapping annotations</a></span></dt><dt><span class="section"><a href="#d5e3741">18.4. Choosing an audit strategy</a></span></dt><dt><span class="section"><a href="#envers-revisionlog">18.5. Revision Log</a></span></dt><dd><dl><dt><span class="section"><a href="#envers-tracking-modified-entities-revchanges">18.5.1. Tracking entity names modified during revisions</a></span></dt></dl></dd><dt><span class="section"><a href="#envers-tracking-properties-changes">18.6. Tracking entity changes at property level</a></span></dt><dt><span class="section"><a href="#envers-queries">18.7. Queries</a></span></dt><dd><dl><dt><span class="section"><a href="#entities-at-revision">18.7.1. Querying for entities of a class at a given revision</a></span></dt><dt><span class="section"><a href="#revisions-of-entity">18.7.2. Querying for revisions, at which entities of a given class changed</a></span></dt><dt><span class="section"><a href="#envers-tracking-properties-changes-queries">18.7.3. Querying for revisions of entity that modified given property</a></span></dt><dt><span class="section"><a href="#envers-tracking-modified-entities-queries">18.7.4. Querying for entities modified in a given revision</a></span></dt></dl></dd><dt><span class="section"><a href="#d5e3959">18.8. Conditional auditing</a></span></dt><dt><span class="section"><a href="#d5e3979">18.9. Understanding the Envers Schema</a></span></dt><dt><span class="section"><a href="#envers-generateschema">18.10. Generating schema with Ant</a></span></dt><dt><span class="section"><a href="#envers-mappingexceptions">18.11. Mapping exceptions</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e4014">18.11.1. What isn't and will not be supported</a></span></dt><dt><span class="section"><a href="#d5e4025">18.11.2. What isn't and <span class="emphasis"><em>will</em></span> be supported</a></span></dt><dt><span class="section"><a href="#d5e4032">18.11.3. <code class="literal">@OneToMany</code>+<code class="literal">@JoinColumn</code></a></span></dt></dl></dd><dt><span class="section"><a href="#envers-partitioning">18.12. Advanced: Audit table partitioning</a></span></dt><dd><dl><dt><span class="section"><a href="#envers-partitioning-benefits">18.12.1. Benefits of audit table partitioning</a></span></dt><dt><span class="section"><a href="#envers-partitioning-columns">18.12.2. Suitable columns for audit table partitioning</a></span></dt><dt><span class="section"><a href="#envers-partitioning-example">18.12.3. Audit table partitioning example</a></span></dt></dl></dd><dt><span class="section"><a href="#envers-links">18.13. Envers links</a></span></dt></dl></dd><dt><span class="chapter"><a href="#portability">19. Database Portability Considerations</a></span></dt><dd><dl><dt><span class="section"><a href="#portability-basics">19.1. Portability Basics</a></span></dt><dt><span class="section"><a href="#portability-dialect">19.2. Dialect</a></span></dt><dt><span class="section"><a href="#portability-dialectresolver">19.3. Dialect resolution</a></span></dt><dt><span class="section"><a href="#portability-idgen">19.4. Identifier generation</a></span></dt><dt><span class="section"><a href="#portability-functions">19.5. Database functions</a></span></dt><dt><span class="section"><a href="#portability-types">19.6. Type mappings</a></span></dt></dl></dd><dt><span class="appendix"><a href="#appendix-legacy-bootstrap">A. Legacy Bootstrapping</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e4322">A.1. Migration</a></span></dt></dl></dd><dt><span class="appendix"><a href="#appendix-legacy-criteria">B. Legacy Hibernate Criteria Queries</a></span></dt><dd><dl><dt><span class="section"><a href="#querycriteria-creating">B.1. Creating a <code class="literal">Criteria</code> instance</a></span></dt><dt><span class="section"><a href="#querycriteria-narrowing">B.2. Narrowing the result set</a></span></dt><dt><span class="section"><a href="#querycriteria-ordering">B.3. Ordering the results</a></span></dt><dt><span class="section"><a href="#querycriteria-associations">B.4. Associations</a></span></dt><dt><span class="section"><a href="#querycriteria-dynamicfetching">B.5. Dynamic association fetching</a></span></dt><dt><span class="section"><a href="#querycriteria-components">B.6. Components</a></span></dt><dt><span class="section"><a href="#querycriteria-collections">B.7. Collections</a></span></dt><dt><span class="section"><a href="#querycriteria-examples">B.8. Example queries</a></span></dt><dt><span class="section"><a href="#querycriteria-projection">B.9. Projections, aggregation and grouping</a></span></dt><dt><span class="section"><a href="#querycriteria-detachedqueries">B.10. Detached queries and subqueries</a></span></dt><dt><span class="section"><a href="#query-criteria-naturalid">B.11. Queries by natural identifier</a></span></dt></dl></dd><dt><span class="bibliography"><a href="#d5e4570">References</a></span></dt></dl></div><div class="list-of-tables"><p><strong>List of Tables</strong></p><dl><dt>5.1. <a href="#d5e743">Provided Dialects</a></dt><dt>12.1. <a href="#d5e1614">Callback annotations</a></dt><dt>15.1. <a href="#aliasinjection-summary">Alias injection names</a></dt><dt>18.1. <a href="#d5e3578">Envers Configuration Properties</a></dt><dt>18.2. <a href="#d5e4094">Salaries table</a></dt><dt>18.3. <a href="#d5e4118">Salaries - audit table</a></dt></dl></div><div class="list-of-examples"><p><strong>List of Examples</strong></p><dl><dt>2.1. <a href="#d5e166">Scope of identity</a></dt><dt>2.2. <a href="#d5e171">Set usage with Session-scoped identity</a></dt><dt>2.3. <a href="#d5e175">Mixed Sessions</a></dt><dt>2.4. <a href="#d5e181">Sets with transient entities</a></dt><dt>2.5. <a href="#d5e186">Naive equals/hashCode implementation</a></dt><dt>2.6. <a href="#d5e190">Still trouble</a></dt><dt>2.7. <a href="#d5e197">Forcing identifier generation</a></dt><dt>2.8. <a href="#d5e202">Better equals/hashCode with natural-id</a></dt><dt>2.9. <a href="#d5e216">Working with Dynamic Domain Models</a></dt><dt>3.1. <a href="#d5e250">Controlling BootstrapServiceRegistry building</a></dt><dt>3.2. <a href="#d5e257">Building a BootstrapServiceRegistryBuilder</a></dt><dt>3.3. <a href="#d5e262">Controlling StandardServiceRegistry building</a></dt><dt>3.4. <a href="#d5e270">Configuring a MetadataSources</a></dt><dt>3.5. <a href="#d5e274">Configuring a MetadataSources with method chaining</a></dt><dt>3.6. <a href="#d5e281">Building Metadata via MetadataBuilder</a></dt><dt>3.7. <a href="#d5e288">Building SessionFactory via SessionFactoryBuilder</a></dt><dt>3.8. <a href="#d5e296">Native Bootstrapping - Putting it all together</a></dt><dt>3.9. <a href="#d5e308">Injecting a EntityManagerFactory</a></dt><dt>3.10. <a href="#d5e312">Application bootstrapped EntityManagerFactory</a></dt><dt>4.1. <a href="#d5e351">Example of making an entity persistent</a></dt><dt>4.2. <a href="#d5e370">Example of deleting an entity</a></dt><dt>4.3. <a href="#d5e382">Example of obtaining an entity reference without initializing its data</a></dt><dt>4.4. <a href="#d5e391">Example of obtaining an entity reference with its data initialized</a></dt><dt>4.5. <a href="#d5e399">Example of simple natural-id access</a></dt><dt>4.6. <a href="#d5e402">Example of natural-id access</a></dt><dt>4.7. <a href="#d5e426">Example of refreshing entity state</a></dt><dt>4.8. <a href="#d5e437">Example of modifying managed state</a></dt><dt>4.9. <a href="#d5e451">Example of reattaching a detached entity</a></dt><dt>4.10. <a href="#d5e468">Visualizing merge</a></dt><dt>4.11. <a href="#d5e472">Example of merging a detached entity</a></dt><dt>4.12. <a href="#d5e479">Examples of verifying managed state</a></dt><dt>4.13. <a href="#d5e483">Examples of verifying laziness</a></dt><dt>4.14. <a href="#d5e490">Alternative JPA means to verify laziness</a></dt><dt>4.15. <a href="#d5e496">Usage of EntityManager.unwrap</a></dt><dt>6.1. <a href="#d5e994">Using Transaction API in JDBC</a></dt><dt>6.2. <a href="#d5e997">Using Transaction API in JTA (CMT)</a></dt><dt>6.3. <a href="#d5e1000">Using Transaction API in JTA (BMT)</a></dt><dt>8.1. <a href="#d5e1181">The @Version annotation</a></dt><dt>8.2. <a href="#d5e1196">Declaring a version property in <code class="filename">hbm.xml</code></a></dt><dt>8.3. <a href="#d5e1246">Using timestamps for optimistic locking</a></dt><dt>8.4. <a href="#d5e1255">The timestamp element in <code class="filename">hbm.xml</code></a></dt><dt>9.1. <a href="#d5e1421">Sample domain model</a></dt><dt>9.2. <a href="#d5e1432">No fetching example</a></dt><dt>9.3. <a href="#d5e1437">No fetching (scalar) example</a></dt><dt>9.4. <a href="#d5e1444">Dynamic query fetching example</a></dt><dt>9.5. <a href="#d5e1453">Fetch profile example</a></dt><dt>12.1. <a href="#d5e1594">Custom LoadListener example</a></dt><dt>12.2. <a href="#d5e1605">JACC listener registration example</a></dt><dt>12.3. <a href="#d5e1652">Example of specifying JPA callbacks</a></dt><dt>13.1. <a href="#d5e1765">Example UPDATE query statements</a></dt><dt>13.2. <a href="#d5e1812">Example INSERT query statements</a></dt><dt>13.3. <a href="#hql-simple-query-ex">Simple query example</a></dt><dt>13.4. <a href="#d5e1844">Simple query using entity name for root entity reference</a></dt><dt>13.5. <a href="#d5e1848">Simple query using multiple root entity references</a></dt><dt>13.6. <a href="#d5e1859">Explicit inner join examples</a></dt><dt>13.7. <a href="#d5e1862">Explicit left (outer) join examples</a></dt><dt>13.8. <a href="#d5e1869">Fetch join example</a></dt><dt>13.9. <a href="#d5e1885">with-clause join example</a></dt><dt>13.10. <a href="#d5e1898">Simple implicit join example</a></dt><dt>13.11. <a href="#d5e1917">Reused implicit join</a></dt><dt>13.12. <a href="#d5e1926">Collection references example</a></dt><dt>13.13. <a href="#d5e1939">Qualified collection references example</a></dt><dt>13.14. <a href="#d5e1995">String literal examples</a></dt><dt>13.15. <a href="#d5e1999">Numeric literal examples</a></dt><dt>13.16. <a href="#d5e2025">Named parameter examples</a></dt><dt>13.17. <a href="#d5e2033">Positional (JPQL) parameter examples</a></dt><dt>13.18. <a href="#d5e2044">Numeric arithmetic examples</a></dt><dt>13.19. <a href="#d5e2068">Concatenation operation example</a></dt><dt>13.20. <a href="#d5e2094">Aggregate function examples</a></dt><dt>13.21. <a href="#d5e2253">Collection-related expressions examples</a></dt><dt>13.22. <a href="#d5e2257">Index operator examples</a></dt><dt>13.23. <a href="#d5e2266">Entity type expression examples</a></dt><dt>13.24. <a href="#d5e2282">Simple case expression example</a></dt><dt>13.25. <a href="#d5e2289">Searched case expression example</a></dt><dt>13.26. <a href="#d5e2295">NULLIF example</a></dt><dt>13.27. <a href="#d5e2312">Dynamic instantiation example - constructor</a></dt><dt>13.28. <a href="#d5e2320">Dynamic instantiation example - list</a></dt><dt>13.29. <a href="#d5e2325">Dynamic instantiation example - map</a></dt><dt>13.30. <a href="#d5e2338">Relational comparison examples</a></dt><dt>13.31. <a href="#d5e2346">ALL subquery comparison qualifier example</a></dt><dt>13.32. <a href="#d5e2353">Nullness checking examples</a></dt><dt>13.33. <a href="#d5e2375">Like predicate examples</a></dt><dt>13.34. <a href="#d5e2381">Between predicate examples</a></dt><dt>13.35. <a href="#d5e2406">In predicate examples</a></dt><dt>13.36. <a href="#d5e2416">Empty collection expression examples</a></dt><dt>13.37. <a href="#d5e2423">Member-of collection expression examples</a></dt><dt>13.38. <a href="#group_by_illustration">Group-by illustration</a></dt><dt>13.39. <a href="#having_illustration">Having illustration</a></dt><dt>13.40. <a href="#d5e2477">Order-by examples</a></dt><dt>13.41. <a href="#d5e2488">Obtaining a Query reference - Hibernate</a></dt><dt>13.42. <a href="#d5e2493">Basic Query usage - Hibernate</a></dt><dt>13.43. <a href="#d5e2507">Parameter binding - Hibernate</a></dt><dt>13.44. <a href="#d5e2511">Parameter binding (inferred type) - Hibernate</a></dt><dt>13.45. <a href="#d5e2515">Parameter binding (short forms) - Hibernate</a></dt><dt>13.46. <a href="#d5e2526">list() and uniqueResult()</a></dt><dt>13.47. <a href="#d5e2559">Obtaining a Query reference - JPA</a></dt><dt>13.48. <a href="#d5e2566">Basic Query usage - JPA</a></dt><dt>13.49. <a href="#d5e2615">Parameter binding - JPA</a></dt><dt>14.1. <a href="#ex-criteria-typedquery-entity">Selecting the root entity</a></dt><dt>14.2. <a href="#ex-criteria-typedquery-attribute">Selecting an attribute</a></dt><dt>14.3. <a href="#ex-criteria-typedquery-array">Selecting an array</a></dt><dt>14.4. <a href="#ex-criteria-typedquery-array2">Selecting an array (2)</a></dt><dt>14.5. <a href="#ex-criteria-typedquery-construct">Selecting an wrapper</a></dt><dt>14.6. <a href="#ex-criteria-typedquery-tuple">Selecting a tuple</a></dt><dt>14.7. <a href="#d5e2778">Adding a root</a></dt><dt>14.8. <a href="#d5e2782">Adding multiple roots</a></dt><dt>14.9. <a href="#criteria-join-singular">Example with Embedded and ManyToOne</a></dt><dt>14.10. <a href="#criteria-join-plural">Example with Collections</a></dt><dt>14.11. <a href="#criteria-fetch-singular">Example with Embedded and ManyToOne</a></dt><dt>14.12. <a href="#criteria-fetch-plural">Example with Collections</a></dt><dt>14.13. <a href="#ex-querycriteria-param">Using parameters</a></dt><dt>15.1. <a href="#d5e3005">Named sql query using the &lt;sql-query&gt; maping
      element</a></dt><dt>15.2. <a href="#d5e3008">Execution of a named query</a></dt><dt>15.3. <a href="#d5e3014">Named sql query with association</a></dt><dt>15.4. <a href="#d5e3019">Named query returning a scalar</a></dt><dt>15.5. <a href="#d5e3025">&lt;resultset&gt; mapping used to externalize mapping
      information</a></dt><dt>15.6. <a href="#d5e3029">Programmatically specifying the result mapping information
      </a></dt><dt>15.7. <a href="#example-named-native-query-annotation-with-result-set-mapping">Named SQL query using <code class="classname">@NamedNativeQuery</code>
      together with <code class="classname">@SqlResultSetMapping</code></a></dt><dt>15.8. <a href="#example-implicit-result-set-mapping">Implicit result set mapping</a></dt><dt>15.9. <a href="#example-field-result-annotation-with-associations">Using dot notation in @FieldResult for specifying associations
      </a></dt><dt>15.10. <a href="#d5e3072">Scalar values via <code class="classname">@ColumnResult</code></a></dt><dt>15.11. <a href="#example-custom-crdu-via-annotations">Custom CRUD via annotations</a></dt><dt>15.12. <a href="#example-custom-crdu-via-xml">Custom CRUD XML</a></dt><dt>15.13. <a href="#example-overriding-sql-collections-annotations">Overriding SQL statements for collections using
      annotations</a></dt><dt>15.14. <a href="#d5e3171">Overriding SQL statements for secondary tables</a></dt><dt>15.15. <a href="#d5e3178">Stored procedures and their return value</a></dt><dt>16.1. <a href="#specifying-tenant-ex">Specifying tenant identifier from <code class="interfacename">SessionFactory</code></a></dt><dt>16.2. <a href="#d5e3332">Implementing MultiTenantConnectionProvider using different connection pools</a></dt><dt>16.3. <a href="#d5e3336">Implementing MultiTenantConnectionProvider using single connection pool</a></dt><dt>17.1. <a href="#d5e3404">datasource-h2.xml</a></dt><dt>17.2. <a href="#d5e3409">META-INF/persistence.xml</a></dt><dt>17.3. <a href="#d5e3428">OSGI-INF/blueprint/blueprint.xml</a></dt><dt>17.4. <a href="#d5e3462">Discover/Use EntityManagerFactory</a></dt><dt>17.5. <a href="#d5e3494">Discover/Use EntityManagerFactory</a></dt><dt>17.6. <a href="#d5e3519">Example extension point registrations in blueprint.xml</a></dt><dt>18.1. <a href="#d5e3800">Example of storing username with revision</a></dt><dt>18.2. <a href="#d5e3833">Custom implementation of tracking entity classes modified during revisions</a></dt><dt>A.1. <a href="#d5e4313">Configuration usage</a></dt></dl></div>
    


    <div class="preface" title="Preface"><div class="titlepage"><div><div><h2 class="title"><a id="preface">Preface</a></h2></div></div></div><a id="preface">
    

    </a><p><a id="preface">
        Developing Object-Oriented software that deals with data from Relational Databases can be cumbersome and
        resource consuming.  Development costs are significantly higher due to a paradigm mismatch between how data is
        represented in objects versus relational databases.  Hibernate is an Object/Relational Mapping (ORM) solution
        for Java environments.  ORM refers to the technique of mapping data between an object model representation to
        a relational data model representation.  See
        </a><a class="ulink" href="http://en.wikipedia.org/wiki/Object-relational_mapping">Wikipedia</a>
        for a good high-level discussion.  Also, Martin Fowler's
        <a class="ulink" href="http://martinfowler.com/bliki/OrmHate.html">OrmHate</a> article takes a look at many of
        the mentioned mismatch problems.
    </p>

    <p>
        Although having a strong background in SQL is not required to use Hibernate, having a basic understanding of the
        concepts can help you understand Hibernate more quickly and fully.  An understanding of data modeling principles
        is especially important.  Both <a class="ulink" href="http://www.agiledata.org/essays/dataModeling101.html">http://www.agiledata.org/essays/dataModeling101.html</a> and
        <a class="ulink" href="http://en.wikipedia.org/wiki/Data_modeling">http://en.wikipedia.org/wiki/Data_modeling</a> are good starting points for understanding these
        data modeling principles.
    </p>

    <p>
        Understanding the basics of transactions and design patterns such as "Unit of Work"[<a class="citation" href="#biblio-PoEAA"><span class="citation">PoEAA</span></a>]
        or "ApplicationTransaction" are important as well.  These topics will be discussed in the documentation, but
        a prior understanding will certainly help.
    </p>

    <p>
        Hibernate not only takes care of the mapping from Java classes to database tables (and from Java data types to
        SQL data types), but also provides data query and retrieval facilities. It can significantly reduce
        development time otherwise spent with manual data handling in SQL and JDBC.  Hibernate’s design goal is to
        relieve the developer from 95% of common data persistence-related programming tasks by eliminating the need for
        manual, hand-crafted data processing using SQL and JDBC.  However, unlike many other persistence solutions,
        Hibernate does not hide the power of SQL from you and guarantees that your investment in relational technology
        and knowledge is as valid as always.
    </p>

    <p>
        Hibernate may not be the best solution for data-centric applications that only use stored-procedures to
        implement the business logic in the database, it is most useful with object-oriented domain models and business
        logic in the Java-based middle-tier. However, Hibernate can certainly help you to remove or encapsulate
        vendor-specific SQL code and will help with the common task of result set translation from a tabular
        representation to a graph of objects.
    </p>

    <p>
        See <a class="ulink" href="http://hibernate.org/orm/contribute/">http://hibernate.org/orm/contribute/</a> for information on getting involved.
    </p>

    <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Tip</h2>
        <p>
            If you are just getting started with using Hibernate you may want to start with the
            “<span class="citetitle">Hibernate Getting Started Guide</span>” available from the
            <a class="ulink" href="http://hibernate.org/orm/documentation">documentation page</a>.  It contains quick-start
            style tutorials as well as lots of introductory information.  There is also a series of topical guides
            providing deep dives into various topics.
        </p>
    </div>

</div>

    <div class="chapter" title="Chapter&nbsp;1.&nbsp;Architecture"><div class="titlepage"><div><div><h2 class="title"><a id="architecture">Chapter&nbsp;1.&nbsp;Architecture</a></h2></div></div></div><div class="toc"><p><a id="architecture"><strong>Table of Contents</strong></a></p><dl><dt><a id="architecture"><span class="section"></span></a><a href="#architecture-overview">1.1. Overview</a></dt><dt><span class="section"><a href="#architecture-current-session">1.2. Contextual sessions</a></span></dt></dl></div>

    

    <div class="section" title="1.1.&nbsp;Overview"><div class="titlepage"><div><div><h2 class="title"><a id="architecture-overview">1.1.&nbsp;Overview</a></h2></div></div></div><a id="architecture-overview">
        
        
        <div class="mediaobject" align="center"><img src="Hibernate%20User%20Guide_files/overview.png" align="middle"></div>

        <p>
            Hibernate, as an ORM solution, effectively "sits between" the Java application and the Relational
            Database, as can be seen in the diagram above.  The Java application makes use of the Hibernate APIs
            to load, store, query, etc its domain data.  Here we will introduce the essential Hibernate APIs.
            This will be a brief introduction; we will discuss these contracts in detail later.

            </p></a><div class="variablelist"><a id="architecture-overview"></a><dl><a id="architecture-overview"><dt><span class="term">SessionFactory (<code class="interfacename">org.hibernate.SessionFactory</code>)</span></dt><dd>
                        <p>
                            A thread-safe (and immutable) representation of the mapping of the application
                            domain model to a database.  Acts as a factory for
                            <code class="interfacename">org.hibernate.Session</code> instances.
                        </p>
                        <p>
                            A SessionFactory is very expensive to create; there should be only
                            one SessionFactory for an application for a given database.  Maintains
                            services that Hibernate uses across all Sessions such as second level caches,
                            connection pools, transaction system integrations, etc.
                        </p>
                    </dd><dt><span class="term">Session (<code class="interfacename">org.hibernate.Session</code>)</span></dt></a><dd><a id="architecture-overview">
                        </a><p><a id="architecture-overview">
                            A single-threaded, short-lived object conceptually modeling a
                            "Unit of Work"[</a><a class="citation" href="#biblio-PoEAA"><span class="citation">PoEAA</span></a>].
                        </p>
                        <p>
                            Wraps a JDBC <code class="interfacename">java.sql.Connection</code>.  Acts as a factory for
                            <code class="interfacename">org.hibernate.Transaction</code> instances.  Maintains a
                            generally "repeatable read" persistence context (first level cache) of the application's
                            domain model.
                        </p>
                    </dd><dt><span class="term">Transaction (<code class="interfacename">org.hibernate.Transaction</code>)</span></dt><dd>
                        <p>
                            A single-threaded, short-lived object used by the application to demarcate individual
                            physical transaction boundaries.  It acts as an abstraction API to isolate the application
                            from the underling transaction system in use (JDBC, JTA, CORBA, etc).
                        </p>
                    </dd></dl></div><p>
        </p>
    </div>

    <div class="section" title="1.2.&nbsp;Contextual sessions"><div class="titlepage"><div><div><h2 class="title"><a id="architecture-current-session">1.2.&nbsp;Contextual sessions</a></h2></div></div></div><a id="architecture-current-session">
        
        <p>
            Most applications using Hibernate need some form of "contextual" session, where a given
            session is in effect throughout the scope of a given context. However, across applications
            the definition of what constitutes a context is typically different; different contexts
            define different scopes to the notion of current. Applications using Hibernate prior
            to version 3.0 tended to utilize either home-grown <code class="literal">ThreadLocal</code>-based
            contextual sessions, helper classes such as <code class="literal">HibernateUtil</code>, or utilized
            third-party frameworks, such as Spring or Pico, which provided proxy/interception-based contextual sessions.
        </p>
        <p>
            Starting with version 3.0.1, Hibernate added the <code class="literal">SessionFactory.getCurrentSession()</code>
            method. Initially, this assumed usage of <code class="literal">JTA</code> transactions, where the
            <code class="literal">JTA</code> transaction defined both the scope and context of a current session.
            Given the maturity of the numerous stand-alone
            <code class="literal">JTA TransactionManager</code> implementations, most, if not all,
            applications should be using <code class="literal">JTA</code> transaction management, whether or not
            they are deployed into a <code class="literal">J2EE</code> container.  Based on that, the
            <code class="literal">JTA</code>-based contextual sessions are all you need to use.
        </p>
        <p>
            However, as of version 3.1, the processing behind
            <code class="literal">SessionFactory.getCurrentSession()</code> is now pluggable.  To that
            end, a new extension interface, <code class="literal">org.hibernate.context.spi.CurrentSessionContext</code>,
            and a new configuration parameter, <code class="literal">hibernate.current_session_context_class</code>,
            have been added to allow pluggability of the scope and context of defining current sessions.
        </p>
        <p>
            See the Javadocs for the <code class="literal">org.hibernate.context.spi.CurrentSessionContext</code>
            interface for a detailed discussion of its contract.  It defines a single method,
            <code class="literal">currentSession()</code>, by which the implementation is responsible for
            tracking the current contextual session.  Out-of-the-box, Hibernate comes with three
            implementations of this interface:
        </p>

        <div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
                <p>
                    <code class="literal">org.hibernate.context.internal.JTASessionContext</code>: current sessions
                    are tracked and scoped by a <code class="literal">JTA</code> transaction.  The processing
                    here is exactly the same as in the older JTA-only approach.  See the Javadocs
                    for details.
                </p>
            </li><li class="listitem">
                <p>
                    <code class="literal">org.hibernate.context.internal.ThreadLocalSessionContext</code>:current
                    sessions are tracked by thread of execution. See the Javadocs for details.
                </p>
            </li><li class="listitem">
                <p>
                    <code class="literal">org.hibernate.context.internal.ManagedSessionContext</code>: current
                    sessions are tracked by thread of execution. However, you are responsible to
                    bind and unbind a <code class="literal">Session</code> instance with static methods
                    on this class: it does not open, flush, or close a <code class="literal">Session</code>.
                </p>
            </li></ul></div>

        <p>
            Typically, the value of this parameter would just name the implementation class to
            use. For the three out-of-the-box implementations, however, there are three corresponding
            short names: "jta", "thread", and "managed".
        </p>

        </a><p><a id="architecture-current-session">
            The first two implementations provide a "one session - one database transaction" programming
            model. This is also known and used as <span class="emphasis"><em>session-per-request</em></span>. The beginning
            and end of a Hibernate session is defined by the duration of a database transaction.
            If you use programmatic transaction demarcation in plain JSE without JTA, you are advised to
            use the Hibernate <code class="literal">Transaction</code> API to hide the underlying transaction system
            from your code. If you use JTA, you can utilize the JTA interfaces to demarcate transactions. If you
            execute in an EJB container that supports CMT, transaction boundaries are defined declaratively
            and you do not need any transaction or session demarcation operations in your code.
            Refer to </a><a class="xref" href="#transactions" title="Chapter&nbsp;6.&nbsp;Transactions and concurrency control">Chapter&nbsp;6, <em>Transactions and concurrency control</em></a> for more information and code examples.
        </p>

        <p>
            The <code class="literal">hibernate.current_session_context_class</code> configuration parameter
            defines which <code class="literal">org.hibernate.context.spi.CurrentSessionContext</code> implementation
            should be used.  For backwards compatibility, if this configuration parameter is not set
            but a <code class="literal">org.hibernate.engine.transaction.jta.platform.spi.JtaPlatform</code> is configured,
            Hibernate will use the <code class="literal">org.hibernate.context.internal.JTASessionContext</code>.
        </p>
        
    </div>

</div>
    <div class="chapter" title="Chapter&nbsp;2.&nbsp;Domain Model"><div class="titlepage"><div><div><h2 class="title"><a id="domainmodel">Chapter&nbsp;2.&nbsp;Domain Model</a></h2></div></div></div><div class="toc"><p><a id="domainmodel"><strong>Table of Contents</strong></a></p><dl><dt><a id="domainmodel"><span class="section"></span></a><a href="#domainmodel-pojo">2.1. POJO Domain Models</a></dt><dd><dl><dt><span class="section"><a href="#domainmodel-pojo-constructor">2.1.1. Implement a no-argument constructor</a></span></dt><dt><span class="section"><a href="#domainmodel-pojo-identifier">2.1.2. Provide identifier attribute(s)</a></span></dt><dt><span class="section"><a href="#domainmodel-pojo-final">2.1.3. Prefer non-final classes</a></span></dt><dt><span class="section"><a href="#domainmodel-pojo-accessors">2.1.4. Declare getters and setters for persistent attributes</a></span></dt><dt><span class="section"><a href="#domainmodel-pojo-equalshashcode">2.1.5. Implementing <code class="literal">equals()</code> and <code class="literal">hashCode()</code></a></span></dt></dl></dd><dt><span class="section"><a href="#domainmodel-dynamic">2.2. Dynamic models</a></span></dt></dl></div>
    

    <p>
        The term <a class="ulink" href="https://en.wikipedia.org/wiki/Domain_model">domain model</a>
        comes from the realm of data modeling.  It is the model that ultimately
        describes the <a class="ulink" href="https://en.wikipedia.org/wiki/Problem_domain">problem domain</a>
        you are working in.  Sometimes you will also hear the term "persistent classes".
    </p>

    <p>
        Ultimately the application's domain model is the central character in an ORM.  They make up the classes
        you wish to map.  Hibernate works best if these classes follow the Plain Old Java Object (POJO) / JavaBean
        programming model.  However, none of these rules are hard requirements. Indeed, Hibernate assumes very little
        about the nature of your persistent objects. You can express a domain model in other ways (using trees of
        <code class="interfacename">java.util.Map</code> instances, for example).
    </p>

    <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2>
        <p>
            Even though Hibernate does not consider all of these rules as hard requirements, JPA does specify
            some of them.  Therefore, if you are concerned about JPA provider portability it is best to
            stick to the strict POJO model.  We will point out these concerns where applicable.
        </p>
    </div>

    <p>
        This chapter will describe the characteristics of a persistable domain model.  However, it will not discuss
        defining the mapping for the domain model.  That is a massive topic in its own right and is the subject of an
        entire dedicated manual.  See the <em class="citetitle">Hibernate Domain Model Mapping Guide</em> from the
        <a class="ulink" href="http://hibernate.org/orm/documentation">documentation site</a>.
    </p>

    <div class="section" title="2.1.&nbsp;POJO Domain Models"><div class="titlepage"><div><div><h2 class="title"><a id="domainmodel-pojo">2.1.&nbsp;POJO Domain Models</a></h2></div></div></div><a id="domainmodel-pojo">
        

        <p>
            This section explores domain models defined as POJOs.
        </p>

        </a><div class="section" title="2.1.1.&nbsp;Implement a no-argument constructor"><a id="domainmodel-pojo"></a><div class="titlepage"><a id="domainmodel-pojo"></a><div><a id="domainmodel-pojo"></a><div><a id="domainmodel-pojo"></a><h3 class="title"><a id="domainmodel-pojo"></a><a id="domainmodel-pojo-constructor">2.1.1.&nbsp;Implement a no-argument constructor</a></h3></div></div></div><a id="domainmodel-pojo-constructor">
            

            <p>
                The POJO should have a no-argument constructor.  Both Hibernate and JPA require this.
            </p>

            <p>
                JPA requires that this constructor be defined as public or protected.  Hibernate for the most part does
                note care about the visibility as long as the system's SecurityManager allows overriding the visibility.
                That said, the constructor should be defined with at least package visibility if you wish to leverage
                runtime proxy generation.
            </p>
        </a></div><a id="domainmodel-pojo-constructor">


        </a><div class="section" title="2.1.2.&nbsp;Provide identifier attribute(s)"><a id="domainmodel-pojo-constructor"></a><div class="titlepage"><a id="domainmodel-pojo-constructor"></a><div><a id="domainmodel-pojo-constructor"></a><div><a id="domainmodel-pojo-constructor"></a><h3 class="title"><a id="domainmodel-pojo-constructor"></a><a id="domainmodel-pojo-identifier">2.1.2.&nbsp;Provide identifier attribute(s)</a></h3></div></div></div><a id="domainmodel-pojo-identifier">
            

            <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2>
                <p>
                    Historically this was considered optional.  However, not defining identifier attribute(s) on the
                    entity should be considered a deprecated feature that will be removed in an upcoming release.
                </p>
            </div>

            <p>
                The identifier attribute does not necessarily need to be mapped to the column(s) that physically
                define the primary key.  However, it should map to column(s) that can uniquely identify each row.
            </p>

            <p>
                We recommend that you declare consistently-named identifier attributes on persistent classes and
                that you use a nullable (i.e., non-primitive) type.
            </p>
        </a></div><a id="domainmodel-pojo-identifier">


        </a><div class="section" title="2.1.3.&nbsp;Prefer non-final classes"><a id="domainmodel-pojo-identifier"></a><div class="titlepage"><a id="domainmodel-pojo-identifier"></a><div><a id="domainmodel-pojo-identifier"></a><div><a id="domainmodel-pojo-identifier"></a><h3 class="title"><a id="domainmodel-pojo-identifier"></a><a id="domainmodel-pojo-final">2.1.3.&nbsp;Prefer non-final classes</a></h3></div></div></div><a id="domainmodel-pojo-final">
            

            <p>
                A central feature of Hibernate is the ability to lazy load an entity's data via runtime proxies.  This
                feature depends upon the entity class being non-final or else implementing an interface that declares
                all the attribute getters/setters.  You can still persist final classes that do not implement such
                an interface with Hibernate; you just will not be able to use proxies for lazy association fetching
                which will ultimately limit your options for performance tuning.
            </p>

            <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2>
                <p>
                    Starting in 5.0 Hibernate offers a more robust version of bytecode enhancement as another means
                    for handling lazy loading.  Hibernate had some bytecode re-writing capabilities prior to 5.0 but
                    they were very rudimentary.
                    
                </p>
            </div>

            <p>
                You should also avoid declaring persistent attribute getters and setters as final for the reasons
                already mentioned.
            </p>
        </a></div><a id="domainmodel-pojo-final">

        </a><div class="section" title="2.1.4.&nbsp;Declare getters and setters for persistent attributes"><a id="domainmodel-pojo-final"></a><div class="titlepage"><a id="domainmodel-pojo-final"></a><div><a id="domainmodel-pojo-final"></a><div><a id="domainmodel-pojo-final"></a><h3 class="title"><a id="domainmodel-pojo-final"></a><a id="domainmodel-pojo-accessors">2.1.4.&nbsp;Declare getters and setters for persistent attributes</a></h3></div></div></div><a id="domainmodel-pojo-accessors">
            

            <p>
                Although not required, it is recommended to follow JavaBean conventions by defining getters and
                setters for you entities persistent attributes.  Hibernate can also directly access the entity's
                fields.
            </p>

            <p>
                Attributes (whether fields or getters/setters) need not be declared public.  Hibernate can deal with
                attributes declared with public, protected, package or private visibility.
            </p>
        </a></div><a id="domainmodel-pojo-accessors">


        </a><div class="section" title="2.1.5.&nbsp;Implementing equals() and hashCode()"><a id="domainmodel-pojo-accessors"></a><div class="titlepage"><a id="domainmodel-pojo-accessors"></a><div><a id="domainmodel-pojo-accessors"></a><div><a id="domainmodel-pojo-accessors"></a><h3 class="title"><a id="domainmodel-pojo-accessors"></a><a id="domainmodel-pojo-equalshashcode">2.1.5.&nbsp;Implementing <code class="literal">equals()</code> and <code class="literal">hashCode()</code></a></h3></div></div></div><a id="domainmodel-pojo-equalshashcode">
            

            </a><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><a id="domainmodel-pojo-equalshashcode"><h2>Note</h2>
                </a><p><a id="domainmodel-pojo-equalshashcode">
                    Much of the discussion in this section deals with the relation of an entity to
                    a Hibernate Session; whether the entity is managed or transient or detached.  These
                    topics are explained in </a><a class="xref" href="#">???</a> if you are unfamiliar with them.
                </p>
            </div>

            <p>
                Whether to implement <code class="methodname">equals()</code> and <code class="methodname">hashCode()</code>
                methods in your domain model, let alone how to implement them, is a surprisingly tricky discussion
                when it comes to ORM.
            </p>

            <p>
                There is really just one absolute case: a class that acts as an identifier must implement
                equals/hashCode based on the id value(s).  Generally this is pertinent for user classes used as
                composite identifiers.  Beyond this one absolute case and the few others we will discuss below, you
                may want to consider not implementing equals/hashCode.
            </p>

            <p>
                So what's all the fuss?  Normally, most Java objects provide a built-in equals() and hashCode() based
                on the object's identity,  so each new object will be different from all others.  This is generally what
                you want in ordinary Java programming.  Conceptually however this starts to break down when you start
                to think about the possibility multiple instances of a class representing the same data which is in
                fact the case when we start dealing with data from a database.  Every time we load a specific
                <code class="classname">Person</code> from the database we would naturally get a unique instance.
                Hibernate, however, works hard to make sure that does not happen within a given Session.  In fact
                Hibernate guarantees equivalence of persistent identity (database row) and Java identity inside a
                particular session scope.  So if we ask a Hibernate Session to load that specific Person multiple
                times we will actually get back the same <span class="emphasis"><em>instance</em></span>:
            </p>

            <div class="example"><a id="d5e166"><p class="title"><strong>Example&nbsp;2.1.&nbsp;Scope of identity</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Session session = ...;

Person p1 = session.get( Person.class, 1 );
Person p2 = session.get( Person.class, 1);

// this evaluates to true
assert p1 == p2;</pre>
            </div></a></div><a id="d5e166"><br class="example-break">

            <p>
                Consider another example using a persistent <code class="interfacename">java.util.Set</code>:
            </p>

            </a><div class="example"><a id="d5e166"></a><a id="d5e171"><p class="title"><strong>Example&nbsp;2.2.&nbsp;Set usage with Session-scoped identity</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Session session = ...;

Club club = session.get( Club.class, 1 );

Person p1 = session.get( Person.class, 1 );
Person p2 = session.get( Person.class, 1);

club.getMembers().add( p1 );
club.getMembers().add( p2 );

// this evaluates to true
assert club.getMembers.size() == 1;</pre>
            </div></a></div><a id="d5e171"><br class="example-break">

            <p>
                However, the semantic changes when we mix instances loaded from different Sessions:
            </p>

            </a><div class="example"><a id="d5e171"></a><a id="d5e175"><p class="title"><strong>Example&nbsp;2.3.&nbsp;Mixed Sessions</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Session session1 = ...;
Session session2 = ...;

Person p1 = session1.get( Person.class, 1 );
Person p2 = session2.get( Person.class, 1);

// this evaluates to false
assert p1 == p2;</pre>
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Session session1 = ...;
Session session2 = ...;

Club club = session1.get( Club.class, 1 );

Person p1 = session1.get( Person.class, 1 );
Person p2 = session2.get( Person.class, 1);

club.getMembers().add( p1 );
club.getMembers().add( p2 );

// this evaluates to ... well it depends
assert club.getMembers.size() == 1;</pre>
            </div></a></div><a id="d5e175"><br class="example-break">

            <p>
                Specifically the outcome in this last example will depend on whether the Person class implemented
                equals/hashCode, and if so how.
            </p>

            <p>
                Consider yet another case:
            </p>

            </a><div class="example"><a id="d5e175"></a><a id="d5e181"><p class="title"><strong>Example&nbsp;2.4.&nbsp;Sets with transient entities</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Session session = ...;

Club club = session.get( Club.class, 1 );

Person p1 = new Person(...);
Person p2 = new Person(...);

club.getMembers().add( p1 );
club.getMembers().add( p2 );

// this evaluates to ... again, it depends
assert club.getMembers.size() == 1;</pre>
            </div></a></div><a id="d5e181"><br class="example-break">

            <p>
                In cases where you will be dealing with entities outside of a Session (whether
                they be transient or detached), especially in cases where you will be using
                them in Java collections, you should consider implementing equals/hashCode.
            </p>

            <p>
                A common initial approach is to use the entity's identifier attribute as the basis for
                equals/hashCode calculations:
            </p>

            </a><div class="example"><a id="d5e181"></a><a id="d5e186"><p class="title"><strong>Example&nbsp;2.5.&nbsp;Naive equals/hashCode implementation</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">@Entity
public class Person {
	@Id
	@GeneratedValue
	private Integer id;

	...

	@Override
	public int hashCode() {
		return id != null ? id.hashCode() : 0;
	}

	@Override
	public boolean equals() {
		if ( this == o ) {
			return true;
		}
		if ( !( o instanceof Person ) ) {
			return false;
		}

		if ( id == null ) {
			return false;
		}

		final Person other = (Person) o;
		return id.equals( other.id );
	}
}</pre>
            </div></a></div><a id="d5e186"><br class="example-break">

            <p>
                It turns out that this still breaks when adding transient instance of Person to a set
                as we saw in the last example:
            </p>

            </a><div class="example"><a id="d5e186"></a><a id="d5e190"><p class="title"><strong>Example&nbsp;2.6.&nbsp;Still trouble</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Session session = ...;
session.getTransaction().begin();

Club club = session.get( Club.class, 1 );

Person p1 = new Person(...);
Person p2 = new Person(...);

club.getMembers().add( p1 );
club.getMembers().add( p2 );

session.getTransaction().commit();

// will actually resolve to false!
assert club.getMembers().contains( p1 );</pre>
            </div></a></div><a id="d5e190"><br class="example-break">

            <p>
                The issue here is a conflict between (1) the use of generated identifier and
                (2) the contract of Set and (3) the equals/hashCode implementations.  Set says that the
                equals/hashCode value for an object should not change while it is part of the Set.
                But that is exactly what happened here because the equals/hasCode are based on the (generated) id,
                which was not set until the <code class="literal">session.getTransaction().commit()</code> call.
            </p>

            <p>
                Note that this is just a concern when using generated identifiers.  If you are using assigned
                identifiers this will not be a problem, assuming the identifier value is assigned prior to
                adding to the Set.
            </p>

            <p>
                Another option is to force the identifier to be generated and set prior to adding to the Set:
            </p>

            </a><div class="example"><a id="d5e190"></a><a id="d5e197"><p class="title"><strong>Example&nbsp;2.7.&nbsp;Forcing identifier generation</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Session session = ...;
session.getTransaction().begin();

Club club = session.get( Club.class, 1 );

Person p1 = new Person(...);
Person p2 = new Person(...);

session.save( p1 );
session.save( p2 );
session.flush();

club.getMembers().add( p1 );
club.getMembers().add( p2 );

session.getTransaction().commit();

// will actually resolve to false!
assert club.getMembers().contains( p1 );</pre>
            </div></a></div><a id="d5e197"><br class="example-break">

            <p>
                But this is often not feasible.
            </p>

            <p>
                The final approach is to use a "better" equals/hashCode implementation, making use of a natural-id
                or business-key.
            </p>

            </a><div class="example"><a id="d5e197"></a><a id="d5e202"><p class="title"><strong>Example&nbsp;2.8.&nbsp;Better equals/hashCode with natural-id</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">@Entity
public class Person {
	@Id
	@GeneratedValue
	private Integer id;

	@NaturalId
	private String ssn;

	protected Person() {
		// ctor for ORM
	}

	public Person(String ssn) {
		// ctor for app
		this.ssn = ssn;
	}

	...

	@Override
	public int hashCode() {
		assert ssn != null;
		return ssn.hashCode();
	}

	@Override
	public boolean equals() {
		if ( this == o ) {
			return true;
		}
		if ( !( o instanceof Person ) ) {
			return false;
		}

		final Person other = (Person) o;
		assert ssn != null;
		assert other.ssn != null;

		return ssn.equals( other.ssn );
	}
}</pre>
            </div></a></div><a id="d5e202"><br class="example-break">

            

            <p>
                As you can see the question of equals/hashCode is not trivial.  Nor is there a one-size-fits-all
                solution.
            </p>
        </a></div><a id="d5e202">

    </a></div><a id="d5e202">

    </a><div class="section" title="2.2.&nbsp;Dynamic models"><a id="d5e202"></a><div class="titlepage"><a id="d5e202"></a><div><a id="d5e202"></a><div><a id="d5e202"></a><h2 class="title"><a id="d5e202"></a><a id="domainmodel-dynamic">2.2.&nbsp;Dynamic models</a></h2></div></div></div><a id="domainmodel-dynamic">
        

        <p>
            Persistent entities do not necessarily have to be represented as
            POJO/JavaBean classes.  Hibernate also supports dynamic models (using <code class="literal">Map</code>s of
            <code class="literal">Map</code>s at runtime). With this approach, you do not write persistent classes,
            only mapping files.
        </p>

        <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2>
            <p>
                The mapping of dynamic models is beyond the scope of this document.  We will discuss
                using such models with Hibernate, but for mapping see the
                <em class="citetitle">Hibernate Domain Model Mapping</em> documentation.
            </p>
        </div>

        <p>
            A given entity has just one <em class="firstterm">entity mode</em> within a given SessionFactory.  This
            is a change from previous versions which allowed to define multiple entity modes for an entity and
            to select which to load.  Entity modes can now also be mixed within a domain model; a dynamic entity
            might reference a POJO entity, and vice versa.
        </p>

        </a><div class="example"><a id="domainmodel-dynamic"></a><a id="d5e216"><p class="title"><strong>Example&nbsp;2.9.&nbsp;Working with Dynamic Domain Models</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Session s = openSession();
Transaction tx = s.beginTransaction();

// Create a customer entity
Map david = new HashMap();
david.put("name", "David");

// Create an organization entity
Map foobar = new HashMap();
foobar.put("name", "Foobar Inc.");

// Link both
david.put("organization", foobar);

// Save both
s.save("Customer", david);
s.save("Organization", foobar);

tx.commit();
s.close();</pre>
        </div></a></div><a id="d5e216"><br class="example-break">

        <p>
            The main advantage of dynamic models is quick turnaround time for prototyping without the need for
            entity class implementation.  The main down-fall is that you lose compile-time type checking and will
            likely deal with many exceptions at runtime.  However, as a result of the Hibernate mapping, the
            database schema can easily be normalized and sound, allowing to add a proper domain model implementation
            on top later on.
        </p>

        <p>
            It is also interesting to note that dynamic models are great for certain integration use cases as well.
            Envers, for example, makes extensive use of dynamic models to represent the historical data.
        </p>
    </a></div><a id="d5e216">

</a></div><a id="d5e216">
    </a><div class="chapter" title="Chapter&nbsp;3.&nbsp;Bootstrap"><a id="d5e216"></a><div class="titlepage"><a id="d5e216"></a><div><a id="d5e216"></a><div><a id="d5e216"></a><h2 class="title"><a id="d5e216"></a><a id="bootstrap">Chapter&nbsp;3.&nbsp;Bootstrap</a></h2></div></div></div><div class="toc"><p><a id="bootstrap"><strong>Table of Contents</strong></a></p><dl><dt><a id="bootstrap"><span class="section"></span></a><a href="#bootstrap-native">3.1. Native Bootstrapping</a></dt><dd><dl><dt><span class="section"><a href="#bootstrap-native-registry">3.1.1. Building the ServiceRegistry</a></span></dt><dt><span class="section"><a href="#bootstrap-native-metadata">3.1.2. Building the Metadata</a></span></dt><dt><span class="section"><a href="#bootstrap-native-sessionfactory">3.1.3. Building the SessionFactory</a></span></dt></dl></dd><dt><span class="section"><a href="#bootstrap-jpa">3.2. JPA Bootstrapping</a></span></dt><dd><dl><dt><span class="section"><a href="#bootstrap-jpa-compliant">3.2.1. JPA-compliant bootstrapping</a></span></dt><dt><span class="section"><a href="#bootstrap-jpa-hibernate">3.2.2. Proprietary 2-phase bootstrapping</a></span></dt></dl></dd></dl></div>
    

    <p>
        The term <em class="firstterm">bootstrapping</em> refers to initializing and starting a software
        component.  In Hibernate we are specifically talking about the process of building a fully functional
        SessionFactory instance or EntityManagerFactory instance for JPA.  The process is very different for
        each.
    </p>

    <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2>
        <p>
            This chapter will not focus on all the possibilities of bootstrapping.  Those will be covered
            in each specific more-relevant chapters later on.  Instead we focus here on the API calls needed
            to perform the bootstrapping.
        </p>
    </div>

    

    <div class="section" title="3.1.&nbsp;Native Bootstrapping"><div class="titlepage"><div><div><h2 class="title"><a id="bootstrap-native">3.1.&nbsp;Native Bootstrapping</a></h2></div></div></div><a id="bootstrap-native">
        

        </a><p><a id="bootstrap-native">
            This section discusses the process of bootstrapping a Hibernate SessionFactory.  Specifically it discusses
            the bootstrapping APIs as redesigned in 5.0.  For a discussion of the legacy bootstrapping API, see
            </a><a class="xref" href="#appendix-legacy-bootstrap" title="Appendix&nbsp;A.&nbsp;Legacy Bootstrapping">Appendix&nbsp;A, <em>Legacy Bootstrapping</em></a>
        </p>

        <div class="section" title="3.1.1.&nbsp;Building the ServiceRegistry"><div class="titlepage"><div><div><h3 class="title"><a id="bootstrap-native-registry">3.1.1.&nbsp;Building the ServiceRegistry</a></h3></div></div></div><a id="bootstrap-native-registry">
            
            <p>
                The first step in native bootstrapping is the building of a ServiceRegistry holding the
                services Hibernate will need at bootstrap and run time.
            </p>

            

            <p>
                Actually we are concerned with building 2 different ServiceRegistries.  First is the
                <code class="interfacename">org.hibernate.boot.registry.BootstrapServiceRegistry</code>. The
                BootstrapServiceRegistry is intended to hold services that Hibernate needs at both bootstrap and
                run time.  This boils down to 3 services:
                </p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
                        <p>
                            <code class="interfacename">org.hibernate.boot.registry.classloading.spi.ClassLoaderService</code> -
                            which controls how Hibernate interacts with ClassLoaders
                        </p>
                    </li><li class="listitem">
                        <p>
                            <code class="interfacename">org.hibernate.integrator.spi.IntegratorService</code> -
                            which controls the management ands discovery of
                            <code class="interfacename">org.hibernate.integrator.spi.Integrator</code> instances.
                        </p>
                    </li><li class="listitem">
                        <p>
                            <code class="interfacename">org.hibernate.boot.registry.selector.spi.StrategySelector</code> -
                            which control how Hibernate resolves implementations of various strategy contracts.  This
                            is a very powerful service, but a full discussion of it is beyond the scope of this guide.
                        </p>
                    </li></ul></div><p>
            </p>

            <p>
                If you are ok with the default behavior of Hibernate in regards to these BootstrapServiceRegistry
                services (which is quite often the case, especially in SE environments), then building the
                BootstrapServiceRegistry can be skipped.
            </p>

            <p>
                If you wish to alter how the BootstrapServiceRegistry is built, that is controlled through the
                <code class="interfacename">org.hibernate.boot.registry.BootstrapServiceRegistryBuilder</code>:
            </p>

            </a><div class="example"><a id="bootstrap-native-registry"></a><a id="d5e250"><p class="title"><strong>Example&nbsp;3.1.&nbsp;Controlling BootstrapServiceRegistry building</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">BootstrapServiceRegistryBuilder bootstrapRegistryBuilder
		= new BootstrapServiceRegistryBuilder();

// add a special ClassLoader
bootstrapRegistryBuilder.applyClassLoader( mySpecialClassLoader );
// manually add an Integrator
bootstrapRegistryBuilder.applyIntegrator( mySpecialIntegrator );
...

BootstrapServiceRegistry bootstrapRegistry = bootstrapRegistryBuilder.build();</pre>
            </div></a></div><a id="d5e250"><br class="example-break">

            <p>
                The services of the BootstrapServiceRegistry cannot be extended (added to) nor overridden (replaced).
            </p>

            <p>
                The second ServiceRegistry is the <code class="interfacename">org.hibernate.boot.registry.StandardServiceRegistry</code>.
                You will almost always need to configure the StandardServiceRegistry, which is done through
                <code class="classname">org.hibernate.boot.registry.StandardServiceRegistryBuilder</code>:
            </p>

            </a><div class="example"><a id="d5e250"></a><a id="d5e257"><p class="title"><strong>Example&nbsp;3.2.&nbsp;Building a BootstrapServiceRegistryBuilder</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">// An example using an implicitly built BootstrapServiceRegistry
StandardServiceRegistryBuilder standardRegistryBuilder
		= new StandardServiceRegistryBuilder();</pre>
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">// An example using an explicitly built BootstrapServiceRegistry
BootstrapServiceRegistry bootstrapRegistry = ...;

StandardServiceRegistryBuilder standardRegistryBuilder
		= new StandardServiceRegistryBuilder( bootstrapRegistry );</pre>
            </div></a></div><a id="d5e257"><br class="example-break">

            <p>
                A StandardServiceRegistry is also highly configurable via the StandardServiceRegistryBuilder API.
                See the StandardServiceRegistryBuilder javadocs for full details.  Some specific methods of interest:
            </p>

            </a><div class="example"><a id="d5e257"></a><a id="d5e262"><p class="title"><strong>Example&nbsp;3.3.&nbsp;Controlling StandardServiceRegistry building</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">StandardServiceRegistryBuilder standardRegistryBuilder = ...;

// load some properties via resource lookup
standardRegistryBuilder.loadProperties( "org/hibernate/example/MyProperties.properties" );

// configure the registry from a resource lookup for a cfg.xml config file
standardRegistryBuilder.configure( "org/hibernate/example/my.cfg.xml" );

// apply a random setting
standardRegistryBuilder.applySetting( "myProp", "some value" );

// apply a service initiator
standardRegistryBuilder.addInitiator( new CustomServiceInitiator() );

// apply a service impl
standardRegistryBuilder.addService( SomeCustomService.class, new SomeCustomServiceImpl() );

// and finally build the StandardServiceRegistry
StandardServiceRegistry standardRegistry = standardRegistryBuilder.build();</pre>
            </div></a></div><a id="d5e262"><br class="example-break">
        </a></div><a id="d5e262">

        </a><div class="section" title="3.1.2.&nbsp;Building the Metadata"><a id="d5e262"></a><div class="titlepage"><a id="d5e262"></a><div><a id="d5e262"></a><div><a id="d5e262"></a><h3 class="title"><a id="d5e262"></a><a id="bootstrap-native-metadata">3.1.2.&nbsp;Building the Metadata</a></h3></div></div></div><a id="bootstrap-native-metadata">
            
            <p>
                The second step in native bootstrapping is the building of a <code class="interfacename">org.hibernate.boot.Metadata</code>
                object containing the parsed representations of an application's domain model and its mapping to
                a database.  The first thing we obviously need to build a parsed representation is the source
                information to be parsed (annotated classes, `hbm.xml` files, `orm.xml` files).  This is
                the purpose of <code class="classname">org.hibernate.boot.MetadataSources</code>:
            </p>

            </a><div class="example"><a id="bootstrap-native-metadata"></a><a id="d5e270"><p class="title"><strong>Example&nbsp;3.4.&nbsp;Configuring a MetadataSources</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">MetadataSources sources = new MetadataSources( standardRegistry );

// alternatively, we can build the MetadataSources without passing
// a service registry, in which case it will build a default
// BootstrapServiceRegistry to use.  But the approach shown
// above is preferred
// MetadataSources sources = new MetadataSources();

// add a class using JPA/Hibernate annotations for mapping
sources.addAnnotatedClass( MyEntity.class );

// add the name of a class using JPA/Hibernate annotations for mapping.
// differs from above in that accessing the Class is deferred which is
// important if using runtime bytecode-enhancement
sources.addAnnotatedClassName( "org.hibernate.example.Customer" );

// Adds the named hbm.xml resource as a source: which performs the
// classpath lookup and parses the XML
sources.addResource( "org/hibernate/example/Order.hbm.xml" );

// Adds the named JPA orm.xml resource as a source: which performs the
// classpath lookup and parses the XML
sources.addResource( "org/hibernate/example/Product.orm.xml" );</pre>
            </div></a></div><a id="d5e270"><br class="example-break">

            <p>
                MetadataSources has many other methods as well; explore its API and javadocs for more information.
                Also, all methods on MetadataSources allow for chaining should you prefer that style:
            </p>

            </a><div class="example"><a id="d5e270"></a><a id="d5e274"><p class="title"><strong>Example&nbsp;3.5.&nbsp;Configuring a MetadataSources with method chaining</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">MetadataSources sources = new MetadataSources( standardRegistry )
		.addAnnotatedClass( MyEntity.class )
		.addAnnotatedClassName( "org.hibernate.example.Customer" )
		.addResource( "org/hibernate/example/Order.hbm.xml" )
		.addResource( "org/hibernate/example/Product.orm.xml" );</pre>
            </div></a></div><a id="d5e274"><br class="example-break">

            <p>
                Once we have the sources of mapping information defined, we need to build the Metadata object.  If
                you are ok with the default behavior in building the Metadata then you can simply call
                MetadataSources#buildMetadata.
            </p>

            <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2>
                <p>
                    Notice that a ServiceRegistry can be passed at a number of points in this bootstrapping process.
                    The suggested approach is to build a StandardServiceRegistry yourself and pass that along to the
                    MetadataSources constructor.  From there, MetadataBuilder, Metadata, SessionFactoryBuilder and
                    SessionFactory will all pick up that same StandardServiceRegistry.
                </p>
            </div>

            <p>
                However, if you wish to adjust the process of building Metadata from MetadataSources you will need
                to use the MetadataBuilder as obtained via MetadataSources#getMetadataBuilder.  MetadataBuilder
                allows a lot of control over the Metadata building process.  See its javadocs for full details.
            </p>

            </a><div class="example"><a id="d5e274"></a><a id="d5e281"><p class="title"><strong>Example&nbsp;3.6.&nbsp;Building Metadata via MetadataBuilder</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">MetadataBuilder metadataBuilder = sources.getMetadataBuilder();

// Use the JPA-compliant implicit naming strategy
metadataBuilder.applyImplicitNamingStrategy( ImplicitNamingStrategyJpaCompliantImpl.INSTANCE );

// specify the schema name to use for tables, etc when none is explicitly specified
metadataBuilder.applyImplicitSchemaName( "my_default_schema" );

Metadata metadata = metadataBuilder.build();</pre>
            </div></a></div><a id="d5e281"><br class="example-break">
        </a></div><a id="d5e281">

        </a><div class="section" title="3.1.3.&nbsp;Building the SessionFactory"><a id="d5e281"></a><div class="titlepage"><a id="d5e281"></a><div><a id="d5e281"></a><div><a id="d5e281"></a><h3 class="title"><a id="d5e281"></a><a id="bootstrap-native-sessionfactory">3.1.3.&nbsp;Building the SessionFactory</a></h3></div></div></div><a id="bootstrap-native-sessionfactory">
            
            <p>
                The final step in native bootstrapping is to build the SessionFactory itself.  Much like
                discussed above, if you are ok with the default behavior of building a SessionFactory from a Metadata
                reference, you can simply call Metadata#buildSessionFactory.
            </p>

            <p>
                However, if you would like to adjust that building process you will need to use
                SessionFactoryBuilder as obtained via Metadata#getSessionFactoryBuilder.   Again, see its
                javadocs for full details.
            </p>

            </a><div class="example"><a id="bootstrap-native-sessionfactory"></a><a id="d5e288"><p class="title"><strong>Example&nbsp;3.7.&nbsp;Building SessionFactory via SessionFactoryBuilder</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">SessionFactoryBuilder sessionFactoryBuilder = metadata.getSessionFactoryBuilder();

// Supply an SessionFactory-level Interceptor
sessionFactoryBuilder.applyInterceptor( new MySessionFactoryInterceptor() );

// Add a custom observer
sessionFactoryBuilder.addSessionFactoryObservers( new MySessionFactoryObserver() );

// Apply a CDI BeanManager (for JPA event listeners)
sessionFactoryBuilder.applyBeanManager( getBeanManagerFromSomewhere() );

SessionFactory sessionFactory = sessionFactoryBuilder.build();</pre>
            </div></a></div><a id="d5e288"><br class="example-break">

            <p>
                The bootstrapping API is quite flexible, but in most cases it makes the most sense to think of
                it as a 3 step process:
                </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
                        Build the StandardServiceRegistry
                    </li><li class="listitem">
                        Build the Metadata
                    </li><li class="listitem">
                        Use those 2 things to build the SessionFactory
                    </li></ol></div><p>
            </p>

            </a><div class="example"><a id="d5e288"></a><a id="d5e296"><p class="title"><strong>Example&nbsp;3.8.&nbsp;Native Bootstrapping - Putting it all together</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">StandardServiceRegistry standardRegistry = new StandardServiceRegistryBuilder()
		.configure( "org/hibernate/example/MyCfg.xml" )
		.build();

Metadata metadata = new MetadataSources( standardRegistry )
		.addAnnotatedClass( MyEntity.class )
		.addAnnotatedClassName( "org.hibernate.example.Customer" )
		.addResource( "org/hibernate/example/Order.hbm.xml" )
		.addResource( "org/hibernate/example/Product.orm.xml" )
		.getMetadataBuilder()
		.applyImplicitNamingStrategy( ImplicitNamingStrategyJpaCompliantImpl.INSTANCE )
		.build();

SessionFactory sessionFactory = metadata.getSessionFactoryBuilder()
		.applyBeanManager( getBeanManagerFromSomewhere() )
		.build();</pre>
            </div></a></div><a id="d5e296"><br class="example-break">
        </a></div><a id="d5e296">
    </a></div><a id="d5e296">

    </a><div class="section" title="3.2.&nbsp;JPA Bootstrapping"><a id="d5e296"></a><div class="titlepage"><a id="d5e296"></a><div><a id="d5e296"></a><div><a id="d5e296"></a><h2 class="title"><a id="d5e296"></a><a id="bootstrap-jpa">3.2.&nbsp;JPA Bootstrapping</a></h2></div></div></div><a id="bootstrap-jpa">
        

        <p>
            Bootstrapping Hibernate as a JPA provider can be done in a JPA-spec compliant manner or using a proprietary
            bootstrapping approach.  The standardized approach has some limitations in certain environments, but aside
            from those limitations, it is *highly* recommended that you use JPA-standardized bootstrapping.
        </p>

        

        </a><div class="section" title="3.2.1.&nbsp;JPA-compliant bootstrapping"><a id="bootstrap-jpa"></a><div class="titlepage"><a id="bootstrap-jpa"></a><div><a id="bootstrap-jpa"></a><div><a id="bootstrap-jpa"></a><h3 class="title"><a id="bootstrap-jpa"></a><a id="bootstrap-jpa-compliant">3.2.1.&nbsp;JPA-compliant bootstrapping</a></h3></div></div></div><a id="bootstrap-jpa-compliant">
            

            <p>
                In JPA we are ultimately interested in bootstrapping an javax.persistence.EntityManagerFactory instance.
                The JPA specification defines 2 primary standardized bootstrap approaches depending on how the
                application intends to access the javax.persistence.EntityManager instances from an
                EntityManagerFactory. It uses the terms "EE" and "SE" for these 2 approaches, but those terms are very
                misleading in this context.  What the JPA spec calls EE bootstrapping is cases where a container
                (EE, OSGi, etc) will manage and inject the persistence context on behalf of the application.
                What it calls SE bootstrapping is everything else.  We will use the terms
                container-bootstrapping and application-bootstrapping in this guide.
            </p>

            </a><div class="sidebar"><a id="bootstrap-jpa-compliant"><div class="titlepage">
                <p>
                    If you would like additional details on accessing and using EntityManager instances, sections 7.6
                    and 7.7 of the JPA 2.1 specification cover container-managed and application-managed EntityManagers,
                    respectively.
                </p>
            </div>

            <p>
                For compliant container-bootstrapping, the container will build an EntityManagerFactory for each
                persistent-unit defined in the deployment's META-INF/persistence.xml and make that available to the
                application for injection via the javax.persistence.PersistenceUnit annotation or via JNDI lookup.
            </p>

            </a><div class="example"><a id="bootstrap-jpa-compliant"></a><a id="d5e308"><p class="title"><strong>Example&nbsp;3.9.&nbsp;Injecting a EntityManagerFactory</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">@PersistenceUnit
EntityManagerFactory emf;</pre>
            </div></a></div><a id="d5e308"><br class="example-break">

            <p>
                For compliant application-bootstrapping, rather than the container building the
                EntityManagerFactory for the application, the application builds the EntityManagerFactory itself
                using the javax.persistence.Persistence bootstrap class.  The application creates an entity manager
                factory by calling the createEntityManagerFactory method:
            </p>

            </a><div class="example"><a id="d5e308"></a><a id="d5e312"><p class="title"><strong>Example&nbsp;3.10.&nbsp;Application bootstrapped EntityManagerFactory</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">// Create an EMF for our CRM persistence-unit.
EntityManagerFactory emf = Persistence.createEntityManagerFactory("CRM");</pre>
            </div></a></div><a id="d5e312"><br class="example-break">
        </a></div><a id="d5e312">
        </a><div class="section" title="3.2.2.&nbsp;Proprietary 2-phase bootstrapping"><a id="d5e312"></a><div class="titlepage"><a id="d5e312"></a><div><a id="d5e312"></a><div><a id="d5e312"></a><h3 class="title"><a id="d5e312"></a><a id="bootstrap-jpa-hibernate">3.2.2.&nbsp;Proprietary 2-phase bootstrapping</a></h3></div></div></div><a id="bootstrap-jpa-hibernate">
            
            <p>
                
                todo
            </p>
        </a></div><a id="bootstrap-jpa-hibernate">
    </a></div><a id="bootstrap-jpa-hibernate">
</a></div><a id="bootstrap-jpa-hibernate">
    </a><div class="chapter" title="Chapter&nbsp;4.&nbsp;Persistence Contexts"><a id="bootstrap-jpa-hibernate"></a><div class="titlepage"><a id="bootstrap-jpa-hibernate"></a><div><a id="bootstrap-jpa-hibernate"></a><div><a id="bootstrap-jpa-hibernate"></a><h2 class="title"><a id="bootstrap-jpa-hibernate"></a><a id="pc">Chapter&nbsp;4.&nbsp;Persistence Contexts</a></h2></div></div></div><div class="toc"><p><a id="pc"><strong>Table of Contents</strong></a></p><dl><dt><a id="pc"><span class="section"></span></a><a href="#d5e344">4.1. Making entities persistent</a></dt><dt><span class="section"><a href="#d5e367">4.2. Deleting entities</a></span></dt><dt><span class="section"><a href="#d5e379">4.3. Obtain an entity reference without initializing its data</a></span></dt><dt><span class="section"><a href="#d5e388">4.4. Obtain an entity with its data initialized</a></span></dt><dt><span class="section"><a href="#d5e396">4.5. Obtain an entity by natural-id</a></span></dt><dt><span class="section"><a href="#d5e423">4.6. Refresh entity state</a></span></dt><dt><span class="section"><a href="#d5e434">4.7. Modifying managed/persistent state</a></span></dt><dt><span class="section"><a href="#d5e441">4.8. Working with detached data</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e445">4.8.1. Reattaching detached data</a></span></dt><dt><span class="section"><a href="#d5e465">4.8.2. Merging detached data</a></span></dt></dl></dd><dt><span class="section"><a href="#d5e476">4.9. Checking persistent state</a></span></dt><dt><span class="section"><a href="#d5e493">4.10. Accessing Hibernate APIs from JPA</a></span></dt></dl></div>
    

    <p>
        Both the <code class="interfacename">org.hibernate.Session</code> API and
        <code class="interfacename">javax.persistence.EntityManager</code> API represent a context for dealing with
        persistent data.  This concept is called a <code class="literal">persistence context</code>.  Persistent data has a
        state in relation to both a persistence context and the underlying database.
    </p>

    <div class="itemizedlist" title="Entity states"><p class="title"><strong>Entity states</strong></p><ul class="itemizedlist"><li class="listitem">
            <p>
                <code class="literal">transient</code> - the entity has just been instantiated and is
                not associated with a persistence context.  It has no persistent representation in the database and
                typically no identifier value has been assigned.
            </p>
        </li><li class="listitem">
            <p>
                <code class="literal">managed</code>, or <code class="literal">persistent</code> - the entity has an associated identifier
                and is associated with a persistence context.  It may or may not physically exist in the database
                yet.
            </p>
        </li><li class="listitem">
            <p>
                <code class="literal">detached</code> - the entity has an associated identifier, but is no longer associated with
                a persistence context (usually because the persistence context was closed or the instance was evicted
                from the context)
            </p>
        </li><li class="listitem">
            <p>
                <code class="literal">removed</code> - the entity has an associated identifier and is associated with a persistence
                context, however it is scheduled for removal from the database.
            </p>
        </li></ul></div>

    <p>
        Much of the <code class="interfacename">org.hibernate.Session</code> and
        <code class="interfacename">javax.persistence.EntityManager</code> methods deal with moving entities between these
        states.
    </p>


    <div class="section" title="4.1.&nbsp;Making entities persistent"><div class="titlepage"><div><div><h2 class="title"><a id="d5e344">4.1.&nbsp;Making entities persistent</a></h2></div></div></div><a id="d5e344">
        

        <p>
            Once you've created a new entity instance (using the standard <code class="literal">new</code> operator) it is in
            <code class="literal">new</code> state.   You can make it persistent by associating it to either a
            <code class="interfacename">org.hibernate.Session</code> or
            <code class="interfacename">javax.persistence.EntityManager</code>
        </p>

        </a><div class="example"><a id="d5e344"></a><a id="d5e351"><p class="title"><strong>Example&nbsp;4.1.&nbsp;Example of making an entity persistent</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">// Using the Hibernate Session
DomesticCat fritz = new DomesticCat();
fritz.setColor( Color.GINGER );
fritz.setSex( 'M' );
fritz.setName( "Fritz" );
session.save( fritz );</pre>
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">// Using the JPA EntityManager
DomesticCat fritz = new DomesticCat();
fritz.setColor( Color.GINGER );
fritz.setSex( 'M' );
fritz.setName( "Fritz" );
entityManager.persist( fritz );</pre>
        </div></a></div><a id="d5e351"><br class="example-break">

        <p>
            <code class="interfacename">org.hibernate.Session</code> also has a method named <code class="methodname">persist</code>
            which follows the exact semantic defined in the JPA specification for the <code class="methodname">persist</code>
            method.  It is this method on <code class="interfacename">org.hibernate.Session</code> to which the
            Hibernate <code class="interfacename">javax.persistence.EntityManager</code> implementation delegates.
        </p>

        <p>
            If the <code class="classname">DomesticCat</code> entity type has a generated identifier, the value is associated
            to the instance when the <code class="methodname">save</code> or <code class="methodname">persist</code> is called.  If the
            identifier is not automatically generated, the application-assigned (usually natural) key value has to be
            set on the instance before <code class="methodname">save</code> or <code class="methodname">persist</code> is called.
        </p>
    </a></div><a id="d5e351">

    </a><div class="section" title="4.2.&nbsp;Deleting entities"><a id="d5e351"></a><div class="titlepage"><a id="d5e351"></a><div><a id="d5e351"></a><div><a id="d5e351"></a><h2 class="title"><a id="d5e351"></a><a id="d5e367">4.2.&nbsp;Deleting entities</a></h2></div></div></div><a id="d5e367">
        
        <p>
            Entities can also be deleted.
        </p>
        </a><div class="example"><a id="d5e367"></a><a id="d5e370"><p class="title"><strong>Example&nbsp;4.2.&nbsp;Example of deleting an entity</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">session.delete( fritz );</pre>
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">entityManager.remove( fritz );</pre>
        </div></a></div><a id="d5e370"><br class="example-break">
        <p>
            It is important to note that Hibernate itself can handle deleting detached state.  JPA, however, disallows
            it.  The implication here is that the entity instance passed to the
            <code class="interfacename">org.hibernate.Session</code> <code class="methodname">delete</code> method can be either
            in managed or detached state, while the entity instance passed to <code class="methodname">remove</code> on
            <code class="interfacename">javax.persistence.EntityManager</code> must be in managed state.
        </p>
    </a></div><a id="d5e370">

    </a><div class="section" title="4.3.&nbsp;Obtain an entity reference without initializing its data"><a id="d5e370"></a><div class="titlepage"><a id="d5e370"></a><div><a id="d5e370"></a><div><a id="d5e370"></a><h2 class="title"><a id="d5e370"></a><a id="d5e379">4.3.&nbsp;Obtain an entity reference without initializing its data</a></h2></div></div></div><a id="d5e379">
        
        <p>
            Sometimes referred to as lazy loading, the ability to obtain a reference to an entity without having to
            load its data is hugely important.  The most common case being the need to create an association between
            an entity and another, existing entity.
        </p>
        </a><div class="example"><a id="d5e379"></a><a id="d5e382"><p class="title"><strong>Example&nbsp;4.3.&nbsp;Example of obtaining an entity reference without initializing its data</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Book book = new Book();
book.setAuthor( session.byId( Author.class ).getReference( authorId ) );</pre>
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Book book = new Book();
book.setAuthor( entityManager.getReference( Author.class, authorId ) );</pre>
        </div></a></div><a id="d5e382"><br class="example-break">
        </a><p><a id="d5e382">
            The above works on the assumption that the entity is defined to allow lazy loading, generally through
            use of runtime proxies.  For more information see </a><a class="xref" href="#">???</a>.  In both
            cases an exception will be thrown later if the given entity does not refer to actual database state if and
            when the application attempts to use the returned proxy in any way that requires access to its data.
        </p>
    </div>

    <div class="section" title="4.4.&nbsp;Obtain an entity with its data initialized"><div class="titlepage"><div><div><h2 class="title"><a id="d5e388">4.4.&nbsp;Obtain an entity with its data initialized</a></h2></div></div></div><a id="d5e388">
        

        <p>
            It is also quite common to want to obtain an entity along with with its data, for display for example.
        </p>
        </a><div class="example"><a id="d5e388"></a><a id="d5e391"><p class="title"><strong>Example&nbsp;4.4.&nbsp;Example of obtaining an entity reference with its data initialized</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">session.byId( Author.class ).load( authorId );</pre>
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">entityManager.find( Author.class, authorId );</pre>
        </div></a></div><a id="d5e391"><br class="example-break">
        <p>
            In both cases null is returned if no matching database row was found.
        </p>
    </a></div><a id="d5e391">

    </a><div class="section" title="4.5.&nbsp;Obtain an entity by natural-id"><a id="d5e391"></a><div class="titlepage"><a id="d5e391"></a><div><a id="d5e391"></a><div><a id="d5e391"></a><h2 class="title"><a id="d5e391"></a><a id="d5e396">4.5.&nbsp;Obtain an entity by natural-id</a></h2></div></div></div><a id="d5e396">
        

        <p>
            In addition to allowing to load by identifier, Hibernate allows applications to load by declared
            natural identifier.
        </p>
        </a><div class="example"><a id="d5e396"></a><a id="d5e399"><p class="title"><strong>Example&nbsp;4.5.&nbsp;Example of simple natural-id access</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">@Entity
public class User {
	@Id
	@GeneratedValue
	Long id;

	@NaturalId
	String userName;

	...
}

// use getReference() to create associations...
Resource aResource = (Resource) session.byId( Resource.class ).getReference( 123 );
User aUser = (User) session.bySimpleNaturalId( User.class ).getReference( "steve" );
aResource.assignTo( user );


// use load() to pull initialzed data
return session.bySimpleNaturalId( User.class ).load( "steve" );</pre>
        </div></a></div><a id="d5e399"><br class="example-break">
        </a><div class="example"><a id="d5e399"></a><a id="d5e402"><p class="title"><strong>Example&nbsp;4.6.&nbsp;Example of natural-id access</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">import java.lang.String;

@Entity
public class User {
	@Id
	@GeneratedValue
	Long id;

	@NaturalId
	String system;

	@NaturalId
	String userName;

	...
}

// use getReference() to create associations...
Resource aResource = (Resource) session.byId( Resource.class ).getReference( 123 );
User aUser = (User) session.byNaturalId( User.class )
		.using( "system", "prod" )
		.using( "userName", "steve" )
		.getReference();
aResource.assignTo( user );


// use load() to pull initialzed data
return session.byNaturalId( User.class )
		.using( "system", "prod" )
		.using( "userName", "steve" )
		.load();</pre>
        </div></a></div><a id="d5e402"><br class="example-break">
        <p>
            Just like we saw above, access entity data by natural id allows both the <code class="methodname">load</code>
            and <code class="methodname">getReference</code> forms, with the same semantics.
        </p>

        <p>
            Accessing persistent data by identifier and by natural-id is consistent in the Hibernate API.  Each defines
            the same 2 data access methods:
        </p>
        <div class="variablelist"><dl><dt><span class="term"><code class="methodname">getReference</code></span></dt><dd>
                    <p>
                        Should be used in cases where the identifier is assumed to exist, where non-existence would be
                        an actual error.  Should never be used to test existence.  That is because this method will
                        prefer to create and return a proxy if the data is not already associated with the Session
                        rather than hit the database.  The quintessential use-case for using this method is to create
                        foreign-key based associations.
                    </p>
                </dd><dt><span class="term"><code class="methodname">load</code></span></dt><dd>
                    <p>
                        Will return the persistent data associated with the given identifier value or null if that
                        identifier does not exist.
                    </p>
                </dd></dl></div>
        <p>
            In addition to those 2 methods, each also defines the method <code class="methodname">with</code> accepting
            a <code class="interfacename">org.hibernate.LockOptions</code> argument.  Locking is discussed in a separate
            chapter.
        </p>
    </a></div><a id="d5e402">

    </a><div class="section" title="4.6.&nbsp;Refresh entity state"><a id="d5e402"></a><div class="titlepage"><a id="d5e402"></a><div><a id="d5e402"></a><div><a id="d5e402"></a><h2 class="title"><a id="d5e402"></a><a id="d5e423">4.6.&nbsp;Refresh entity state</a></h2></div></div></div><a id="d5e423">
        

        <p>
            You can reload an entity instance and it's collections at any time.
        </p>

        </a><div class="example"><a id="d5e423"></a><a id="d5e426"><p class="title"><strong>Example&nbsp;4.7.&nbsp;Example of refreshing entity state</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Cat cat = session.get( Cat.class, catId );
...
session.refresh( cat );</pre>
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Cat cat = entityManager.find( Cat.class, catId );
...
entityManager.refresh( cat );</pre>
        </div></a></div><a id="d5e426"><br class="example-break">

        <p>
            One case where this is useful is when it is known that the database state has changed since the data was
            read.  Refreshing allows the current database state to be pulled into the entity instance and the
            persistence context.
        </p>

        <p>
            Another case where this might be useful is when database triggers are used to initialize some of the
            properties of the entity.  Note that only the entity instance and its collections are refreshed unless you
            specify <code class="literal">REFRESH</code> as a cascade style of any associations.  However, please note that
            Hibernate has the capability to handle this automatically through its notion of generated properties.
            See the discussion of non-identifier generated attributes in the
            <em class="citetitle">Hibernate User Guide</em>
        </p>
    </a></div><a id="d5e426">

    </a><div class="section" title="4.7.&nbsp;Modifying managed/persistent state"><a id="d5e426"></a><div class="titlepage"><a id="d5e426"></a><div><a id="d5e426"></a><div><a id="d5e426"></a><h2 class="title"><a id="d5e426"></a><a id="d5e434">4.7.&nbsp;Modifying managed/persistent state</a></h2></div></div></div><a id="d5e434">
        

        <p>
            Entities in managed/persistent state may be manipulated by the application and any changes will be
            automatically detected and persisted when the persistence context is flushed. There is no need to call a
            particular method to make your modifications persistent.
        </p>

        </a><div class="example"><a id="d5e434"></a><a id="d5e437"><p class="title"><strong>Example&nbsp;4.8.&nbsp;Example of modifying managed state</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Cat cat = session.get( Cat.class, catId );
cat.setName( "Garfield" );
session.flush(); // generally this is not explicitly needed</pre>
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Cat cat = entityManager.find( Cat.class, catId );
cat.setName( "Garfield" );
entityManager.flush(); // generally this is not explicitly needed</pre>
        </div></a></div><a id="d5e437"><br class="example-break">
    </a></div><a id="d5e437">

    </a><div class="section" title="4.8.&nbsp;Working with detached data"><a id="d5e437"></a><div class="titlepage"><a id="d5e437"></a><div><a id="d5e437"></a><div><a id="d5e437"></a><h2 class="title"><a id="d5e437"></a><a id="d5e441">4.8.&nbsp;Working with detached data</a></h2></div></div></div><a id="d5e441">
        

        <p>
            Detachment is the process of working with data outside the scope of any persistence context.  Data becomes
            detached in a number of ways.  Once the persistence context is closed, all data that was associated with it
            becomes detached.  Clearing the persistence context has the same effect.  Evicting a particular entity
            from the persistence context makes it detached.  And finally, serialization will make the deserialized form
            be detached (the original instance is still managed).
        </p>

        <p>
            Detached data can still be manipulated, however the persistence context will no longer automatically know
            about these modification and the application will need to intervene to make the changes persistent.
        </p>

        </a><div class="section" title="4.8.1.&nbsp;Reattaching detached data"><a id="d5e441"></a><div class="titlepage"><a id="d5e441"></a><div><a id="d5e441"></a><div><a id="d5e441"></a><h3 class="title"><a id="d5e441"></a><a id="d5e445">4.8.1.&nbsp;Reattaching detached data</a></h3></div></div></div><a id="d5e445">
            
            <p>
                Reattachment is the process of taking an incoming entity instance that is in detached state
                and re-associating it with the current persistence context.
            </p>
            <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Important</h2>
                <p>
                    JPA does not provide for this model.  This is only available through Hibernate
                    <code class="interfacename">org.hibernate.Session</code>.
                </p>
            </div>
            </a><div class="example"><a id="d5e445"></a><a id="d5e451"><p class="title"><strong>Example&nbsp;4.9.&nbsp;Example of reattaching a detached entity</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">session.lock( someDetachedCat, LockMode.NONE );</pre>
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">session.saveOrUpdate( someDetachedCat );</pre>
            </div></a></div><a id="d5e451"><br class="example-break">
            <p>
                The method name <code class="methodname">update</code> is a bit misleading here.  It does not mean that an
                <code class="literal">SQL</code> <code class="literal">UPDATE</code> is immediately performed.  It does, however, mean that
                an <code class="literal">SQL</code> <code class="literal">UPDATE</code> will be performed when the persistence context is
                flushed since Hibernate does not know its previous state against which to compare for changes.  Unless
                the entity is mapped with <code class="literal">select-before-update</code>, in which case Hibernate will
                pull the current state from the database and see if an update is needed.
            </p>
            <p>
                Provided the entity is detached, <code class="methodname">update</code> and <code class="methodname">saveOrUpdate</code>
                operate exactly the same.
            </p>
        </a></div><a id="d5e451">

        </a><div class="section" title="4.8.2.&nbsp;Merging detached data"><a id="d5e451"></a><div class="titlepage"><a id="d5e451"></a><div><a id="d5e451"></a><div><a id="d5e451"></a><h3 class="title"><a id="d5e451"></a><a id="d5e465">4.8.2.&nbsp;Merging detached data</a></h3></div></div></div><a id="d5e465">
            
            <p>
                Merging is the process of taking an incoming entity instance that is in detached state and copying its
                data over onto a new instance that is in managed state.
            </p>
            </a><div class="example"><a id="d5e465"></a><a id="d5e468"><p class="title"><strong>Example&nbsp;4.10.&nbsp;Visualizing merge</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Object detached = ...;
Object managed = entityManager.find( detached.getClass(), detached.getId() );
managed.setXyz( detached.getXyz() );
...
return managed;</pre>
            </div></a></div><a id="d5e468"><br class="example-break">
            <p>
                That is not exactly what happens, but its a good visualization.
            </p>
            </a><div class="example"><a id="d5e468"></a><a id="d5e472"><p class="title"><strong>Example&nbsp;4.11.&nbsp;Example of merging a detached entity</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Cat theManagedInstance = session.merge( someDetachedCat );</pre>
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Cat theManagedInstance = entityManager.merge( someDetachedCat );</pre>
            </div></a></div><a id="d5e472"><br class="example-break">
        </a></div><a id="d5e472">

    </a></div><a id="d5e472">


    </a><div class="section" title="4.9.&nbsp;Checking persistent state"><a id="d5e472"></a><div class="titlepage"><a id="d5e472"></a><div><a id="d5e472"></a><div><a id="d5e472"></a><h2 class="title"><a id="d5e472"></a><a id="d5e476">4.9.&nbsp;Checking persistent state</a></h2></div></div></div><a id="d5e476">
        

        <p>
            An application can verify the state of entities and collections in relation to the persistence context.
        </p>
        </a><div class="example"><a id="d5e476"></a><a id="d5e479"><p class="title"><strong>Example&nbsp;4.12.&nbsp;Examples of verifying managed state</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">assert session.contains( cat );</pre>
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">assert entityManager.contains( cat );</pre>
        </div></a></div><a id="d5e479"><br class="example-break">
        </a><div class="example"><a id="d5e479"></a><a id="d5e483"><p class="title"><strong>Example&nbsp;4.13.&nbsp;Examples of verifying laziness</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">if ( Hibernate.isInitialized( customer.getAddress() ) {
    //display address if loaded
}
if ( Hibernate.isInitialized( customer.getOrders()) ) ) {
    //display orders if loaded
}
if (Hibernate.isPropertyInitialized( customer, "detailedBio" ) ) {
    //display property detailedBio if loaded
}</pre>
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">javax.persistence.PersistenceUnitUtil jpaUtil = entityManager.getEntityManagerFactory().getPersistenceUnitUtil();
if ( jpaUtil.isLoaded( customer.getAddress() ) {
    //display address if loaded
}
if ( jpaUtil.isLoaded( customer.getOrders()) ) ) {
    //display orders if loaded
}
if (jpaUtil.isLoaded( customer, "detailedBio" ) ) {
    //display property detailedBio if loaded
}</pre>
        </div></a></div><a id="d5e483"><br class="example-break">
        <p>
            In JPA there is an alternative means to check laziness using the following
            <code class="interfacename">javax.persistence.PersistenceUtil</code> pattern.  However, the
            <code class="interfacename">javax.persistence.PersistenceUnitUtil</code> is recommended where ever possible
        </p>
        </a><div class="example"><a id="d5e483"></a><a id="d5e490"><p class="title"><strong>Example&nbsp;4.14.&nbsp;Alternative JPA means to verify laziness</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">javax.persistence.PersistenceUtil jpaUtil = javax.persistence.Persistence.getPersistenceUtil();
if ( jpaUtil.isLoaded( customer.getAddress() ) {
    //display address if loaded
}
if ( jpaUtil.isLoaded( customer.getOrders()) ) ) {
    //display orders if loaded
}
if (jpaUtil.isLoaded(customer, "detailedBio") ) {
    //display property detailedBio if loaded
}</pre>
        </div></a></div><a id="d5e490"><br class="example-break">

    </a></div><a id="d5e490">

    </a><div class="section" title="4.10.&nbsp;Accessing Hibernate APIs from JPA"><a id="d5e490"></a><div class="titlepage"><a id="d5e490"></a><div><a id="d5e490"></a><div><a id="d5e490"></a><h2 class="title"><a id="d5e490"></a><a id="d5e493">4.10.&nbsp;Accessing Hibernate APIs from JPA</a></h2></div></div></div><a id="d5e493">
        
        <p>
            JPA defines an incredibly useful method to allow applications access to the APIs of the underlying provider.
        </p>
        </a><div class="example"><a id="d5e493"></a><a id="d5e496"><p class="title"><strong>Example&nbsp;4.15.&nbsp;Usage of EntityManager.unwrap</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Session session = entityManager.unwrap( Session.class );
SessionImplementor sessionImplementor = entityManager.unwrap( SessionImplementor.class );</pre>
        </div></a></div><a id="d5e496"><br class="example-break">
    </a></div><a id="d5e496">

    

</a></div><a id="d5e496">
    </a><div class="chapter" title="Chapter&nbsp;5.&nbsp;Database access"><a id="d5e496"></a><div class="titlepage"><a id="d5e496"></a><div><a id="d5e496"></a><div><a id="d5e496"></a><h2 class="title"><a id="d5e496"></a><a id="database">Chapter&nbsp;5.&nbsp;Database access</a></h2></div></div></div><div class="toc"><p><a id="database"><strong>Table of Contents</strong></a></p><dl><dt><a id="database"><span class="section"></span></a><a href="#database-connectionprovider">5.1. ConnectionProvider</a></dt><dd><dl><dt><span class="section"><a href="#database-connectionprovider-datasource">5.1.1. Using DataSources</a></span></dt><dt><span class="section"><a href="#database-connectionprovider-c3p0">5.1.2. Using c3p0</a></span></dt><dt><span class="section"><a href="#database-connectionprovider-proxool">5.1.3. Using Proxool</a></span></dt><dt><span class="section"><a href="#database-connectionprovider-hikari">5.1.4. Using Hikari</a></span></dt><dt><span class="section"><a href="#database-connectionprovider-drivermanager">5.1.5. Using Hibernate's built-in (and unsupported) pooling</a></span></dt><dt><span class="section"><a href="#database-connectionprovider-provided">5.1.6. User-provided Connections</a></span></dt><dt><span class="section"><a href="#database-connectionprovider-isolation">5.1.7. ConnectionProvider support for transaction isolation setting</a></span></dt></dl></dd><dt><span class="section"><a href="#database-dialect">5.2. Database Dialect</a></span></dt></dl></div>

    


    <div class="section" title="5.1.&nbsp;ConnectionProvider"><div class="titlepage"><div><div><h2 class="title"><a id="database-connectionprovider">5.1.&nbsp;ConnectionProvider</a></h2></div></div></div><a id="database-connectionprovider">
        

        <p>
            As an ORM tool, probably the single most important thing you need to tell Hibernate is how to connect to
            your database so that it may connect on behalf of your application.  This is ultimately the function of
            the <code class="interfacename">org.hibernate.engine.jdbc.connections.spi.ConnectionProvider</code>
            interface.  Hibernate provides some out of the box implementations of this interface.  ConnectionProvider
            is also an extension point, so you can also use custom implementations from third parties or written yourself.
            The ConnectionProvider to use is defined by the <code class="literal">hibernate.connection.provider_class</code> setting.
            See the <code class="interfacename">org.hibernate.cfg.AvailableSettings#CONNECTION_PROVIDER</code>
        </p>

        <p>
            Generally speaking applications should not have to configure a ConnectionProvider explicitly if using
            one of the Hibernate-provided implementations.  Hibernate will internally determine which ConnectionProvider
            to use based on the following algorithm:
            </p></a><div class="orderedlist"><a id="database-connectionprovider"></a><ol class="orderedlist" compact="compact" type="1"><a id="database-connectionprovider"><li class="listitem">
                    <p>
                        If <code class="literal">hibernate.connection.provider_class</code> is set, it takes precedence
                    </p>
                </li></a><li class="listitem"><a id="database-connectionprovider">
                    </a><p><a id="database-connectionprovider">
                        else if <code class="literal">hibernate.connection.datasource</code> is set -&gt; </a><a class="xref" href="#database-connectionprovider-datasource" title="5.1.1.&nbsp;Using DataSources">Section&nbsp;5.1.1, “Using DataSources”</a>
                    </p>
                </li><li class="listitem">
                    <p>
                        else if any setting prefixed by <code class="literal">hibernate.c3p0.</code> is set -&gt; <a class="xref" href="#database-connectionprovider-c3p0" title="5.1.2.&nbsp;Using c3p0">Section&nbsp;5.1.2, “Using c3p0”</a>
                    </p>
                </li><li class="listitem">
                    <p>
                        else if any setting prefixed by <code class="literal">hibernate.proxool.</code> is set -&gt; <a class="xref" href="#database-connectionprovider-proxool" title="5.1.3.&nbsp;Using Proxool">Section&nbsp;5.1.3, “Using Proxool”</a>
                    </p>
                </li><li class="listitem">
                    <p>
                        else if any setting prefixed by <code class="literal">hibernate.hikari.</code> is set -&gt; <a class="xref" href="#database-connectionprovider-hikari" title="5.1.4.&nbsp;Using Hikari">Section&nbsp;5.1.4, “Using Hikari”</a>
                    </p>
                </li><li class="listitem">
                    <p>
                        else if <code class="literal">hibernate.connection.url</code> is set -&gt; <a class="xref" href="#database-connectionprovider-drivermanager" title="5.1.5.&nbsp;Using Hibernate's built-in (and unsupported) pooling">Section&nbsp;5.1.5, “Using Hibernate's built-in (and unsupported) pooling”</a>
                    </p>
                </li><li class="listitem">
                    <p>
                        else -&gt; <a class="xref" href="#database-connectionprovider-provided" title="5.1.6.&nbsp;User-provided Connections">Section&nbsp;5.1.6, “User-provided Connections”</a>
                    </p>
                </li></ol></div><p>
        </p>


        <div class="section" title="5.1.1.&nbsp;Using DataSources"><div class="titlepage"><div><div><h3 class="title"><a id="database-connectionprovider-datasource">5.1.1.&nbsp;Using DataSources</a></h3></div></div></div><a id="database-connectionprovider-datasource">
            

            </a><p><a id="database-connectionprovider-datasource">
                Hibernate can integrate with a <code class="interfacename">javax.sql.DataSource</code> for obtaining
                JDBC Connections.  Applications would tell Hibernate about the DataSource via the (required)
                <code class="literal">hibernate.connection.datasource</code> setting which can either specify a JNDI name
                or would reference the actual DataSource instance.  For cases where a JNDI name is given, be sure
                to read </a><a class="xref" href="#jndi" title="Chapter&nbsp;7.&nbsp;JNDI">Chapter&nbsp;7, <em>JNDI</em></a>
            </p>

            <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2>
                <p>
                    For JPA applications, note that <code class="literal">hibernate.connection.datasource</code> corresponds to
                    either <code class="literal">javax.persistence.jtaDataSource</code> or <code class="literal">javax.persistence.nonJtaDataSource</code>.
                </p>
            </div>

            <p>
                The DataSource ConnectionProvider also (optionally) accepts the <code class="literal">hibernate.connection.username</code>
                and <code class="literal">hibernate.connection.password</code>.  If specified, the form of DataSource#getConnection
                accepting username and password will be used.  Otherwise the no-arg form is used.
            </p>
        </div>

        <div class="section" title="5.1.2.&nbsp;Using c3p0"><div class="titlepage"><div><div><h3 class="title"><a id="database-connectionprovider-c3p0">5.1.2.&nbsp;Using c3p0</a></h3></div></div></div><a id="database-connectionprovider-c3p0">
            

            <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Important</h2>
                <p>
                    To use this integration, the application must include the hibernate-c3p0
                    module jar (as well as its dependencies) on the classpath.
                </p>
            </div>

            </a><p><a id="database-connectionprovider-c3p0">
                Hibernate also provides support for applications to use </a><a class="ulink" href="http://www.mchange.com/projects/c3p0/">c3p0</a>
                connection pooling.  When using this c3p0 support, a number of additional configuration settings
                are recognized.
            </p>

            <p>
                Transaction isolation of the Connections is managed by the ConnectionProvider itself.  See
                <a class="xref" href="#database-connectionprovider-isolation" title="5.1.7.&nbsp;ConnectionProvider support for transaction isolation setting">Section&nbsp;5.1.7, “ConnectionProvider support for transaction isolation setting”</a>.
            </p>

            <div class="variablelist" title="Additional settings"><p class="title"><strong>Additional settings</strong></p><dl><dt><span class="term"><code class="literal">hibernate.connection.driver_class</code></span></dt><dd>
                        <p>
                            The name of the JDBC Driver class to use
                        </p>
                    </dd><dt><span class="term"><code class="literal">hibernate.connection.url</code></span></dt><dd>
                        <p>
                            The JDBC connection url.
                        </p>
                    </dd><dt><span class="term">Any settings prefixed with <code class="literal">hibernate.connection.</code> (other than the "special ones")</span></dt><dd>
                        <p>
                            These all have the <code class="literal">hibernate.connection.</code> prefix stripped and the
                            rest will be passed as JDBC connection properties
                        </p>
                    </dd><dt><span class="term"><code class="literal">hibernate.c3p0.min_size</code> or <code class="literal">c3p0.minPoolSize</code></span></dt><dd>
                        <p>
                            The minimum size of the c3p0 pool.  See <a class="ulink" href="http://www.mchange.com/projects/c3p0/#minPoolSize">http://www.mchange.com/projects/c3p0/#minPoolSize</a>
                        </p>
                    </dd><dt><span class="term"><code class="literal">hibernate.c3p0.max_size</code> or <code class="literal">c3p0.maxPoolSize</code></span></dt><dd>
                        <p>
                            The maximum size of the c3p0 pool.  See <a class="ulink" href="http://www.mchange.com/projects/c3p0/#maxPoolSize">http://www.mchange.com/projects/c3p0/#maxPoolSize</a>
                        </p>
                    </dd><dt><span class="term"><code class="literal">hibernate.c3p0.timeout</code> or <code class="literal">c3p0.maxIdleTime</code></span></dt><dd>
                        <p>
                            The Connection idle time.  See <a class="ulink" href="http://www.mchange.com/projects/c3p0/#maxIdleTime">http://www.mchange.com/projects/c3p0/#maxIdleTime</a>
                        </p>
                    </dd><dt><span class="term"><code class="literal">hibernate.c3p0.max_statements</code> or <code class="literal">c3p0.maxStatements</code></span></dt><dd>
                        <p>
                            Controls the c3p0 PreparedStatement cache size (if using).  See <a class="ulink" href="http://www.mchange.com/projects/c3p0/#maxStatements">http://www.mchange.com/projects/c3p0/#maxStatements</a>
                        </p>
                    </dd><dt><span class="term"><code class="literal">hibernate.c3p0.acquire_increment</code> or <code class="literal">c3p0.acquireIncrement</code></span></dt><dd>
                        <p>
                            Number of connections c3p0 should acquire at a time when pool is exhauted.  See <a class="ulink" href="http://www.mchange.com/projects/c3p0/#acquireIncrement">http://www.mchange.com/projects/c3p0/#acquireIncrement</a>
                        </p>
                    </dd><dt><span class="term"><code class="literal">hibernate.c3p0.idle_test_period</code> or <code class="literal">c3p0.idleConnectionTestPeriod</code></span></dt><dd>
                        <p>
                            Idle time before a c3p0 pooled connection is validated.  See <a class="ulink" href="http://www.mchange.com/projects/c3p0/#idleConnectionTestPeriod">http://www.mchange.com/projects/c3p0/#idleConnectionTestPeriod</a>
                        </p>
                    </dd><dt><span class="term"><code class="literal">c3p0.initialPoolSize</code></span></dt><dd>
                        <p>
                            The initial c3p0 pool size.  If not specified, default is to use the min pool size.
                            See <a class="ulink" href="http://www.mchange.com/projects/c3p0/#initialPoolSize">http://www.mchange.com/projects/c3p0/#initialPoolSize</a>
                        </p>
                    </dd><dt><span class="term">Any other settings prefixed with <code class="literal">hibernate.c3p0.</code></span></dt><dd>
                        <p>
                            Will have the <code class="literal">hibernate.</code> portion stripped and be passed to c3p0.
                        </p>
                    </dd><dt><span class="term">Any other settings prefixed with <code class="literal">c3p0.</code></span></dt><dd>
                        <p>
                            Get passed to c3p0 as is.  See <a class="ulink" href="http://www.mchange.com/projects/c3p0/#configuration">http://www.mchange.com/projects/c3p0/#configuration</a>
                        </p>
                    </dd></dl></div>
        </div>

        <div class="section" title="5.1.3.&nbsp;Using Proxool"><div class="titlepage"><div><div><h3 class="title"><a id="database-connectionprovider-proxool">5.1.3.&nbsp;Using Proxool</a></h3></div></div></div><a id="database-connectionprovider-proxool">
            

            <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Important</h2>
                <p>
                    To use this integration, the application must include the hibernate-proxool
                    module jar (as well as its dependencies) on the classpath.
                </p>
            </div>

            </a><p><a id="database-connectionprovider-proxool">
                Hibernate also provides support for applications to use </a><a class="ulink" href="http://proxool.sourceforge.net/">Proxool</a>
                connection pooling.
            </p>

            <p>
                Transaction isolation of the Connections is managed by the ConnectionProvider itself.  See
                <a class="xref" href="#database-connectionprovider-isolation" title="5.1.7.&nbsp;ConnectionProvider support for transaction isolation setting">Section&nbsp;5.1.7, “ConnectionProvider support for transaction isolation setting”</a>.
            </p>

            <div class="section" title="5.1.3.1.&nbsp;Using existing Proxool pools"><div class="titlepage"><div><div><h4 class="title"><a id="database-connectionprovider-proxool-existing">5.1.3.1.&nbsp;Using existing Proxool pools</a></h4></div></div></div><a id="database-connectionprovider-proxool-existing">
                

                <p>
                    Controlled by the <code class="literal">hibernate.proxool.existing_pool</code> setting.  If set to true,
                    this ConnectionProvider will use an already existing Proxool pool by alias as indicated by
                    the <code class="literal">hibernate.proxool.pool_alias</code> setting
                </p>
            </a></div><a id="database-connectionprovider-proxool-existing">

            </a><div class="section" title="5.1.3.2.&nbsp;Configuring Proxool via XML"><a id="database-connectionprovider-proxool-existing"></a><div class="titlepage"><a id="database-connectionprovider-proxool-existing"></a><div><a id="database-connectionprovider-proxool-existing"></a><div><a id="database-connectionprovider-proxool-existing"></a><h4 class="title"><a id="database-connectionprovider-proxool-existing"></a><a id="database-connectionprovider-proxool-jaxp">5.1.3.2.&nbsp;Configuring Proxool via XML</a></h4></div></div></div><a id="database-connectionprovider-proxool-jaxp">
                

                </a><p><a id="database-connectionprovider-proxool-jaxp">
                    The <code class="literal">hibernate.proxool.xml</code> setting names a Proxool configuration XML
                    file to be loaded as a classpath resource and loaded by Proxool's JAXPConfigurator.
                    See </a><a class="ulink" href="http://proxool.sourceforge.net/configure.html">http://proxool.sourceforge.net/configure.html</a>.
                    <code class="literal">hibernate.proxool.pool_alias</code> must be set to indicate which pool to use.
                </p>
            </div>

            <div class="section" title="5.1.3.3.&nbsp;Configuring Proxool via Properties"><div class="titlepage"><div><div><h4 class="title"><a id="database-connectionprovider-proxool-properties">5.1.3.3.&nbsp;Configuring Proxool via Properties</a></h4></div></div></div><a id="database-connectionprovider-proxool-properties">
                

                </a><p><a id="database-connectionprovider-proxool-properties">
                    The <code class="literal">hibernate.proxool.properties</code> setting names a Proxool configuration Properties
                    file to be loaded as a classpath resource and loaded by Proxool's PropertyConfigurator.
                    See </a><a class="ulink" href="http://proxool.sourceforge.net/configure.html">http://proxool.sourceforge.net/configure.html</a>.
                    <code class="literal">hibernate.proxool.pool_alias</code> must be set to indicate which pool to use.
                </p>
            </div>
        </div>

        <div class="section" title="5.1.4.&nbsp;Using Hikari"><div class="titlepage"><div><div><h3 class="title"><a id="database-connectionprovider-hikari">5.1.4.&nbsp;Using Hikari</a></h3></div></div></div><a id="database-connectionprovider-hikari">
            

            <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Important</h2>
                <p>
                    To use this integration, the application must include the hibernate-hikari
                    module jar (as well as its dependencies) on the classpath.
                </p>
            </div>

            </a><p><a id="database-connectionprovider-hikari">
                Hibernate also provides support for applications to use
                </a><a class="ulink" href="http://brettwooldridge.github.io/HikariCP/">Hikari</a> connection pool.
            </p>

            <p>
                Set all of your Hikari settings in Hibernate prefixed by <code class="literal">hibernate.hikari.</code>
                and this ConnectionProvider will pick them up and pass them along to Hikari.  Additionally, this
                ConnectionProvider will pick up the following Hibernate-specific properties and map
                them to the corresponding Hikari ones (any <code class="literal">hibernate.hikari.</code> prefixed ones have precedence):
            </p>

            <div class="variablelist" title="Hibernate-specific properties recognized by Hikari ConnectionProvider"><p class="title"><strong>Hibernate-specific properties recognized by Hikari ConnectionProvider</strong></p><dl><dt><span class="term"><code class="literal">hibernate.connection.driver_class</code></span></dt><dd>
                        <p>Mapped to Hikari's <code class="literal">driverClassName</code> setting</p>
                    </dd><dt><span class="term"><code class="literal">hibernate.connection.url</code></span></dt><dd>
                        <p>Mapped to Hikari's <code class="literal">jdbcUrl</code> setting</p>
                    </dd><dt><span class="term"><code class="literal">hibernate.connection.username</code></span></dt><dd>
                        <p>Mapped to Hikari's <code class="literal">username</code> setting</p>
                    </dd><dt><span class="term"><code class="literal">hibernate.connection.password</code></span></dt><dd>
                        <p>Mapped to Hikari's <code class="literal">password</code> setting</p>
                    </dd><dt><span class="term"><code class="literal">hibernate.connection.isolation</code></span></dt><dd>
                        <p>
                            Mapped to Hikari's <code class="literal">transactionIsolation</code> setting.  See
                            <a class="xref" href="#database-connectionprovider-isolation" title="5.1.7.&nbsp;ConnectionProvider support for transaction isolation setting">Section&nbsp;5.1.7, “ConnectionProvider support for transaction isolation setting”</a>.  Note that
                            Hikari only supports JDBC standard isolation levels (apparently).
                        </p>
                    </dd><dt><span class="term"><code class="literal">hibernate.connection.autocommit</code></span></dt><dd>
                        <p>Mapped to Hikari's <code class="literal">autoCommit</code> setting</p>
                    </dd></dl></div>
        </div>

        <div class="section" title="5.1.5.&nbsp;Using Hibernate's built-in (and unsupported) pooling"><div class="titlepage"><div><div><h3 class="title"><a id="database-connectionprovider-drivermanager">5.1.5.&nbsp;Using Hibernate's built-in (and unsupported) pooling</a></h3></div></div></div><a id="database-connectionprovider-drivermanager">
            

            <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Important</h2>
                <p>
                    The built-in connection pool is not supported supported for use.
                </p>
            </div>

            <p>
                This section is here just for completeness.
            </p>
        </a></div><a id="database-connectionprovider-drivermanager">

        </a><div class="section" title="5.1.6.&nbsp;User-provided Connections"><a id="database-connectionprovider-drivermanager"></a><div class="titlepage"><a id="database-connectionprovider-drivermanager"></a><div><a id="database-connectionprovider-drivermanager"></a><div><a id="database-connectionprovider-drivermanager"></a><h3 class="title"><a id="database-connectionprovider-drivermanager"></a><a id="database-connectionprovider-provided">5.1.6.&nbsp;User-provided Connections</a></h3></div></div></div><a id="database-connectionprovider-provided">
            

            <p>
                It is possible to use Hibernate by simply passing a Connection to use to the Session when the Session
                is opened.  This usage is discouraged and not discussed here.
            </p>
        </a></div><a id="database-connectionprovider-provided">

        </a><div class="section" title="5.1.7.&nbsp;ConnectionProvider support for transaction isolation setting"><a id="database-connectionprovider-provided"></a><div class="titlepage"><a id="database-connectionprovider-provided"></a><div><a id="database-connectionprovider-provided"></a><div><a id="database-connectionprovider-provided"></a><h3 class="title"><a id="database-connectionprovider-provided"></a><a id="database-connectionprovider-isolation">5.1.7.&nbsp;ConnectionProvider support for transaction isolation setting</a></h3></div></div></div><a id="database-connectionprovider-isolation">
            
            <p>
                All of the provided ConnectionProvider implementations, other than DataSourceConnectionProvider,
                support consistent setting of transaction isolation for all Connections obtained from the underlying
                pool.  The value for <code class="literal">hibernate.connection.isolation</code> can be specified in
                one of 3 formats:
                </p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
                        <p>
                            the integer value accepted at the JDBC level
                        </p>
                    </li><li class="listitem">
                        <p>
                            the name of the <code class="interfacename">java.sql.Connection</code> constant field
                            representing the isolation you would like to use.  For example,
                            <code class="literal">TRANSACTION_REPEATABLE_READ</code> for
                            <code class="methodname">java.sql.Connection#TRANSACTION_REPEATABLE_READ</code>.  Not that this is
                            only supported for JDBC standard isolations, not for isolation levels specific to
                            a particular JDBC driver.
                        </p>
                    </li><li class="listitem">
                        <p>
                            a short-name version of the <code class="interfacename">java.sql.Connection</code> constant field
                            without the <code class="literal">TRANSACTION_</code> prefix.  For example,
                            <code class="literal">REPEATABLE_READ</code> for
                            <code class="methodname">java.sql.Connection#TRANSACTION_REPEATABLE_READ</code>.  Again, this is
                            only supported for JDBC standard isolations, not for isolation levels specific to
                            a particular JDBC driver.
                        </p>
                    </li></ul></div><p>
            </p>
        </a></div><a id="database-connectionprovider-isolation">
    </a></div><a id="database-connectionprovider-isolation">



    </a><div class="section" title="5.2.&nbsp;Database Dialect"><a id="database-connectionprovider-isolation"></a><div class="titlepage"><a id="database-connectionprovider-isolation"></a><div><a id="database-connectionprovider-isolation"></a><div><a id="database-connectionprovider-isolation"></a><h2 class="title"><a id="database-connectionprovider-isolation"></a><a id="database-dialect">5.2.&nbsp;Database Dialect</a></h2></div></div></div><a id="database-dialect">
        

        <p>
            Although SQL is relatively standardized, each database vendor uses a subset and superset of
            ANSI SQL defined syntax.  This is referred to as the database's <em class="firstterm">dialect</em>.
            Hibernate handles variations across these dialects through its
            <code class="classname">org.hibernate.dialect.Dialect</code> class and the various subclasses for each database
            vendor.
        </p>

        </a><p><a id="database-dialect">
            In most cases Hibernate will be able to determine the proper Dialect to use by asking some questions
            of the JDBC Connection during bootstrap.  For information on Hibernate's ability to determine the
            proper Dialect to use (and your ability to influence that resolution), see </a><a class="xref" href="#portability-dialectresolver" title="19.3.&nbsp;Dialect resolution">Section&nbsp;19.3, “Dialect resolution”</a>
        </p>

        <p>
            If for some reason it is not able to determine the proper one
            or you want to use a custom Dialect, you will need to set the <code class="literal">hibernate.dialect</code> setting.
        </p>

        <div class="table"><a id="d5e743"><p class="title"><strong>Table&nbsp;5.1.&nbsp;Provided Dialects</strong></p><div class="table-contents">
            

            <table summary="Provided Dialects" border="1"><colgroup><col width="120px"><col width="320px"></colgroup><thead><tr><th>Dialect (short name)</th><th>Remarks</th></tr></thead><tbody><tr><td>Cache71</td><td>
                            Support for the CachÉ database, version 2007.1
                        </td></tr><tr><td>CUBRID</td><td>
                            Support for the CUBRID database, version 8.3.  May work with later versions.
                        </td></tr><tr><td>DB2</td><td>
                            Support for the DB2 database
                        </td></tr><tr><td>DB2390</td><td>
                            Support for DB2 Universal Database for OS/390, also known as DB2/390.
                        </td></tr><tr><td>DB2400</td><td>
                            Support for DB2 Universal Database for iSeries, also known as DB2/400.
                        </td></tr><tr><td>DerbyTenFive</td><td>
                            Support for the Derby database, version 10.5
                        </td></tr><tr><td>DerbyTenSix</td><td>
                            Support for the Derby database, version 10.6
                        </td></tr><tr><td>DerbyTenSeven</td><td>
                            Support for the Derby database, version 10.7
                        </td></tr><tr><td>Firebird</td><td>
                            Support for the Firebird database
                        </td></tr><tr><td>FrontBase</td><td>
                            Support for the Frontbase database
                        </td></tr><tr><td>H2</td><td>
                            Support for the H2 database
                        </td></tr><tr><td>HSQL</td><td>
                            Support for the HSQL (HyperSQL) database
                        </td></tr><tr><td>Informix</td><td>
                            Support for the Informix database
                        </td></tr><tr><td>Ingres</td><td>
                            Support for the Ingres database, version 9.2
                        </td></tr><tr><td>Ingres9</td><td>
                            Support for the Ingres database, version 9.3.  May work with newer versions
                        </td></tr><tr><td>Ingres10</td><td>
                            Support for the Ingres database, version 10.  May work with newer versions
                        </td></tr><tr><td>Interbase</td><td>
                            Support for the Interbase database.
                        </td></tr><tr><td>JDataStore</td><td>
                            Support for the JDataStore database
                        </td></tr><tr><td>McKoi</td><td>
                            Support for the McKoi database
                        </td></tr><tr><td>Mimer</td><td>
                            Support for the Mimer database, version 9.2.1.  May work with newer versions
                        </td></tr><tr><td>MySQL5</td><td>
                            Support for the MySQL database, version 5.x
                        </td></tr><tr><td>MySQL5InnoDB</td><td>
                            Support for the MySQL database, version 5.x preferring the InnoDB storage engine
                            when exporting tables.
                        </td></tr><tr><td>MySQL57InnoDB</td><td>
                            Support for the MySQL database, version 5.7 preferring the InnoDB storage engine
                            when exporting tables.  May work with newer versions
                        </td></tr><tr><td>Oracle8i</td><td>
                            Support for the Oracle database, version 8i
                        </td></tr><tr><td>Oracle9i</td><td>
                            Support for the Oracle database, version 9i
                        </td></tr><tr><td>Oracle10g</td><td>
                            Support for the Oracle database, version 10g
                        </td></tr><tr><td>Pointbase</td><td>
                            Support for the Pointbase database
                        </td></tr><tr><td>PostgresPlus</td><td>
                            Support for the Postgres Plus database
                        </td></tr><tr><td>PostgreSQL81</td><td>
                            Support for the PostgrSQL database, version 8.1
                        </td></tr><tr><td>PostgreSQL82</td><td>
                            Support for the PostgreSQL database, version 8.2
                        </td></tr><tr><td>PostgreSQL9</td><td>
                            Support for the PostgreSQL database, version 9.  May work with later versions.
                        </td></tr><tr><td>Progress</td><td>
                            Support for the Progress database, version 9.1C.  May work with newer versions.
                        </td></tr><tr><td>SAPDB</td><td>
                            Support for the SAPDB/MAXDB database.
                        </td></tr><tr><td>SQLServer</td><td>
                            Support for the SQL Server 2000 database
                        </td></tr><tr><td>SQLServer2005</td><td>
                            Support for the SQL Server 2005 database
                        </td></tr><tr><td>SQLServer2008</td><td>
                            Support for the SQL Server 2008 database
                        </td></tr><tr><td>Sybase11</td><td>
                            Support for the Sybase database, up to version 11.9.2
                        </td></tr><tr><td>SybaseAnywhere</td><td>
                            Support for the Sybase Anywhere database
                        </td></tr><tr><td>SybaseASE15</td><td>
                            Support for the Sybase Adaptive Server Enterprise database, version 15
                        </td></tr><tr><td>SybaseASE157</td><td>
                            Support for the Sybase Adaptive Server 
Enterprise database, version 15.7.  May work with newer versions.
                        </td></tr><tr><td>Teradata</td><td>
                            Support for the Teradata database
                        </td></tr><tr><td>TimesTen</td><td>
                            Support for the TimesTen database, version 5.1.  May work with newer versions
                        </td></tr></tbody></table>
        </div></a></div><a id="d5e743"><br class="table-break">
    </a></div><a id="d5e743">
</a></div><a id="d5e743">
    </a><div class="chapter" title="Chapter&nbsp;6.&nbsp;Transactions and concurrency control"><a id="d5e743"></a><div class="titlepage"><a id="d5e743"></a><div><a id="d5e743"></a><div><a id="d5e743"></a><h2 class="title"><a id="d5e743"></a><a id="transactions">Chapter&nbsp;6.&nbsp;Transactions and concurrency control</a></h2></div></div></div><div class="toc"><p><a id="transactions"><strong>Table of Contents</strong></a></p><dl><dt><a id="transactions"><span class="section"></span></a><a href="#transactions-physical">6.1. Physical Transactions</a></dt><dd><dl><dt><span class="section"><a href="#transactions-physical-jtaplatform">6.1.1. JTA configuration</a></span></dt></dl></dd><dt><span class="section"><a href="#transactions-api">6.2. Hibernate Transaction API</a></span></dt><dt><span class="section"><a href="#d5e1005">6.3. Transactional patterns (and anti-patterns)</a></span></dt><dd><dl><dt><span class="section"><a href="#session-per-operation">6.3.1. Session-per-operation anti-pattern</a></span></dt><dt><span class="section"><a href="#session-per-request">6.3.2. Session-per-request pattern</a></span></dt><dt><span class="section"><a href="#long-conversations">6.3.3. Conversations</a></span></dt><dt><span class="section"><a href="#d5e1098">6.3.4. Session-per-application</a></span></dt></dl></dd><dt><span class="section"><a href="#transactions-basics-issues">6.4. Common issues</a></span></dt></dl></div>

    

    <p>
        It is important to understand that the term transaction has many different yet related meanings in regards
        to persistence and Object/Relational Mapping.  In most use-cases these definitions align, but that is not
        always the case.
    </p>
    <div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
            <p>
                Might refer to the physical transaction with the database.
            </p>
        </li><li class="listitem">
            <p>
                Might refer to the logical notion of a transaction as related to a persistence context.
            </p>
        </li><li class="listitem">
            <p>
                Might refer to the application notion of a Unit-of-Work, as defined by the archetypal pattern.
            </p>
        </li></ul></div>

    <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2>
        <p>
            This documentation largely treats the physical and logic notions of transaction as one-in-the-same.
        </p>
    </div>


    <div class="section" title="6.1.&nbsp;Physical Transactions"><div class="titlepage"><div><div><h2 class="title"><a id="transactions-physical">6.1.&nbsp;Physical Transactions</a></h2></div></div></div><a id="transactions-physical">
        
        <p>
            Hibernate uses the JDBC API for persistence.  In the world of Java there are 2 well defined mechanism
            for dealing with transactions in JDBC: JDBC itself and JTA.  Hibernate supports both mechanisms for
            integrating with transactions and allowing applications to manage physical transactions.
        </p>

        <p>
            Transaction handling per Session is handled by the
            <code class="interfacename">org.hibernate.resource.transaction.TransactionCoordinator</code> contract, which
            are built by the <code class="interfacename">org.hibernate.resource.transaction.TransactionCoordinatorBuilder</code>
            service.  TransactionCoordinatorBuilder represents a strategy for dealing with transactions whereas
            TransactionCoordinator represents one instance of that strategy related to a Session.  Which
            TransactionCoordinatorBuilder implementation to use is defined by the
            <code class="literal">hibernate.transaction.coordinator_class</code> setting.
        </p>

        </a><div class="itemizedlist" title="Hibernate-provided TransactionCoordinatorBuilder implementations"><a id="transactions-physical"><p class="title"><strong>Hibernate-provided TransactionCoordinatorBuilder implementations</strong></p></a><ul class="itemizedlist"><a id="transactions-physical"><li class="listitem">
                <p>
                    <code class="literal">jdbc</code> (the default) - Manages transactions via calls to <code class="interfacename">java.sql.Connection</code>
                </p>
            </li></a><li class="listitem"><a id="transactions-physical">
                </a><p><a id="transactions-physical">
                    <code class="literal">jta</code> - Manages transactions via JTA.  See </a><a class="xref" href="#">???</a>
                </p>
            </li></ul></div>

        <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2>
            <p>
                For details on implementing a custom TransactionCoordinatorBuilder, or simply better understanding
                how it works, see the <em class="citetitle">Integrations Guide</em>
            </p>
        </div>

        <p>
            Hibernate uses JDBC connections and JTA resources directly, without adding any additional locking behavior.
            Hibernate does not lock objects in memory.  The behavior defined by the isolation level of your database
            transactions does not change when you use Hibernate.  The Hibernate Session acts as a transaction-scoped
            cache providing repeatable reads for lookup by identifier and queries that result in loading entities.
        </p>

        <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Important</h2>
            <p>
                To reduce lock contention in the database, the physical database transaction needs to be as short as
                possible.  Long database transactions prevent your application from scaling to a highly-concurrent load.
                Do not hold a database transaction open during end-user-level work, but open it after the end-user-level
                work is finished.  This is concept is referred to as <code class="literal">transactional write-behind</code>.
            </p>
        </div>

        <div class="section" title="6.1.1.&nbsp;JTA configuration"><div class="titlepage"><div><div><h3 class="title"><a id="transactions-physical-jtaplatform">6.1.1.&nbsp;JTA configuration</a></h3></div></div></div><a id="transactions-physical-jtaplatform">
            

            <p>
                Interaction with a JTA system is consolidated behind a single contract named
                <code class="interfacename">org.hibernate.engine.transaction.jta.platform.spi.JtaPlatform</code> which
                exposes access to the <code class="interfacename">javax.transaction.TransactionManager</code> and
                <code class="interfacename">javax.transaction.UserTransaction</code> for that system as well as exposing
                the ability to register <code class="interfacename">javax.transaction.Synchronization</code> instances,
                check transaction status, etc.
            </p>

            </a><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><a id="transactions-physical-jtaplatform"><h2>Note</h2>
                </a><p><a id="transactions-physical-jtaplatform">
                    Generally JtaPlatform will need access to JNDI to resolve the JTA TransactionManager,
                    UserTransaction, etc.  See </a><a class="xref" href="#jndi" title="Chapter&nbsp;7.&nbsp;JNDI">Chapter&nbsp;7, <em>JNDI</em></a> for details on configuring access
                    to JNDI
                </p>
            </div>

            <p>
                Hibernate tries to discover the JtaPlatform it should use through the use of another service named
                <code class="interfacename">org.hibernate.engine.transaction.jta.platform.spi.JtaPlatformResolver</code>.
                If that resolution does not work, or if you wish to provide a custom implementation you will need to
                specify the <code class="literal">hibernate.transaction.jta.platform</code> setting.  Hibernate provides many
                implementations of the JtaPlatform contract, all with short-names:
            </p>

            <div class="itemizedlist" title="Built-in JtaPlatform implementations by short name"><p class="title"><strong>Built-in JtaPlatform implementations by short name</strong></p><ul class="itemizedlist"><li class="listitem">
                    <p>
                        <code class="literal">Borland</code> - JtaPlatform for the Borland Enterprise Server.
                    </p>
                </li><li class="listitem">
                    <p>
                        <code class="literal">Bitronix</code> - JtaPlatform for Bitronix.
                    </p>
                </li><li class="listitem">
                    <p>
                        <code class="literal">JBossAS</code> - JtaPlatform for Arjuna/JBossTransactions/Narnya when used within the JBoss/WildFly Application Server.
                    </p>
                </li><li class="listitem">
                    <p>
                        <code class="literal">JBossTS</code> - JtaPlatform for Arjuna/JBossTransactions/Narnya when used standalone.
                    </p>
                </li><li class="listitem">
                    <p>
                        <code class="literal">JOnAS</code> - JtaPlatform for JOTM when used within JOnAS.
                    </p>
                </li><li class="listitem">
                    <p>
                        <code class="literal">JOTM</code> - JtaPlatform for JOTM when used standalone.
                    </p>
                </li><li class="listitem">
                    <p>
                        <code class="literal">JRun4</code> - JtaPlatform for the JRun 4 Application Server.
                    </p>
                </li><li class="listitem">
                    <p>
                        <code class="literal">OC4J</code> - JtaPlatform for Oracle's OC4J container.
                    </p>
                </li><li class="listitem">
                    <p>
                        <code class="literal">Orion</code> - JtaPlatform for the Orion Application Server.
                    </p>
                </li><li class="listitem">
                    <p>
                        <code class="literal">Resin</code> - JtaPlatform for the Resin Application Server.
                    </p>
                </li><li class="listitem">
                    <p>
                        <code class="literal">SunOne</code> - JtaPlatform for the SunOne Application Server.
                    </p>
                </li><li class="listitem">
                    <p>
                        <code class="literal">Weblogic</code> - JtaPlatform for the Weblogic Application Server.
                    </p>
                </li><li class="listitem">
                    <p>
                        <code class="literal">WebSphere</code> - JtaPlatform for older versions of the WebSphere Application Server.
                    </p>
                </li><li class="listitem">
                    <p>
                        <code class="literal">WebSphereExtended</code> - JtaPlatform for newer versions of the WebSphere Application Server.
                    </p>
                </li></ul></div>
        </div>
    </div>

    <div class="section" title="6.2.&nbsp;Hibernate Transaction API"><div class="titlepage"><div><div><h2 class="title"><a id="transactions-api">6.2.&nbsp;Hibernate Transaction API</a></h2></div></div></div><a id="transactions-api">
        

        <p>
            Hibernate provides an API for helping to isolate applications from the differences in the underlying
            physical transaction system in use.  Based on the configured TransactionCoordinatorBuilder, Hibernate
            will simply do the right thing when this transaction API is used by the application.  This allows your
            applications and components to be more portable move around into different environments.
        </p>

        <p>
            To use this API, you would obtain the <code class="interfacename">org.hibernate.Transaction</code>
            from the Session.
        </p>

        <p>
            Transaction allows for all the normal operations you'd expect.  <code class="methodname">begin</code>,
            <code class="methodname">commit</code> and <code class="methodname">rollback</code>.  And these calls noop if they
            should.
        </p>

        <p>
            It even exposes some cool methods like:
            </p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
                    <code class="methodname">markRollbackOnly</code> that works in both JTA and JDBC!
                </li><li class="listitem">
                    <code class="methodname">getTimeout</code> and <code class="methodname">setTimeout</code> that again work
                    in both JTA and JDBC!
                </li><li class="listitem">
                    <code class="methodname">registerSynchronization</code> that allows you to register JTA Synchronizations
                    even in non-JTA environments.  In fact in both JTA and JDBC environments, these Synchronizations
                    are kept locally by Hibernate.  In JTA environments Hibernate will only ever register one single
                    Synchronization with the TransactionManager to avoid ordering problems.
                </li></ul></div><p>
        </p>

        <p>
            Additionally it exposes a <code class="methodname">getStatus</code> method that returns an
            <code class="classname">org.hibernate.resource.transaction.spi.TransactionStatus</code> enum.  This method
            checks with the underling transaction system if needed, so care should be taken to minimize its use;
            it can have a big performance impact in certain JTA set ups.
        </p>

        <p>
            Lets take a look at using the Transaction API in the various environments.
        </p>

        </a><div class="example"><a id="transactions-api"></a><a id="d5e994"><p class="title"><strong>Example&nbsp;6.1.&nbsp;Using Transaction API in JDBC</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">public void doSomeWork() {
	StandardServiceRegistry ssr = new StandardServiceRegistryBuilder()
			// "jdbc" is the default, but for explicitness
			.applySetting( AvailableSettings.TRANSACTION_COORDINATOR_STRATEGY, "jdbc" )
			...;

	SessionFactory = ...;

	Session session = sessionFactory.openSession();
	try {
		// calls Connection#setAutoCommit(false) to
		// signal start of transaction
		session.getTransaction().begin();

		doTheWork();

		// calls Connection#commit(), if an error
		// happens we attempt a rollback
		session.getTransaction().commit();
	}
	catch (Exception e) {
		// we may need to rollback depending on
		// where the exception happened
		if ( session.getTransaction().getStatus() == ACTIVE
				|| session.getTransaction().getStatus() == MARKED_ROLLBACK ) {
			session.getTransaction().rollback();
		}
		// handle the underlying error
	}
	finally {
		session.close();
	}
}</pre>
        </div></a></div><a id="d5e994"><br class="example-break">

        </a><div class="example"><a id="d5e994"></a><a id="d5e997"><p class="title"><strong>Example&nbsp;6.2.&nbsp;Using Transaction API in JTA (CMT)</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">public void doSomeWork() {
	StandardServiceRegistry ssr = new StandardServiceRegistryBuilder()
			.applySetting( AvailableSettings.TRANSACTION_COORDINATOR_STRATEGY, "jta" )
			...;

	// Note: depending on the JtaPlatform used and some optional settings,
	// the underlying transactions here will be controlled through either
	// the JTA TransactionManager or UserTransaction

	SessionFactory = ...;

	Session session = sessionFactory.openSession();
	try {
		// Since we are in CMT, a JTA transaction would
		// already have been started.  This call essentially
		// no-ops
		session.getTransaction().begin();

		doTheWork();

		// Since we did not start the transaction (CMT),
		// we also will not end it.  This call essentially
		// no-ops in terms of transaction handling.
		session.getTransaction().commit();
	}
	catch (Exception e) {
		// again, the rollback call here would no-op (aside from
		// marking the underlying CMT transaction for rollback only).
		if ( session.getTransaction().getStatus() == ACTIVE
				|| session.getTransaction().getStatus() == MARKED_ROLLBACK ) {
			session.getTransaction().rollback();
		}
		// handle the underlying error
	}
	finally {
		session.close();
	}
}</pre>
        </div></a></div><a id="d5e997"><br class="example-break">

        </a><div class="example"><a id="d5e997"></a><a id="d5e1000"><p class="title"><strong>Example&nbsp;6.3.&nbsp;Using Transaction API in JTA (BMT)</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">public void doSomeWork() {
	StandardServiceRegistry ssr = new StandardServiceRegistryBuilder()
			.applySetting( AvailableSettings.TRANSACTION_COORDINATOR_STRATEGY, "jta" )
			...;

	// Note: depending on the JtaPlatform used and some optional settings,
	// the underlying transactions here will be controlled through either
	// the JTA TransactionManager or UserTransaction

	SessionFactory = ...;

	Session session = sessionFactory.openSession();
	try {
		// Assuming a JTA transaction is not already active,
		// this call the TM/UT begin method.  If a JTA
		// transaction is already active, we remember that
		// the Transaction associated with the Session did
		// not "initiate" the JTA transaction and will later
		// nop-op the commit and rollback calls...
		session.getTransaction().begin();

		doTheWork();

		// calls TM/UT commit method, assuming we are initiator.
		session.getTransaction().commit();
	}
	catch (Exception e) {
		// we may need to rollback depending on
		// where the exception happened
		if ( session.getTransaction().getStatus() == ACTIVE
				|| session.getTransaction().getStatus() == MARKED_ROLLBACK ) {
			// calls TM/UT commit method, assuming we are initiator;
			// otherwise marks the JTA trsnaction for rollback only
			session.getTransaction().rollback();
		}
		// handle the underlying error
	}
	finally {
		session.close();
	}
}</pre>
        </div></a></div><a id="d5e1000"><br class="example-break">

        <p>
            In the CMT case we really could have omitted all of the Transaction calls.  But the point of
            the examples was to show that the Transaction API really does insulate your code from the underlying
            transaction mechanism.  In fact if you strip away the comments and the single configruation
            setting supplied at bootstrap, the code is exactly the same in all 3 examples.  In other words,
            we could develop that code and drop it, as-is, in any of the 3 transaction environments.
        </p>

        <p>
            The Transaction API tries hard to make the experience consistent across all environments.  To that end,
            it generally defers to the JTA specification when there are differences (for example automatically trying
            rollback on a failed commit).
        </p>
    </a></div><a id="d5e1000">

    </a><div class="section" title="6.3.&nbsp;Transactional patterns (and anti-patterns)"><a id="d5e1000"></a><div class="titlepage"><a id="d5e1000"></a><div><a id="d5e1000"></a><div><a id="d5e1000"></a><h2 class="title"><a id="d5e1000"></a><a id="d5e1005">6.3.&nbsp;Transactional patterns (and anti-patterns)</a></h2></div></div></div><a id="d5e1005">
        

        </a><div class="section" title="6.3.1.&nbsp;Session-per-operation anti-pattern"><a id="d5e1005"></a><div class="titlepage"><a id="d5e1005"></a><div><a id="d5e1005"></a><div><a id="d5e1005"></a><h3 class="title"><a id="d5e1005"></a><a id="session-per-operation">6.3.1.&nbsp;Session-per-operation anti-pattern</a></h3></div></div></div><a id="session-per-operation">
            
            <p>
                This is an anti-pattern of opening and closing a <code class="classname">Session</code> for each database call
                in a single thread.  It is also an anti-pattern in terms of database transactions. Group your database
                calls into a planned sequence.  In the same way, do not auto-commit after every SQL statement in your
                application.  Hibernate disables, or expects the application server to disable, auto-commit mode
                immediately.  Database transactions are never optional.  All communication with a database must
                be encapsulated by a transaction.  Avoid auto-commit behavior for reading data, because many small
                transactions are unlikely to perform better than one clearly-defined unit of work, and are more
                difficult to maintain and extend.
            </p>
            <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2>
                <p>
                    Using auto-commit does not circumvent database transactions.  Instead, when in auto-commit mode,
                    JDBC drivers simply perform each call in an implicit transaction call.  It is as if your application
                    called commit after each and every JDBC call.
                </p>
            </div>
        </a></div><a id="session-per-operation">

        </a><div class="section" title="6.3.2.&nbsp;Session-per-request pattern"><a id="session-per-operation"></a><div class="titlepage"><a id="session-per-operation"></a><div><a id="session-per-operation"></a><div><a id="session-per-operation"></a><h3 class="title"><a id="session-per-operation"></a><a id="session-per-request">6.3.2.&nbsp;Session-per-request pattern</a></h3></div></div></div><a id="session-per-request">
            
            <p>
                This is the most common transaction pattern.  The term request here relates to the concept of a system
                that reacts to a series of requests from a client/user.  Web applications are a prime example of this
                type of system, though certainly not the only one.  At the beginning of handling such a request, the
                application opens a Hibernate <code class="interfacename">Session</code>, starts a transaction, performs
                all data related work, ends the transaction and closes the <code class="interfacename">Session</code>.
                The crux of the pattern is the one-to-one relationship between the transaction and the
                <code class="interfacename">Session</code>.
            </p>

            <p>
                Within this pattern there is a common technique of defining a <em class="firstterm">current session</em> to
                simplify the need of passing this <code class="interfacename">Session</code> around to all the application
                components that may need access to it.  Hibernate provides support for this technique through the
                <code class="methodname">getCurrentSession</code> method of the <code class="interfacename">SessionFactory</code>.
                The concept of a "current" session has to have a scope that defines the bounds in which the notion
                of "current" is valid.   This is purpose of the
                <code class="interfacename">org.hibernate.context.spi.CurrentSessionContext</code> contract.  There are 2
                reliable defining scopes:
            </p>
            <div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
                    <p>
                        First is a JTA transaction because it allows a callback hook to know when it is ending which
                        gives Hibernate a chance to close the <code class="interfacename">Session</code> and clean up.
                        This is represented by the
                        <code class="classname">org.hibernate.context.internal.JTASessionContext</code> implementation of
                        the <code class="interfacename">org.hibernate.context.spi.CurrentSessionContext</code> contract.
                        Using this implementation, a <code class="interfacename">Session</code> will be opened the first
                        time <code class="methodname">getCurrentSession</code> is called within that transaction.
                    </p>
                </li><li class="listitem">
                    <p>
                        Secondly is this application request cycle itself.  This is best represented with the
                        <code class="classname">org.hibernate.context.internal.ManagedSessionContext</code> implementation of
                        the <code class="interfacename">org.hibernate.context.spi.CurrentSessionContext</code> contract.
                        Here an external component is responsible for managing the lifecycle and scoping of a "current"
                        session.  At the start of such a scope, <code class="classname">ManagedSessionContext</code>'s
                        <code class="methodname">bind</code> method is called passing in the
                        <code class="interfacename">Session</code>.  At the end, its <code class="methodname">unbind</code>
                        method is called.
                    </p>
                    <p>
                        Some common examples of such "external components" include:
                    </p>
                    <div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
                            <p>
                                <code class="interfacename">javax.servlet.Filter</code> implementation
                            </p>
                        </li><li class="listitem">
                            <p>
                                AOP interceptor with a pointcut on the service methods
                            </p>
                        </li><li class="listitem">
                            <p>
                                A proxy/interception container
                            </p>
                        </li></ul></div>
                </li></ul></div>
            <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Important</h2>
                <p>
                    The <code class="methodname">getCurrentSession()</code> method has one downside in a JTA environment.  If
                    you use it, after_statement connection release mode is also used by default.  Due to a limitation of
                    the JTA specification, Hibernate cannot automatically clean up any unclosed
                    <code class="interfacename">ScrollableResults</code> or <code class="interfacename">Iterator</code>
                    instances returned by <code class="methodname">scroll()</code> or <code class="methodname">iterate()</code>.
                    Release the underlying database cursor by calling <code class="methodname">ScrollableResults.close()</code>
                    or <code class="methodname">Hibernate.close(Iterator)</code> explicitly from a
                    <code class="systemitem">finally</code> block.
                </p>
            </div>
        </a></div><a id="session-per-request">

        </a><div class="section" title="6.3.3.&nbsp;Conversations"><a id="session-per-request"></a><div class="titlepage"><a id="session-per-request"></a><div><a id="session-per-request"></a><div><a id="session-per-request"></a><h3 class="title"><a id="session-per-request"></a><a id="long-conversations">6.3.3.&nbsp;Conversations</a></h3></div></div></div><a id="long-conversations">
            
            <p>
                The <span>session-per-request</span> pattern is not the only valid way of designing units of work.
                Many business processes require a whole series of interactions with the user that are interleaved with
                database accesses. In web and enterprise applications, it is not acceptable for a database transaction
                to span a user interaction. Consider the following example:
            </p>
            </a><div class="procedure" title="Procedure&nbsp;6.1.&nbsp;An example of a long-running conversation"><a id="long-conversations"></a><a id="d5e1064"><p class="title"><strong>Procedure&nbsp;6.1.&nbsp;An example of a long-running conversation</strong></p><ol class="procedure" type="1"><li class="step" title="Step 1">
                    <p>
                        The first screen of a dialog opens. The data seen by the user is loaded in a particular
                        <code class="classname">Session</code> and database transaction.  The user is free to modify the objects.
                    </p>
                </li><li class="step" title="Step 2">
                    <p>
                        The user uses a UI element to save their work after five minutes of editing. The modifications
                        are made persistent.  The user also expects to have exclusive access to the data during the edit
                        session.
                    </p>
                </li></ol></a></div><a id="d5e1064">

            <p>
                Even though we have multiple databases access here, from the point of view of the user, this series of
                steps represents a single unit of work.  There are many ways to implement this in your application.
            </p>

            <p>
                A first naive implementation might keep the <code class="classname">Session</code> and database transaction open
                while the user is editing, using database-level locks to prevent other users from modifying the same
                data and to guarantee isolation and atomicity.  This is an anti-pattern, because lock contention is a
                bottleneck which will prevent scalability in the future.
            </p>
            <p>
                Several database transactions are used to implement the conversation.  In this case, maintaining
                isolation of business processes becomes the partial responsibility of the application tier.  A single
                conversation usually spans several database transactions.  These multiple database accesses can only
                be atomic as a whole if only one of these database transactions (typically the last one) stores the
                updated data.  All others only read data.  A common way to receive this data is through a wizard-style
                dialog spanning several request/response cycles.  Hibernate includes some features which make this easy
                to implement.
            </p>

            <div class="informaltable">
                <table border="1"><colgroup><col><col></colgroup><tbody><tr><td>
                                <p>
                                    Automatic Versioning
                                </p>
                            </td><td>
                                <p>
                                    Hibernate can perform automatic optimistic concurrency control for you.  It can
                                    automatically detect if a concurrent modification occurred during user think time.
                                    Check for this at the end of the conversation.
                                </p>
                            </td></tr><tr><td>
                                <p>
                                    Detached Objects
                                </p>
                            </td><td>
                                <p>
                                    If you decide to use the session-per-request pattern, all loaded instances will be
                                    in the detached state during user think time.  Hibernate allows you to reattach the
                                    objects and persist the modifications.  The pattern is called
                                    session-per-request-with-detached-objects.  Automatic versioning is used to isolate
                                    concurrent modifications.
                                </p>
                            </td></tr><tr><td>
                                <p>
                                    Extended Session
                                </p>
                            </td><td>
                                <p>
                                    The Hibernate <code class="interfacename">Session</code> can be disconnected from the
                                    underlying JDBC connection after the database transaction has been committed and
                                    reconnected when a new client request occurs. This pattern is known as
                                    session-per-conversation and makes even reattachment unnecessary. Automatic
                                    versioning is used to isolate concurrent modifications and the
                                    <code class="interfacename">Session</code> will not be allowed to flush automatically,
                                    only explicitly.
                                </p>
                            </td></tr></tbody></table>
            </div>

            <p>
                <span>Session-per-request-with-detached-objects</span> and <span>session-per-conversation</span>
                each have advantages and disadvantages.
            </p>
        </a></div><a id="d5e1064">

        </a><div class="section" title="6.3.4.&nbsp;Session-per-application"><a id="d5e1064"></a><div class="titlepage"><a id="d5e1064"></a><div><a id="d5e1064"></a><div><a id="d5e1064"></a><h3 class="title"><a id="d5e1064"></a><a id="d5e1098">6.3.4.&nbsp;Session-per-application</a></h3></div></div></div><a id="d5e1098">
            
            <p>
                Discussion coming soon..
            </p>
        </a></div><a id="d5e1098">
    </a></div><a id="d5e1098">


    </a><div class="section" title="6.4.&nbsp;Common issues"><a id="d5e1098"></a><div class="titlepage"><a id="d5e1098"></a><div><a id="d5e1098"></a><div><a id="d5e1098"></a><h2 class="title"><a id="d5e1098"></a><a id="transactions-basics-issues">6.4.&nbsp;Common issues</a></h2></div></div></div><a id="transactions-basics-issues">
        

        </a><div class="itemizedlist"><a id="transactions-basics-issues"></a><ul class="itemizedlist"><a id="transactions-basics-issues"><li class="listitem">
                <p>
                    A Session is not thread-safe. Things that work concurrently, like HTTP requests, session beans,
                    or Swing workers, will cause race conditions if a Session instance is shared.  If you keep your
                    Hibernate Session in your <code class="interfacename">javax.servlet.http.HttpSession</code> you should
                    consider synchronizing access to your HttpSession; otherwise, a user that clicks reload fast enough
                    can use the same Session in two concurrently running threads.
                </p>
            </li><li class="listitem">
                <p>
                    An exception thrown by Hibernate means you have to rollback your database transaction
                    and close the Session immediately.  If your Session is bound to the application,
                    you have to stop the application.  Rolling back the database transaction does not put your business
                    objects back into the state they were at the start of the transaction.  This means that the
                    database state and the business objects will be out of sync. Usually this is not a
                    problem, because exceptions are not recoverable and you will have to start over after
                    rollback anyway.
                </p>
            </li></a><li class="listitem"><a id="transactions-basics-issues">
                </a><p><a id="transactions-basics-issues">
                    The Session caches every object that is in a persistent state (watched and checked for changes
                    by Hibernate).  If you keep it open for a long time or simply load too much data, it will grow
                    endlessly until you get an OutOfMemoryException.  One solution is to call
                    <code class="methodname">clear()</code> and <code class="methodname">evict()</code> to manage the
                    Session cache, but you should consider an alternate means of dealing with large amounts of data
                    such as a Stored Procedure.  Java is simply not the right tool for these kind of operations.
                    Some solutions are shown in </a><a class="xref" href="#batch" title="Chapter&nbsp;10.&nbsp;Batching">Chapter&nbsp;10, <em>Batching</em></a>.  Keeping a Session open for the duration of
                    a user session also means a higher probability of stale data.
                </p>
            </li></ul></div>

    </div>

</div>
    <div xml:lang="en" class="chapter" title="Chapter&nbsp;7.&nbsp;JNDI"><div class="titlepage"><div><div><h2 class="title"><a id="jndi">Chapter&nbsp;7.&nbsp;JNDI</a></h2></div></div></div><a id="jndi">
    

    <p>
        Hibernate does optionally interact with JNDI on the applications behalf.  Generally
        it does this when the application:
        </p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
                <p>has asked the SessionFactory be bound to JNDI</p>
            </li><li class="listitem">
                <p>has specified a DataSource to use by JNDI name</p>
            </li><li class="listitem">
                <p>is using JTA transactions and the JtaPlatform needs to do JNDI lookups for TM, UT, etc</p>
            </li></ul></div><p>
    </p>

    <p>
        All of these JNDI calls route through a single service whose role is
        <code class="interfacename">org.hibernate.engine.jndi.spi.JndiService</code>.  The standard JndiService
        accepts a number of configuration settings
        </p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
                <p>
                    <code class="literal">hibernate.jndi.class</code> - names the
                    <code class="interfacename">javax.naming.InitialContext</code> implementation class to use.  See
                    <code class="constant">javax.naming.Context#INITIAL_CONTEXT_FACTORY</code>
                </p>
            </li><li class="listitem">
                <p>
                    <code class="literal">hibernate.jndi.url</code> - names the JNDI InitialContext connection url.  See
                    <code class="constant">javax.naming.Context.PROVIDER_URL</code>
                </p>
            </li><li class="listitem">
                <p>
                    Any other settings prefixed with <code class="literal">hibernate.jndi.</code> will be collected
                    and passed along to the JNDI provider.
                </p>
            </li></ul></div><p>
    </p>

    <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2>
        <p>
            The standard JndiService assumes that all JNDI calls are relative to the same InitialContext.  If your
            application uses multiple naming servers for whatever reason, you will need a custom JndiService
            implementation to handle those details.
        </p>
    </div>
</a></div><a id="jndi">
    </a><div class="chapter" title="Chapter&nbsp;8.&nbsp;Locking"><a id="jndi"></a><div class="titlepage"><a id="jndi"></a><div><a id="jndi"></a><div><a id="jndi"></a><h2 class="title"><a id="jndi"></a><a id="d5e1141">Chapter&nbsp;8.&nbsp;Locking</a></h2></div></div></div><div class="toc"><p><a id="d5e1141"><strong>Table of Contents</strong></a></p><dl><dt><a id="d5e1141"><span class="section"></span></a><a href="#d5e1161">8.1. Optimistic</a></dt><dd><dl><dt><span class="section"><a href="#d5e1177">8.1.1. Dedicated version number</a></span></dt><dt><span class="section"><a href="#d5e1240">8.1.2. Timestamp</a></span></dt></dl></dd><dt><span class="section"><a href="#d5e1289">8.2. Pessimistic</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e1294">8.2.1. The <code class="classname">LockMode</code> class</a></span></dt></dl></dd></dl></div>
  
  <p>
    Locking refers to actions taken to prevent data in a relational database from changing between the time it is read
    and the time that it is used.
  </p>
  <p>
    Your locking strategy can be either <em class="firstterm">optimistic</em> or <em class="firstterm">pessimistic</em>.
  </p>
  <div class="variablelist" title="Locking strategies"><p class="title"><strong>Locking strategies</strong></p><dl><dt><span class="term">Optimistic</span></dt><dd>
        <p>
          Optimistic locking assumes that multiple transactions can complete without affecting each other, and that
          therefore transactions can proceed without locking the data resources that they affect. Before committing,
          each transaction verifies that no other transaction has modified its data. If the check reveals conflicting
          modifications, the committing transaction rolls back<sup>[<a id="d5e1153" href="#ftn.d5e1153" class="footnote">1</a>]</sup>.
        </p>
      </dd><dt><span class="term">Pessimistic</span></dt><dd>
        <p>
          Pessimistic locking assumes that concurrent transactions will conflict with each other, and requires resources
          to be locked after they are read and only unlocked after the application has finished using the data.
        </p>
      </dd></dl></div>
  <p>
    Hibernate provides mechanisms for implementing both types of locking in your applications.
  </p>
  <div class="section" title="8.1.&nbsp;Optimistic"><div class="titlepage"><div><div><h2 class="title"><a id="d5e1161">8.1.&nbsp;Optimistic</a></h2></div></div></div><a id="d5e1161">
    
    <p>
      When your application uses long transactions or conversations that span several database transactions, you can
      store versioning data, so that if the same entity is updated by two conversations, the last to commit changes is
      informed of the conflict, and does not override the other conversation's work. This approach guarantees some
      isolation, but scales well and works particularly well in <em class="firstterm">Read-Often Write-Sometimes</em>
      situations.
    </p>
    <p>
      Hibernate provides two different mechanisms for storing versioning information, a dedicated version number or a
      timestamp.
    </p>
    <div class="variablelist"><dl><dt><span class="term">Version number</span></dt><dd>
          <p>

          </p>
        </dd><dt><span class="term">Timestamp</span></dt><dd>
          <p>

          </p>
        </dd></dl></div>
    <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2>
      <p>
        A version or timestamp property can never be null for a detached instance. Hibernate detects any instance with a
        null version or timestamp as transient, regardless of other unsaved-value strategies that you specify. Declaring
        a nullable version or timestamp property is an easy way to avoid problems with transitive reattachment in
        Hibernate, especially useful if you use assigned identifiers or composite keys.
      </p>
    </div>
    
    </a><div class="section" title="8.1.1.&nbsp;Dedicated version number"><a id="d5e1161"></a><div class="titlepage"><a id="d5e1161"></a><div><a id="d5e1161"></a><div><a id="d5e1161"></a><h3 class="title"><a id="d5e1161"></a><a id="d5e1177">8.1.1.&nbsp;Dedicated version number</a></h3></div></div></div><a id="d5e1177">
      
      <p>
        The version number mechanism for optimistic locking is provided through a <code class="literal">@Version</code>
        annotation.
      </p>
      </a><div class="example"><a id="d5e1177"></a><a id="d5e1181"><p class="title"><strong>Example&nbsp;8.1.&nbsp;The @Version annotation</strong></p><div class="example-contents">
        
        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">Entity</span>
<!--  --><br><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">Flight</span><span class="java_plain">&nbsp;</span><span class="java_keyword">implements</span><span class="java_plain">&nbsp;</span><span class="java_type">Serializable</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br><span class="java_separator">...</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Version</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Column</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">"OPTLOCK"</span><span class="java_separator">)</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">Integer</span><span class="java_plain">&nbsp;getVersion</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_separator">...</span><span class="java_plain">&nbsp;</span><span class="java_separator">}</span>
<!--  --><br><span class="java_separator">}</span><span class="java_plain">&nbsp;&nbsp;&nbsp;</span></pre>
        <p>
          Here, the version property is mapped to the <code class="literal">OPTLOCK</code> column, and the entity manager uses it
          to detect conflicting updates, and prevent the loss of updates that would be overwritten by a
          <em class="firstterm">last-commit-wins</em> strategy.
        </p>
      </div></a></div><a id="d5e1181"><br class="example-break">
      <p>
        The version column can be any kind of type, as long as you define and implement the appropriate
        <code class="classname">UserVersionType</code>.
      </p>
      <p>
        Your application is forbidden from altering the version number set by Hibernate. To artificially increase the
        version number, see the documentation for properties
        <span class="property">LockModeType.OPTIMISTIC_FORCE_INCREMENT</span> or
        <span class="property">LockModeType.PESSIMISTIC_FORCE_INCREMENTcheck</span> in the Hibernate Entity Manager reference
        documentation.
      </p>
      <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Database-generated version numbers</h2>
        
        <p>
          If the version number is generated by the database, such as a trigger, use the annotation
          <code class="literal">@org.hibernate.annotations.Generated(GenerationTime.ALWAYS)</code>.
        </p>
      </div>
      </a><div class="example"><a id="d5e1181"></a><a id="d5e1196"><p class="title"><strong>Example&nbsp;8.2.&nbsp;Declaring a version property in <code class="filename">hbm.xml</code></strong></p><div class="example-contents">
        
        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_comment">&lt;!--</span><span class="xml_plain"></span><br>
<span class="xml_comment">&nbsp;&nbsp;~&nbsp;Hibernate,&nbsp;Relational&nbsp;Persistence&nbsp;for&nbsp;Idiomatic&nbsp;Java</span><span class="xml_plain"></span><br>
<span class="xml_comment">&nbsp;&nbsp;~</span><span class="xml_plain"></span><br>
<span class="xml_comment">&nbsp;&nbsp;~&nbsp;License:&nbsp;GNU&nbsp;Lesser&nbsp;General&nbsp;Public&nbsp;License&nbsp;(LGPL),&nbsp;version&nbsp;2.1&nbsp;or&nbsp;later.</span><span class="xml_plain"></span><br>
<span class="xml_comment">&nbsp;&nbsp;~&nbsp;See&nbsp;the&nbsp;lgpl.txt&nbsp;file&nbsp;in&nbsp;the&nbsp;root&nbsp;directory&nbsp;or&nbsp;&lt;http://www.gnu.org/licenses/lgpl-2.1.html&gt;.</span><span class="xml_plain"></span><br>
<span class="xml_comment">&nbsp;&nbsp;--&gt;</span><span class="xml_plain"></span><br>
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">version</span><span class="xml_plain"></span><br>
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">column</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">"version_column"</span><span class="xml_plain"></span><br>
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">"propertyName"</span><span class="xml_plain"></span><br>
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">type</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">"typename"</span><span class="xml_plain"></span><br>
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">access</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">"field|property|ClassName"</span><span class="xml_plain"></span><br>
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">unsaved-value</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">"null|negative|undefined"</span><span class="xml_plain"></span><br>
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">generated</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">"never|always"</span><span class="xml_plain"></span><br>
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">insert</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">"true|false"</span><span class="xml_plain"></span><br>
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">node</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">"element-name|@attribute-name|element/@attribute|."</span><span class="xml_plain"></span><br>
<span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br>
</pre>
        <div class="informaltable">
          <table border="1"><colgroup><col><col></colgroup><tbody><tr><td>column</td><td><p>The name of the column holding the version number. Optional, defaults to the property
                name. </p></td></tr><tr><td>name</td><td><p>The name of a property of the persistent class.</p></td></tr><tr><td>type</td><td><p>The type of the version number. Optional, defaults to
                <code class="literal">integer</code>.</p></td></tr><tr><td>access</td><td><p>Hibernate's strategy for accessing the property value. Optional, defaults to
                <code class="literal">property</code>.</p></td></tr><tr><td>unsaved-value</td><td><p>Indicates that an instance is newly instantiated and thus unsaved. This distinguishes it
                from detached instances that were saved or loaded in a previous session. The default value,
                <code class="literal">undefined</code>, indicates that the identifier property value should be
                used. Optional.</p></td></tr><tr><td>generated</td><td><p>Indicates that the version property value is generated by the database. Optional, defaults
                to <code class="literal">never</code>.</p></td></tr><tr><td>insert</td><td><p>Whether or not to include the <code class="code">version</code> column in SQL <code class="code">insert</code>
                statements. Defaults to <code class="literal">true</code>, but you can set it to <code class="literal">false</code> if the
                database column is defined with a default value of <code class="literal">0</code>.</p></td></tr></tbody></table>
        </div>
      </div></a></div><a id="d5e1196"><br class="example-break">
    </a></div><a id="d5e1196">
    
    </a><div class="section" title="8.1.2.&nbsp;Timestamp"><a id="d5e1196"></a><div class="titlepage"><a id="d5e1196"></a><div><a id="d5e1196"></a><div><a id="d5e1196"></a><h3 class="title"><a id="d5e1196"></a><a id="d5e1240">8.1.2.&nbsp;Timestamp</a></h3></div></div></div><a id="d5e1240">
      
      <p>
        Timestamps are a less reliable way of optimistic locking than version numbers, but can be used by applications
        for other purposes as well. Timestamping is automatically used if you the <code class="code">@Version</code> annotation on a
        <span class="type">Date</span> or <span class="type">Calendar</span>.
      </p>
      </a><div class="example"><a id="d5e1240"></a><a id="d5e1246"><p class="title"><strong>Example&nbsp;8.3.&nbsp;Using timestamps for optimistic locking</strong></p><div class="example-contents">
        
        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">Entity</span>
<!--  --><br><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">Flight</span><span class="java_plain">&nbsp;</span><span class="java_keyword">implements</span><span class="java_plain">&nbsp;</span><span class="java_type">Serializable</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br><span class="java_separator">...</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Version</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">Date</span><span class="java_plain">&nbsp;getLastUpdate</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_separator">...</span><span class="java_plain">&nbsp;</span><span class="java_separator">}</span>
<!--  --><br><span class="java_separator">}</span><span class="java_plain">&nbsp;</span></pre>
      </div></a></div><a id="d5e1246"><br class="example-break">
      <p>
        Hibernate can retrieve the timestamp value from the database or the JVM, by reading the value you specify for
        the <code class="code">@org.hibernate.annotations.Source</code> annotation. The value can be either
        <code class="literal">org.hibernate.annotations.SourceType.DB</code> or
        <code class="literal">org.hibernate.annotations.SourceType.VM</code>. The default behavior is to use the database, and is
        also used if you don't specify the annotation at all.
      </p>
      <p>
        The timestamp can also be generated by the database instead of Hibernate, if you use the
        <code class="code">@org.hibernate.annotations.Generated(GenerationTime.ALWAYS)</code> annotation.
      </p>
      </a><div class="example"><a id="d5e1246"></a><a id="d5e1255"><p class="title"><strong>Example&nbsp;8.4.&nbsp;The timestamp element in <code class="filename">hbm.xml</code></strong></p><div class="example-contents">
        
        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_comment">&lt;!--</span><span class="xml_plain"></span><br>
<span class="xml_comment">&nbsp;&nbsp;~&nbsp;Hibernate,&nbsp;Relational&nbsp;Persistence&nbsp;for&nbsp;Idiomatic&nbsp;Java</span><span class="xml_plain"></span><br>
<span class="xml_comment">&nbsp;&nbsp;~</span><span class="xml_plain"></span><br>
<span class="xml_comment">&nbsp;&nbsp;~&nbsp;License:&nbsp;GNU&nbsp;Lesser&nbsp;General&nbsp;Public&nbsp;License&nbsp;(LGPL),&nbsp;version&nbsp;2.1&nbsp;or&nbsp;later.</span><span class="xml_plain"></span><br>
<span class="xml_comment">&nbsp;&nbsp;~&nbsp;See&nbsp;the&nbsp;lgpl.txt&nbsp;file&nbsp;in&nbsp;the&nbsp;root&nbsp;directory&nbsp;or&nbsp;&lt;http://www.gnu.org/licenses/lgpl-2.1.html&gt;.</span><span class="xml_plain"></span><br>
<span class="xml_comment">&nbsp;&nbsp;--&gt;</span><span class="xml_plain"></span><br>
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">timestamp</span><span class="xml_plain"></span><br>
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">column</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">"timestamp_column"</span><span class="xml_plain"></span><br>
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">"propertyName"</span><span class="xml_plain"></span><br>
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">access</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">"field|property|ClassName"</span><span class="xml_plain"></span><br>
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">unsaved-value</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">"null|undefined"</span><span class="xml_plain"></span><br>
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">source</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">"vm|db"</span><span class="xml_plain"></span><br>
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">generated</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">"never|always"</span><span class="xml_plain"></span><br>
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">node</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">"element-name|@attribute-name|element/@attribute|."</span><span class="xml_plain"></span><br>
<span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br>
</pre>
        <div class="informaltable">
          <table border="1"><colgroup><col><col></colgroup><tbody><tr><td>column</td><td><p>The name of the column which holds the timestamp. Optional, defaults to the property
                namel</p></td></tr><tr><td>name</td><td><p>The name of a JavaBeans style property of Java type Date or Timestamp of the persistent
                class.</p></td></tr><tr><td>access</td><td><p>The strategy Hibernate uses to access the property value. Optional, defaults to
                <code class="literal">property</code>.</p></td></tr><tr><td>unsaved-value</td><td><p>A version property which indicates than instance is newly
                instantiated, and unsaved. This distinguishes it from detached instances that were saved or loaded in a
                previous session. The default value of <code class="literal">undefined</code> indicates that Hibernate uses the
                identifier property value.</p></td></tr><tr><td>source</td><td><p>Whether Hibernate retrieves the timestamp from the database or the current
                JVM. Database-based timestamps incur an overhead because Hibernate needs to query the database each time
                to determine the incremental next value. However, database-derived timestamps are safer to use in a
                clustered environment. Not all database dialects are known to support the retrieval of the database's
                current timestamp. Others may also be unsafe for locking, because of lack of precision.</p></td></tr><tr><td>generated</td><td><p>Whether the timestamp property value is generated by the database. Optional, defaults to
                <code class="literal">never</code>.</p></td></tr></tbody></table>
        </div>
      </div></a></div><a id="d5e1255"><br class="example-break">
    </a></div><a id="d5e1255">

  </a></div><a id="d5e1255">
  
  </a><div class="section" title="8.2.&nbsp;Pessimistic"><a id="d5e1255"></a><div class="titlepage"><a id="d5e1255"></a><div><a id="d5e1255"></a><div><a id="d5e1255"></a><h2 class="title"><a id="d5e1255"></a><a id="d5e1289">8.2.&nbsp;Pessimistic</a></h2></div></div></div><a id="d5e1289">
    
    <p>
      Typically, you only need to specify an isolation level for the JDBC connections and let the database handle
      locking issues. If you do need to obtain exclusive pessimistic locks or re-obtain locks at the start of a new
      transaction, Hibernate gives you the tools you need.
    </p>
    <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2>
      <p>
        Hibernate always uses the locking mechanism of the database, and never lock objects in memory.
      </p>
    </div>
    </a><div class="section" title="8.2.1.&nbsp;The LockMode class"><a id="d5e1289"></a><div class="titlepage"><a id="d5e1289"></a><div><a id="d5e1289"></a><div><a id="d5e1289"></a><h3 class="title"><a id="d5e1289"></a><a id="d5e1294">8.2.1.&nbsp;The <code class="classname">LockMode</code> class</a></h3></div></div></div><a id="d5e1294">
      
      <p>
        The <code class="classname">LockMode</code> class defines the different lock levels that Hibernate can acquire.
      </p>
      <div class="informaltable">
        <table border="1"><colgroup><col><col></colgroup><tbody><tr><td>LockMode.WRITE</td><td><p>acquired automatically when Hibernate updates or inserts a row.</p></td></tr><tr><td>LockMode.UPGRADE</td><td><p>acquired upon explicit user request using <code class="code">SELECT ... FOR UPDATE</code> on databases
              which support that syntax.</p></td></tr><tr><td>LockMode.UPGRADE_NOWAIT</td><td><p>acquired upon explicit user request using a <code class="code">SELECT ... FOR UPDATE NOWAIT</code> in
              Oracle.</p></td></tr><tr><td>LockMode.UPGRADE_SKIPLOCKED</td><td><p>acquired upon explicit user request using a <code class="code">SELECT ... FOR UPDATE SKIP LOCKED</code> in
              Oracle, or <code class="code">SELECT ... with (rowlock,updlock,readpast) in SQL Server</code>.</p></td></tr><tr><td>LockMode.READ</td><td><p>acquired automatically when Hibernate reads data under <span>Repeatable Read</span> or
              <span>Serializable</span> isolation level. It can be re-acquired by explicit user
              request.</p></td></tr><tr><td>LockMode.NONE</td><td><p>The absence of a lock. All objects switch to this lock mode at the end of a
              Transaction. Objects associated with the session via a call to <code class="methodname">update()</code> or
              <code class="methodname">saveOrUpdate()</code> also start out in this lock mode. </p></td></tr></tbody></table>
      </div>
      <p>
        The explicit user request mentioned above occurs as a consequence of any of the following actions:
      </p>
      <div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
          <p>
            A call to <code class="methodname">Session.load()</code>, specifying a LockMode.
          </p>
        </li><li class="listitem">
          <p>
            A call to <code class="methodname">Session.lock()</code>.
          </p>
        </li><li class="listitem">
          <p>
            A call to <code class="methodname">Query.setLockMode()</code>.
          </p>
        </li></ul></div>
      <p>
        If you call <code class="methodname">Session.load()</code> with option <code class="option">UPGRADE</code>,
        <code class="option">UPGRADE_NOWAIT</code> or <code class="option">UPGRADE_SKIPLOCKED</code>, and the requested object is not already
        loaded by the session, the object is loaded using <code class="code">SELECT ... FOR UPDATE</code>. If you call 
        <code class="methodname">load()</code> for an object that is already loaded with a less restrictive lock than the one 
        you request, Hibernate calls <code class="methodname">lock()</code> for that object.
      </p>
      <p>
        <code class="methodname">Session.lock()</code> performs a version number check if the specified lock mode is
        <code class="literal">READ</code>, <code class="literal">UPGRADE</code>, <code class="literal">UPGRADE_NOWAIT</code> or 
        <code class="literal">UPGRADE_SKIPLOCKED</code>. In the case of <code class="literal">UPGRADE</code>, 
        <code class="literal">UPGRADE_NOWAIT</code> or <code class="literal">UPGRADE_SKIPLOCKED</code>, <code class="code">SELECT ... FOR UPDATE</code> 
	syntax is used.
      </p>
      <p>
        If the requested lock mode is not supported by the database, Hibernate uses an appropriate alternate mode
        instead of throwing an exception. This ensures that applications are portable.
      </p>
    </a></div><a id="d5e1294">
  </a></div><a id="d5e1294">
</a><div class="footnotes"><a id="d5e1294"><br><hr width="100" align="left"></a><div class="footnote"><a id="d5e1294"></a><p><a id="d5e1294"><sup>[</sup></a><a id="ftn.d5e1153" href="#d5e1153" class="para">1</a>] <a class="ulink" href="http://en.wikipedia.org/wiki/Optimistic_locking">http://en.wikipedia.org/wiki/Optimistic_locking</a></p></div></div></div>
    <div class="chapter" title="Chapter&nbsp;9.&nbsp;Fetching"><div class="titlepage"><div><div><h2 class="title"><a id="fetching">Chapter&nbsp;9.&nbsp;Fetching</a></h2></div></div></div><div class="toc"><p><a id="fetching"><strong>Table of Contents</strong></a></p><dl><dt><a id="fetching"><span class="section"></span></a><a href="#d5e1367">9.1. The basics</a></dt><dt><span class="section"><a href="#d5e1418">9.2. Applying fetch strategies</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e1428">9.2.1. No fetching</a></span></dt><dt><span class="section"><a href="#d5e1440">9.2.2. Dynamic fetching via queries</a></span></dt><dt><span class="section"><a href="#d5e1449">9.2.3. Dynamic fetching via profiles</a></span></dt></dl></dd></dl></div>
    

    
    
    

    <p>
        Fetching, essentially, is the process of grabbing data from the database and making it available to the
        application.  Tuning how an application does fetching is one of the biggest factors in determining how an
        application will perform.  Fetching too much data, in terms of width (values/columns) and/or
        depth (results/rows), adds unnecessary overhead in terms of both JDBC communication and ResultSet processing.
        Fetching too little data causes additional fetches to be needed.  Tuning how an application
        fetches data presents a great opportunity to influence the application's overall performance.
    </p>

    <div class="section" title="9.1.&nbsp;The basics"><div class="titlepage"><div><div><h2 class="title"><a id="d5e1367">9.1.&nbsp;The basics</a></h2></div></div></div><a id="d5e1367">
        

        <p>
            The concept of fetching breaks down into two different questions.
            </p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
                    <p>
                        When should the data be fetched?  Now?  Later?
                    </p>
                </li><li class="listitem">
                    <p>
                        How should the data be fetched?
                    </p>
                </li></ul></div><p>
        </p>

        <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2>
            <p>
                "now" is generally termed <span>eager</span> or <span>immediate</span>.  "later" is
                generally termed <span>lazy</span> or <span>delayed</span>.
            </p>
        </div>

        <p>
            There are a number of scopes for defining fetching:
            </p></a><div class="itemizedlist"><a id="d5e1367"></a><ul class="itemizedlist"><a id="d5e1367"></a><li class="listitem"><a id="d5e1367">
                    </a><p><a id="d5e1367">
                        <span class="emphasis"><em>static</em></span> - Static definition of fetching strategies is done in the
                        mappings.  The statically-defined fetch strategies is used in the absence of any dynamically
                        defined strategies <sup>[</sup></a><a id="d5e1386" href="#ftn.d5e1386" class="footnote">2</a>].
                    </p>
                </li><li class="listitem">
                    <p>
                        <span class="emphasis"><em>dynamic</em></span> (sometimes referred to as runtime) - Dynamic definition is
                        really use-case centric.  There are 2 main ways to define dynamic fetching:
                    </p>
                    <div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
                            <p>
                                <span class="emphasis"><em>fetch profiles</em></span> - defined in mappings, but can be
                                enabled/disabled on the Session.
                            </p>
                        </li><li class="listitem">
                            <p>
                                HQL/JPQL and both Hibernate and JPA Criteria queries have the ability to specify
                                fetching, specific to said query.
                            </p>
                        </li></ul></div>
                </li><li class="listitem">
                    <p>
                        Starting in Hibernate 4.2 (JPA 2.1) you can also use JPA EntityGraphs.
                    </p>
                </li></ul></div><p>
        </p>

        <div class="variablelist" title="The strategies"><p class="title"><strong>The strategies</strong></p><dl><dt><span class="term">SELECT</span></dt><dd>
                    <p>
                        Performs a separate SQL select to load the data.  This can either be EAGER (the second select
                        is issued immediately) or LAZY (the second select is delayed until the data is needed).  This
                        is the strategy generally termed <span>N+1</span>.
                    </p>
                </dd><dt><span class="term">JOIN</span></dt><dd>
                    <p>
                        Inherently an EAGER style of fetching.  The data to be fetched is obtained through the use of
                        an SQL join.
                    </p>
                </dd><dt><span class="term">BATCH</span></dt><dd>
                    <p>
                        Performs a separate SQL select to load a number of related data items using an
                        IN-restriction as part of the SQL WHERE-clause based on a batch size.  Again, this can either
                        be EAGER (the second select is issued immediately) or LAZY (the second select is delayed until
                        the data is needed).
                    </p>
                </dd><dt><span class="term">SUBSELECT</span></dt><dd>
                    <p>
                        Performs a separate SQL select to load associated data based on the SQL restriction used to
                        load the owner.  Again, this can either be EAGER (the second select is issued immediately)
                        or LAZY (the second select is delayed until the data is needed).
                    </p>
                </dd></dl></div>
    </div>

    <div class="section" title="9.2.&nbsp;Applying fetch strategies"><div class="titlepage"><div><div><h2 class="title"><a id="d5e1418">9.2.&nbsp;Applying fetch strategies</a></h2></div></div></div><a id="d5e1418">
        

        <p>
            Let's consider these topics as it relates to an simple domain model and a few use cases.
        </p>

        </a><div class="example"><a id="d5e1418"></a><a id="d5e1421"><p class="title"><strong>Example&nbsp;9.1.&nbsp;Sample domain model</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">@Entity
public class Employee {
	@Id
	private Long id;

	@NaturalId
	private String userid;

	@Column( name="pswd" )
	@ColumnTransformer( read="decrypt(pswd)" write="encrypt(?)" )
	private String password;

	private int accessLevel;

	@ManyToOne( fetch=LAZY )
	@JoinColumn
	private Department department;

	@ManyToMany(mappedBy="employees")
	@JoinColumn
	private Set&lt;Project&gt; projects;

	...
}</pre>
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">@Entity
public class Department {
	@Id
	private Long id;

	@OneToMany(mappedBy="department")
	private List&lt;Employees&gt; employees;

	...
}</pre>
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">@Entity
public class Project {
	@Id
	private Long id;

	@ManyToMany
	private Set&lt;Employee&gt; employees;

	...
}</pre>
        </div></a></div><a id="d5e1421"><br class="example-break">

        <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Important</h2>
            <p>
                The Hibernate recommendation is to statically mark all associations lazy and to use dynamic fetching
                strategies for eagerness.  This is unfortunately at odds with the JPA specification which defines that
                all one-to-one and many-to-one associations should be eagerly fetched by default.  Hibernate, as a JPA
                provider, honors that default.
            </p>
        </div>

        </a><div class="section" title="9.2.1.&nbsp;No fetching"><a id="d5e1421"></a><div class="titlepage"><a id="d5e1421"></a><div><a id="d5e1421"></a><div><a id="d5e1421"></a><h3 class="title"><a id="d5e1421"></a><a id="d5e1428">9.2.1.&nbsp;No fetching</a></h3></div><div><h4 class="subtitle"><a id="d5e1428">The login use-case</a></h4></div></div></div><a id="d5e1428">
            
            
            <p>
                For the first use case, consider the application's login process for an Employee.  Lets assume that
                login only requires access to the Employee information, not Project nor Department information.
            </p>

            </a><div class="example"><a id="d5e1428"></a><a id="d5e1432"><p class="title"><strong>Example&nbsp;9.2.&nbsp;No fetching example</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">String loginHql = "select e from Employee e where e.userid = :userid and e.password = :password";
Employee employee = (Employee) session.createQuery( loginHql )
        ...
        .uniqueResult();
</pre>
            </div></a></div><a id="d5e1432"><br class="example-break">

            <p>
                In this example, the application gets the Employee data.  However, because all associations from
                Employee are declared as LAZY (JPA defines the default for collections as LAZY) no other data is
                fetched.
            </p>

            <p>
                If the login process does not need access to the Employee information specifically, another
                fetching optimization here would be to limit the width of the query results.
            </p>

            </a><div class="example"><a id="d5e1432"></a><a id="d5e1437"><p class="title"><strong>Example&nbsp;9.3.&nbsp;No fetching (scalar) example</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">String loginHql = "select e.accessLevel from Employee e where e.userid = :userid and e.password = :password";
Employee employee = (Employee) session.createQuery( loginHql )
        ...
        .uniqueResult();
</pre>
            </div></a></div><a id="d5e1437"><br class="example-break">
        </a></div><a id="d5e1437">

        </a><div class="section" title="9.2.2.&nbsp;Dynamic fetching via queries"><a id="d5e1437"></a><div class="titlepage"><a id="d5e1437"></a><div><a id="d5e1437"></a><div><a id="d5e1437"></a><h3 class="title"><a id="d5e1437"></a><a id="d5e1440">9.2.2.&nbsp;Dynamic fetching via queries</a></h3></div><div><h4 class="subtitle"><a id="d5e1440">The projects for an employee use-case</a></h4></div></div></div><a id="d5e1440">
            
            

            <p>
                For the second use case, consider a screen displaying the Projects for an Employee.  Certainly access
                to the Employee is needed, as is the collection of Projects for that Employee.  Information
                about Departments, other Employees or other Projects is not needed.
            </p>

            </a><div class="example"><a id="d5e1440"></a><a id="d5e1444"><p class="title"><strong>Example&nbsp;9.4.&nbsp;Dynamic query fetching example</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">String userid = ...;
String hql = "select e from Employee e join fetch e.projects where e.userid = :userid";
Employee e = (Employee) session.createQuery( hql )
        .setParameter( "userid", userid )
        .uniqueResult();
</pre>
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">String userid = ...;
CriteriaBuilder cb = entityManager.getCriteriaBuilder();
CriteriaQuery&lt;Employee&gt; criteria = cb.createQuery( Employee.class );
Root&lt;Employee&gt; root = criteria.from( Employee.class );
root.fetch( Employee_.projects );
criteria.select( root );
criteria.where(
	cb.equal( root.get( Employee_.userid ), cb.literal( userid ) )
);
Employee e = entityManager.createQuery( criteria ).getSingleResult();
</pre>
            </div></a></div><a id="d5e1444"><br class="example-break">

            <p>
                In this example we have an Employee and their Projects loaded in a single query shown both as an HQL
                query and a JPA Criteria query.  In both cases, this resolves to exactly one database query to get all
                that information.
            </p>
        </a></div><a id="d5e1444">

        </a><div class="section" title="9.2.3.&nbsp;Dynamic fetching via profiles"><a id="d5e1444"></a><div class="titlepage"><a id="d5e1444"></a><div><a id="d5e1444"></a><div><a id="d5e1444"></a><h3 class="title"><a id="d5e1444"></a><a id="d5e1449">9.2.3.&nbsp;Dynamic fetching via profiles</a></h3></div><div><h4 class="subtitle"><a id="d5e1449">The projects for an employee use-case using natural-id</a></h4></div></div></div><a id="d5e1449">
            
            

            <p>
                Suppose we wanted to leverage loading by natural-id to obtain the Employee information in the
                "projects for and employee" use-case.  Loading by natural-id uses the statically defined fetching
                strategies, but does not expose a means to define load-specific fetching.  So we would leverage a
                fetch profile.
            </p>

            </a><div class="example"><a id="d5e1449"></a><a id="d5e1453"><p class="title"><strong>Example&nbsp;9.5.&nbsp;Fetch profile example</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">@FetchProfile(
	name="employee.projects",
	fetchOverrides={
		@FetchOverride(
			entity=Employee.class,
			association="projects",
			mode=JOIN
		)
	}
)</pre>
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">String userid = ...;
session.enableFetchProfile( "employee.projects" );
Employee e = (Employee) session.bySimpleNaturalId( Employee.class )
		.load( userid );</pre>
            </div></a></div><a id="d5e1453"><br class="example-break">

            <p>
                Here the Employee is obtained by natural-id lookup and the Employee's Project data is fetched eagerly.
                If the Employee data is resolved from cache, the Project data is resolved on its own.  However,
                if the Employee data is not resolved in cache, the Employee and Project data is resolved in one
                SQL query via join as we saw above.
            </p>
        </a></div><a id="d5e1453">
    </a></div><a id="d5e1453">

</a><div class="footnotes"><a id="d5e1453"><br><hr width="100" align="left"></a><div class="footnote"><a id="d5e1453"></a><p><a id="d5e1453"><sup>[</sup></a><a id="ftn.d5e1386" href="#d5e1386" class="para">2</a>] Except in the case of HQL/JPQL; see xyz</p></div></div></div>
    <div class="chapter" title="Chapter&nbsp;10.&nbsp;Batching"><div class="titlepage"><div><div><h2 class="title"><a id="batch">Chapter&nbsp;10.&nbsp;Batching</a></h2></div></div></div><div class="toc"><p><a id="batch"><strong>Table of Contents</strong></a></p><dl><dt><a id="batch"><span class="section"></span></a><a href="#batch-jdbcbatch">10.1. JDBC batching</a></dt></dl></div>
    

    <p>
        First we need to decide what all to discuss here as that phrase has so many connotations. Do we cover
        </p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">JDBC batch updates?</li><li class="listitem">Session w/ incremental flushing?</li><li class="listitem">StatelessSession?</li><li class="listitem">Java EE batching?</li><li class="listitem">Any/all of the above?</li><li class="listitem">Others?</li></ul></div><p>
    </p>

    <div class="section" title="10.1.&nbsp;JDBC batching"><div class="titlepage"><div><div><h2 class="title"><a id="batch-jdbcbatch">10.1.&nbsp;JDBC batching</a></h2></div></div></div><a id="batch-jdbcbatch">
        

        <p>
            JDBC offers support for batching together SQL statements that can be represented
            as a single PreparedStatement.  Implementation wise this generally means that drivers
            will send the batched operation to the server in one call, which can save on network calls
            to the database.  Hibernate can leverage JDBC batching.  The following settings control this
            behavior.
        </p>

        <div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
                <p>
                    <code class="literal">hibernate.jdbc.batch_size</code> - Controls the maximum number of
                    statements Hibernate will batch together before asking the driver to execute
                    the batch.  Zero or a negative number disables this feature.
                </p>
            </li><li class="listitem">
                <p>
                    <code class="literal">hibernate.jdbc.batch_versioned_data</code> - Some JDBC drivers
                    return incorrect row counts when a batch is executed.  If your JDBC driver
                    falls into this category this setting should be set to <code class="literal">false</code>.
                    Otherwise it is safe to enable this which will allow Hibernate to still
                    batch the DML for versioned entities and still use the returned row counts for
                    optimitic lock checks.  Currently defaults to false to be safe.
                </p>
            </li><li class="listitem">
                <p>
                    <code class="literal">hibernate.jdbc.batch.builder</code> - Names the implementation class
                    used to manage batching capabilities.  It is almost never a good idea to switch from
                    Hibernate's default implementation.  But if you wish to, this setting would name the
                    <code class="interfacename">org.hibernate.engine.jdbc.batch.spi.BatchBuilder</code>
                    implementation to use.
                </p>
            </li><li class="listitem">
                <p>
                    <code class="literal">hibernate.order_update</code> - Forces Hibernate to order SQL updates by the
                    entity type and the primary key value of the items being updated. This allows for more batching
                    to be used.  It will also result in fewer transaction deadlocks in highly concurrent systems.
                    Comes with a performance hit, so benchmark before and after to see if this actually helps or
                    hurts your application.
                </p>
            </li><li class="listitem">
                <p>
                    <code class="literal">hibernate.order_inserts</code> - Forces Hibernate to order inserts to allow for
                    more batching to be used.  Comes with a performance hit, so benchmark before and after to see
                    if this actually helps or hurts your application.
                </p>
            </li></ul></div>
    </a></div><a id="batch-jdbcbatch">
</a></div><a id="batch-jdbcbatch">
    </a><div class="chapter" title="Chapter&nbsp;11.&nbsp;Caching"><a id="batch-jdbcbatch"></a><div class="titlepage"><a id="batch-jdbcbatch"></a><div><a id="batch-jdbcbatch"></a><div><a id="batch-jdbcbatch"></a><h2 class="title"><a id="batch-jdbcbatch"></a><a id="caching">Chapter&nbsp;11.&nbsp;Caching</a></h2></div></div></div><div class="toc"><p><a id="caching"><strong>Table of Contents</strong></a></p><dl><dt><a id="caching"><span class="section"></span></a><a href="#caching-config">11.1. Configuring second-level caching</a></dt><dd><dl><dt><span class="section"><a href="#caching-config-provider">11.1.1. RegionFactory</a></span></dt><dt><span class="section"><a href="#caching-config-behavior">11.1.2. Caching behavior</a></span></dt></dl></dd><dt><span class="section"><a href="#caching-management">11.2. Managing the Cached Data</a></span></dt></dl></div>
    

    <div class="section" title="11.1.&nbsp;Configuring second-level caching"><div class="titlepage"><div><div><h2 class="title"><a id="caching-config">11.1.&nbsp;Configuring second-level caching</a></h2></div></div></div><a id="caching-config">
        

        <p>
            Hibernate defines the ability to integrate with pluggable providers for the purpose of
            caching data outside the context of a particular Session.  This section defines
            the settings which control that behavior.
        </p>

        </a><div class="section" title="11.1.1.&nbsp;RegionFactory"><a id="caching-config"></a><div class="titlepage"><a id="caching-config"></a><div><a id="caching-config"></a><div><a id="caching-config"></a><h3 class="title"><a id="caching-config"></a><a id="caching-config-provider">11.1.1.&nbsp;RegionFactory</a></h3></div></div></div><a id="caching-config-provider">
            

            <p>
                <code class="interfacename">org.hibernate.cache.spi.RegionFactory</code> defines the integration
                between Hibernate and a pluggable caching provider.  <code class="literal">hibernate.cache.region.factory_class</code>
                is used to declare the provider to use.  Hibernate comes with support for 2 popular caching
                libraries: Ehcache and Infinispan.
            </p>

            </a><div class="section" title="11.1.1.1.&nbsp;Ehcache"><a id="caching-config-provider"></a><div class="titlepage"><a id="caching-config-provider"></a><div><a id="caching-config-provider"></a><div><a id="caching-config-provider"></a><h4 class="title"><a id="caching-config-provider"></a><a id="caching-config-provider-ehcache">11.1.1.1.&nbsp;Ehcache</a></h4></div></div></div><a id="caching-config-provider-ehcache">
                
                <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Important</h2>
                    <p>
                        Use of the build-in integration for Ehcache requires that the hibernate-ehcache module
                        jar (and all of its dependencies) are on the classpath.
                    </p>
                </div>
                <p>
                    The hibernate-ehcache module defines 2 specific providers:
                    </p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
                            <p>
                                
                                <code class="literal">ehcache</code> - todo : document
                            </p>
                        </li><li class="listitem">
                            <p>
                                
                                <code class="literal">ehcache-singleton</code> - todo : document
                            </p>
                        </li></ul></div><p>
                </p>
            </a></div><a id="caching-config-provider-ehcache">

            </a><div class="section" title="11.1.1.2.&nbsp;Infinispan"><a id="caching-config-provider-ehcache"></a><div class="titlepage"><a id="caching-config-provider-ehcache"></a><div><a id="caching-config-provider-ehcache"></a><div><a id="caching-config-provider-ehcache"></a><h4 class="title"><a id="caching-config-provider-ehcache"></a><a id="caching-config-provider-infinispan">11.1.1.2.&nbsp;Infinispan</a></h4></div></div></div><a id="caching-config-provider-infinispan">
                
                <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Important</h2>
                    <p>
                        Use of the build-in integration for Infinispan requires that the hibernate-infinispan module
                        jar (and all of its dependencies) are on the classpath.
                    </p>
                </div>
                <p>
                    The hibernate-infinispan module defines 2 specific providers:
                    </p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
                            <p>
                                
                                <code class="literal">infinispan</code> - todo : document
                            </p>
                        </li><li class="listitem">
                            <p>
                                
                                <code class="literal">infinispan-jndi</code> - todo : document
                            </p>
                        </li></ul></div><p>
                </p>
            </a></div><a id="caching-config-provider-infinispan">
        </a></div><a id="caching-config-provider-infinispan">

        </a><div class="section" title="11.1.2.&nbsp;Caching behavior"><a id="caching-config-provider-infinispan"></a><div class="titlepage"><a id="caching-config-provider-infinispan"></a><div><a id="caching-config-provider-infinispan"></a><div><a id="caching-config-provider-infinispan"></a><h3 class="title"><a id="caching-config-provider-infinispan"></a><a id="caching-config-behavior">11.1.2.&nbsp;Caching behavior</a></h3></div></div></div><a id="caching-config-behavior">
            

            <p>
                Besides specific provider configuration, there are a number of configurations options on the
                Hibernate side of the integration that control various caching behavior:
                </p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
                        <p>
                            <code class="literal">hibernate.cache.use_second_level_cache</code> - Enable or disable
                            second level caching overall.  Default is true.
                        </p>
                    </li><li class="listitem">
                        <code class="literal">hibernate.cache.use_query_cache</code> - Enable or disable second level
                        caching of query results.  Default is false.
                    </li><li class="listitem">
                        <code class="literal">hibernate.cache.query_cache_factory</code> - Query result caching is
                        handled by a special contract that deals with staleness-based invalidation of the results.
                        The default implementation does not allow stale results at all.  Use this for applications
                        that would like to relax that.  Names an implementation of
                        <code class="interfacename">org.hibernate.cache.spi.QueryCacheFactory</code>
                    </li><li class="listitem">
                        <code class="literal">hibernate.cache.use_minimal_puts</code> - Optimizes second-level cache
                        operations to minimize writes, at the cost of more frequent reads.  Providers typically
                        set this appropriately.
                    </li><li class="listitem">
                        <code class="literal">hibernate.cache.region_prefix</code> - Defines a name to be used as a prefix to
                        all second-level cache region names.
                    </li><li class="listitem">
                        <code class="literal">hibernate.cache.default_cache_concurrency_strategy</code> - In Hibernate
                        second-level caching, all regions can be configured differently including the concurrency
                        strategy to use when accessing the region.  This setting allows to define a default strategy to
                        be used.  This setting is very rarely required as the pluggable providers do specify the
                        default strategy to use.  Valid values include: <code class="literal">read-only</code>,
                        <code class="literal">read-write</code>, <code class="literal">nonstrict-read-write</code>,
                        <code class="literal">transactional</code>.
                    </li><li class="listitem">
                        <code class="literal">hibernate.cache.use_structured_entries</code> - If <code class="literal">true</code>,
                        forces Hibernate to store data in the second-level cache in a more human-friendly format.
                        Can be useful if you'd like to be able to "browse" the data directly in your cache, but does
                        have a performance impact.
                    </li><li class="listitem">
                        <code class="literal">hibernate.cache.auto_evict_collection_cache</code> - Enables or disables the
                        automatic eviction of a bi-directional association's collection cache entry when the association
                        is changed just from the owning side.  This is disabled by default, as it has a performance
                        impact to track this state.  However if your application does not manage both sides
                        of bi-directional association where the collection side is cached, the alternative is to
                        have stale data in that collection cache.
                    </li></ul></div><p>
            </p>
        </a></div><a id="caching-config-behavior">
    </a></div><a id="caching-config-behavior">

    </a><div class="section" title="11.2.&nbsp;Managing the Cached Data"><a id="caching-config-behavior"></a><div class="titlepage"><a id="caching-config-behavior"></a><div><a id="caching-config-behavior"></a><div><a id="caching-config-behavior"></a><h2 class="title"><a id="caching-config-behavior"></a><a id="caching-management">11.2.&nbsp;Managing the Cached Data</a></h2></div></div></div><a id="caching-management">
        

        <p>
            At runtime Hibernate handles moving data into and out of the second-level cache
            in response to the operations performed by the Session.
        </p>

        

        <p>
            The <code class="interfacename">org.hibernate.Cache</code> interface (or the <code class="interfacename">javax.persistence.Cache</code>
            interface if using JPA) allow to clear data from the second-level cache.
        </p>
    </a></div><a id="caching-management">
</a></div><a id="caching-management">
    </a><div class="chapter" title="Chapter&nbsp;12.&nbsp;Interceptors and events"><a id="caching-management"></a><div class="titlepage"><a id="caching-management"></a><div><a id="caching-management"></a><div><a id="caching-management"></a><h2 class="title"><a id="caching-management"></a><a id="events">Chapter&nbsp;12.&nbsp;Interceptors and events</a></h2></div></div></div><div class="toc"><p><a id="events"><strong>Table of Contents</strong></a></p><dl><dt><a id="events"><span class="section"></span></a><a href="#d5e1559">12.1. Interceptors</a></dt><dt><span class="section"><a href="#d5e1578">12.2. Native Event system</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e1599">12.2.1. Hibernate declarative security</a></span></dt></dl></dd><dt><span class="section"><a href="#d5e1611">12.3. JPA Callbacks</a></span></dt></dl></div>

    

    <p>
        It is useful for the application to react to certain events that occur inside Hibernate. This allows for the
        implementation of generic functionality and the extension of Hibernate functionality.
    </p>

    <div class="section" title="12.1.&nbsp;Interceptors"><div class="titlepage"><div><div><h2 class="title"><a id="d5e1559">12.1.&nbsp;Interceptors</a></h2></div></div></div><a id="d5e1559">
        

        <p>
            The <code class="interfacename">org.hibernate.Interceptor</code> interface provides callbacks from the session
            to the application, allowing the application to inspect and/or manipulate properties of a persistent object
            before it is saved, updated, deleted or loaded.  One possible use for this is to track auditing information.
            For example, the following example shows an <code class="interfacename">Interceptor</code> implementation
            that automatically sets the <code class="literal">createTimestamp</code> property when an
            <code class="interfacename">Auditable</code> entity is created and updates the
            <code class="literal">lastUpdateTimestamp</code> property when an <code class="interfacename">Auditable</code> entity is
            updated.
        </p>

        <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2>
            <p>
                You can either implement <code class="interfacename">Interceptor</code> directly or extend
                <code class="classname">org.hibernate.EmptyInterceptor</code>.
            </p>
        </div>

        <p>
            An Interceptor can be either Session-scoped or SessionFactory-scoped.
        </p>

        <p>
            A Session-scoped interceptor is specified when a session is opened.
        </p>

        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Session session = sf.withOptions().interceptor( new AuditInterceptor() ).openSession();
</pre>

        <p>
            A SessionFactory-scoped interceptor is registered with the <code class="classname">Configuration</code> object
            prior to building the SessionFactory.  Unless a session is opened explicitly specifying the interceptor to
            use, the SessionFactory-scoped interceptor will be applied to all sessions opened from that SessionFactory.
            SessionFactory-scoped interceptors must be thread safe.  Ensure that you do not store session-specific
            states, since multiple sessions will use this interceptor potentially concurrently.
        </p>

        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">SessionFactory sessionFactory = new Configuration()
		.setInterceptor( new AuditInterceptor() )
		...
		.buildSessionFactory();</pre>

    </a></div><a id="d5e1559">

     </a><div class="section" title="12.2.&nbsp;Native Event system"><a id="d5e1559"></a><div class="titlepage"><a id="d5e1559"></a><div><a id="d5e1559"></a><div><a id="d5e1559"></a><h2 class="title"><a id="d5e1559"></a><a id="d5e1578">12.2.&nbsp;Native Event system</a></h2></div></div></div><a id="d5e1578">
        

        <p>
            If you have to react to particular events in the persistence layer, you can also use the Hibernate
            <span class="emphasis"><em>event</em></span> architecture.  The event system can be used in place of or in addition to
            interceptors.
        </p>

        <p>
            Many methods of the <code class="interfacename">Session</code> interface correlate to an event type.  The
            full range of defined event types is declared as enum values on
            <code class="classname">org.hibernate.event.spi.EventType</code>.  When a request is made of one of these methods,
            the Session generates an appropriate event and passes it to the configured event listener(s) for that type.
            Applications are free to implement a customization of one of the listener interfaces
            (i.e., the <code class="literal">LoadEvent</code> is processed by the registered implementation
            of the <code class="literal">LoadEventListener</code> interface), in which case their
            implementation would be responsible for processing any <code class="literal">load()</code> requests
            made of the <code class="literal">Session</code>.
        </p>

         </a><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><a id="d5e1578"><h2>Note</h2>
             </a><p><a id="d5e1578">
                 See </a><a class="xref" href="#">???</a> for information on registering custom event
                 listeners.
             </p>
         </div>

        <p>
            The listeners should be considered stateless; they are shared between requests, and should not save any
            state as instance variables.
        </p>

        <p>
            A custom listener implements the appropriate interface for the event it wants to process and/or extend one
            of the convenience base classes (or even the default event listeners used by Hibernate out-of-the-box as
            these are declared non-final for this purpose). Here is an example of a custom load event listener:
        </p>

         <div class="example"><a id="d5e1594"><p class="title"><strong>Example&nbsp;12.1.&nbsp;Custom LoadListener example</strong></p><div class="example-contents">
             
             <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">public class LoadListenerExample implements LoadEventListener {
    // this is the single method defined by the LoadEventListener interface
    public void onLoad(LoadEvent event, LoadEventListener.LoadType loadType)
            throws HibernateException {
        if ( !MySecurity.isAuthorized( event.getEntityClassName(), event.getEntityId() ) ) {
            throw MySecurityException("Unauthorized access");
        }
    }
}</pre>
         </div></a></div><a id="d5e1594"><br class="example-break">

         </a><div class="section" title="12.2.1.&nbsp;Hibernate declarative security"><a id="d5e1594"></a><div class="titlepage"><a id="d5e1594"></a><div><a id="d5e1594"></a><div><a id="d5e1594"></a><h3 class="title"><a id="d5e1594"></a><a id="d5e1599">12.2.1.&nbsp;Hibernate declarative security</a></h3></div></div></div><a id="d5e1599">
             
             <p>
                 Usually, declarative security in Hibernate applications is managed in a session facade
                 layer. Hibernate allows certain actions to be permissioned via JACC, and authorized
                 via JAAS. This is an optional functionality that is built on top of the event architecture.
             </p>

             </a><p><a id="d5e1599">
                 First, you must configure the appropriate event listeners, to enable the use of JACC authorization.
                 Again, see </a><a class="xref" href="#">???</a> for the details.  Below is an example of an
                 appropriate <code class="interfacename">org.hibernate.integrator.spi.Integrator</code> implementation for
                 this purpose.
             </p>

             <div class="example"><a id="d5e1605"><p class="title"><strong>Example&nbsp;12.2.&nbsp;JACC listener registration example</strong></p><div class="example-contents">
                 
                 <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">import org.hibernate.event.service.spi.DuplicationStrategy;
import org.hibernate.event.service.spi.EventListenerRegistry;
import org.hibernate.integrator.spi.Integrator;
import org.hibernate.secure.internal.JACCPreDeleteEventListener;
import org.hibernate.secure.internal.JACCPreInsertEventListener;
import org.hibernate.secure.internal.JACCPreLoadEventListener;
import org.hibernate.secure.internal.JACCPreUpdateEventListener;
import org.hibernate.secure.internal.JACCSecurityListener;

public class JaccEventListenerIntegrator implements Integrator {

	private static final DuplicationStrategy JACC_DUPLICATION_STRATEGY = new DuplicationStrategy() {
		@Override
		public boolean areMatch(Object listener, Object original) {
			return listener.getClass().equals( original.getClass() ) &amp;&amp;
					JACCSecurityListener.class.isInstance( original );
		}

		@Override
		public Action getAction() {
			return Action.KEEP_ORIGINAL;
		}
	};

	@Override
	@SuppressWarnings( {"unchecked"})
	public void integrate(
			Configuration configuration,
			SessionFactoryImplementor sessionFactory,
			SessionFactoryServiceRegistry serviceRegistry) {
		boolean isSecurityEnabled = configuration.getProperties().containsKey( AvailableSettings.JACC_ENABLED );
		if ( !isSecurityEnabled ) {
			return;
		}

		final EventListenerRegistry eventListenerRegistry = serviceRegistry.getService( EventListenerRegistry.class );
		eventListenerRegistry.addDuplicationStrategy( JACC_DUPLICATION_STRATEGY );

		final String jaccContextId = configuration.getProperty( Environment.JACC_CONTEXTID );
		eventListenerRegistry.prependListeners( EventType.PRE_DELETE, new JACCPreDeleteEventListener(jaccContextId) );
		eventListenerRegistry.prependListeners( EventType.PRE_INSERT, new JACCPreInsertEventListener(jaccContextId) );
		eventListenerRegistry.prependListeners( EventType.PRE_UPDATE, new JACCPreUpdateEventListener(jaccContextId) );
		eventListenerRegistry.prependListeners( EventType.PRE_LOAD, new JACCPreLoadEventListener(jaccContextId) );
	}
}</pre>
             </div></a></div><a id="d5e1605"><br class="example-break">

             <p>
                 You must also decide how to configure your JACC provider.  Consult your JACC provider documentation.
             </p>
         </a></div><a id="d5e1605">
    </a></div><a id="d5e1605">

    </a><div class="section" title="12.3.&nbsp;JPA Callbacks"><a id="d5e1605"></a><div class="titlepage"><a id="d5e1605"></a><div><a id="d5e1605"></a><div><a id="d5e1605"></a><h2 class="title"><a id="d5e1605"></a><a id="d5e1611">12.3.&nbsp;JPA Callbacks</a></h2></div></div></div><a id="d5e1611">
        
        <p>
            JPA also defines a more limited set of callbacks through annotations.
        </p>

        </a><div class="table"><a id="d5e1611"></a><a id="d5e1614"><p class="title"><strong>Table&nbsp;12.1.&nbsp;Callback annotations</strong></p><div class="table-contents">
            
            <table summary="Callback annotations" border="1"><colgroup><col><col></colgroup><thead><tr><th align="center">Type</th><th align="center">Description</th></tr></thead><tbody><tr><td>
                            @PrePersist
                        </td><td>
                            Executed before the entity manager persist operation is actually executed or cascaded.
                            This call is synchronous with the persist operation.
                        </td></tr><tr><td>
                            @PreRemove
                        </td><td>
                            Executed before the entity manager remove operation is actually executed or cascaded.
                            This call is synchronous with the remove operation.
                        </td></tr><tr><td>
                            @PostPersist
                        </td><td>
                            Executed after the entity manager persist operation is actually executed or cascaded.
                            This call is invoked after the database INSERT is executed.
                        </td></tr><tr><td>
                            @PostRemove
                        </td><td>
                            Executed after the entity manager remove operation is actually executed or cascaded.
                            This call is synchronous with the remove operation.
                        </td></tr><tr><td>
                            @PreUpdate
                        </td><td>
                            Executed before the database UPDATE operation.
                        </td></tr><tr><td>
                            @PostUpdate
                        </td><td>
                            Executed after the database UPDATE operation.
                        </td></tr><tr><td>
                            @PostLoad
                        </td><td>
                            Executed after an entity has been loaded into the current persistence context or an entity
                            has been refreshed.
                        </td></tr></tbody></table>
        </div></a></div><a id="d5e1614"><br class="table-break">

        <p>
            There are 2 available approaches defined for specifying callback handling:
        </p>
        <div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
                <p>
                    The first approach is to annotate methods on the entity itself to receive notification of
                    particular entity life cycle event(s).
                </p>
            </li><li class="listitem">
                <p>
                    The second is to use a separate entity listener class.  An entity listener is a stateless class
                    with a no-arg constructor.  The callback annotations are placed on a method of this class instead
                    of the entity class.  The entity listener class is then associated with the entity using the
                    <code class="interfacename">javax.persistence.EntityListeners</code> annotation
                </p>
            </li></ul></div>
        </a><div class="example"><a id="d5e1614"></a><a id="d5e1652"><p class="title"><strong>Example&nbsp;12.3.&nbsp;Example of specifying JPA callbacks</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">@Entity
@EntityListeners( LastUpdateListener.class )
public class Cat {
    @Id private Integer id;
    private String name;
    private Calendar dateOfBirth;
    @Transient private int age;
    private Date lastUpdate;
    //getters and setters

    /**
     * Set my transient property at load time based on a calculation,
     * note that a native Hibernate formula mapping is better for this purpose.
     */
    @PostLoad
    public void calculateAge() {
        Calendar birth = new GregorianCalendar();
        birth.setTime(dateOfBirth);
        Calendar now = new GregorianCalendar();
        now.setTime( new Date() );
        int adjust = 0;
        if ( now.get(Calendar.DAY_OF_YEAR) - birth.get(Calendar.DAY_OF_YEAR) &amp;lt; 0) {
            adjust = -1;
        }
        age = now.get(Calendar.YEAR) - birth.get(Calendar.YEAR) + adjust;
    }
}

public class LastUpdateListener {
    /**
     * automatic property set before any database persistence
     */
    @PreUpdate
    @PrePersist
    public void setLastUpdate(Cat o) {
        o.setLastUpdate( new Date() );
    }
}</pre>
        </div></a></div><a id="d5e1652"><br class="example-break">
        <p>
            These approaches can be mixed, meaning you can use both together.
        </p>
        <p>
            Regardless of whether the callback method is defined on the entity or on an entity listener, it must have
            a void-return signature.  The name of the method is irrelevant as it is the placement of the callback
            annotations that makes the method a callback.  In the case of callback methods defined on the
            entity class, the method must additionally have a no-argument signature.  For callback methods defined on
            an entity listener class, the method must have a single argument signature; the type of that argument can
            be either <code class="classname">java.lang.Object</code> (to facilitate attachment to multiple entities) or the
            specific entity type.
        </p>
        <p>
            A callback method can throw a <code class="classname">RuntimeException</code>.  If the callback method does
            throw a <code class="classname">RuntimeException</code>, then the current transaction, if any, must be rolled back.
        </p>
        <p>
            A callback method must not invoke <code class="interfacename">EntityManager</code> or
            <code class="interfacename">Query</code> methods!
        </p>
        <p>
            It is possible that multiple callback methods are defined for a particular lifecycle event.  When that
            is the case, the defined order of execution is well defined by the JPA spec (specifically section 3.5.4):
        </p>
        <div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
                <p>
                    Any default listeners associated with the entity are invoked first, in the order they were
                    specified in the XML.  See the <code class="interfacename">javax.persistence.ExcludeDefaultListeners</code>
                    annotation.
                </p>
            </li><li class="listitem">
                <p>
                    Next, entity listener class callbacks associated with the entity hierarchy are invoked, in the order
                    they are defined in the <code class="interfacename">EntityListeners</code>.  If multiple classes in the
                    entity hierarchy define entity listeners, the listeners defined for a superclass are invoked before
                    the listeners defined for its subclasses.  See the
                    <code class="interfacename">javax.persistence.ExcludeSuperclassListeners</code> annotation.
                </p>
            </li><li class="listitem">
                <p>
                    Lastly, callback methods defined on the entity hierarchy are invoked.  If a callback type is
                    annotated on both an entity and one or more of its superclasses without method overriding, both
                    would be called, the most general superclass first.  An entity class is also allowed to override
                    a callback method defined in a superclass in which case the super callback would not get invoked;
                    the overriding method would get invoked provided it is annotated.
                </p>
            </li></ul></div>
    </a></div><a id="d5e1652">

</a></div><a id="d5e1652">
    </a><div class="chapter" title="Chapter&nbsp;13.&nbsp;HQL and JPQL"><a id="d5e1652"></a><div class="titlepage"><a id="d5e1652"></a><div><a id="d5e1652"></a><div><a id="d5e1652"></a><h2 class="title"><a id="d5e1652"></a><a id="hql">Chapter&nbsp;13.&nbsp;HQL and JPQL</a></h2></div><div><div class="abstract" title="Abstract"><p class="title"><a id="hql"><strong>Abstract</strong></a></p><a id="hql">
            <p>Discuss syntax and execution of both HQL and JPQL</p>
        </a></div></div></div></div><div class="toc"><p><a id="hql"><strong>Table of Contents</strong></a></p><dl><dt><a id="hql"><span class="section"></span></a><a href="#d5e1698">13.1. Case Sensitivity</a></dt><dt><span class="section"><a href="#d5e1710">13.2. Statement types</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e1726">13.2.1. Select statements</a></span></dt><dt><span class="section"><a href="#d5e1739">13.2.2. Update statements</a></span></dt><dt><span class="section"><a href="#d5e1774">13.2.3. Delete statements</a></span></dt><dt><span class="section"><a href="#d5e1784">13.2.4. Insert statements</a></span></dt></dl></dd><dt><span class="section"><a href="#hql-from-clause">13.3. The <code class="literal">FROM</code> clause</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e1821">13.3.1. Identification variables</a></span></dt><dt><span class="section"><a href="#d5e1828">13.3.2. Root entity references</a></span></dt><dt><span class="section"><a href="#d5e1852">13.3.3. Explicit joins</a></span></dt><dt><span class="section"><a href="#d5e1895">13.3.4. Implicit joins (path expressions)</a></span></dt><dt><span class="section"><a href="#hql-collection-valued-associations">13.3.5. Collection member references</a></span></dt><dt><span class="section"><a href="#d5e1965">13.3.6. Polymorphism</a></span></dt></dl></dd><dt><span class="section"><a href="#hql-expressions">13.4. Expressions</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e1984">13.4.1. Identification variable</a></span></dt><dt><span class="section"><a href="#d5e1988">13.4.2. Path expressions</a></span></dt><dt><span class="section"><a href="#d5e1992">13.4.3. Literals</a></span></dt><dt><span class="section"><a href="#d5e2018">13.4.4. Parameters</a></span></dt><dt><span class="section"><a href="#d5e2041">13.4.5. Arithmetic</a></span></dt><dt><span class="section"><a href="#d5e2063">13.4.6. Concatenation (operation)</a></span></dt><dt><span class="section"><a href="#d5e2074">13.4.7. Aggregate functions</a></span></dt><dt><span class="section"><a href="#hql-exp-functions">13.4.8. Scalar functions</a></span></dt><dt><span class="section"><a href="#hql-collection-expressions">13.4.9. Collection-related expressions</a></span></dt><dt><span class="section"><a href="#hql-entity-type-exp">13.4.10. Entity type</a></span></dt><dt><span class="section"><a href="#d5e2273">13.4.11. CASE expressions</a></span></dt></dl></dd><dt><span class="section"><a href="#hql-select-clause">13.5. The <code class="literal">SELECT</code> clause</a></span></dt><dt><span class="section"><a href="#hql-conditional-expressions">13.6. Predicates</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e2335">13.6.1. Relational comparisons</a></span></dt><dt><span class="section"><a href="#d5e2350">13.6.2. Nullness predicate</a></span></dt><dt><span class="section"><a href="#d5e2356">13.6.3. Like predicate</a></span></dt><dt><span class="section"><a href="#d5e2378">13.6.4. Between predicate</a></span></dt><dt><span class="section"><a href="#d5e2384">13.6.5. In predicate</a></span></dt><dt><span class="section"><a href="#d5e2409">13.6.6. Exists predicate</a></span></dt><dt><span class="section"><a href="#d5e2412">13.6.7. Empty collection predicate</a></span></dt><dt><span class="section"><a href="#d5e2419">13.6.8. Member-of collection predicate</a></span></dt><dt><span class="section"><a href="#d5e2426">13.6.9. NOT predicate operator</a></span></dt><dt><span class="section"><a href="#d5e2430">13.6.10. AND predicate operator</a></span></dt><dt><span class="section"><a href="#d5e2434">13.6.11. OR predicate operator</a></span></dt></dl></dd><dt><span class="section"><a href="#hql-where-clause">13.7. The <code class="literal">WHERE</code> clause</a></span></dt><dt><span class="section"><a href="#hql-grouping">13.8. Grouping</a></span></dt><dt><span class="section"><a href="#hql-ordering">13.9. Ordering</a></span></dt><dt><span class="section"><a href="#hql-api">13.10. Query API</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e2482">13.10.1. Hibernate Query API</a></span></dt><dt><span class="section"><a href="#d5e2552">13.10.2. JPA Query API</a></span></dt></dl></dd></dl></div>

    

    <div class="sidebar" title="Related topics"><div class="titlepage"><div><div><p class="title"><strong>Related topics</strong></p></div></div></div>
        
        <div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
                <p><a class="xref" href="#">???</a></p>
            </li><li class="listitem">
                <p><a class="xref" href="#fetching" title="Chapter&nbsp;9.&nbsp;Fetching">Chapter&nbsp;9, <em>Fetching</em></a></p>
            </li><li class="listitem">
                <p><a class="xref" href="#pc" title="Chapter&nbsp;4.&nbsp;Persistence Contexts">Chapter&nbsp;4, <em>Persistence Contexts</em></a></p>
            </li></ul></div>
    </div>

    <p>
        The Hibernate Query Language (HQL) and Java Persistence Query Language (JPQL) are both object model
        focused query languages similar in nature to SQL.  JPQL is a heavily-inspired-by subset of HQL.  A JPQL
        query is always a valid HQL query, the reverse is not true however.
    </p>

    <p>
        Both HQL and JPQL are non-type-safe ways to perform query operations.  Criteria queries offer a
        type-safe approach to querying.  See <a class="xref" href="#criteria" title="Chapter&nbsp;14.&nbsp;Criteria">Chapter&nbsp;14, <em>Criteria</em></a> for more information.
    </p>

    <div class="section" title="13.1.&nbsp;Case Sensitivity"><div class="titlepage"><div><div><h2 class="title"><a id="d5e1698">13.1.&nbsp;Case Sensitivity</a></h2></div></div></div><a id="d5e1698">
        

        <p>
            With the exception of names of Java classes and properties, queries are case-insensitive.
            So <code class="literal">SeLeCT</code> is the same as <code class="literal">sELEct</code> is the same as
            <code class="literal">SELECT</code>, but
            <code class="literal">org.hibernate.eg.FOO</code> and <code class="literal">org.hibernate.eg.Foo</code> are different, as are
            <code class="literal">foo.barSet</code> and <code class="literal">foo.BARSET</code>.
        </p>

        <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2>
            <p>
                This documentation uses lowercase keywords as convention in examples.
            </p>
        </div>
    </a></div><a id="d5e1698">

    </a><div class="section" title="13.2.&nbsp;Statement types"><a id="d5e1698"></a><div class="titlepage"><a id="d5e1698"></a><div><a id="d5e1698"></a><div><a id="d5e1698"></a><h2 class="title"><a id="d5e1698"></a><a id="d5e1710">13.2.&nbsp;Statement types</a></h2></div></div></div><a id="d5e1710">
        
        <p>
            Both HQL and JPQL allow <code class="literal">SELECT</code>, <code class="literal">UPDATE</code> and <code class="literal">DELETE</code>
            statements to be performed.  HQL additionally allows <code class="literal">INSERT</code> statements, in a form
            similar to a SQL <code class="literal">INSERT-SELECT</code>.
        </p>

        <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Important</h2>
            <p>
                Care should be taken as to when a <code class="literal">UPDATE</code> or <code class="literal">DELETE</code> statement is
                executed.
            </p>
            <div class="blockquote"><table class="blockquote" summary="Block quote" cellpadding="0" cellspacing="0" width="100%" border="0"><tbody><tr><td valign="top" width="10%">&nbsp;</td><td valign="top" width="80%"><p>
                    Caution should be used when executing bulk update or delete operations because they may result in
                    inconsistencies between the database and the entities in the active persistence context. In general, bulk
                    update and delete operations should only be performed within a transaction in a new persistence con-
                    text or before fetching or accessing entities whose state might be affected by such operations.
                </p></td><td valign="top" width="10%">&nbsp;</td></tr><tr><td valign="top" width="10%">&nbsp;</td><td colspan="2" valign="top" align="right">--<span class="attribution"><em class="citetitle">Section 4.10 of the JPA 2.0 Specification</em></span></td></tr></tbody></table></div>
        </div>

        </a><div class="section" title="13.2.1.&nbsp;Select statements"><a id="d5e1710"></a><div class="titlepage"><a id="d5e1710"></a><div><a id="d5e1710"></a><div><a id="d5e1710"></a><h3 class="title"><a id="d5e1710"></a><a id="d5e1726">13.2.1.&nbsp;Select statements</a></h3></div></div></div><a id="d5e1726">
            
            <p>
                The BNF for <code class="literal">SELECT</code> statements in HQL is:
            </p>
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">select_statement :: =
        [select_clause]
        from_clause
        [where_clause]
        [groupby_clause]
        [having_clause]
        [orderby_clause]</pre>
            <p>
                The simplest possible HQL <code class="literal">SELECT</code> statement is of the form:
            </p>
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">from com.acme.Cat</pre>
            <p>
                The select statement in JPQL is exactly the same as for HQL except that JPQL requires a
                <code class="literal">select_clause</code>, whereas HQL does not.  Even though HQL does not require the presence
                of a <code class="literal">select_clause</code>, it is generally good practice to include one.  For simple queries
                the intent is clear and so the intended result of the <code class="literal">select_clause</code> is east to
                infer.  But on more complex queries that is not always the case.  It is usually better to explicitly
                specify intent.  Hibernate does not actually enforce that a <code class="literal">select_clause</code> be present
                even when parsing JPQL queries, however applications interested in JPA portability should take heed of
                this.
                
            </p>
        </a></div><a id="d5e1726">

        </a><div class="section" title="13.2.2.&nbsp;Update statements"><a id="d5e1726"></a><div class="titlepage"><a id="d5e1726"></a><div><a id="d5e1726"></a><div><a id="d5e1726"></a><h3 class="title"><a id="d5e1726"></a><a id="d5e1739">13.2.2.&nbsp;Update statements</a></h3></div></div></div><a id="d5e1739">
            
            <p>
                The BNF for <code class="literal">UPDATE</code> statements is the same in HQL and JPQL:
            </p>
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">update_statement ::= update_clause [where_clause]

update_clause ::= UPDATE entity_name [[AS] identification_variable]
        SET update_item {, update_item}*

update_item ::= [identification_variable.]{state_field | single_valued_object_field}
        = new_value

new_value ::= scalar_expression |
                simple_entity_expression |
                NULL
</pre>
            <p>
                <code class="literal">UPDATE</code> statements, by default, do not effect the <code class="literal">version</code>
                or the <code class="literal">timestamp</code> attribute values for the affected entities. However,
                you can force Hibernate to set the <code class="literal">version</code> or <code class="literal">timestamp</code> attribute
                values through the use of a <code class="literal">versioned update</code>.  This is achieved by adding the
                <code class="literal">VERSIONED</code> keyword after the <code class="literal">UPDATE</code> keyword.  Note, however, that
                this is a Hibernate specific feature and will not work in a portable manner.  Custom version types,
                <code class="interfacename">org.hibernate.usertype.UserVersionType</code>, are not allowed in conjunction
                with a <code class="literal">update versioned</code> statement.
            </p>
            <p>
                An <code class="literal">UPDATE</code> statement is executed using the <code class="methodname">executeUpdate</code>
                of either <code class="interfacename">org.hibernate.Query</code> or
                <code class="interfacename">javax.persistence.Query</code>.  The method is named for those familiar with
                the JDBC <code class="methodname">executeUpdate</code> on <code class="interfacename">java.sql.PreparedStatement</code>.
                The <code class="literal">int</code> value returned by the <code class="methodname">executeUpdate()</code> method
                indicates the number of entities effected by the operation.  This may or may not correlate to the number
                of rows effected in the database.  An HQL bulk operation might result in multiple actual SQL statements
                being executed (for joined-subclass, for example).  The returned number indicates the number of actual
                entities affected by the statement.  Using a JOINED inheritance hierarchy, a delete against one of the
                subclasses may actually result in deletes against not just the table to which that subclass is mapped,
                but also the "root" table and tables <span class="quote">“<span class="quote">in between</span>”</span>
            </p>
            </a><div class="example"><a id="d5e1739"></a><a id="d5e1765"><p class="title"><strong>Example&nbsp;13.1.&nbsp;Example UPDATE query statements</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">String hqlUpdate =
		"update Customer c " +
		"set c.name = :newName " +
		"where c.name = :oldName";
int updatedEntities = session.createQuery( hqlUpdate )
        .setString( "newName", newName )
        .setString( "oldName", oldName )
        .executeUpdate();
</pre>
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">String jpqlUpdate =
		"update Customer c " +
		"set c.name = :newName " +
		"where c.name = :oldName";
int updatedEntities = entityManager.createQuery( jpqlUpdate )
        .setString( "newName", newName )
        .setString( "oldName", oldName )
        .executeUpdate();
</pre>
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">String hqlVersionedUpdate =
		"update versioned Customer c " +
		"set c.name = :newName " +
		"where c.name = :oldName";
int updatedEntities = s.createQuery( hqlUpdate )
        .setString( "newName", newName )
        .setString( "oldName", oldName )
        .executeUpdate();</pre>
            </div></a></div><a id="d5e1765"><br class="example-break">
        </a></div><a id="d5e1765">

        <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Important</h2>
            <p>
                Neither <code class="literal">UPDATE</code> nor <code class="literal">DELETE</code> statements are allowed to
                result in what is called an implicit join.  Their form already disallows explicit joins.
            </p>
        </div>

        </a><div class="section" title="13.2.3.&nbsp;Delete statements"><a id="d5e1765"></a><div class="titlepage"><a id="d5e1765"></a><div><a id="d5e1765"></a><div><a id="d5e1765"></a><h3 class="title"><a id="d5e1765"></a><a id="d5e1774">13.2.3.&nbsp;Delete statements</a></h3></div></div></div><a id="d5e1774">
            
            <p>
                The BNF for <code class="literal">DELETE</code> statements is the same in HQL and JPQL:
            </p>
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">delete_statement ::= delete_clause [where_clause]

delete_clause ::= DELETE FROM entity_name [[AS] identification_variable]
</pre>
            <p>
                A <code class="literal">DELETE</code> statement is also executed using the <code class="methodname">executeUpdate</code>
                method of either <code class="interfacename">org.hibernate.Query</code> or
                <code class="interfacename">javax.persistence.Query</code>.
            </p>
        </a></div><a id="d5e1774">

        </a><div class="section" title="13.2.4.&nbsp;Insert statements"><a id="d5e1774"></a><div class="titlepage"><a id="d5e1774"></a><div><a id="d5e1774"></a><div><a id="d5e1774"></a><h3 class="title"><a id="d5e1774"></a><a id="d5e1784">13.2.4.&nbsp;Insert statements</a></h3></div></div></div><a id="d5e1784">
            
            <p>
                HQL adds the ability to define <code class="literal">INSERT</code> statements as well.  There is no JPQL
                equivalent to this.  The BNF for an HQL <code class="literal">INSERT</code> statement is:
            </p>
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">insert_statement ::= insert_clause select_statement

insert_clause ::= INSERT INTO entity_name (attribute_list)

attribute_list ::= state_field[, state_field ]*</pre>
            <p>
                The <code class="literal">attribute_list</code> is analogous to the <code class="literal">column specification</code> in the
                SQL <code class="literal">INSERT</code> statement.  For entities involved in mapped inheritance, only attributes
                directly defined on the named entity can be used in the <code class="literal">attribute_list</code>.  Superclass
                properties are not allowed and subclass properties do not make sense.  In other words,
                <code class="literal">INSERT</code> statements are inherently non-polymorphic.
            </p>
            <p>
                <code class="literal">select_statement</code> can be any valid HQL select query, with the caveat that the return
                types must match the types expected by the insert.  Currently, this is checked during query
                compilation rather than allowing the check to relegate to the database.  This may cause problems
                between Hibernate Types which are <span class="emphasis"><em>equivalent</em></span> as opposed to
                <span class="emphasis"><em>equal</em></span>.  For example, this might cause lead to issues with mismatches between an
                attribute mapped as a <code class="classname">org.hibernate.type.DateType</code> and an attribute defined as
                a <code class="classname">org.hibernate.type.TimestampType</code>, even though the database might not make a
                distinction or might be able to handle the conversion.
            </p>
            <p>
                For the id attribute, the insert statement gives you two options.  You can either explicitly specify
                the id property in the <code class="literal">attribute_list</code>, in which case its value is taken from the
                corresponding select expression, or omit it from the <code class="literal">attribute_list</code> in which case a
                generated value is used.  This latter option is only available when using id generators that operate
                <span class="quote">“<span class="quote">in the database</span>”</span>; attempting to use this option with any <span class="quote">“<span class="quote">in memory</span>”</span> type
                generators will cause an exception during parsing.
            </p>
            <p>
                For optimistic locking attributes, the insert statement again gives you two options.  You can either
                specify the attribute in the <code class="literal">attribute_list</code> in which case its value is taken from
                the corresponding select expressions, or omit it from the <code class="literal">attribute_list</code> in which
                case the <code class="literal">seed value</code> defined by the corresponding
                <code class="interfacename">org.hibernate.type.VersionType</code> is used.
            </p>
            </a><div class="example"><a id="d5e1784"></a><a id="d5e1812"><p class="title"><strong>Example&nbsp;13.2.&nbsp;Example INSERT query statements</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">String hqlInsert = "insert into DelinquentAccount (id, name) select c.id, c.name from Customer c where ...";
int createdEntities = s.createQuery( hqlInsert ).executeUpdate();</pre>
            </div></a></div><a id="d5e1812"><br class="example-break">
        </a></div><a id="d5e1812">
    </a></div><a id="d5e1812">

    </a><div class="section" title="13.3.&nbsp;The FROM clause"><a id="d5e1812"></a><div class="titlepage"><a id="d5e1812"></a><div><a id="d5e1812"></a><div><a id="d5e1812"></a><h2 class="title"><a id="d5e1812"></a><a id="hql-from-clause">13.3.&nbsp;The <code class="literal">FROM</code> clause</a></h2></div></div></div><a id="hql-from-clause">
        
        <p>
            The <code class="literal">FROM</code> clause is responsible defining the scope of object model types available to
            the rest of the query.  It also is responsible for defining all the <span class="quote">“<span class="quote">identification variables</span>”</span>
            available to the rest of the query.
        </p>
        </a><div class="section" title="13.3.1.&nbsp;Identification variables"><a id="hql-from-clause"></a><div class="titlepage"><a id="hql-from-clause"></a><div><a id="hql-from-clause"></a><div><a id="hql-from-clause"></a><h3 class="title"><a id="hql-from-clause"></a><a id="d5e1821">13.3.1.&nbsp;Identification variables</a></h3></div></div></div><a id="d5e1821">
            
            <p>
                Identification variables are often referred to as aliases.  References to object model classes
                in the FROM clause can be associated with an identification variable that can then be used to
                refer to that type thoughout the rest of the query.
            </p>
            <p>
                In most cases declaring an identification variable is optional, though it is usually good practice to
                declare them.
            </p>
            <p>
                An identification variable must follow the rules for Java identifier validity.
            </p>
            <p>
                According to JPQL, identification variables must be treated as case insensitive.  Good practice
                says you should use the same case throughout a query to refer to a given identification variable.  In
                other words, JPQL says they <span class="emphasis"><em>can be</em></span> case insensitive and so Hibernate must
                be able to treat them as such, but this does not make it good practice.
            </p>
        </a></div><a id="d5e1821">
        </a><div class="section" title="13.3.2.&nbsp;Root entity references"><a id="d5e1821"></a><div class="titlepage"><a id="d5e1821"></a><div><a id="d5e1821"></a><div><a id="d5e1821"></a><h3 class="title"><a id="d5e1821"></a><a id="d5e1828">13.3.2.&nbsp;Root entity references</a></h3></div></div></div><a id="d5e1828">
            
            <p>
                A root entity reference, or what JPA calls a <code class="literal">range variable declaration</code>, is
                specifically a reference to a mapped entity type from the application.  It cannot name component/
                embeddable types.  And associations, including collections, are handled in a different manner
                discussed later.
            </p>
            <p>
                The BNF for a root entity reference is:
            </p>
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">root_entity_reference ::= entity_name [AS] identification_variable</pre>
            </a><div class="example"><a id="d5e1828"></a><a id="hql-simple-query-ex"><p class="title"><strong>Example&nbsp;13.3.&nbsp;Simple query example</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">select c from com.acme.Cat c</pre>
            </div></a></div><a id="hql-simple-query-ex"><br class="example-break">
            <p>
                We see that the query is defining a root entity reference to the <code class="classname">com.acme.Cat</code>
                object model type.  Additionally, it declares an alias of <code class="literal">c</code> to that
                <code class="classname">com.acme.Cat</code> reference; this is the identification variable.
            </p>
            <p>
                Usually the root entity reference just names the <code class="literal">entity name</code> rather than the
                entity class FQN.  By default the entity name is the unqualified entity class name,
                here <code class="literal">Cat</code>
            </p>
            </a><div class="example"><a id="hql-simple-query-ex"></a><a id="d5e1844"><p class="title"><strong>Example&nbsp;13.4.&nbsp;Simple query using entity name for root entity reference</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">select c from Cat c</pre>
            </div></a></div><a id="d5e1844"><br class="example-break">
            <p>
                Multiple root entity references can also be specified.  Even naming the same entity!
            </p>
            </a><div class="example"><a id="d5e1844"></a><a id="d5e1848"><p class="title"><strong>Example&nbsp;13.5.&nbsp;Simple query using multiple root entity references</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">// build a product between customers and active mailing campaigns so we can spam!
select distinct cust, camp
from Customer cust, Campaign camp
where camp.type = 'mail'
  and current_timestamp() between camp.activeRange.start and camp.activeRange.end</pre>
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">// retrieve all customers with headquarters in the same state as Acme's headquarters
select distinct c1
from Customer c1, Customer c2
where c1.address.state = c2.address.state
  and c2.name = 'Acme'</pre>
            </div></a></div><a id="d5e1848"><br class="example-break">
        </a></div><a id="d5e1848">
        </a><div class="section" title="13.3.3.&nbsp;Explicit joins"><a id="d5e1848"></a><div class="titlepage"><a id="d5e1848"></a><div><a id="d5e1848"></a><div><a id="d5e1848"></a><h3 class="title"><a id="d5e1848"></a><a id="d5e1852">13.3.3.&nbsp;Explicit joins</a></h3></div></div></div><a id="d5e1852">
            
            <p>
                The <code class="literal">FROM</code> clause can also contain explicit relationship joins using the
                <code class="literal">join</code> keyword.  These joins can be either <code class="literal">inner</code>
                or <code class="literal">left outer</code> style joins.
            </p>
            </a><div class="example"><a id="d5e1852"></a><a id="d5e1859"><p class="title"><strong>Example&nbsp;13.6.&nbsp;Explicit inner join examples</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">select c
from Customer c
    join c.chiefExecutive ceo
where ceo.age &lt; 25

// same query but specifying join type as 'inner' explicitly
select c
from Customer c
    inner join c.chiefExecutive ceo
where ceo.age &lt; 25
</pre>
            </div></a></div><a id="d5e1859"><br class="example-break">
            </a><div class="example"><a id="d5e1859"></a><a id="d5e1862"><p class="title"><strong>Example&nbsp;13.7.&nbsp;Explicit left (outer) join examples</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">// get customers who have orders worth more than $5000
// or who are in "preferred" status
select distinct c
from Customer c
    left join c.orders o
where o.value &gt; 5000.00
  or c.status = 'preferred'

// functionally the same query but using the
// 'left outer' phrase
select distinct c
from Customer c
    left outer join c.orders o
where o.value &gt; 5000.00
  or c.status = 'preferred'
</pre>
            </div></a></div><a id="d5e1862"><br class="example-break">
            <p>
                An important use case for explicit joins is to define <code class="literal">FETCH JOINS</code> which override
                the laziness of the joined association.  As an example, given an entity named <code class="classname">Customer</code>
                with a collection-valued association named <code class="literal">orders</code>
            </p>
            </a><div class="example"><a id="d5e1862"></a><a id="d5e1869"><p class="title"><strong>Example&nbsp;13.8.&nbsp;Fetch join example</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">select c
from Customer c
    left join fetch c.orders o</pre>
            </div></a></div><a id="d5e1869"><br class="example-break">
            <p>
                As you can see from the example, a fetch join is specified by injecting the keyword <code class="literal">fetch</code>
                after the keyword <code class="literal">join</code>.  In the example, we used a left outer join because we want
                to return customers who have no orders also.  Inner joins can also be fetched.  But inner joins still
                filter.  In the example, using an inner join instead would have resulted in customers without any orders
                being filtered out of the result.
            </p>
            <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Important</h2>
                <p>
                    Fetch joins are not valid in sub-queries.
                </p>
                <p>
                    Care should be taken when fetch joining a collection-valued association which is in any way further
                    restricted; the fetched collection will be restricted too!  For this reason it is usually considered
                    best practice to not assign an identification variable to fetched joins except for the purpose
                    of specifying nested fetch joins.
                </p>
                <p>
                    Fetch joins should not be used in paged queries (aka, <code class="methodname">setFirstResult</code>/
                    <code class="methodname">setMaxResults</code>).  Nor should they be used with the HQL
                    <code class="methodname">scroll</code> or <code class="methodname">iterate</code> features.
                </p>
            </div>
            <p>
                HQL also defines a <code class="literal">WITH</code> clause to qualify the join conditions.  Again, this is
                specific to HQL; JPQL does not define this feature.
            </p>
            </a><div class="example"><a id="d5e1869"></a><a id="d5e1885"><p class="title"><strong>Example&nbsp;13.9.&nbsp;with-clause join example</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">select distinct c
from Customer c
    left join c.orders o
        with o.value &gt; 5000.00</pre>
            </div></a></div><a id="d5e1885"><br class="example-break">
            <p>
                The important distinction is that in the generated SQL the conditions of the
                <code class="literal">with clause</code> are made part of the <code class="literal">on clause</code> in the generated SQL
                as opposed to the other queries in this section where the HQL/JPQL conditions are made part of the
                <code class="literal">where clause</code> in the generated SQL.  The distinction in this specific example is
                probably not that significant.  The <code class="literal">with clause</code> is sometimes necessary in more
                complicated queries.
            </p>
            </a><p><a id="d5e1885">
                Explicit joins may reference association or component/embedded attributes.  For further information
                about collection-valued association references, see </a><a class="xref" href="#hql-collection-valued-associations" title="13.3.5.&nbsp;Collection member references">Section&nbsp;13.3.5, “Collection member references”</a>.
                In the case of component/embedded attributes, the join is simply logical and does not correlate to a
                physical (SQL) join.
            </p>
        </div>
        <div class="section" title="13.3.4.&nbsp;Implicit joins (path expressions)"><div class="titlepage"><div><div><h3 class="title"><a id="d5e1895">13.3.4.&nbsp;Implicit joins (path expressions)</a></h3></div></div></div><a id="d5e1895">
            
            <p>
                Another means of adding to the scope of object model types available to the query is through the
                use of implicit joins, or path expressions.
            </p>
            </a><div class="example"><a id="d5e1895"></a><a id="d5e1898"><p class="title"><strong>Example&nbsp;13.10.&nbsp;Simple implicit join example</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">select c
from Customer c
where c.chiefExecutive.age &lt; 25

// same as
select c
from Customer c
    inner join c.chiefExecutive ceo
where ceo.age &lt; 25
</pre>
            </div></a></div><a id="d5e1898"><br class="example-break">
            <p>
                An implicit join always starts from an <code class="literal">identification variable</code>, followed by
                the navigation operator (.), followed by an attribute for the object model type referenced by the
                initial <code class="literal">identification variable</code>.  In the example, the initial
                <code class="literal">identification variable</code> is <code class="literal">c</code> which refers to the
                <code class="classname">Customer</code> entity.  The <code class="literal">c.chiefExecutive</code> reference then refers
                to the <code class="methodname">chiefExecutive</code> attribute of the <code class="classname">Customer</code> entity.
                <code class="methodname">chiefExecutive</code> is an association type so we further navigate to its
                <code class="methodname">age</code> attribute.
            </p>
            <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Important</h2>
                <p>
                    If the attribute represents an entity association (non-collection) or a component/embedded, that
                    reference can be further navigated.  Basic values and collection-valued associations cannot be
                    further navigated.
                </p>
            </div>
            <p>
                As shown in the example, implicit joins can appear outside the <code class="literal">FROM clause</code>.  However,
                they affect the <code class="literal">FROM clause</code>.  Implicit joins are always treated as inner joins.
                Multiple references to the same implicit join always refer to the same logical and physical (SQL) join.
            </p>
            </a><div class="example"><a id="d5e1898"></a><a id="d5e1917"><p class="title"><strong>Example&nbsp;13.11.&nbsp;Reused implicit join</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">select c
from Customer c
where c.chiefExecutive.age &lt; 25
   and c.chiefExecutive.address.state = 'TX'

// same as
select c
from Customer c
    inner join c.chiefExecutive ceo
where ceo.age &lt; 25
  and ceo.address.state = 'TX'

// same as
select c
from Customer c
    inner join c.chiefExecutive ceo
    inner join ceo.address a
where ceo.age &lt; 25
  and a.state = 'TX'
</pre>
            </div></a></div><a id="d5e1917"><br class="example-break">
            </a><p><a id="d5e1917">
                Just as with explicit joins, implicit joins may reference association or component/embedded attributes.
                For further information about collection-valued association references, see
                </a><a class="xref" href="#hql-collection-valued-associations" title="13.3.5.&nbsp;Collection member references">Section&nbsp;13.3.5, “Collection member references”</a>.  In the case of component/embedded attributes,
                the join is simply logical and does not correlate to a physical (SQL) join.  Unlike explicit joins,
                however, implicit joins may also reference basic state fields as long as the path expression ends
                there.
            </p>
        </div>
        <div class="section" title="13.3.5.&nbsp;Collection member references"><div class="titlepage"><div><div><h3 class="title"><a id="hql-collection-valued-associations">13.3.5.&nbsp;Collection member references</a></h3></div></div></div><a id="hql-collection-valued-associations">
            
            <p>
                References to collection-valued associations actually refer to the <span class="emphasis"><em>values</em></span> of
                that collection.
            </p>
            </a><div class="example"><a id="hql-collection-valued-associations"></a><a id="d5e1926"><p class="title"><strong>Example&nbsp;13.12.&nbsp;Collection references example</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">select c
from Customer c
    join c.orders o
    join o.lineItems l
    join l.product p
where o.status = 'pending'
  and p.status = 'backorder'

// alternate syntax
select c
from Customer c,
    in(c.orders) o,
    in(o.lineItems) l
    join l.product p
where o.status = 'pending'
  and p.status = 'backorder'</pre>
            </div></a></div><a id="d5e1926"><br class="example-break">
            <p>
                In the example, the identification variable <code class="literal">o</code> actually refers to the object model
                type <code class="classname">Order</code> which is the type of the elements of the
                <code class="methodname">Customer#orders</code> association.
            </p>
            <p>
                The example also shows the alternate syntax for specifying collection association joins using the
                <code class="literal">IN</code> syntax.  Both forms are equivalent.  Which form an application chooses to use is
                simply a matter of taste.
            </p>
            </a><div class="section" title="13.3.5.1.&nbsp;Special case - qualified path expressions"><a id="d5e1926"></a><div class="titlepage"><a id="d5e1926"></a><div><a id="d5e1926"></a><div><a id="d5e1926"></a><h4 class="title"><a id="d5e1926"></a><a id="hql-collection-qualification">13.3.5.1.&nbsp;Special case - qualified path expressions</a></h4></div></div></div><a id="hql-collection-qualification">
                
                <p>
                    We said earlier that collection-valued associations actually refer to the <span class="emphasis"><em>values</em></span>
                    of that collection.  Based on the type of collection, there are also available a set of
                    explicit qualification expressions.
                </p>
                </a><div class="example"><a id="hql-collection-qualification"></a><a id="d5e1939"><p class="title"><strong>Example&nbsp;13.13.&nbsp;Qualified collection references example</strong></p><div class="example-contents">
                    
                    <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">// Product.images is a Map&lt;String,String&gt; : key = a name, value = file path

// select all the image file paths (the map value) for Product#123
select i
from Product p
    join p.images i
where p.id = 123

// same as above
select value(i)
from Product p
    join p.images i
where p.id = 123

// select all the image names (the map key) for Product#123
select key(i)
from Product p
    join p.images i
where p.id = 123

// select all the image names and file paths (the 'Map.Entry') for Product#123
select entry(i)
from Product p
    join p.images i
where p.id = 123

// total the value of the initial line items for all orders for a customer
select sum( li.amount )
from Customer c
        join c.orders o
        join o.lineItems li
where c.id = 123
  and index(li) = 1</pre>
                </div></a></div><a id="d5e1939"><br class="example-break">
                <div class="variablelist"><dl><dt><span class="term">VALUE</span></dt><dd>
                            <p>
                                Refers to the collection value.  Same as not specifying a qualifier.  Useful to
                                explicitly show intent.  Valid for any type of collection-valued reference.
                            </p>
                        </dd><dt><span class="term">INDEX</span></dt><dd>
                            <p>
                                According to HQL rules, this is valid for both Maps and Lists which specify a
                                <code class="interfacename">javax.persistence.OrderColumn</code> annotation to refer to
                                the Map key or the List position (aka the OrderColumn value).  JPQL however, reserves
                                this for use in the List case and adds <code class="literal">KEY</code> for the MAP case.
                                Applications interested in JPA provider portability should be aware of this
                                distinction.
                            </p>
                        </dd><dt><span class="term">KEY</span></dt><dd>
                            <p>
                                Valid only for Maps.  Refers to the map's key.  If the key is itself an entity,
                                can be further navigated.
                            </p>
                        </dd><dt><span class="term">ENTRY</span></dt><dd>
                            <p>
                                Only valid only for Maps.  Refers to the Map's logical
                                <code class="interfacename">java.util.Map.Entry</code> tuple (the combination  of its key
                                and value).  <code class="literal">ENTRY</code> is only valid as a terminal path and only valid
                                in the select clause.
                            </p>
                        </dd></dl></div>
                </a><p><a id="d5e1939">
                    See </a><a class="xref" href="#hql-collection-expressions" title="13.4.9.&nbsp;Collection-related expressions">Section&nbsp;13.4.9, “Collection-related expressions”</a> for additional details on collection related
                    expressions.
                </p>
            </div>
        </div>
        <div class="section" title="13.3.6.&nbsp;Polymorphism"><div class="titlepage"><div><div><h3 class="title"><a id="d5e1965">13.3.6.&nbsp;Polymorphism</a></h3></div></div></div><a id="d5e1965">
            
            <p>
                HQL and JPQL queries are inherently polymorphic.
            </p>
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">select p from Payment p</pre>
            <p>
                This query names the <code class="classname">Payment</code> entity explicitly.  However, all subclasses of
                <code class="classname">Payment</code> are also available to the query.  So if the
                <code class="classname">CreditCardPayment</code> entity and <code class="classname">WireTransferPayment</code> entity
                each extend from <code class="classname">Payment</code> all three types would be available to the query.  And
                the query would return instances of all three.
            </p>
            <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>The logical extreme</h2>
                
                <p>
                    The HQL query <code class="literal">from java.lang.Object</code> is totally valid!  It returns every
                    object of every type defined in your application. 
                </p>
            </div>
            <p>
                This can be altered by using either the
                <code class="interfacename">org.hibernate.annotations.Polymorphism</code> annotation (global, and
                Hibernate-specific) or limiting them using in the query itself using an entity type expression.
            </p>
        </a></div><a id="d5e1965">
    </a></div><a id="d5e1965">

    </a><div class="section" title="13.4.&nbsp;Expressions"><a id="d5e1965"></a><div class="titlepage"><a id="d5e1965"></a><div><a id="d5e1965"></a><div><a id="d5e1965"></a><h2 class="title"><a id="d5e1965"></a><a id="hql-expressions">13.4.&nbsp;Expressions</a></h2></div></div></div><a id="hql-expressions">
        

        <p>
            Essentially expressions are references that resolve to basic or tuple values.
        </p>

        </a><div class="section" title="13.4.1.&nbsp;Identification variable"><a id="hql-expressions"></a><div class="titlepage"><a id="hql-expressions"></a><div><a id="hql-expressions"></a><div><a id="hql-expressions"></a><h3 class="title"><a id="hql-expressions"></a><a id="d5e1984">13.4.1.&nbsp;Identification variable</a></h3></div></div></div><a id="d5e1984">
            
            </a><p><a id="d5e1984">
                See </a><a class="xref" href="#hql-from-clause" title="13.3.&nbsp;The FROM clause">Section&nbsp;13.3, “The <code class="literal">FROM</code> clause”</a>.
            </p>
        </div>

        <div class="section" title="13.4.2.&nbsp;Path expressions"><div class="titlepage"><div><div><h3 class="title"><a id="d5e1988">13.4.2.&nbsp;Path expressions</a></h3></div></div></div><a id="d5e1988">
            
            </a><p><a id="d5e1988">
                Again, see </a><a class="xref" href="#hql-from-clause" title="13.3.&nbsp;The FROM clause">Section&nbsp;13.3, “The <code class="literal">FROM</code> clause”</a>.
            </p>
        </div>

        <div class="section" title="13.4.3.&nbsp;Literals"><div class="titlepage"><div><div><h3 class="title"><a id="d5e1992">13.4.3.&nbsp;Literals</a></h3></div></div></div><a id="d5e1992">
            
            <p>
                String literals are enclosed in single-quotes.  To escape a single-quote within a string literal, use
                double single-quotes.
            </p>
            </a><div class="example"><a id="d5e1992"></a><a id="d5e1995"><p class="title"><strong>Example&nbsp;13.14.&nbsp;String literal examples</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">select c
from Customer c
where c.name = 'Acme'

select c
from Customer c
where c.name = 'Acme''s Pretzel Logic'

</pre>
            </div></a></div><a id="d5e1995"><br class="example-break">

            <p>
                Numeric literals are allowed in a few different forms.
            </p>
            </a><div class="example"><a id="d5e1995"></a><a id="d5e1999"><p class="title"><strong>Example&nbsp;13.15.&nbsp;Numeric literal examples</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">// simple integer literal
select o
from Order o
where o.referenceNumber = 123

// simple integer literal, typed as a long
select o
from Order o
where o.referenceNumber = 123L

// decimal notation
select o
from Order o
where o.total &gt; 5000.00

// decimal notation, typed as a float
select o
from Order o
where o.total &gt; 5000.00F

// scientific notation
select o
from Order o
where o.total &gt; 5e+3

// scientific notation, typed as a float
select o
from Order o
where o.total &gt; 5e+3F</pre>
            </div></a></div><a id="d5e1999"><br class="example-break">
            <p>
                In the scientific notation form, the <code class="literal">E</code> is case insensitive.
            </p>
            <p>
                Specific typing can be achieved through the use of the same suffix approach specified by Java.  So,
                <code class="literal">L</code> denotes a long; <code class="literal">D</code> denotes a double; <code class="literal">F</code>
                denotes a float.  The actual suffix is case insensitive.
            </p>

            <p>
                The boolean literals are <code class="literal">TRUE</code> and <code class="literal">FALSE</code>, again case-insensitive.
            </p>

            <p>
                Enums can even be referenced as literals.  The fully-qualified enum class name must be used.  HQL
                can also handle constants in the same manner, though JPQL does not define that as supported.
            </p>

            </a><p><a id="d5e1999">
                Entity names can also be used as literal.  See </a><a class="xref" href="#hql-entity-type-exp" title="13.4.10.&nbsp;Entity type">Section&nbsp;13.4.10, “Entity type”</a>.
            </p>

            <p>
                Date/time literals can be specified using the JDBC escape syntax: <code class="literal">{d 'yyyy-mm-dd'}</code>
                for dates, <code class="literal">{t 'hh:mm:ss'}</code> for times and
                <code class="literal">{ts 'yyyy-mm-dd hh:mm:ss[.millis]'}</code> (millis optional) for timestamps.  These
                literals only work if you JDBC drivers supports them.
            </p>
        </div>

        <div class="section" title="13.4.4.&nbsp;Parameters"><div class="titlepage"><div><div><h3 class="title"><a id="d5e2018">13.4.4.&nbsp;Parameters</a></h3></div></div></div><a id="d5e2018">
            
            <p>
                HQL supports all 3 of the following forms.  JPQL does not support the HQL-specific positional
                parameters notion.  It is good practice to not mix forms in a given query.
            </p>
            </a><div class="section" title="13.4.4.1.&nbsp;Named parameters"><a id="d5e2018"></a><div class="titlepage"><a id="d5e2018"></a><div><a id="d5e2018"></a><div><a id="d5e2018"></a><h4 class="title"><a id="d5e2018"></a><a id="d5e2021">13.4.4.1.&nbsp;Named parameters</a></h4></div></div></div><a id="d5e2021">
                
                <p>
                    Named parameters are declared using a colon followed by an identifier -
                    <code class="literal">:aNamedParameter</code>.  The same named parameter can appear multiple times in a query.
                </p>
                </a><div class="example"><a id="d5e2021"></a><a id="d5e2025"><p class="title"><strong>Example&nbsp;13.16.&nbsp;Named parameter examples</strong></p><div class="example-contents">
                    
                    <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">String queryString =
        "select c " +
        "from Customer c " +
        "where c.name = :name " +
        "   or c.nickName = :name";

// HQL
List customers = session.createQuery( queryString )
        .setParameter( "name", theNameOfInterest )
        .list();

// JPQL
List&lt;Customer&gt; customers = entityManager.createQuery( queryString, Customer.class )
        .setParameter( "name", theNameOfInterest )
        .getResultList();</pre>
                </div></a></div><a id="d5e2025"><br class="example-break">
            </a></div><a id="d5e2025">
            </a><div class="section" title="13.4.4.2.&nbsp;Positional (JPQL) parameters"><a id="d5e2025"></a><div class="titlepage"><a id="d5e2025"></a><div><a id="d5e2025"></a><div><a id="d5e2025"></a><h4 class="title"><a id="d5e2025"></a><a id="d5e2028">13.4.4.2.&nbsp;Positional (JPQL) parameters</a></h4></div></div></div><a id="d5e2028">
                
                <p>
                    JPQL-style positional parameters are declared using a question mark followed by an ordinal -
                    <code class="literal">?1</code>, <code class="literal">?2</code>.  The ordinals start with 1.  Just like with
                    named parameters, positional parameters can also appear multiple times in a query.
                </p>
                </a><div class="example"><a id="d5e2028"></a><a id="d5e2033"><p class="title"><strong>Example&nbsp;13.17.&nbsp;Positional (JPQL) parameter examples</strong></p><div class="example-contents">
                    
                    <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">String queryString =
        "select c " +
        "from Customer c " +
        "where c.name = ?1 " +
        "   or c.nickName = ?1";

// HQL - as you can see, handled just like named parameters
//      in terms of API
List customers = session.createQuery( queryString )
        .setParameter( "1", theNameOfInterest )
        .list();

// JPQL
List&lt;Customer&gt; customers = entityManager.createQuery( queryString, Customer.class )
        .setParameter( 1, theNameOfInterest )
        .getResultList();</pre>
                </div></a></div><a id="d5e2033"><br class="example-break">
            </a></div><a id="d5e2033">
            </a><div class="section" title="13.4.4.3.&nbsp;Positional (HQL) parameters"><a id="d5e2033"></a><div class="titlepage"><a id="d5e2033"></a><div><a id="d5e2033"></a><div><a id="d5e2033"></a><h4 class="title"><a id="d5e2033"></a><a id="d5e2036">13.4.4.3.&nbsp;Positional (HQL) parameters</a></h4></div></div></div><a id="d5e2036">
                
                <p>
                    HQL-style positional parameters follow JDBC positional parameter syntax.  They are declared using
                    <code class="literal">?</code> without a following ordinal.  There is no way to relate two such
                    positional parameters as being "the same" aside from binding the same value to each.
                </p>
                <p>
                    This form should be considered deprecated and may be removed in the near future.
                </p>
            </a></div><a id="d5e2036">
        </a></div><a id="d5e2036">

        </a><div class="section" title="13.4.5.&nbsp;Arithmetic"><a id="d5e2036"></a><div class="titlepage"><a id="d5e2036"></a><div><a id="d5e2036"></a><div><a id="d5e2036"></a><h3 class="title"><a id="d5e2036"></a><a id="d5e2041">13.4.5.&nbsp;Arithmetic</a></h3></div></div></div><a id="d5e2041">
            
            <p>
                Arithmetic operations also represent valid expressions.
            </p>
            </a><div class="example"><a id="d5e2041"></a><a id="d5e2044"><p class="title"><strong>Example&nbsp;13.18.&nbsp;Numeric arithmetic examples</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">select year( current_date() ) - year( c.dateOfBirth )
from Customer c

select c
from Customer c
where year( current_date() ) - year( c.dateOfBirth ) &lt; 30

select o.customer, o.total + ( o.total * :salesTax )
from Order o</pre>
            </div></a></div><a id="d5e2044"><br class="example-break">
            <p>
                The following rules apply to the result of arithmetic operations:
            </p>
            <div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
                    <p>
                        If either of the operands is Double/double, the result is a Double;
                    </p>
                </li><li class="listitem">
                    <p>
                        else, if either of the operands is Float/float, the result is a Float;
                    </p>
                </li><li class="listitem">
                    <p>
                        else, if either operand is BigDecimal, the result is BigDecimal;
                    </p>
                </li><li class="listitem">
                    <p>
                        else, if either operand is BigInteger, the result is BigInteger (except for division, in
                        which case the result type is not further defined);
                    </p>
                </li><li class="listitem">
                    <p>
                        else, if either operand is Long/long, the result is Long (except for division, in
                        which case the result type is not further defined);
                    </p>
                </li><li class="listitem">
                    <p>
                        else, (the assumption being that both operands are of integral type) the result is Integer
                        (except for division, in which case the result type is not further defined);
                    </p>
                </li></ul></div>

            <p>
                Date arithmetic is also supported, albeit in a more limited fashion.  This is due partially to
                differences in database support and partially to the lack of support for <code class="literal">INTERVAL</code>
                definition in the query language itself.
            </p>
        </a></div><a id="d5e2044">

        </a><div class="section" title="13.4.6.&nbsp;Concatenation (operation)"><a id="d5e2044"></a><div class="titlepage"><a id="d5e2044"></a><div><a id="d5e2044"></a><div><a id="d5e2044"></a><h3 class="title"><a id="d5e2044"></a><a id="d5e2063">13.4.6.&nbsp;Concatenation (operation)</a></h3></div></div></div><a id="d5e2063">
            
            <p>
                HQL defines a concatenation operator in addition to supporting the concatenation
                (<code class="literal">CONCAT</code>) function.  This is not defined by JPQL, so portable applications
                should avoid it use.  The concatenation operator is taken from the SQL concatenation operator -
                <code class="literal">||</code>.
            </p>
            </a><div class="example"><a id="d5e2063"></a><a id="d5e2068"><p class="title"><strong>Example&nbsp;13.19.&nbsp;Concatenation operation example</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">select 'Mr. ' || c.name.first || ' ' || c.name.last
from Customer c
where c.gender = Gender.MALE</pre>
            </div></a></div><a id="d5e2068"><br class="example-break">
            </a><p><a id="d5e2068">
                See </a><a class="xref" href="#hql-exp-functions" title="13.4.8.&nbsp;Scalar functions">Section&nbsp;13.4.8, “Scalar functions”</a> for details on the <code class="literal">concat()</code> function
            </p>
        </div>

        <div class="section" title="13.4.7.&nbsp;Aggregate functions"><div class="titlepage"><div><div><h3 class="title"><a id="d5e2074">13.4.7.&nbsp;Aggregate functions</a></h3></div></div></div><a id="d5e2074">
            
            <p>
                Aggregate functions are also valid expressions in HQL and JPQL.  The semantic is the same as their
                SQL counterpart.  The supported aggregate functions are:
            </p>
            <div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
                    <p>
                        <code class="literal">COUNT</code> (including distinct/all qualifiers) - The result type is always Long.
                    </p>
                </li><li class="listitem">
                    <p>
                        <code class="literal">AVG</code> -  The result type is always Double.
                    </p>
                </li><li class="listitem">
                    <p>
                        <code class="literal">MIN</code> - The result type is the same as the argument type.
                    </p>
                </li><li class="listitem">
                    <p>
                        <code class="literal">MAX</code> - The result type is the same as the argument type.
                    </p>
                </li><li class="listitem">
                    <p>
                        <code class="literal">SUM</code> -  The result type of the <code class="literal">avg()</code> function depends on
                        the type of the values being averaged.  For integral values (other than BigInteger), the result
                        type is Long.  For floating point values (other than BigDecimal) the result type is Double.  For
                        BigInteger values, the result type is BigInteger.  For BigDecimal values, the result type is
                        BigDecimal.
                    </p>
                </li></ul></div>
            </a><div class="example"><a id="d5e2074"></a><a id="d5e2094"><p class="title"><strong>Example&nbsp;13.20.&nbsp;Aggregate function examples</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">select count(*), sum( o.total ), avg( o.total ), min( o.total ), max( o.total )
from Order o

select count( distinct c.name )
from Customer c

select c.id, c.name, sum( o.total )
from Customer c
    left join c.orders o
group by c.id, c.name</pre>
            </div></a></div><a id="d5e2094"><br class="example-break">
            </a><p><a id="d5e2094">
                Aggregations often appear with grouping.  For information on grouping see </a><a class="xref" href="#hql-grouping" title="13.8.&nbsp;Grouping">Section&nbsp;13.8, “Grouping”</a>
            </p>
        </div>

        <div class="section" title="13.4.8.&nbsp;Scalar functions"><div class="titlepage"><div><div><h3 class="title"><a id="hql-exp-functions">13.4.8.&nbsp;Scalar functions</a></h3></div></div></div><a id="hql-exp-functions">
            
            <p>
                Both HQL and JPQL define some standard functions that are available regardless of the underlying 
                database in use.  HQL can also understand additional functions defined by the Dialect as well as the 
                application.
            </p>

            </a><div class="section" title="13.4.8.1.&nbsp;Standardized functions - JPQL"><a id="hql-exp-functions"></a><div class="titlepage"><a id="hql-exp-functions"></a><div><a id="hql-exp-functions"></a><div><a id="hql-exp-functions"></a><h4 class="title"><a id="hql-exp-functions"></a><a id="d5e2102">13.4.8.1.&nbsp;Standardized functions - JPQL</a></h4></div></div></div><a id="d5e2102">
                
                <p>
                    Here are the list of functions defined as supported by JPQL.  Applications interested in remaining
                    portable between JPA providers should stick to these functions.
                </p>
                <div class="variablelist"><dl><dt><span class="term">CONCAT</span></dt><dd>
                            <p>
                                String concatenation function.  Variable argument length of 2 or more string values
                                to be concatenated together.
                            </p>
                        </dd><dt><span class="term">SUBSTRING</span></dt><dd>
                            <p>
                                Extracts a portion of a string value.
                            </p>
                            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">substring( string_expression, numeric_expression [, numeric_expression] )</pre>
                            <p>
                                The second argument denotes the starting position.  The third (optional) argument
                                denotes the length.
                            </p>
                        </dd><dt><span class="term">UPPER</span></dt><dd>
                            <p>
                                Upper cases the specified string
                            </p>
                        </dd><dt><span class="term">LOWER</span></dt><dd>
                            <p>
                                Lower cases the specified string
                            </p>
                        </dd><dt><span class="term">TRIM</span></dt><dd>
                            <p>
                                Follows the semantics of the SQL trim function.
                            </p>
                        </dd><dt><span class="term">LENGTH</span></dt><dd>
                            <p>
                                Returns the length of a string.
                            </p>
                        </dd><dt><span class="term">LOCATE</span></dt><dd>
                            <p>
                                Locates a string within another string.
                            </p>
                            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">locate( string_expression, string_expression[, numeric_expression] )</pre>
                            <p>
                                The third argument (optional) is used to denote a position from which to start looking.
                            </p>
                        </dd><dt><span class="term">ABS</span></dt><dd>
                            <p>
                                Calculates the mathematical absolute value of a numeric value.
                            </p>
                        </dd><dt><span class="term">MOD</span></dt><dd>
                            <p>
                                Calculates the remainder of dividing the first argument by the second.
                            </p>
                        </dd><dt><span class="term">SQRT</span></dt><dd>
                            <p>
                                Calculates the mathematical square root of a numeric value.
                            </p>
                        </dd><dt><span class="term">CURRENT_DATE</span></dt><dd>
                            <p>
                                Returns the database current date.
                            </p>
                        </dd><dt><span class="term">CURRENT_TIME</span></dt><dd>
                            <p>
                                Returns the database current time.
                            </p>
                        </dd><dt><span class="term">CURRENT_TIMESTAMP</span></dt><dd>
                            <p>
                                Returns the database current timestamp.
                            </p>
                        </dd></dl></div>
            </a></div><a id="d5e2102">
            </a><div class="section" title="13.4.8.2.&nbsp;Standardized functions - HQL"><a id="d5e2102"></a><div class="titlepage"><a id="d5e2102"></a><div><a id="d5e2102"></a><div><a id="d5e2102"></a><h4 class="title"><a id="d5e2102"></a><a id="d5e2162">13.4.8.2.&nbsp;Standardized functions - HQL</a></h4></div></div></div><a id="d5e2162">
                
                <p>
                    Beyond the JPQL standardized functions, HQL makes some additional functions available regardless
                    of the underlying database in use.
                </p>
                <div class="variablelist"><dl><dt><span class="term">BIT_LENGTH</span></dt><dd>
                            <p>
                                Returns the length of binary data.
                            </p>
                        </dd><dt><span class="term">CAST</span></dt><dd>
                            <p>
                                Performs a SQL cast.  The cast target should name the Hibernate mapping type to use.
                                See the chapter on data types for more information.
                            </p>
                        </dd><dt><span class="term">EXTRACT</span></dt><dd>
                            <p>
                                Performs a SQL extraction on datetime values.  An extraction extracts parts of
                                the datetime (the year, for example).  See the abbreviated forms below.
                            </p>
                        </dd><dt><span class="term">SECOND</span></dt><dd>
                            <p>
                                Abbreviated extract form for extracting the second.
                            </p>
                        </dd><dt><span class="term">MINUTE</span></dt><dd>
                            <p>
                                Abbreviated extract form for extracting the minute.
                            </p>
                        </dd><dt><span class="term">HOUR</span></dt><dd>
                            <p>
                                Abbreviated extract form for extracting the hour.
                            </p>
                        </dd><dt><span class="term">DAY</span></dt><dd>
                            <p>
                                Abbreviated extract form for extracting the day.
                            </p>
                        </dd><dt><span class="term">MONTH</span></dt><dd>
                            <p>
                                Abbreviated extract form for extracting the month.
                            </p>
                        </dd><dt><span class="term">YEAR</span></dt><dd>
                            <p>
                                Abbreviated extract form for extracting the year.
                            </p>
                        </dd><dt><span class="term">STR</span></dt><dd>
                            <p>
                                Abbreviated form for casting a value as character data.
                            </p>
                        </dd></dl></div>
            </a></div><a id="d5e2162">

            </a><div class="section" title="13.4.8.3.&nbsp;Non-standardized functions"><a id="d5e2162"></a><div class="titlepage"><a id="d5e2162"></a><div><a id="d5e2162"></a><div><a id="d5e2162"></a><h4 class="title"><a id="d5e2162"></a><a id="d5e2206">13.4.8.3.&nbsp;Non-standardized functions</a></h4></div></div></div><a id="d5e2206">
                
                <p>
                    Hibernate Dialects can register additional functions known to be available for that particular
                    database product.  These functions are also available in HQL (and JPQL, though only when using
                    Hibernate as the JPA provider obviously).  However, they would only be available when using that
                    database/Dialect.  Applications that aim for database portability should avoid using functions
                    in this category.
                </p>
                <p>
                    Application developers can also supply their own set of functions.  This would usually represent
                    either custom SQL functions or aliases for snippets of SQL.  Such function declarations are
                    made by using the <code class="methodname">addSqlFunction</code> method of
                    <code class="classname">org.hibernate.cfg.Configuration</code>
                </p>
            </a></div><a id="d5e2206">
        </a></div><a id="d5e2206">

        </a><div class="section" title="13.4.9.&nbsp;Collection-related expressions"><a id="d5e2206"></a><div class="titlepage"><a id="d5e2206"></a><div><a id="d5e2206"></a><div><a id="d5e2206"></a><h3 class="title"><a id="d5e2206"></a><a id="hql-collection-expressions">13.4.9.&nbsp;Collection-related expressions</a></h3></div></div></div><a id="hql-collection-expressions">
            
            <p>
                There are a few specialized expressions for working with collection-valued associations.  Generally
                these are just abbreviated forms or other expressions for the sake of conciseness.
            </p>
            <div class="variablelist"><dl><dt><span class="term">SIZE</span></dt><dd>
                        <p>
                            Calculate the size of a collection.  Equates to a subquery!
                        </p>
                    </dd><dt><span class="term">MAXELEMENT</span></dt><dd>
                        <p>
                            Available for use on collections of basic type.  Refers to the maximum value as determined
                            by applying the <code class="literal">max</code> SQL aggregation.
                        </p>
                    </dd><dt><span class="term">MAXINDEX</span></dt><dd>
                        <p>
                            Available for use on indexed collections.  Refers to the maximum index (key/position) as
                            determined by applying the <code class="literal">max</code> SQL aggregation.
                        </p>
                    </dd><dt><span class="term">MINELEMENT</span></dt><dd>
                        <p>
                            Available for use on collections of basic type.  Refers to the minimum value as determined
                            by applying the <code class="literal">min</code> SQL aggregation.
                        </p>
                    </dd><dt><span class="term">MININDEX</span></dt><dd>
                        <p>
                            Available for use on indexed collections.  Refers to the minimum index (key/position) as
                            determined by applying the <code class="literal">min</code> SQL aggregation.
                        </p>
                    </dd><dt><span class="term">ELEMENTS</span></dt><dd>
                        <p>
                            Used to refer to the elements of a collection as a whole.  Only allowed in the where clause.
                            Often used in conjunction with <code class="literal">ALL</code>, <code class="literal">ANY</code> or
                            <code class="literal">SOME</code> restrictions.
                        </p>
                    </dd><dt><span class="term">INDICES</span></dt><dd>
                        <p>
                            Similar to <code class="literal">elements</code> except that <code class="literal">indices</code> refers to
                            the collections indices (keys/positions) as a whole.
                        </p>
                    </dd></dl></div>
            </a><div class="example"><a id="hql-collection-expressions"></a><a id="d5e2253"><p class="title"><strong>Example&nbsp;13.21.&nbsp;Collection-related expressions examples</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">select cal
from Calendar cal
where maxelement(cal.holidays) &gt; current_date()

select o
from Order o
where maxindex(o.items) &gt; 100

select o
from Order o
where minelement(o.items) &gt; 10000

select m
from Cat as m, Cat as kit
where kit in elements(m.kittens)

// the above query can be re-written in jpql standard way:
select m
from Cat as m, Cat as kit
where kit member of m.kittens

select p
from NameList l, Person p
where p.name = some elements(l.names)

select cat
from Cat cat
where exists elements(cat.kittens)

select p
from Player p
where 3 &gt; all elements(p.scores)

select show
from Show show
where 'fizard' in indices(show.acts)</pre>
            </div></a></div><a id="d5e2253"><br class="example-break">
            <p>
                Elements of indexed collections (arrays, lists, and maps) can be referred to by index operator.
            </p>
            </a><div class="example"><a id="d5e2253"></a><a id="d5e2257"><p class="title"><strong>Example&nbsp;13.22.&nbsp;Index operator examples</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">select o
from Order o
where o.items[0].id = 1234

select p
from Person p, Calendar c
where c.holidays['national day'] = p.birthDay
  and p.nationality.calendar = c

select i
from Item i, Order o
where o.items[ o.deliveredItemIndices[0] ] = i
  and o.id = 11

select i
from Item i, Order o
where o.items[ maxindex(o.items) ] = i
  and o.id = 11

select i
from Item i, Order o
where o.items[ size(o.items) - 1 ] = i</pre>
            </div></a></div><a id="d5e2257"><br class="example-break">
            </a><p><a id="d5e2257">
                See also </a><a class="xref" href="#hql-collection-qualification" title="13.3.5.1.&nbsp;Special case - qualified path expressions">Section&nbsp;13.3.5.1, “Special case - qualified path expressions”</a> as there is a good deal of overlap.
            </p>
        </div>

        <div class="section" title="13.4.10.&nbsp;Entity type"><div class="titlepage"><div><div><h3 class="title"><a id="hql-entity-type-exp">13.4.10.&nbsp;Entity type</a></h3></div></div></div><a id="hql-entity-type-exp">
            
            <p>
                We can also refer to the type of an entity as an expression.  This is mainly useful when dealing
                with entity inheritance hierarchies.  The type can expressed using a <code class="literal">TYPE</code> function
                used to refer to the type of an identification variable representing an entity.  The name of the
                entity also serves as a way to refer to an entity type.  Additionally the entity type can be
                parametrized, in which case the entity's Java Class reference would be bound as the parameter
                value.
            </p>
            </a><div class="example"><a id="hql-entity-type-exp"></a><a id="d5e2266"><p class="title"><strong>Example&nbsp;13.23.&nbsp;Entity type expression examples</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">select p
from Payment p
where type(p) = CreditCardPayment

select p
from Payment p
where type(p) = :aType

</pre>
            </div></a></div><a id="d5e2266"><br class="example-break">
            <p>
                HQL also has a legacy form of referring to an entity type, though that legacy form is considered
                deprecated in favor of <code class="literal">TYPE</code>.  The legacy form would have used <code class="literal">p.class</code>
                in the examples rather than <code class="literal">type(p)</code>.  It is mentioned only for completeness.
            </p>
        </a></div><a id="d5e2266">

        </a><div class="section" title="13.4.11.&nbsp;CASE expressions"><a id="d5e2266"></a><div class="titlepage"><a id="d5e2266"></a><div><a id="d5e2266"></a><div><a id="d5e2266"></a><h3 class="title"><a id="d5e2266"></a><a id="d5e2273">13.4.11.&nbsp;CASE expressions</a></h3></div></div></div><a id="d5e2273">
            
            <p>
                Both the simple and searched forms are supported, as well as the 2 SQL defined abbreviated forms
                (<code class="literal">NULLIF</code> and <code class="literal">COALESCE</code>)
            </p>
            </a><div class="section" title="13.4.11.1.&nbsp;Simple CASE expressions"><a id="d5e2273"></a><div class="titlepage"><a id="d5e2273"></a><div><a id="d5e2273"></a><div><a id="d5e2273"></a><h4 class="title"><a id="d5e2273"></a><a id="d5e2278">13.4.11.1.&nbsp;Simple CASE expressions</a></h4></div></div></div><a id="d5e2278">
                
                <p>
                    The simple form has the following syntax:
                </p>
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">CASE {operand} WHEN {test_value} THEN {match_result} ELSE {miss_result} END</pre>
                </a><div class="example"><a id="d5e2278"></a><a id="d5e2282"><p class="title"><strong>Example&nbsp;13.24.&nbsp;Simple case expression example</strong></p><div class="example-contents">
                    
                    <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">select case c.nickName when null then '&lt;no nick name&gt;' else c.nickName end
from Customer c

// This NULL checking is such a common case that most dbs
// define an abbreviated CASE form.  For example:
select nvl( c.nickName, '&lt;no nick name&gt;' )
from Customer c

// or:
select isnull( c.nickName, '&lt;no nick name&gt;' )
from Customer c

// the standard coalesce abbreviated form can be used
// to achieve the same result:
select coalesce( c.nickName, '&lt;no nick name&gt;' )
from Customer c
</pre>
                </div></a></div><a id="d5e2282"><br class="example-break">
            </a></div><a id="d5e2282">
            </a><div class="section" title="13.4.11.2.&nbsp;Searched CASE expressions"><a id="d5e2282"></a><div class="titlepage"><a id="d5e2282"></a><div><a id="d5e2282"></a><div><a id="d5e2282"></a><h4 class="title"><a id="d5e2282"></a><a id="d5e2285">13.4.11.2.&nbsp;Searched CASE expressions</a></h4></div></div></div><a id="d5e2285">
                
                <p>
                    The searched form has the following syntax:
                </p>
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">CASE [ WHEN {test_conditional} THEN {match_result} ]* ELSE {miss_result} END</pre>
                </a><div class="example"><a id="d5e2285"></a><a id="d5e2289"><p class="title"><strong>Example&nbsp;13.25.&nbsp;Searched case expression example</strong></p><div class="example-contents">
                    
                    <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">select case when c.name.first is not null then c.name.first
            when c.nickName is not null then c.nickName
            else '&lt;no first name&gt;' end
from Customer c

// Again, the abbreviated form coalesce can handle this a
// little more succinctly
select coalesce( c.name.first, c.nickName, '&lt;no first name&gt;' )
from Customer c
</pre>
                </div></a></div><a id="d5e2289"><br class="example-break">
            </a></div><a id="d5e2289">
            </a><div class="section" title="13.4.11.3.&nbsp;NULLIF expressions"><a id="d5e2289"></a><div class="titlepage"><a id="d5e2289"></a><div><a id="d5e2289"></a><div><a id="d5e2289"></a><h4 class="title"><a id="d5e2289"></a><a id="d5e2292">13.4.11.3.&nbsp;NULLIF expressions</a></h4></div></div></div><a id="d5e2292">
                
                <p>
                    NULLIF is an abbreviated CASE expression that returns NULL if its operands are considered equal.
                </p>
                </a><div class="example"><a id="d5e2292"></a><a id="d5e2295"><p class="title"><strong>Example&nbsp;13.26.&nbsp;NULLIF example</strong></p><div class="example-contents">
                    
                    <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">// return customers who have changed their last name
select nullif( c.previousName.last, c.name.last )
from Customer c

// equivalent CASE expression
select case when c.previousName.last = c.name.last then null
            else c.previousName.last end
from Customer c
</pre>
                </div></a></div><a id="d5e2295"><br class="example-break">
            </a></div><a id="d5e2295">
            </a><div class="section" title="13.4.11.4.&nbsp;COALESCE expressions"><a id="d5e2295"></a><div class="titlepage"><a id="d5e2295"></a><div><a id="d5e2295"></a><div><a id="d5e2295"></a><h4 class="title"><a id="d5e2295"></a><a id="d5e2298">13.4.11.4.&nbsp;COALESCE expressions</a></h4></div></div></div><a id="d5e2298">
                
                <p>
                    COALESCE is an  abbreviated CASE expression that returns the first non-null operand.  We have seen a 
                    number of COALESCE examples above.
                </p>
            </a></div><a id="d5e2298">
        </a></div><a id="d5e2298">
    </a></div><a id="d5e2298">

    </a><div class="section" title="13.5.&nbsp;The SELECT clause"><a id="d5e2298"></a><div class="titlepage"><a id="d5e2298"></a><div><a id="d5e2298"></a><div><a id="d5e2298"></a><h2 class="title"><a id="d5e2298"></a><a id="hql-select-clause">13.5.&nbsp;The <code class="literal">SELECT</code> clause</a></h2></div></div></div><a id="hql-select-clause">
        
        </a><p><a id="hql-select-clause">
            The <code class="literal">SELECT</code> clause identifies which objects and values to return as the query results.
            The expressions discussed in </a><a class="xref" href="#hql-expressions" title="13.4.&nbsp;Expressions">Section&nbsp;13.4, “Expressions”</a> are all valid select expressions, except
            where otherwise noted.  See the section <a class="xref" href="#hql-api" title="13.10.&nbsp;Query API">Section&nbsp;13.10, “Query API”</a> for information on handling the results
            depending on the types of values specified in the <code class="literal">SELECT</code> clause.
        </p>

        <p>
            There is a particular expression type that is only valid in the select clause.  Hibernate calls this
            <span class="quote">“<span class="quote">dynamic instantiation</span>”</span>.  JPQL supports some of that feature and calls it
            a <span class="quote">“<span class="quote">constructor expression</span>”</span>
        </p>

        <div class="example"><a id="d5e2312"><p class="title"><strong>Example&nbsp;13.27.&nbsp;Dynamic instantiation example - constructor</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">select new Family( mother, mate, offspr )
from DomesticCat as mother
    join mother.mate as mate
    left join mother.kittens as offspr</pre>
        </div></a></div><a id="d5e2312"><br class="example-break">

        </a><p><a id="d5e2312">
            So rather than dealing with the Object[] (again, see </a><a class="xref" href="#hql-api" title="13.10.&nbsp;Query API">Section&nbsp;13.10, “Query API”</a>) here we are wrapping
            the values in a type-safe java object that will be returned as the results of the query.  The class
            reference must be fully qualified and it must have a matching constructor.
        </p>
        <p>
            The class here need not be mapped.  If it does represent an entity, the resulting instances are
            returned in the NEW state (not managed!).
        </p>

        <p>
            That is the part JPQL supports as well.  HQL supports additional <span class="quote">“<span class="quote">dynamic instantiation</span>”</span>
            features.  First, the query can specify to return a List rather than an Object[] for scalar results:
        </p>
        <div class="example"><a id="d5e2320"><p class="title"><strong>Example&nbsp;13.28.&nbsp;Dynamic instantiation example - list</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">select new list(mother, offspr, mate.name)
from DomesticCat as mother
    inner join mother.mate as mate
    left outer join mother.kittens as offspr</pre>
        </div></a></div><a id="d5e2320"><br class="example-break">
        <p>
            The results from this query will be a List&lt;List&gt; as opposed to a List&lt;Object[]&gt;
        </p>

        <p>
            HQL also supports wrapping the scalar results in a Map.
        </p>
        </a><div class="example"><a id="d5e2320"></a><a id="d5e2325"><p class="title"><strong>Example&nbsp;13.29.&nbsp;Dynamic instantiation example - map</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">select new map( mother as mother, offspr as offspr, mate as mate )
from DomesticCat as mother
    inner join mother.mate as mate
    left outer join mother.kittens as offspr

select new map( max(c.bodyWeight) as max, min(c.bodyWeight) as min, count(*) as n )
from Cat c</pre>
        </div></a></div><a id="d5e2325"><br class="example-break">
        <p>
            The results from this query will be a List&lt;Map&lt;String,Object&gt;&gt; as opposed to a
            List&lt;Object[]&gt;.  The keys of the map are defined by the aliases given to the select
            expressions.
        </p>
    </a></div><a id="d5e2325">

    </a><div class="section" title="13.6.&nbsp;Predicates"><a id="d5e2325"></a><div class="titlepage"><a id="d5e2325"></a><div><a id="d5e2325"></a><div><a id="d5e2325"></a><h2 class="title"><a id="d5e2325"></a><a id="hql-conditional-expressions">13.6.&nbsp;Predicates</a></h2></div></div></div><a id="hql-conditional-expressions">
        
        <p>
            Predicates form the basis of the where clause, the having clause and searched case expressions.
            They are expressions which resolve to a truth value, generally <code class="literal">TRUE</code> or
            <code class="literal">FALSE</code>, although boolean comparisons involving NULLs generally resolve to
            <code class="literal">UNKNOWN</code>.
        </p>

        </a><div class="section" title="13.6.1.&nbsp;Relational comparisons"><a id="hql-conditional-expressions"></a><div class="titlepage"><a id="hql-conditional-expressions"></a><div><a id="hql-conditional-expressions"></a><div><a id="hql-conditional-expressions"></a><h3 class="title"><a id="hql-conditional-expressions"></a><a id="d5e2335">13.6.1.&nbsp;Relational comparisons</a></h3></div></div></div><a id="d5e2335">
            
            <p>
                Comparisons involve one of the comparison operators - =,
 &gt;, &gt;=, &lt;, &lt;=, &lt;&gt;]&gt;.  HQL also defines
                &lt;![CDATA[!= as a comparison operator synonymous with 
&lt;&gt;.  The operands should be
                of the same type.
            </p>
            </a><div class="example"><a id="d5e2335"></a><a id="d5e2338"><p class="title"><strong>Example&nbsp;13.30.&nbsp;Relational comparison examples</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">// numeric comparison
select c
from Customer c
where c.chiefExecutive.age &lt; 30

// string comparison
select c
from Customer c
where c.name = 'Acme'

// datetime comparison
select c
from Customer c
where c.inceptionDate &lt; {d '2000-01-01'}

// enum comparison
select c
from Customer c
where c.chiefExecutive.gender = com.acme.Gender.MALE

// boolean comparison
select c
from Customer c
where c.sendEmail = true

// entity type comparison
select p
from Payment p
where type(p) = WireTransferPayment

// entity value comparison
select c
from Customer c
where c.chiefExecutive = c.chiefTechnologist</pre>
            </div></a></div><a id="d5e2338"><br class="example-break">
            <p>
                Comparisons can also involve subquery qualifiers - <code class="literal">ALL</code>, <code class="literal">ANY</code>,
                <code class="literal">SOME</code>.  SOME and ANY are synonymous.
            </p>
            <p>
                The ALL qualifier resolves to true if the comparison is true for all of the values in the result of
                the subquery.  It resolves to false if the subquery result is empty.
            </p>
            </a><div class="example"><a id="d5e2338"></a><a id="d5e2346"><p class="title"><strong>Example&nbsp;13.31.&nbsp;ALL subquery comparison qualifier example</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">// select all players that scored at least 3 points
// in every game.
select p
from Player p
where 3 &gt; all (
    select spg.points
    from StatsPerGame spg
    where spg.player = p
)</pre>
            </div></a></div><a id="d5e2346"><br class="example-break">
            <p>
                The ANY/SOME qualifier resolves to true if the comparison is true for some of (at least one of) the
                values in the result of the subquery.  It resolves to false if the subquery result is empty.
            </p>
        </a></div><a id="d5e2346">

        </a><div class="section" title="13.6.2.&nbsp;Nullness predicate"><a id="d5e2346"></a><div class="titlepage"><a id="d5e2346"></a><div><a id="d5e2346"></a><div><a id="d5e2346"></a><h3 class="title"><a id="d5e2346"></a><a id="d5e2350">13.6.2.&nbsp;Nullness predicate</a></h3></div></div></div><a id="d5e2350">
            
            <p>
                Check a value for nullness.  Can be applied to basic attribute references, entity references and
                parameters.  HQL additionally allows it to be applied to component/embeddable types.
            </p>
            </a><div class="example"><a id="d5e2350"></a><a id="d5e2353"><p class="title"><strong>Example&nbsp;13.32.&nbsp;Nullness checking examples</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">// select everyone with an associated address
select p
from Person p
where p.address is not null

// select everyone without an associated address
select p
from Person p
where p.address is null</pre>
            </div></a></div><a id="d5e2353"><br class="example-break">
        </a></div><a id="d5e2353">

        </a><div class="section" title="13.6.3.&nbsp;Like predicate"><a id="d5e2353"></a><div class="titlepage"><a id="d5e2353"></a><div><a id="d5e2353"></a><div><a id="d5e2353"></a><h3 class="title"><a id="d5e2353"></a><a id="d5e2356">13.6.3.&nbsp;Like predicate</a></h3></div></div></div><a id="d5e2356">
            
            <p>
                Performs a like comparison on string values.  The syntax is:
            </p>
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">like_expression ::=
        string_expression
        [NOT] LIKE pattern_value
        [ESCAPE escape_character]
</pre>
            <p>
                The semantics follow that of the SQL like expression.  The <code class="literal">pattern_value</code> is the
                pattern to attempt to match in the <code class="literal">string_expression</code>.  Just like SQL,
                <code class="literal">pattern_value</code> can use <span class="quote">“<span class="quote">_</span>”</span> and <span class="quote">“<span class="quote">%</span>”</span> as wildcards.  The
                meanings are the same.  <span class="quote">“<span class="quote">_</span>”</span> matches any single character.  <span class="quote">“<span class="quote">%</span>”</span> matches
                any number of characters.
            </p>
            <p>
                The optional <code class="literal">escape_character</code> is used to specify an escape character used to
                escape the special meaning of <span class="quote">“<span class="quote">_</span>”</span> and <span class="quote">“<span class="quote">%</span>”</span> in the
                <code class="literal">pattern_value</code>.  THis is useful when needing to search on patterns including either
                <span class="quote">“<span class="quote">_</span>”</span> or <span class="quote">“<span class="quote">%</span>”</span>
            </p>
            </a><div class="example"><a id="d5e2356"></a><a id="d5e2375"><p class="title"><strong>Example&nbsp;13.33.&nbsp;Like predicate examples</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">select p
from Person p
where p.name like '%Schmidt'

select p
from Person p
where p.name not like 'Jingleheimmer%'

// find any with name starting with "sp_"
select sp
from StoredProcedureMetadata sp
where sp.name like 'sp|_%' escape '|'

</pre>
            </div></a></div><a id="d5e2375"><br class="example-break">
        </a></div><a id="d5e2375">

        </a><div class="section" title="13.6.4.&nbsp;Between predicate"><a id="d5e2375"></a><div class="titlepage"><a id="d5e2375"></a><div><a id="d5e2375"></a><div><a id="d5e2375"></a><h3 class="title"><a id="d5e2375"></a><a id="d5e2378">13.6.4.&nbsp;Between predicate</a></h3></div></div></div><a id="d5e2378">
            
            <p>
                Analogous to the SQL between expression.  Perform a evaluation that a value is within the range
                of 2 other values.  All the operands should have comparable types.
            </p>
            </a><div class="example"><a id="d5e2378"></a><a id="d5e2381"><p class="title"><strong>Example&nbsp;13.34.&nbsp;Between predicate examples</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">select p
from Customer c
    join c.paymentHistory p
where c.id = 123
  and index(p) between 0 and 9

select c
from Customer c
where c.president.dateOfBirth
        between {d '1945-01-01'}
            and {d '1965-01-01'}

select o
from Order o
where o.total between 500 and 5000

select p
from Person p
where p.name between 'A' and 'E' </pre>
            </div></a></div><a id="d5e2381"><br class="example-break">
        </a></div><a id="d5e2381">

        </a><div class="section" title="13.6.5.&nbsp;In predicate"><a id="d5e2381"></a><div class="titlepage"><a id="d5e2381"></a><div><a id="d5e2381"></a><div><a id="d5e2381"></a><h3 class="title"><a id="d5e2381"></a><a id="d5e2384">13.6.5.&nbsp;In predicate</a></h3></div></div></div><a id="d5e2384">
            
            <p>
                <code class="literal">IN</code> predicates performs a check that a particular value is in a list of values.
                Its syntax is:
            </p>
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">in_expression ::= single_valued_expression
            [NOT] IN single_valued_list

single_valued_list ::= constructor_expression |
            (subquery) |
            collection_valued_input_parameter

constructor_expression ::= (expression[, expression]*)</pre>
            <p>
                The types of the <code class="literal">single_valued_expression</code> and the individual values in the
                <code class="literal">single_valued_list</code> must be consistent.    JPQL limits the valid types here
                to string, numeric, date, time, timestamp, and enum types.  In JPQL,
                <code class="literal">single_valued_expression</code> can only refer to:
            </p>
            </a><div class="itemizedlist"><a id="d5e2384"></a><ul class="itemizedlist"><a id="d5e2384"><li class="listitem">
                    <p>
                        <span class="quote">“<span class="quote">state fields</span>”</span>, which is its term for simple attributes.  Specifically this
                        excludes association and component/embedded attributes.
                    </p>
                </li></a><li class="listitem"><a id="d5e2384">
                    </a><p><a id="d5e2384">
                        entity type expressions.  See </a><a class="xref" href="#hql-entity-type-exp" title="13.4.10.&nbsp;Entity type">Section&nbsp;13.4.10, “Entity type”</a>
                    </p>
                </li></ul></div>
            <p>
                In HQL, <code class="literal">single_valued_expression</code> can refer to a far more broad set of expression
                types.  Single-valued association are allowed.  So are component/embedded attributes, although that
                feature depends on the level of support for tuple or <span class="quote">“<span class="quote">row value constructor syntax</span>”</span> in
                the underlying database.  Additionally, HQL does not limit the value type in any way, though
                application developers should be aware that different types may incur limited support based on
                the underlying database vendor.  This is largely the reason for the JPQL limitations.
            </p>
            <p>
                The list of values can come from a number of different sources.  In the
                <code class="literal">constructor_expression</code> and <code class="literal">collection_valued_input_parameter</code>, the
                list of values must not be empty; it must contain at least one value.
            </p>
            <div class="example"><a id="d5e2406"><p class="title"><strong>Example&nbsp;13.35.&nbsp;In predicate examples</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">select p
from Payment p
where type(p) in (CreditCardPayment, WireTransferPayment)

select c
from Customer c
where c.hqAddress.state in ('TX', 'OK', 'LA', 'NM')

select c
from Customer c
where c.hqAddress.state in ?

select c
from Customer c
where c.hqAddress.state in (
    select dm.state
    from DeliveryMetadata dm
    where dm.salesTax is not null
)

// Not JPQL compliant!
select c
from Customer c
where c.name in (
    ('John','Doe'),
    ('Jane','Doe')
)

// Not JPQL compliant!
select c
from Customer c
where c.chiefExecutive in (
    select p
    from Person p
    where ...
)</pre>
            </div></a></div><a id="d5e2406"><br class="example-break">
        </a></div><a id="d5e2406">

        </a><div class="section" title="13.6.6.&nbsp;Exists predicate"><a id="d5e2406"></a><div class="titlepage"><a id="d5e2406"></a><div><a id="d5e2406"></a><div><a id="d5e2406"></a><h3 class="title"><a id="d5e2406"></a><a id="d5e2409">13.6.6.&nbsp;Exists predicate</a></h3></div></div></div><a id="d5e2409">
            
            <p>
                Exists expressions test the existence of results from a subquery.  The affirmative form returns true
                if the subquery result contains values.  The negated form returns true if the subquery
                result is empty.
            </p>
        </a></div><a id="d5e2409">

        </a><div class="section" title="13.6.7.&nbsp;Empty collection predicate"><a id="d5e2409"></a><div class="titlepage"><a id="d5e2409"></a><div><a id="d5e2409"></a><div><a id="d5e2409"></a><h3 class="title"><a id="d5e2409"></a><a id="d5e2412">13.6.7.&nbsp;Empty collection predicate</a></h3></div></div></div><a id="d5e2412">
            
            <p>
                The <code class="literal">IS [NOT] EMPTY</code> expression applies to collection-valued path expressions.  It
                checks whether the particular collection has any associated values.
            </p>
            </a><div class="example"><a id="d5e2412"></a><a id="d5e2416"><p class="title"><strong>Example&nbsp;13.36.&nbsp;Empty collection expression examples</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">select o
from Order o
where o.lineItems is empty

select c
from Customer c
where c.pastDueBills is not empty</pre>
            </div></a></div><a id="d5e2416"><br class="example-break">
        </a></div><a id="d5e2416">

        </a><div class="section" title="13.6.8.&nbsp;Member-of collection predicate"><a id="d5e2416"></a><div class="titlepage"><a id="d5e2416"></a><div><a id="d5e2416"></a><div><a id="d5e2416"></a><h3 class="title"><a id="d5e2416"></a><a id="d5e2419">13.6.8.&nbsp;Member-of collection predicate</a></h3></div></div></div><a id="d5e2419">
            
            <p>
                The <code class="literal">[NOT] MEMBER [OF]</code> expression applies to collection-valued path expressions.  It
                checks whether a value is a member of the specified collection.
            </p>
            </a><div class="example"><a id="d5e2419"></a><a id="d5e2423"><p class="title"><strong>Example&nbsp;13.37.&nbsp;Member-of collection expression examples</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">select p
from Person p
where 'John' member of p.nickNames

select p
from Person p
where p.name.first = 'Joseph'
  and 'Joey' not member of p.nickNames
</pre>
            </div></a></div><a id="d5e2423"><br class="example-break">
        </a></div><a id="d5e2423">

        </a><div class="section" title="13.6.9.&nbsp;NOT predicate operator"><a id="d5e2423"></a><div class="titlepage"><a id="d5e2423"></a><div><a id="d5e2423"></a><div><a id="d5e2423"></a><h3 class="title"><a id="d5e2423"></a><a id="d5e2426">13.6.9.&nbsp;NOT predicate operator</a></h3></div></div></div><a id="d5e2426">
            
            <p>
                The <code class="literal">NOT</code> operator is used to negate the predicate that follows it.  If that
                following predicate is true, the NOT resolves to false.  If the predicate is true, NOT resolves to
                false.  If the predicate is unknown, the NOT resolves to unknown as well.
            </p>
        </a></div><a id="d5e2426">

        </a><div class="section" title="13.6.10.&nbsp;AND predicate operator"><a id="d5e2426"></a><div class="titlepage"><a id="d5e2426"></a><div><a id="d5e2426"></a><div><a id="d5e2426"></a><h3 class="title"><a id="d5e2426"></a><a id="d5e2430">13.6.10.&nbsp;AND predicate operator</a></h3></div></div></div><a id="d5e2430">
            
            <p>
                The <code class="literal">AND</code> operator is used to combine 2 predicate expressions.  The result of the
                AND expression is true if and only if both predicates resolve to true.  If either predicate resolves
                to unknown, the AND expression resolves to unknown as well.  Otherwise, the result is false.
            </p>
        </a></div><a id="d5e2430">

        </a><div class="section" title="13.6.11.&nbsp;OR predicate operator"><a id="d5e2430"></a><div class="titlepage"><a id="d5e2430"></a><div><a id="d5e2430"></a><div><a id="d5e2430"></a><h3 class="title"><a id="d5e2430"></a><a id="d5e2434">13.6.11.&nbsp;OR predicate operator</a></h3></div></div></div><a id="d5e2434">
            
            <p>
                The <code class="literal">OR</code> operator is used to combine 2 predicate expressions.  The result of the
                OR expression is true if either predicate resolves to true.  If both predicates resolve to unknown, the
                OR expression resolves to unknown.  Otherwise, the result is false.
            </p>
        </a></div><a id="d5e2434">
    </a></div><a id="d5e2434">

    </a><div class="section" title="13.7.&nbsp;The WHERE clause"><a id="d5e2434"></a><div class="titlepage"><a id="d5e2434"></a><div><a id="d5e2434"></a><div><a id="d5e2434"></a><h2 class="title"><a id="d5e2434"></a><a id="hql-where-clause">13.7.&nbsp;The <code class="literal">WHERE</code> clause</a></h2></div></div></div><a id="hql-where-clause">
        
        <p>
            The <code class="literal">WHERE</code> clause of a query is made up of predicates which assert whether values in
            each potential row match the predicated checks.  Thus, the where clause restricts the results returned
            from a select query and limits the scope of update and delete queries.
        </p>
    </a></div><a id="hql-where-clause">

    </a><div class="section" title="13.8.&nbsp;Grouping"><a id="hql-where-clause"></a><div class="titlepage"><a id="hql-where-clause"></a><div><a id="hql-where-clause"></a><div><a id="hql-where-clause"></a><h2 class="title"><a id="hql-where-clause"></a><a id="hql-grouping">13.8.&nbsp;Grouping</a></h2></div></div></div><a id="hql-grouping">
        
        <p>
            The <code class="literal">GROUP BY</code> clause allows building aggregated results for various value groups.  As an
            example, consider the following queries:
        </p>
        </a><div class="example"><a id="hql-grouping"></a><a id="group_by_illustration"><p class="title"><strong>Example&nbsp;13.38.&nbsp;Group-by illustration</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">// retrieve the total for all orders
select sum( o.total )
from Order o

// retrieve the total of all orders
// *grouped by* customer
select c.id, sum( o.total )
from Order o
    inner join o.customer c
group by c.id</pre>
        </div></a></div><a id="group_by_illustration"><br class="example-break">
        <p>
            The first query retrieves the complete total of all orders.  The second retrieves the total for each
            customer; grouped by each customer.
        </p>
        </a><p><a id="group_by_illustration">
            In a grouped query, the where clause applies to the non aggregated values (essentially it determines whether
            rows will make it into the aggregation).  The <code class="literal">HAVING</code> clause also restricts results,
            but it operates on the aggregated values.  In the </a><a class="xref" href="#group_by_illustration" title="Example&nbsp;13.38.&nbsp;Group-by illustration">Example&nbsp;13.38, “Group-by illustration”</a> example,
            we retrieved order totals for all customers.  If that ended up being too much data to deal with,
            we might want to restrict the results to focus only on customers with a summed order total of more than
            $10,000.00:
        </p>
        <div class="example"><a id="having_illustration"><p class="title"><strong>Example&nbsp;13.39.&nbsp;Having illustration</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">select c.id, sum( o.total )
from Order o
    inner join o.customer c
group by c.id
having sum( o.total ) &gt; 10000.00</pre>
        </div></a></div><a id="having_illustration"><br class="example-break">
        <p>
            The HAVING clause follows the same rules as the WHERE clause and is also made up of predicates.  HAVING is
            applied after the groupings and aggregations have been done; WHERE is applied before.
        </p>
    </a></div><a id="having_illustration">

    </a><div class="section" title="13.9.&nbsp;Ordering"><a id="having_illustration"></a><div class="titlepage"><a id="having_illustration"></a><div><a id="having_illustration"></a><div><a id="having_illustration"></a><h2 class="title"><a id="having_illustration"></a><a id="hql-ordering">13.9.&nbsp;Ordering</a></h2></div></div></div><a id="hql-ordering">
        
        <p>
            The results of the query can also be ordered.  The <code class="literal">ORDER BY</code> clause is used to specify
            the selected values to be used to order the result.  The types of expressions considered valid as part
             of the order-by clause include:
        </p>
        <div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
                <p>
                    state fields
                </p>
            </li><li class="listitem">
                <p>
                    component/embeddable attributes
                </p>
            </li><li class="listitem">
                <p>
                    scalar expressions such as arithmetic operations, functions, etc.
                </p>
            </li><li class="listitem">
                <p>
                    identification variable declared in the select clause for any of the previous expression types
                </p>
            </li></ul></div>
        <p>
            Additionally, JPQL says that all values referenced in the order-by clause must be named in the select
            clause.  HQL does not mandate that restriction, but applications desiring database portability should be
            aware that not all databases support referencing values in the order-by clause that are not referenced
            in the select clause.
        </p>
        <p>
            Individual expressions in the order-by can be qualified with either <code class="literal">ASC</code> (ascending) or
            <code class="literal">DESC</code> (descending) to indicated the desired ordering direction. Null values can be placed
            in front or at the end of sorted set using <code class="literal">NULLS FIRST</code> or <code class="literal">NULLS LAST</code>
            clause respectively.
        </p>
        </a><div class="example"><a id="hql-ordering"></a><a id="d5e2477"><p class="title"><strong>Example&nbsp;13.40.&nbsp;Order-by examples</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">// legal because p.name is implicitly part of p
select p
from Person p
order by p.name

select c.id, sum( o.total ) as t
from Order o
    inner join o.customer c
group by c.id
order by t
</pre>
        </div></a></div><a id="d5e2477"><br class="example-break">
    </a></div><a id="d5e2477">

    </a><div class="section" title="13.10.&nbsp;Query API"><a id="d5e2477"></a><div class="titlepage"><a id="d5e2477"></a><div><a id="d5e2477"></a><div><a id="d5e2477"></a><h2 class="title"><a id="d5e2477"></a><a id="hql-api">13.10.&nbsp;Query API</a></h2></div></div></div><a id="hql-api">
        

        </a><div class="section" title="13.10.1.&nbsp;Hibernate Query API"><a id="hql-api"></a><div class="titlepage"><a id="hql-api"></a><div><a id="hql-api"></a><div><a id="hql-api"></a><h3 class="title"><a id="hql-api"></a><a id="d5e2482">13.10.1.&nbsp;Hibernate Query API</a></h3></div></div></div><a id="d5e2482">
            

            <p>
                In Hibernate the HQL/JPQL query is represented as <code class="interfacename">org.hibernate.Query</code> which
                is obtained from the Session.  If the HQL/JPQL is a named query, <code class="methodname">Session#getNamedQuery</code>
                would be used; otherwise <code class="methodname">Session#createQuery</code> would be used.
            </p>

            </a><div class="example"><a id="d5e2482"></a><a id="d5e2488"><p class="title"><strong>Example&nbsp;13.41.&nbsp;Obtaining a Query reference - Hibernate</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Query query = session.getNamedQuery( "my-predefined-named-query" );</pre>
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Query query = session.createQuery(
    "select e.id, e.name from MyEntity e"
);</pre>
            </div></a></div><a id="d5e2488"><br class="example-break">

            <p>
                The Query interface can then be used to control the execution of the query.  For example, we
                may want to specify an execution timeout or control caching.
            </p>

            </a><div class="example"><a id="d5e2488"></a><a id="d5e2493"><p class="title"><strong>Example&nbsp;13.42.&nbsp;Basic Query usage - Hibernate</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Query query = ...;
// in seconds
query.setTimeout( 2 );
// write to L2 caches, but do not read from them
query.setCacheMode( CacheMode.REFRESH );
// assuming query cache was enabled for the SessionFactory
query.setCacheable( true );
// add a comment to the generated SQL if enabled with the SF
query.setComment( "e pluribus unum" )</pre>
            </div></a></div><a id="d5e2493"><br class="example-break">

            <p>
                For complete details, see the Query javadocs.
            </p>

            <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Important</h2>
                <p>
                    Query hints here are database query hints.  They are added directly to the generated SQL
                    according to <code class="methodname">Dialect#getQueryHintString</code>.  The JPA notion of query
                    hints, on the other hand, refer to hints that target the provider (Hibernate).  So even though
                    they are called the same, be aware they have a very different purpose.  Also be aware that
                    Hibernate query hints generally make the application non-portable across databases unless the code
                    adding them first checks the Dialect.
                </p>
            </div>

            </a><p><a id="d5e2493">
                Flushing is covered in detail in </a><a class="xref" href="#">???</a>.  Locking is covered in detail in
                <a class="xref" href="#">???</a>.  The concept of read-only state is covered in <a class="xref" href="#pc" title="Chapter&nbsp;4.&nbsp;Persistence Contexts">Chapter&nbsp;4, <em>Persistence Contexts</em></a>.
            </p>

            <p>
                Hibernate also allows an application to hook into the process of building the query results via the
                <code class="interfacename">org.hibernate.transform.ResultTransformer</code> contract.  See its javadocs
                as well as the Hibernate-provided implementations for additional details.
            </p>

            <p>
                The last thing that needs to happen before we can execute the query is to bind the values for any
                parameters defined in the query.  Query defines many overloaded methods for this purpose.  The most
                generic form takes the value as well as the Hibernate Type.
            </p>

            <div class="example"><a id="d5e2507"><p class="title"><strong>Example&nbsp;13.43.&nbsp;Parameter binding - Hibernate</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Query query = session.createQuery(
    "select e from MyEntity e where e.name like :filter"
);
query.setParameter( "filter", "D%", StringType.INSTANCE );</pre>
            </div></a></div><a id="d5e2507"><br class="example-break">

            <p>
                Hibernate generally understands the expected type of the parameter given its context in the query.
                In the previous example, since we are using the parameter in a LIKE comparison against a String-typed
                attribute Hibernate would automatically infer the type; so the above could be simplified.
            </p>

            </a><div class="example"><a id="d5e2507"></a><a id="d5e2511"><p class="title"><strong>Example&nbsp;13.44.&nbsp;Parameter binding (inferred type) - Hibernate</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Query query = session.createQuery(
    "select e from MyEntity e where e.name like :filter"
);
query.setParameter( "filter", "D%" );
</pre>
            </div></a></div><a id="d5e2511"><br class="example-break">

            <p>
                There are also short hand forms for binding common types such as strings, booleans, integers, etc.
            </p>

            </a><div class="example"><a id="d5e2511"></a><a id="d5e2515"><p class="title"><strong>Example&nbsp;13.45.&nbsp;Parameter binding (short forms) - Hibernate</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Query query = session.createQuery(
    "select e from MyEntity e where e.name like :filter"
);
query.setString( "filter", "D%" );

query = session.createQuery(
    "select e from MyEntity e where e.active = :active"
);
query.setBoolean( "active", true );</pre>
            </div></a></div><a id="d5e2515"><br class="example-break">

            <p>
                In terms of execution, Hibernate offers 4 different methods.  The 2 most commonly used are
                </p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
                        <p>
                            <code class="methodname">Query#list</code> - executes the select query and returns back the list
                            of results.
                        </p>
                    </li><li class="listitem">
                        <p>
                            <code class="methodname">Query#uniqueResult</code> - executes the select query and returns the
                            single result.  If there were more than one result an exception is thrown.
                        </p>
                    </li></ul></div><p>
            </p>

            </a><div class="example"><a id="d5e2515"></a><a id="d5e2526"><p class="title"><strong>Example&nbsp;13.46.&nbsp;list() and uniqueResult()</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">List results =
    session.createQuery( "select e from MyEntity e" )
        .list();
</pre>
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">String qry = "select e from MyEntity e " +
		" where e.code = :code"
MyEntity result = (MyEntity) session.createQuery( qry )
    .setParameter( "code", 123 )
    .uniqueResult();
</pre>
            </div></a></div><a id="d5e2526"><br class="example-break">

            <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2>
                <p>
                    If the unique result is used often and the attributes upon which it is based are unique, you may
                    want to consider mapping a natural-id and using the natural-id loading API.  See the
                    <em class="citetitle">Hibernate Domain Mapping Guide</em> for more information on natural-ids.
                </p>
            </div>

            <p>
                Hibernate offers 2 additional, specialized methods for performing the query and handling results.
                <code class="methodname">Query#scroll</code> works in tandem with the JDBC notion of a scrollable
                ResultSet.  The <code class="methodname">scroll</code> method is overloaded.  Then main form accepts a single
                argument of type <code class="interfacename">org.hibernate.ScrollMode</code> which indicates the type of
                scrolling to be used.  See the javadocs for ScrollMode for the details on each.  The second form accepts
                no argument and will use the ScrollMode indicated by
                <code class="methodname">Dialect#defaultScrollMode</code>.  <code class="methodname">Query#scroll</code> returns
                a <code class="interfacename">org.hibernate.ScrollableResults</code> which wraps the underlying JDBC
                (scrollable) ResultSet and provides access to the results.  Since this form holds the JDBC ResultSet
                open, the application should indicate when it is done with the ScrollableResults by calling
                its <code class="methodname">close</code> method (as inherited from <code class="interfacename">java.io.Closeable</code>,
                so that ScrollableResults will work with try-with-resources blocks!).  If left unclosed by the
                application, Hibernate will automatically close the ScrollableResults when the current transaction
                completes.
            </p>

            <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2>
                <p>
                    If you plan to use <code class="methodname">Query#scroll</code> with collection fetches it is important
                    that your query explicitly order the results so that the JDBC results contain the the related
                    rows sequentially.
                </p>
            </div>

            <p>
                The last is <code class="methodname">Query#iterate</code>, which is intended for loading entities which the
                the application feels certain will be in the second-level cache.  The idea behind iterate is that just
                the matching identifiers will be obtained in the SQL query.  From these the identifiers are resolved
                by second-level cache lookup.  If these second-level cache lookups fail, additional queries will
                need to be issued against the database.  This operation can perform significantly better for loading
                large numbers of entities that for certain already exist in the second-level cache.  In cases where
                many of the entities do not exist in the second-level cache, this operation will almost definitely
                perform worse.  The Iterator returned from <code class="methodname">Query#iterate</code> is actually a
                specially typed Iterator: <code class="interfacename">org.hibernate.engine.HibernateIterator</code>.  It
                is specialized to expose a <code class="methodname">close</code> method (again,
                inherited from <code class="interfacename">java.io.Closeable</code>).  When you are done with this Iterator
                you should close it, either by casting to HibernateIterator or Closeable, or by calling
                <code class="methodname">org.hibernate.Hibernate#close</code>
            </p>
        </a></div><a id="d5e2526">

        </a><div class="section" title="13.10.2.&nbsp;JPA Query API"><a id="d5e2526"></a><div class="titlepage"><a id="d5e2526"></a><div><a id="d5e2526"></a><div><a id="d5e2526"></a><h3 class="title"><a id="d5e2526"></a><a id="d5e2552">13.10.2.&nbsp;JPA Query API</a></h3></div></div></div><a id="d5e2552">
            

            <p>
                In JPA the query is represented by <code class="interfacename">javax.persistence.Query</code> or
                <code class="interfacename">javax.persistence.TypedQuery</code> as obtained from the EntityManager.  For named
                queries <code class="methodname">EntityManager#createNamedQuery</code> is used; otherwise
                <code class="methodname">EntityManager#createQuery</code> is used.
            </p>

            </a><div class="example"><a id="d5e2552"></a><a id="d5e2559"><p class="title"><strong>Example&nbsp;13.47.&nbsp;Obtaining a Query reference - JPA</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Query query = em.createNamedQuery( "my-predefined-named-query" );
TypedQuery&lt;MyEntity&gt; query2 = em.createNamedQuery(
    "my-predefined-named-query",
    MyEntity.class
);</pre>
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Query query = em.createQuery(
    "select e from MyEntity e where name like :filter"
);
TypedQuery&lt;MyEntity&gt; query2 = em.createQuery(
    "select e from MyEntity e where name like :filter"
    MyEntity.class
);</pre>
            </div></a></div><a id="d5e2559"><br class="example-break">

            <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2>
                <p>
                    This will all sound very familiar.  Not only was the JPQL syntax heavily inspired by HQL, but many
                    of the JPA APIs were heavily inspired by Hibernate.  The 2 Query contracts are very similar.
                </p>
            </div>

            <p>
                The Query interface can then be used to control the execution of the query.  For example, we
                may want to specify an execution timeout or control caching.
            </p>

            </a><div class="example"><a id="d5e2559"></a><a id="d5e2566"><p class="title"><strong>Example&nbsp;13.48.&nbsp;Basic Query usage - JPA</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Query query = ...;
// timeout - in milliseconds
query.setHint( "javax.persistence.query.timeout", 2000 )
// Do not peform (AUTO) implicit flushing
query.setFlushMode( COMMIT );</pre>
            </div></a></div><a id="d5e2566"><br class="example-break">

            <p>
                For complete details, see the Query javadocs.  Many of the settings controlling the execution of the
                query are defined as hints.  JPA defines some standard hints (like timeout in the example), but most
                are provider specific.  Relying on provider specific hints limits your applications portability to some
                degree.
            </p>

            </a><div class="itemizedlist" title="JPA standardized Query hints"><a id="d5e2566"><p class="title"><strong>JPA standardized Query hints</strong></p></a><ul class="itemizedlist"><a id="d5e2566"><li class="listitem">
                    <p>
                        <code class="literal">javax.persistence.query.timeout</code> - Defines the query timeout, in milliseconds.
                    </p>
                </li></a><li class="listitem"><a id="d5e2566">
                    </a><p><a id="d5e2566">
                        <code class="literal">javax.persistence.fetchgraph</code> - Defines a "fetchgraph" EntityGraph.
                        Attributes explicitly specified as AttributeNodes are treated as FetchType.EAGER (via join fetch
                        or subsequent select).  For details, see the EntityGraph discussions in </a><a class="xref" href="#fetching" title="Chapter&nbsp;9.&nbsp;Fetching">Chapter&nbsp;9, <em>Fetching</em></a>.
                    </p>
                </li><li class="listitem">
                    <p>
                        <code class="literal">javax.persistence.loadgraph</code> - Defines a "loadgraph" EntityGraph.  Attributes
                        explicitly specified as AttributeNodes are treated as  FetchType.EAGER (via join fetch or
                        subsequent select).  Attributes that are not specified are treated as FetchType.LAZY or
                        FetchType.EAGER depending on the attribute's definition in metadata.  For details, see the
                        EntityGraph discussions in <a class="xref" href="#fetching" title="Chapter&nbsp;9.&nbsp;Fetching">Chapter&nbsp;9, <em>Fetching</em></a>.
                    </p>
                </li></ul></div>

            <div class="itemizedlist" title="Hibernate specific JPA Query hints"><p class="title"><strong>Hibernate specific JPA Query hints</strong></p><ul class="itemizedlist"><li class="listitem">
                    <p>
                        <code class="literal">org.hibernate.cacheMode</code> - Defines the CacheMode to use.  See
                        <code class="methodname">org.hibernate.Query#setCacheMode</code>.
                    </p>
                </li><li class="listitem">
                    <p>
                        <code class="literal">org.hibernate.cacheable</code> - Defines whether the query is cacheable.
                        true/false.  See <code class="methodname">org.hibernate.Query#setCacheable</code>.
                    </p>
                </li><li class="listitem">
                    <p>
                        <code class="literal">org.hibernate.cacheRegion</code> For queries that are cacheable, defines a specific
                        cache region to use.  See <code class="methodname">org.hibernate.Query#setCacheRegion</code>.
                    </p>
                </li><li class="listitem">
                    <p>
                        <code class="literal">org.hibernate.comment</code> - Defines the comment to apply to the generated SQL.
                        See <code class="methodname">org.hibernate.Query#setComment</code>.
                    </p>
                </li><li class="listitem">
                    <p>
                        <code class="literal">org.hibernate.fetchSize</code> - Defines the JDBC fetch-size to use.  See
                        <code class="methodname">org.hibernate.Query#setFetchSize</code>
                    </p>
                </li><li class="listitem">
                    <p>
                        <code class="literal">org.hibernate.flushMode</code> - Defines the Hibernate-specific FlushMode to use.
                        See <code class="methodname">org.hibernate.Query#setFlushMode</code>.  If possible, prefer using
                        <code class="methodname">javax.persistence.Query#setFlushMode</code> instead.
                    </p>
                </li><li class="listitem">
                    <p>
                        <code class="literal">org.hibernate.readOnly</code> - Defines that entities and collections loaded by
                        this query should be marked as read-only.  See <code class="methodname">org.hibernate.Query#setReadOnly</code>
                    </p>
                </li></ul></div>

            <p>
                Just as seen in the Hibernate API, the final thing that needs to happen before the query can be
                executed is to bind the values for any defined parameters.  JPA defines a simplified set of parameter
                binding methods.  Essentially it supports setting the parameter value (by name/position) and
                a specialized form for Calendar/Date types additionally accepting a TemporalType.
            </p>

            <div class="example"><a id="d5e2615"><p class="title"><strong>Example&nbsp;13.49.&nbsp;Parameter binding - JPA</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Query query = em.createQuery(
    "select e from MyEntity e where e.name like :filter"
);
query.setParameter( "filter", "D%" );

Query q2 = em.createQuery(
    "select e from MyEntity e where e.activeDate &gt; :activeDate"
);
q2.setParameter( "activeDate", new Date(), TemporalType.DATE );</pre>
            </div></a></div><a id="d5e2615"><br class="example-break">

            <p>
                Additionally, JPA allows access to read some information about parameters as well.
            </p>

            <p>
                As far as execution, JPA supports the two main methods discussed above for the Hibernate API.  It calls
                these methods <code class="methodname">Query#getResultList</code> and <code class="methodname">Query#getSingleResult</code>.
                They behave exactly as described for <code class="methodname">org.hibernate.Query#list</code> and
                <code class="methodname">org.hibernate.Query#uniqueResult</code>.
            </p>
        </a></div><a id="d5e2615">
    </a></div><a id="d5e2615">

</a></div><a id="d5e2615">
    </a><div class="chapter" title="Chapter&nbsp;14.&nbsp;Criteria"><a id="d5e2615"></a><div class="titlepage"><a id="d5e2615"></a><div><a id="d5e2615"></a><div><a id="d5e2615"></a><h2 class="title"><a id="d5e2615"></a><a id="criteria">Chapter&nbsp;14.&nbsp;Criteria</a></h2></div></div></div><div class="toc"><p><a id="criteria"><strong>Table of Contents</strong></a></p><dl><dt><a id="criteria"><span class="section"></span></a><a href="#querycriteria-typedquery">14.1. Typed criteria queries</a></dt><dd><dl><dt><span class="section"><a href="#querycriteria-typedquery-entity">14.1.1. Selecting an entity</a></span></dt><dt><span class="section"><a href="#querycriteria-typedquery-expression">14.1.2. Selecting an expression</a></span></dt><dt><span class="section"><a href="#querycriteria-typedquery-multiselect">14.1.3. Selecting multiple values</a></span></dt><dt><span class="section"><a href="#querycriteria-typedquery-construct">14.1.4. Selecting a wrapper</a></span></dt></dl></dd><dt><span class="section"><a href="#querycriteria-tuple">14.2. Tuple criteria queries</a></span></dt><dt><span class="section"><a href="#querycriteria-from">14.3. FROM clause</a></span></dt><dd><dl><dt><span class="section"><a href="#querycriteria-from-root">14.3.1. Roots</a></span></dt><dt><span class="section"><a href="#querycriteria-from-join">14.3.2. Joins</a></span></dt><dt><span class="section"><a href="#querycriteria-from-fetch">14.3.3. Fetches</a></span></dt></dl></dd><dt><span class="section"><a href="#querycriteria-path">14.4. Path expressions</a></span></dt><dt><span class="section"><a href="#querycriteria-param">14.5. Using parameters</a></span></dt></dl></div>

    

    <p>
        Criteria queries offer a type-safe alternative to HQL, JPQL and native-sql queries.
    </p>

    <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Important</h2>
        <p>
            Hibernate offers an older, legacy <code class="interfacename">org.hibernate.Criteria</code> API which should be
            considered deprecated.  No feature development will target those APIs.  Eventually, Hibernate-specific
            criteria features will be ported as extensions to the JPA
            <code class="interfacename">javax.persistence.criteria.CriteriaQuery</code>.  For details on the
            <code class="interfacename">org.hibernate.Criteria</code> API, see <a class="xref" href="#appendix-legacy-criteria" title="Appendix&nbsp;B.&nbsp;Legacy Hibernate Criteria Queries">Appendix&nbsp;B, <em>Legacy Hibernate Criteria Queries</em></a>.
        </p>
        <p>
            This chapter will focus on the JPA APIs for declaring type-safe criteria queries.
        </p>
    </div>


    <p>
        Criteria queries are a programmatic, type-safe way to express a query.  They are type-safe in terms of
        using interfaces and classes to represent various structural parts of a query such as the query itself,
        or the select clause, or an order-by, etc.  They can also be type-safe in terms of referencing attributes
        as we will see in a bit. Users of the older Hibernate <code class="interfacename">org.hibernate.Criteria</code>
        query API will recognize the general approach, though we believe the JPA API to be superior
        as it represents a clean look at the lessons learned from that API.
    </p>

    <p>
        Criteria queries are essentially an object graph, where each part of the graph represents an increasing
        (as we navigate down this graph) more atomic part of query. The first step in performing a criteria query
        is building this graph. The <code class="interfacename">javax.persistence.criteria.CriteriaBuilder</code>
        interface is the first thing with which you need to become acquainted to begin using criteria queries. Its
        role is that of a factory for all the individual pieces of the criteria. You obtain a
        <code class="interfacename">javax.persistence.criteria.CriteriaBuilder</code> instance by calling the
        <code class="methodname">getCriteriaBuilder</code> method of either
        <code class="interfacename">javax.persistence.EntityManagerFactory</code> or
        <code class="interfacename">javax.persistence.EntityManager</code>.
    </p>

    <p>
        The next step is to obtain a <code class="interfacename">javax.persistence.criteria.CriteriaQuery</code>. This
        is accomplished using one of the 3 methods on
        <code class="interfacename">javax.persistence.criteria.CriteriaBuilder</code> for this purpose:
    </p>

    <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&lt;T&gt; CriteriaQuery&lt;T&gt; createQuery(Class&lt;T&gt; resultClass);
CriteriaQuery&lt;Tuple&gt; createTupleQuery();
CriteriaQuery&lt;Object&gt; createQuery();
</pre>

    <p>
        Each serves a different purpose depending on the expected type of the query results.
    </p>

    <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2>
        <p>
            <em class="citetitle">Chapter 6 Criteria API</em> of the JPA Specification
            already contains a decent amount of reference material pertaining to the various parts of a
            criteria query. So rather than duplicate all that content here, lets instead look at some of
            the more widely anticipated usages of the API.
        </p>
    </div>

    <div class="section" title="14.1.&nbsp;Typed criteria queries"><div class="titlepage"><div><div><h2 class="title"><a id="querycriteria-typedquery">14.1.&nbsp;Typed criteria queries</a></h2></div></div></div><a id="querycriteria-typedquery">
        

        <p>
            The type of the criteria query (aka the &lt;T&gt;) indicates the expected types in the query
            result.  This might be an entity, an Integer, or any other object.
        </p>

        </a><div class="section" title="14.1.1.&nbsp;Selecting an entity"><a id="querycriteria-typedquery"></a><div class="titlepage"><a id="querycriteria-typedquery"></a><div><a id="querycriteria-typedquery"></a><div><a id="querycriteria-typedquery"></a><h3 class="title"><a id="querycriteria-typedquery"></a><a id="querycriteria-typedquery-entity">14.1.1.&nbsp;Selecting an entity</a></h3></div></div></div><a id="querycriteria-typedquery-entity">
            

            <p>
                This is probably the most common form of query.  The application wants to select entity instances.
            </p>

            </a><div class="example"><a id="querycriteria-typedquery-entity"></a><a id="ex-criteria-typedquery-entity"><p class="title"><strong>Example&nbsp;14.1.&nbsp;Selecting the root entity</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">CriteriaQuery&lt;Person&gt; criteria = builder.createQuery( Person.class );
Root&lt;Person&gt; personRoot = criteria.from( Person.class );
criteria.select( personRoot );
criteria.where( builder.equal( personRoot.get( Person_.eyeColor ), "brown" ) );

List&lt;Person&gt; people = em.createQuery( criteria ).getResultList();
for ( Person person : people ) {
    ...
}</pre>
            </div></a></div><a id="ex-criteria-typedquery-entity"><br class="example-break">

            <p>
                The example uses <code class="methodname">createQuery</code> passing in the <code class="classname">Person</code>
                class reference as the results of the query will be Person objects.
            </p>

            <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2>
                <p>
                    The call to the <code class="methodname">CriteriaQuery.select</code> method in this example is
                    unnecessary because <span class="emphasis"><em>personRoot</em></span> will be the implied selection since we
                    have only a single query root. It was done here only for completeness of an example.
                </p>
                <p>
                    The <span class="emphasis"><em>Person_.eyeColor</em></span> reference is an example of the static form of JPA
                    metamodel reference.  We will use that form exclusively in this chapter.  See
                    the documentation for the Hibernate JPA Metamodel Generator for additional details on
                    the JPA static metamodel.
                </p>
            </div>
        </a></div><a id="ex-criteria-typedquery-entity">

        </a><div class="section" title="14.1.2.&nbsp;Selecting an expression"><a id="ex-criteria-typedquery-entity"></a><div class="titlepage"><a id="ex-criteria-typedquery-entity"></a><div><a id="ex-criteria-typedquery-entity"></a><div><a id="ex-criteria-typedquery-entity"></a><h3 class="title"><a id="ex-criteria-typedquery-entity"></a><a id="querycriteria-typedquery-expression">14.1.2.&nbsp;Selecting an expression</a></h3></div></div></div><a id="querycriteria-typedquery-expression">
            

            <p>
                The simplest form of selecting an expression is selecting a particular attribute from an entity.
                But this expression might also represent an aggregation, a mathematical operation, etc.
            </p>

            </a><div class="example"><a id="querycriteria-typedquery-expression"></a><a id="ex-criteria-typedquery-attribute"><p class="title"><strong>Example&nbsp;14.2.&nbsp;Selecting an attribute</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">CriteriaQuery&lt;Integer&gt; criteria = builder.createQuery( Integer.class );
Root&lt;Person&gt; personRoot = criteria.from( Person.class );
criteria.select( personRoot.get( Person_.age ) );
criteria.where( builder.equal( personRoot.get( Person_.eyeColor ), "brown" ) );

List&lt;Integer&gt; ages = em.createQuery( criteria ).getResultList();
for ( Integer age : ages ) {
	...
}</pre>
            </div></a></div><a id="ex-criteria-typedquery-attribute"><br class="example-break">

            <p>
                In this example, the query is typed as <code class="classname">java.lang.Integer</code> because that
                is the anticipated type of the results (the type of the <code class="methodname">Person#age</code> attribute
                is <code class="classname">java.lang.Integer</code>).  Because a query might contain multiple references to
                the Person entity, attribute references always need to be qualified.  This is accomplished by the
                <code class="methodname">Root#get</code> method call.
            </p>
        </a></div><a id="ex-criteria-typedquery-attribute">


        </a><div class="section" title="14.1.3.&nbsp;Selecting multiple values"><a id="ex-criteria-typedquery-attribute"></a><div class="titlepage"><a id="ex-criteria-typedquery-attribute"></a><div><a id="ex-criteria-typedquery-attribute"></a><div><a id="ex-criteria-typedquery-attribute"></a><h3 class="title"><a id="ex-criteria-typedquery-attribute"></a><a id="querycriteria-typedquery-multiselect">14.1.3.&nbsp;Selecting multiple values</a></h3></div></div></div><a id="querycriteria-typedquery-multiselect">
            

            </a><p><a id="querycriteria-typedquery-multiselect">
                There are actually a few different ways to select multiple values using criteria queries. We
                will explore 2 options here, but an alternative recommended approach is to use tuples as described in
                </a><a class="xref" href="#querycriteria-tuple" title="14.2.&nbsp;Tuple criteria queries">Section&nbsp;14.2, “Tuple criteria queries”</a>.  Or consider a wrapper query; see
                <a class="xref" href="#querycriteria-typedquery-construct" title="14.1.4.&nbsp;Selecting a wrapper">Section&nbsp;14.1.4, “Selecting a wrapper”</a> for details.
            </p>

            <div class="example"><a id="ex-criteria-typedquery-array"><p class="title"><strong>Example&nbsp;14.3.&nbsp;Selecting an array</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">CriteriaQuery&lt;Object[]&gt; criteria = builder.createQuery( Object[].class );
Root&lt;Person&gt; personRoot = criteria.from( Person.class );
Path&lt;Long&gt; idPath = personRoot.get( Person_.id );
Path&lt;Integer&gt; agePath = personRoot.get( Person_.age );
criteria.select( builder.array( idPath, agePath ) );
criteria.where( builder.equal( personRoot.get( Person_.eyeColor ), "brown" ) );

List&lt;Object[]&gt; valueArray = em.createQuery( criteria ).getResultList();
for ( Object[] values : valueArray ) {
	final Long id = (Long) values[0];
	final Integer age = (Integer) values[1];
	...
}</pre>
            </div></a></div><a id="ex-criteria-typedquery-array"><br class="example-break">

            <p>
                Technically this is classified as a typed query, but you can see from handling the results that
                this is sort of misleading.  Anyway, the expected result type here is an array.
            </p>

            <p>
                The example then uses the <code class="methodname">array</code> method of
                <code class="interfacename">javax.persistence.criteria.CriteriaBuilder</code> which explicitly
                combines individual selections into a
                <code class="interfacename">javax.persistence.criteria.CompoundSelection</code>.
            </p>

            </a><div class="example"><a id="ex-criteria-typedquery-array"></a><a id="ex-criteria-typedquery-array2"><p class="title"><strong>Example&nbsp;14.4.&nbsp;Selecting an array (2)</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">CriteriaQuery&lt;Object[]&gt; criteria = builder.createQuery( Object[].class );
Root&lt;Person&gt; personRoot = criteria.from( Person.class );
Path&lt;Long&gt; idPath = personRoot.get( Person_.id );
Path&lt;Integer&gt; agePath = personRoot.get( Person_.age );
criteria.multiselect( idPath, agePath );
criteria.where( builder.equal( personRoot.get( Person_.eyeColor ), "brown" ) );

List&lt;Object[]&gt; valueArray = em.createQuery( criteria ).getResultList();
for ( Object[] values : valueArray ) {
    final Long id = (Long) values[0];
    final Integer age = (Integer) values[1];
    ...
}</pre>
            </div></a></div><a id="ex-criteria-typedquery-array2"><br class="example-break">

            </a><p><a id="ex-criteria-typedquery-array2">
                Just as we saw in </a><a class="xref" href="#ex-criteria-typedquery-array" title="Example&nbsp;14.3.&nbsp;Selecting an array">Example&nbsp;14.3, “Selecting an array”</a> we have a typed criteria
                query returning an Object array.  Both queries are functionally equivalent.  This second example
                uses the <code class="methodname">multiselect</code> method which behaves slightly differently based on
                the type given when the criteria query was first built, but in this case it says to select and
                return an <span class="emphasis"><em>Object[]</em></span>.
            </p>
        </div>

        <div class="section" title="14.1.4.&nbsp;Selecting a wrapper"><div class="titlepage"><div><div><h3 class="title"><a id="querycriteria-typedquery-construct">14.1.4.&nbsp;Selecting a wrapper</a></h3></div></div></div><a id="querycriteria-typedquery-construct">
            

            </a><p><a id="querycriteria-typedquery-construct">Another alternative to </a><a class="xref" href="#querycriteria-typedquery-multiselect" title="14.1.3.&nbsp;Selecting multiple values">Section&nbsp;14.1.3, “Selecting multiple values”</a> is to instead
                select an object that will <span class="quote">“<span class="quote">wrap</span>”</span> the multiple values. Going back to the example
                query there, rather than returning an array of <span class="emphasis"><em>[Person#id, Person#age]</em></span>
                instead declare a class that holds these values and instead return that.
            </p>

            <div class="example"><a id="ex-criteria-typedquery-construct"><p class="title"><strong>Example&nbsp;14.5.&nbsp;Selecting an wrapper</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">public class PersonWrapper {
	private final Long id;
	private final Integer age;
	public PersonWrapper(Long id, Integer age) {
		this.id = id;
		this.age = age;
	}
	...
}

...

CriteriaQuery&lt;PersonWrapper&gt; criteria = builder.createQuery( PersonWrapper.class );
Root&lt;Person&gt; personRoot = criteria.from( Person.class );
criteria.select(
		builder.construct(
			PersonWrapper.class,
			personRoot.get( Person_.id ),
			personRoot.get( Person_.age )
		)
);
criteria.where( builder.equal( personRoot.get( Person_.eyeColor ), "brown" ) );

List&lt;PersonWrapper&gt; people = em.createQuery( criteria ).getResultList();
for ( PersonWrapper person : people ) {
    ...
}</pre>
            </div></a></div><a id="ex-criteria-typedquery-construct"><br class="example-break">

            <p>
                First we see the simple definition of the wrapper object we will be using to wrap our result
                values. Specifically notice the constructor and its argument types.  Since we will be returning
                <code class="classname">PersonWrapper</code> objects, we use <code class="classname">PersonWrapper</code> as the
                type of our criteria query.
            </p>

            <p>
                This example illustrates the use of the
                <code class="interfacename">javax.persistence.criteria.CriteriaBuilder</code> method
                <code class="methodname">construct</code> which is used to build a wrapper expression.  For every row in the
                result we are saying we would like a <span class="emphasis"><em>PersonWrapper</em></span> instantiated with
                the remaining arguments by the matching constructor. This wrapper expression is then passed as
                the select.
            </p>
        </a></div><a id="ex-criteria-typedquery-construct">
    </a></div><a id="ex-criteria-typedquery-construct">

    </a><div class="section" title="14.2.&nbsp;Tuple criteria queries"><a id="ex-criteria-typedquery-construct"></a><div class="titlepage"><a id="ex-criteria-typedquery-construct"></a><div><a id="ex-criteria-typedquery-construct"></a><div><a id="ex-criteria-typedquery-construct"></a><h2 class="title"><a id="ex-criteria-typedquery-construct"></a><a id="querycriteria-tuple">14.2.&nbsp;Tuple criteria queries</a></h2></div></div></div><a id="querycriteria-tuple">
        

        </a><p><a id="querycriteria-tuple">
            A better approach to </a><a class="xref" href="#querycriteria-typedquery-multiselect" title="14.1.3.&nbsp;Selecting multiple values">Section&nbsp;14.1.3, “Selecting multiple values”</a> is to use either a
            wrapper (which we just saw in <a class="xref" href="#querycriteria-typedquery-construct" title="14.1.4.&nbsp;Selecting a wrapper">Section&nbsp;14.1.4, “Selecting a wrapper”</a>) or using the
            <code class="interfacename">javax.persistence.Tuple</code> contract.
        </p>

        <div class="example"><a id="ex-criteria-typedquery-tuple"><p class="title"><strong>Example&nbsp;14.6.&nbsp;Selecting a tuple</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">CriteriaQuery&lt;Tuple&gt; criteria = builder.createTupleQuery();
Root&lt;Person&gt; personRoot = criteria.from( Person.class );
Path&lt;Long&gt; idPath = personRoot.get( Person_.id );
Path&lt;Integer&gt; agePath = personRoot.get( Person_.age );
criteria.multiselect( idPath, agePath );
criteria.where( builder.equal( personRoot.get( Person_.eyeColor ), "brown" ) );

List&lt;Tuple&gt; tuples = em.createQuery( criteria ).getResultList();
for ( Tuple tuple : valueArray ) {
    assert tuple.get( 0 ) == tuple.get( idPath );
	assert tuple.get( 1 ) == tuple.get( agePath );
	...
}</pre>
        </div></a></div><a id="ex-criteria-typedquery-tuple"><br class="example-break">

        <p>
            This example illustrates accessing the query results through the
            <code class="interfacename">javax.persistence.Tuple</code> interface.  The example uses the explicit
            <code class="methodname">createTupleQuery</code> of
            <code class="interfacename">javax.persistence.criteria.CriteriaBuilder</code>.  An alternate approach
            is to use <code class="methodname">createQuery</code> passing <code class="literal">Tuple.class</code>.
        </p>

        </a><p><a id="ex-criteria-typedquery-tuple">
            Again we see the use of the <code class="methodname">multiselect</code> method, just like in
            </a><a class="xref" href="#ex-criteria-typedquery-array2" title="Example&nbsp;14.4.&nbsp;Selecting an array (2)">Example&nbsp;14.4, “Selecting an array (2)”</a>. The difference here is that the type of the
            <code class="interfacename">javax.persistence.criteria.CriteriaQuery</code> was defined as
            <code class="interfacename">javax.persistence.Tuple</code> so the compound selections in this case are
            interpreted to be the tuple elements.
        </p>

        <p>
            The <code class="interfacename">javax.persistence.Tuple</code> contract provides 3 forms of access to
            the underlying elements:
        </p>

        <div class="variablelist"><dl><dt><span class="term">typed</span></dt><dd>
                    <p>
                        The <a class="xref" href="#ex-criteria-typedquery-tuple" title="Example&nbsp;14.6.&nbsp;Selecting a tuple">Example&nbsp;14.6, “Selecting a tuple”</a> example illustrates this form of access
                        in the <code class="literal">tuple.get( idPath )</code> and <code class="literal">tuple.get( agePath )</code> calls.
                        This allows typed access to the underlying tuple values based on the
                        <code class="interfacename">javax.persistence.TupleElement</code> expressions used to build
                        the criteria.
                    </p>
                </dd><dt><span class="term">positional</span></dt><dd>
                    <p>
                        Allows access to the underlying tuple values based on the position.  The simple
                        <span class="emphasis"><em>Object get(int position)</em></span> form is very similar to the access
                        illustrated in <a class="xref" href="#ex-criteria-typedquery-array" title="Example&nbsp;14.3.&nbsp;Selecting an array">Example&nbsp;14.3, “Selecting an array”</a> and
                        <a class="xref" href="#ex-criteria-typedquery-array2" title="Example&nbsp;14.4.&nbsp;Selecting an array (2)">Example&nbsp;14.4, “Selecting an array (2)”</a>.  The
                        <span class="emphasis"><em>&lt;X&gt; X get(int position, Class&lt;X&gt; type</em></span> form
                        allows typed positional access, but based on the explicitly supplied type which the tuple
                        value must be type-assignable to.
                    </p>
                </dd><dt><span class="term">aliased</span></dt><dd>
                    <p>
                        Allows access to the underlying tuple values based an (optionally) assigned alias.  The
                        example query did not apply an alias.  An alias would be applied via the
                        <code class="methodname">alias</code> method on
                        <code class="interfacename">javax.persistence.criteria.Selection</code>.  Just like
                        <code class="literal">positional</code> access, there is both a typed
                        (<span class="emphasis"><em>Object get(String alias)</em></span>) and an untyped
                        (<span class="emphasis"><em>&lt;X&gt; X get(String alias, Class&lt;X&gt; type</em></span> form.
                    </p>
                </dd></dl></div>
    </div>

    <div class="section" title="14.3.&nbsp;FROM clause"><div class="titlepage"><div><div><h2 class="title"><a id="querycriteria-from">14.3.&nbsp;FROM clause</a></h2></div></div></div><a id="querycriteria-from">
        

        <div class="blockquote"><table class="blockquote" summary="Block quote" cellpadding="0" cellspacing="0" width="100%" border="0"><tbody><tr><td valign="top" width="10%">&nbsp;</td><td valign="top" width="80%"><p>
                A CriteriaQuery object defines a query over one or more entity, embeddable, or basic abstract
                schema types. The root objects of the query are entities, from which the other types are reached
                by navigation.
            </p></td><td valign="top" width="10%">&nbsp;</td></tr><tr><td valign="top" width="10%">&nbsp;</td><td colspan="2" valign="top" align="right">--<span class="attribution"><em class="citetitle">JPA Specification</em>, section 6.5.2 Query Roots, pg 262</span></td></tr></tbody></table></div>

        <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2>
            <p>
                All the individual parts of the FROM clause (roots, joins, paths) implement the
                <code class="interfacename">javax.persistence.criteria.From</code> interface.
            </p>
        </div>

        </a><div class="section" title="14.3.1.&nbsp;Roots"><a id="querycriteria-from"></a><div class="titlepage"><a id="querycriteria-from"></a><div><a id="querycriteria-from"></a><div><a id="querycriteria-from"></a><h3 class="title"><a id="querycriteria-from"></a><a id="querycriteria-from-root">14.3.1.&nbsp;Roots</a></h3></div></div></div><a id="querycriteria-from-root">
            

            <p>
                Roots define the basis from which all joins, paths and attributes are available in the query.
                A root is always an entity type.  Roots are defined and added to the criteria by the overloaded
                <code class="methodname">from</code> methods on
                <code class="interfacename">javax.persistence.criteria.CriteriaQuery</code>:
            </p>

            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&lt;X&gt; Root&lt;X&gt; from(Class&lt;X&gt;);

&lt;X&gt; Root&lt;X&gt; from(EntityType&lt;X&gt;)</pre>

            </a><div class="example"><a id="querycriteria-from-root"></a><a id="d5e2778"><p class="title"><strong>Example&nbsp;14.7.&nbsp;Adding a root</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">CriteriaQuery&lt;Person&gt; personCriteria = builder.createQuery( Person.class );
// create and add the root
person.from( Person.class );</pre>
            </div></a></div><a id="d5e2778"><br class="example-break">

            <p>
                Criteria queries may define multiple roots, the effect of which is to create a cartesian
                product between the newly added root and the others. Here is an example matching all single
                men and all single women:
            </p>

            </a><div class="example"><a id="d5e2778"></a><a id="d5e2782"><p class="title"><strong>Example&nbsp;14.8.&nbsp;Adding multiple roots</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">CriteriaQuery query = builder.createQuery();
Root&lt;Person&gt; men = query.from( Person.class );
Root&lt;Person&gt; women = query.from( Person.class );
Predicate menRestriction = builder.and(
		builder.equal( men.get( Person_.gender ), Gender.MALE ),
		builder.equal( men.get( Person_.relationshipStatus ), RelationshipStatus.SINGLE )
);
Predicate womenRestriction = builder.and(
		builder.equal( women.get( Person_.gender ), Gender.FEMALE ),
		builder.equal( women.get( Person_.relationshipStatus ), RelationshipStatus.SINGLE )
);
query.where( builder.and( menRestriction, womenRestriction ) );</pre>
            </div></a></div><a id="d5e2782"><br class="example-break">
        </a></div><a id="d5e2782">

        </a><div class="section" title="14.3.2.&nbsp;Joins"><a id="d5e2782"></a><div class="titlepage"><a id="d5e2782"></a><div><a id="d5e2782"></a><div><a id="d5e2782"></a><h3 class="title"><a id="d5e2782"></a><a id="querycriteria-from-join">14.3.2.&nbsp;Joins</a></h3></div></div></div><a id="querycriteria-from-join">
            

            <p>
                Joins allow navigation from other <code class="interfacename">javax.persistence.criteria.From</code>
                to either association or embedded attributes.  Joins are created by the numerous overloaded
                <code class="methodname">join</code> methods of the
                <code class="interfacename">javax.persistence.criteria.From</code> interface
            </p>

            </a><div class="example"><a id="querycriteria-from-join"></a><a id="criteria-join-singular"><p class="title"><strong>Example&nbsp;14.9.&nbsp;Example with Embedded and ManyToOne</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">CriteriaQuery&lt;Person&gt; personCriteria = builder.createQuery( Person.class );
Root&lt;Person&gt; personRoot = person.from( Person.class );
// Person.address is an embedded attribute
Join&lt;Person,Address&gt; personAddress = personRoot.join( Person_.address );
// Address.country is a ManyToOne
Join&lt;Address,Country&gt; addressCountry = personAddress.join( Address_.country );</pre>
            </div></a></div><a id="criteria-join-singular"><br class="example-break">

            </a><div class="example"><a id="criteria-join-singular"></a><a id="criteria-join-plural"><p class="title"><strong>Example&nbsp;14.10.&nbsp;Example with Collections</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">CriteriaQuery&lt;Person&gt; personCriteria = builder.createQuery( Person.class );
Root&lt;Person&gt; personRoot = person.from( Person.class );
Join&lt;Person,Order&gt; orders = personRoot.join( Person_.orders );
Join&lt;Order,LineItem&gt; orderLines = orders.join( Order_.lineItems );</pre>
            </div></a></div><a id="criteria-join-plural"><br class="example-break">
        </a></div><a id="criteria-join-plural">

        </a><div class="section" title="14.3.3.&nbsp;Fetches"><a id="criteria-join-plural"></a><div class="titlepage"><a id="criteria-join-plural"></a><div><a id="criteria-join-plural"></a><div><a id="criteria-join-plural"></a><h3 class="title"><a id="criteria-join-plural"></a><a id="querycriteria-from-fetch">14.3.3.&nbsp;Fetches</a></h3></div></div></div><a id="querycriteria-from-fetch">
            

            <p>
                Just like in HQL and JPQL, criteria queries can specify that associated data be fetched along
                with the owner.  Fetches are created by the numerous overloaded <code class="methodname">fetch</code>
                methods of the <code class="interfacename">javax.persistence.criteria.From</code> interface.
            </p>

            </a><div class="example"><a id="querycriteria-from-fetch"></a><a id="criteria-fetch-singular"><p class="title"><strong>Example&nbsp;14.11.&nbsp;Example with Embedded and ManyToOne</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">CriteriaQuery&lt;Person&gt; personCriteria = builder.createQuery( Person.class );
Root&lt;Person&gt; personRoot = person.from( Person.class );
// Person.address is an embedded attribute
Fetch&lt;Person,Address&gt; personAddress = personRoot.fetch( Person_.address );
// Address.country is a ManyToOne
Fetch&lt;Address,Country&gt; addressCountry = personAddress.fetch( Address_.country );</pre>
            </div></a></div><a id="criteria-fetch-singular"><br class="example-break">

            <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2>
                <p>
                    Technically speaking, embedded attributes are always fetched with their owner.  However in
                    order to define the fetching of <span class="emphasis"><em>Address#country</em></span> we needed a
                    <code class="interfacename">javax.persistence.criteria.Fetch</code> for its parent path.
                </p>
            </div>

            </a><div class="example"><a id="criteria-fetch-singular"></a><a id="criteria-fetch-plural"><p class="title"><strong>Example&nbsp;14.12.&nbsp;Example with Collections</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">CriteriaQuery&amp;lt;Person&amp;gt; personCriteria = builder.createQuery( Person.class );
Root&lt;Person&gt; personRoot = person.from( Person.class );
Fetch&lt;Person,Order&gt; orders = personRoot.fetch( Person_.orders );
Fetch&lt;Order,LineItem&gt; orderLines = orders.fetch( Order_.lineItems );</pre>
            </div></a></div><a id="criteria-fetch-plural"><br class="example-break">
        </a></div><a id="criteria-fetch-plural">
    </a></div><a id="criteria-fetch-plural">

    </a><div class="section" title="14.4.&nbsp;Path expressions"><a id="criteria-fetch-plural"></a><div class="titlepage"><a id="criteria-fetch-plural"></a><div><a id="criteria-fetch-plural"></a><div><a id="criteria-fetch-plural"></a><h2 class="title"><a id="criteria-fetch-plural"></a><a id="querycriteria-path">14.4.&nbsp;Path expressions</a></h2></div></div></div><a id="querycriteria-path">
        
        <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2>
            <p>
                Roots, joins and fetches are themselves paths as well.
            </p>
        </div>
    </a></div><a id="querycriteria-path">

    </a><div class="section" title="14.5.&nbsp;Using parameters"><a id="querycriteria-path"></a><div class="titlepage"><a id="querycriteria-path"></a><div><a id="querycriteria-path"></a><div><a id="querycriteria-path"></a><h2 class="title"><a id="querycriteria-path"></a><a id="querycriteria-param">14.5.&nbsp;Using parameters</a></h2></div></div></div><a id="querycriteria-param">
        

        </a><div class="example"><a id="querycriteria-param"></a><a id="ex-querycriteria-param"><p class="title"><strong>Example&nbsp;14.13.&nbsp;Using parameters</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">CriteriaQuery&lt;Person&gt; criteria = build.createQuery( Person.class );
Root&lt;Person&gt; personRoot = criteria.from( Person.class );
criteria.select( personRoot );
ParameterExpression&lt;String&gt; eyeColorParam = builder.parameter( String.class );
criteria.where( builder.equal( personRoot.get( Person_.eyeColor ), eyeColorParam ) );

TypedQuery&lt;Person&gt; query = em.createQuery( criteria );
query.setParameter( eyeColorParam, "brown" );
List&lt;Person&gt; people = query.getResultList();</pre>
        </div></a></div><a id="ex-querycriteria-param"><br class="example-break">

        <p>
            Use the <code class="methodname">parameter</code> method of
            <code class="interfacename">javax.persistence.criteria.CriteriaBuilder</code> to obtain a parameter
            reference.  Then use the parameter reference to bind the parameter value to the
            <code class="interfacename">javax.persistence.Query</code>
        </p>
    </a></div><a id="ex-querycriteria-param">

</a></div><a id="ex-querycriteria-param">
    </a><div class="chapter" title="Chapter&nbsp;15.&nbsp;Native SQL Queries"><a id="ex-querycriteria-param"></a><div class="titlepage"><a id="ex-querycriteria-param"></a><div><a id="ex-querycriteria-param"></a><div><a id="ex-querycriteria-param"></a><h2 class="title"><a id="ex-querycriteria-param"></a><a id="querynative">Chapter&nbsp;15.&nbsp;Native SQL Queries</a></h2></div></div></div><div class="toc"><p><a id="querynative"><strong>Table of Contents</strong></a></p><dl><dt><a id="querynative"><span class="section"></span></a><a href="#querynative-creating">15.1. Using a <code class="literal">SQLQuery</code></a></dt><dd><dl><dt><span class="section"><a href="#d5e2834">15.1.1. Scalar queries</a></span></dt><dt><span class="section"><a href="#d5e2858">15.1.2. Entity queries</a></span></dt><dt><span class="section"><a href="#d5e2876">15.1.3. Handling associations and collections</a></span></dt><dt><span class="section"><a href="#d5e2889">15.1.4. Returning multiple entities</a></span></dt><dt><span class="section"><a href="#d5e2981">15.1.5. Returning non-managed entities</a></span></dt><dt><span class="section"><a href="#d5e2993">15.1.6. Handling inheritance</a></span></dt><dt><span class="section"><a href="#d5e2996">15.1.7. Parameters</a></span></dt></dl></dd><dt><span class="section"><a href="#querysql-namedqueries">15.2. Named SQL queries</a></span></dt><dd><dl><dt><span class="section"><a href="#propertyresults">15.2.1. Using return-property to explicitly specify column/alias
      names</a></span></dt><dt><span class="section"><a href="#sp_query">15.2.2. Using stored procedures for querying</a></span></dt></dl></dd><dt><span class="section"><a href="#querysql-cud">15.3. Custom SQL for create, update and delete</a></span></dt><dt><span class="section"><a href="#querysql-load">15.4. Custom SQL for loading</a></span></dt></dl></div>

    

    <p>
        You may also express queries in the native SQL dialect of your database. This is useful if you
        want to utilize database specific features such as query hints or the CONNECT BY option in Oracle.
        It also provides a clean migration path from a direct SQL/JDBC based application to Hibernate/JPA.
        Hibernate also allows you to specify handwritten SQL (including stored procedures) for all
        create, update, delete, and load operations.
    </p>

  <div class="section" title="15.1.&nbsp;Using a SQLQuery"><div class="titlepage"><div><div><h2 class="title"><a id="querynative-creating">15.1.&nbsp;Using a <code class="literal">SQLQuery</code></a></h2></div></div></div><a id="querynative-creating">
    

    <p>Execution of native SQL queries is controlled via the
    <code class="literal">SQLQuery</code> interface, which is obtained by calling
    <code class="literal">Session.createSQLQuery()</code>. The following sections
    describe how to use this API for querying.</p>

    </a><div class="section" title="15.1.1.&nbsp;Scalar queries"><a id="querynative-creating"></a><div class="titlepage"><a id="querynative-creating"></a><div><a id="querynative-creating"></a><div><a id="querynative-creating"></a><h3 class="title"><a id="querynative-creating"></a><a id="d5e2834">15.1.1.&nbsp;Scalar queries</a></h3></div></div></div><a id="d5e2834">
      

      <p>The most basic SQL query is to get a list of scalars
      (values).</p>

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">sess.createSQLQuery("SELECT * FROM CATS").list();
sess.createSQLQuery("SELECT ID, NAME, BIRTHDATE FROM CATS").list();
</pre>

      <p>These will return a List of Object arrays (Object[]) with scalar
      values for each column in the CATS table. Hibernate will use
      ResultSetMetadata to deduce the actual order and types of the returned
      scalar values.</p>

      <p>To avoid the overhead of using
      <code class="literal">ResultSetMetadata</code>, or simply to be more explicit in
      what is returned, one can use <code class="literal">addScalar()</code>:</p>

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">sess.createSQLQuery("SELECT * FROM CATS")
 .addScalar("ID", Hibernate.LONG)
 .addScalar("NAME", Hibernate.STRING)
 .addScalar("BIRTHDATE", Hibernate.DATE)
</pre>

      <p>This query specified:</p>

      <div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
          <p>the SQL query string</p>
        </li><li class="listitem">
          <p>the columns and types to return</p>
        </li></ul></div>

      <p>This will return Object arrays, but now it will not use
      <code class="literal">ResultSetMetadata</code> but will instead explicitly get the
      ID, NAME and BIRTHDATE column as respectively a Long, String and a Short
      from the underlying resultset. This also means that only these three
      columns will be returned, even though the query is using
      <code class="literal">*</code> and could return more than the three listed
      columns.</p>

      <p>It is possible to leave out the type information for all or some
      of the scalars.</p>

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">sess.createSQLQuery("SELECT * FROM CATS")
 .addScalar("ID", Hibernate.LONG)
 .addScalar("NAME")
 .addScalar("BIRTHDATE")
</pre>

      <p>This is essentially the same query as before, but now
      <code class="literal">ResultSetMetaData</code> is used to determine the type of
      NAME and BIRTHDATE, where as the type of ID is explicitly
      specified.</p>

      <p>How the java.sql.Types returned from ResultSetMetaData is mapped
      to Hibernate types is controlled by the Dialect. If a specific type is
      not mapped, or does not result in the expected type, it is possible to
      customize it via calls to <code class="literal">registerHibernateType</code> in
      the Dialect.</p>
    </a></div><a id="d5e2834">

    </a><div class="section" title="15.1.2.&nbsp;Entity queries"><a id="d5e2834"></a><div class="titlepage"><a id="d5e2834"></a><div><a id="d5e2834"></a><div><a id="d5e2834"></a><h3 class="title"><a id="d5e2834"></a><a id="d5e2858">15.1.2.&nbsp;Entity queries</a></h3></div></div></div><a id="d5e2858">
      

      <p>The above queries were all about returning scalar values,
      basically returning the "raw" values from the resultset. The following
      shows how to get entity objects from a native sql query via
      <code class="literal">addEntity()</code>.</p>

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">sess.createSQLQuery("SELECT * FROM CATS").addEntity(Cat.class);
sess.createSQLQuery("SELECT ID, NAME, BIRTHDATE FROM CATS").addEntity(Cat.class);
</pre>

      <p>This query specified:</p>

      <div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
          <p>the SQL query string</p>
        </li><li class="listitem">
          <p>the entity returned by the query</p>
        </li></ul></div>

      <p>Assuming that Cat is mapped as a class with the columns ID, NAME
      and BIRTHDATE the above queries will both return a List where each
      element is a Cat entity.</p>

      <p>If the entity is mapped with a <code class="literal">many-to-one</code> to
      another entity it is required to also return this when performing the
      native query, otherwise a database specific "column not found" error
      will occur. The additional columns will automatically be returned when
      using the * notation, but we prefer to be explicit as in the following
      example for a <code class="literal">many-to-one</code> to a
      <code class="literal">Dog</code>:</p>

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">sess.createSQLQuery("SELECT ID, NAME, BIRTHDATE, DOG_ID FROM CATS").addEntity(Cat.class);
</pre>

      <p>This will allow cat.getDog() to function properly.</p>
    </a></div><a id="d5e2858">

    </a><div class="section" title="15.1.3.&nbsp;Handling associations and collections"><a id="d5e2858"></a><div class="titlepage"><a id="d5e2858"></a><div><a id="d5e2858"></a><div><a id="d5e2858"></a><h3 class="title"><a id="d5e2858"></a><a id="d5e2876">15.1.3.&nbsp;Handling associations and collections</a></h3></div></div></div><a id="d5e2876">
      

      <p>It is possible to eagerly join in the <code class="literal">Dog</code> to
      avoid the possible extra roundtrip for initializing the proxy. This is
      done via the <code class="literal">addJoin()</code> method, which allows you to
      join in an association or collection.</p>

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">sess.createSQLQuery("SELECT c.ID, NAME, BIRTHDATE, DOG_ID, D_ID, D_NAME FROM CATS c, DOGS d WHERE c.DOG_ID = d.D_ID")
 .addEntity("cat", Cat.class)
 .addJoin("cat.dog");
</pre>

      <p>In this example, the returned <code class="literal">Cat</code>'s will have
      their <code class="literal">dog</code> property fully initialized without any
      extra roundtrip to the database. Notice that you added an alias name
      ("cat") to be able to specify the target property path of the join. It
      is possible to do the same eager joining for collections, e.g. if the
      <code class="literal">Cat</code> had a one-to-many to <code class="literal">Dog</code>
      instead.</p>

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">sess.createSQLQuery("SELECT ID, NAME, BIRTHDATE, D_ID, D_NAME, CAT_ID FROM CATS c, DOGS d WHERE c.ID = d.CAT_ID")
 .addEntity("cat", Cat.class)
 .addJoin("cat.dogs");
</pre>

      <p>At this stage you are reaching the limits of what is possible with
      native queries, without starting to enhance the sql queries to make them
      usable in Hibernate. Problems can arise when returning multiple entities
      of the same type or when the default alias/column names are not
      enough.</p>
    </a></div><a id="d5e2876">

    </a><div class="section" title="15.1.4.&nbsp;Returning multiple entities"><a id="d5e2876"></a><div class="titlepage"><a id="d5e2876"></a><div><a id="d5e2876"></a><div><a id="d5e2876"></a><h3 class="title"><a id="d5e2876"></a><a id="d5e2889">15.1.4.&nbsp;Returning multiple entities</a></h3></div></div></div><a id="d5e2889">
      

      <p>Until now, the result set column names are assumed to be the same
      as the column names specified in the mapping document. This can be
      problematic for SQL queries that join multiple tables, since the same
      column names can appear in more than one table.</p>

      <p>Column alias injection is needed in the following query (which
      most likely will fail):</p>

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">sess.createSQLQuery("SELECT c.*, m.*  FROM CATS c, CATS m WHERE c.MOTHER_ID = c.ID")
 .addEntity("cat", Cat.class)
 .addEntity("mother", Cat.class)
</pre>

      <p>The query was intended to return two Cat instances per row: a cat
      and its mother. The query will, however, fail because there is a
      conflict of names; the instances are mapped to the same column names.
      Also, on some databases the returned column aliases will most likely be
      on the form "c.ID", "c.NAME", etc. which are not equal to the columns
      specified in the mappings ("ID" and "NAME").</p>

      <p>The following form is not vulnerable to column name
      duplication:</p>

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">sess.createSQLQuery("SELECT {cat.*}, {m.*}  FROM CATS c, CATS m WHERE c.MOTHER_ID = m.ID")
 .addEntity("cat", Cat.class)
 .addEntity("mother", Cat.class)
</pre>

      <p>This query specified:</p>

      <div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
          <p>the SQL query string, with placeholders for Hibernate to
          inject column aliases</p>
        </li><li class="listitem">
          <p>the entities returned by the query</p>
        </li></ul></div>

      <p>The {cat.*} and {mother.*} notation used above is a shorthand for
      "all properties". Alternatively, you can list the columns explicitly,
      but even in this case Hibernate injects the SQL column aliases for each
      property. The placeholder for a column alias is just the property name
      qualified by the table alias. In the following example, you retrieve
      Cats and their mothers from a different table (cat_log) to the one
      declared in the mapping metadata. You can even use the property aliases
      in the where clause.</p>

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">String sql = "SELECT ID as {c.id}, NAME as {c.name}, " +
         "BIRTHDATE as {c.birthDate}, MOTHER_ID as {c.mother}, {mother.*} " +
         "FROM CAT_LOG c, CAT_LOG m WHERE {c.mother} = c.ID";

List loggedCats = sess.createSQLQuery(sql)
        .addEntity("cat", Cat.class)
        .addEntity("mother", Cat.class).list()
</pre>

      </a><div class="section" title="15.1.4.1.&nbsp;Alias and property references"><a id="d5e2889"></a><div class="titlepage"><a id="d5e2889"></a><div><a id="d5e2889"></a><div><a id="d5e2889"></a><h4 class="title"><a id="d5e2889"></a><a id="querysql-aliasreferences">15.1.4.1.&nbsp;Alias and property references</a></h4></div></div></div><a id="querysql-aliasreferences">
        

        <p>In most cases the above alias injection is needed. For queries
        relating to more complex mappings, like composite properties,
        inheritance discriminators, collections etc., you can use specific
        aliases that allow Hibernate to inject the proper aliases.</p>

        <p>The following table shows the different ways you can use the
        alias injection. Please note that the alias names in the result are
        simply examples; each alias will have a unique and probably different
        name when used.</p>

        </a><div class="table"><a id="querysql-aliasreferences"></a><a id="aliasinjection-summary"><p class="title"><strong>Table&nbsp;15.1.&nbsp;Alias injection names</strong></p><div class="table-contents">
          

          <table summary="Alias injection names" border="1"><colgroup><col width="1*"><col width="1*"><col width="2.5*"></colgroup><thead><tr><th>Description</th><th>Syntax</th><th>Example</th></tr></thead><tbody><tr><td>A simple property</td><td><code class="literal">{[aliasname].[propertyname]</code></td><td><code class="literal">A_NAME as {item.name}</code></td></tr><tr><td>A composite property</td><td><code class="literal">{[aliasname].[componentname].[propertyname]}</code></td><td><code class="literal">CURRENCY as {item.amount.currency}, VALUE as
                {item.amount.value}</code></td></tr><tr><td>Discriminator of an entity</td><td><code class="literal">{[aliasname].class}</code></td><td><code class="literal">DISC as {item.class}</code></td></tr><tr><td>All properties of an entity</td><td><code class="literal">{[aliasname].*}</code></td><td><code class="literal">{item.*}</code></td></tr><tr><td>A collection key</td><td><code class="literal">{[aliasname].key}</code></td><td><code class="literal">ORGID as {coll.key}</code></td></tr><tr><td>The id of an collection</td><td><code class="literal">{[aliasname].id}</code></td><td><code class="literal">EMPID as {coll.id}</code></td></tr><tr><td>The element of an collection</td><td><code class="literal">{[aliasname].element}</code></td><td><code class="literal">XID as {coll.element}</code></td></tr><tr><td>property of the element in the collection</td><td><code class="literal">{[aliasname].element.[propertyname]}</code></td><td><code class="literal">NAME as {coll.element.name}</code></td></tr><tr><td>All properties of the element in the collection</td><td><code class="literal">{[aliasname].element.*}</code></td><td><code class="literal">{coll.element.*}</code></td></tr><tr><td>All properties of the collection</td><td><code class="literal">{[aliasname].*}</code></td><td><code class="literal">{coll.*}</code></td></tr></tbody></table>
        </div></a></div><a id="aliasinjection-summary"><br class="table-break">
      </a></div><a id="aliasinjection-summary">
    </a></div><a id="aliasinjection-summary">

    </a><div class="section" title="15.1.5.&nbsp;Returning non-managed entities"><a id="aliasinjection-summary"></a><div class="titlepage"><a id="aliasinjection-summary"></a><div><a id="aliasinjection-summary"></a><div><a id="aliasinjection-summary"></a><h3 class="title"><a id="aliasinjection-summary"></a><a id="d5e2981">15.1.5.&nbsp;Returning non-managed entities</a></h3></div></div></div><a id="d5e2981">
      

      <p>It is possible to apply a ResultTransformer to native SQL queries,
      allowing it to return non-managed entities.</p>

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">sess.createSQLQuery("SELECT NAME, BIRTHDATE FROM CATS")
        .setResultTransformer(Transformers.aliasToBean(CatDTO.class))</pre>

      <p>This query specified:</p>

      <div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
          <p>the SQL query string</p>
        </li><li class="listitem">
          <p>a result transformer</p>
        </li></ul></div>

      <p>The above query will return a list of <code class="literal">CatDTO</code>
      which has been instantiated and injected the values of NAME and
      BIRTHNAME into its corresponding properties or fields.</p>
    </a></div><a id="d5e2981">

    </a><div class="section" title="15.1.6.&nbsp;Handling inheritance"><a id="d5e2981"></a><div class="titlepage"><a id="d5e2981"></a><div><a id="d5e2981"></a><div><a id="d5e2981"></a><h3 class="title"><a id="d5e2981"></a><a id="d5e2993">15.1.6.&nbsp;Handling inheritance</a></h3></div></div></div><a id="d5e2993">
      

      <p>Native SQL queries which query for entities that are mapped as
      part of an inheritance must include all properties for the baseclass and
      all its subclasses.</p>
    </a></div><a id="d5e2993">

    </a><div class="section" title="15.1.7.&nbsp;Parameters"><a id="d5e2993"></a><div class="titlepage"><a id="d5e2993"></a><div><a id="d5e2993"></a><div><a id="d5e2993"></a><h3 class="title"><a id="d5e2993"></a><a id="d5e2996">15.1.7.&nbsp;Parameters</a></h3></div></div></div><a id="d5e2996">
      

      <p>Native SQL queries support positional as well as named
      parameters:</p>

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Query query = sess.createSQLQuery("SELECT * FROM CATS WHERE NAME like ?").addEntity(Cat.class);
List pusList = query.setString(0, "Pus%").list();

query = sess.createSQLQuery("SELECT * FROM CATS WHERE NAME like :name").addEntity(Cat.class);
List pusList = query.setString("name", "Pus%").list();          </pre>
    </a></div><a id="d5e2996">
  </a></div><a id="d5e2996">

  </a><div class="section" title="15.2.&nbsp;Named SQL queries"><a id="d5e2996"></a><div class="titlepage"><a id="d5e2996"></a><div><a id="d5e2996"></a><div><a id="d5e2996"></a><h2 class="title"><a id="d5e2996"></a><a id="querysql-namedqueries">15.2.&nbsp;Named SQL queries</a></h2></div></div></div><a id="querysql-namedqueries">
    

    <p>Named SQL queries can also be defined in the mapping document and
    called in exactly the same way as a named HQL query. In this case, you do
    <span class="emphasis"><em>not</em></span> need to call
    <code class="literal">addEntity()</code>.</p>

    </a><div class="example"><a id="querysql-namedqueries"></a><a id="d5e3005"><p class="title"><strong>Example&nbsp;15.1.&nbsp;Named sql query using the &lt;sql-query&gt; maping
      element</strong></p><div class="example-contents">
      

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&lt;sql-query name="persons"&gt;
    &lt;return alias="person" class="eg.Person"/&gt;
    SELECT person.NAME AS {person.name},
           person.AGE AS {person.age},
           person.SEX AS {person.sex}
    FROM PERSON person
    WHERE person.NAME LIKE :namePattern
&lt;/sql-query&gt;</pre>
    </div></a></div><a id="d5e3005"><br class="example-break">

    </a><div class="example"><a id="d5e3005"></a><a id="d5e3008"><p class="title"><strong>Example&nbsp;15.2.&nbsp;Execution of a named query</strong></p><div class="example-contents">
      

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">List people = sess.getNamedQuery("persons")
    .setString("namePattern", namePattern)
    .setMaxResults(50)
    .list();</pre>
    </div></a></div><a id="d5e3008"><br class="example-break">

    <p>The <code class="literal">&lt;return-join&gt;</code> element is use to join
    associations and the <code class="literal">&lt;load-collection&gt;</code> element is
    used to define queries which initialize collections,</p>

    </a><div class="example"><a id="d5e3008"></a><a id="d5e3014"><p class="title"><strong>Example&nbsp;15.3.&nbsp;Named sql query with association</strong></p><div class="example-contents">
      

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&lt;sql-query name="personsWith"&gt;
    &lt;return alias="person" class="eg.Person"/&gt;
    &lt;return-join alias="address" property="person.mailingAddress"/&gt;
    SELECT person.NAME AS {person.name},
           person.AGE AS {person.age},
           person.SEX AS {person.sex},
           address.STREET AS {address.street},
           address.CITY AS {address.city},
           address.STATE AS {address.state},
           address.ZIP AS {address.zip}
    FROM PERSON person
    JOIN ADDRESS address
        ON person.ID = address.PERSON_ID AND address.TYPE='MAILING'
    WHERE person.NAME LIKE :namePattern
&lt;/sql-query&gt;</pre>
    </div></a></div><a id="d5e3014"><br class="example-break">

    <p>A named SQL query may return a scalar value. You must declare the
    column alias and Hibernate type using the
    <code class="literal">&lt;return-scalar&gt;</code> element:</p>

    </a><div class="example"><a id="d5e3014"></a><a id="d5e3019"><p class="title"><strong>Example&nbsp;15.4.&nbsp;Named query returning a scalar</strong></p><div class="example-contents">
      

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&lt;sql-query name="mySqlQuery"&gt;
    &lt;return-scalar column="name" type="string"/&gt;
    &lt;return-scalar column="age" type="long"/&gt;
    SELECT p.NAME AS name,
           p.AGE AS age,
    FROM PERSON p WHERE p.NAME LIKE 'Hiber%'
&lt;/sql-query&gt;</pre>
    </div></a></div><a id="d5e3019"><br class="example-break">

    <p>You can externalize the resultset mapping information in a
    <code class="literal">&lt;resultset&gt;</code> element which will allow you to
    either reuse them across several named queries or through the
    <code class="literal">setResultSetMapping()</code> API.</p>

    </a><div class="example"><a id="d5e3019"></a><a id="d5e3025"><p class="title"><strong>Example&nbsp;15.5.&nbsp;&lt;resultset&gt; mapping used to externalize mapping
      information</strong></p><div class="example-contents">
      

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&lt;resultset name="personAddress"&gt;
    &lt;return alias="person" class="eg.Person"/&gt;
    &lt;return-join alias="address" property="person.mailingAddress"/&gt;
&lt;/resultset&gt;

&lt;sql-query name="personsWith" resultset-ref="personAddress"&gt;
    SELECT person.NAME AS {person.name},
           person.AGE AS {person.age},
           person.SEX AS {person.sex},
           address.STREET AS {address.street},
           address.CITY AS {address.city},
           address.STATE AS {address.state},
           address.ZIP AS {address.zip}
    FROM PERSON person
    JOIN ADDRESS address
        ON person.ID = address.PERSON_ID AND address.TYPE='MAILING'
    WHERE person.NAME LIKE :namePattern
&lt;/sql-query&gt;</pre>
    </div></a></div><a id="d5e3025"><br class="example-break">

    <p>You can, alternatively, use the resultset mapping information in
    your hbm files directly in java code.</p>

    </a><div class="example"><a id="d5e3025"></a><a id="d5e3029"><p class="title"><strong>Example&nbsp;15.6.&nbsp;Programmatically specifying the result mapping information
      </strong></p><div class="example-contents">
      

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">List cats = sess.createSQLQuery(
        "select {cat.*}, {kitten.*} from cats cat, cats kitten where kitten.mother = cat.id"
    )
    .setResultSetMapping("catAndKitten")
    .list();</pre>
    </div></a></div><a id="d5e3029"><br class="example-break">

    <p>So far we have only looked at externalizing SQL queries using
    Hibernate mapping files. The same concept is also available with
    anntations and is called named native queries. You can use
    <code class="classname">@NamedNativeQuery</code>
    (<code class="classname">@NamedNativeQueries</code>) in conjunction with
    <code class="literal">@SqlResultSetMapping</code>
    (<code class="literal">@SqlResultSetMappings</code>). Like
    <code class="literal">@NamedQuery</code>, <code class="classname">@NamedNativeQuery</code>
    and <code class="literal">@SqlResultSetMapping</code> can be defined at class level,
    but their scope is global to the application. Lets look at a view
    examples.</p>

    </a><p><a id="d5e3029"></a><a class="xref" href="#example-named-native-query-annotation-with-result-set-mapping" title="Example&nbsp;15.7.&nbsp;Named SQL query using @NamedNativeQuery together with @SqlResultSetMapping">Example&nbsp;15.7, “Named SQL query using <code class="classname">@NamedNativeQuery</code>
      together with <code class="classname">@SqlResultSetMapping</code>”</a>
    shows how a <code class="literal">resultSetMapping</code> parameter is defined in
    <code class="literal">@NamedNativeQuery</code>. It represents the name of a defined
    <code class="literal">@SqlResultSetMapping</code>. The resultset mapping declares
    the entities retrieved by this native query. Each field of the entity is
    bound to an SQL alias (or column name). All fields of the entity including
    the ones of subclasses and the foreign key columns of related entities
    have to be present in the SQL query. Field definitions are optional
    provided that they map to the same column name as the one declared on the
    class property. In the example 2 entities, <code class="literal">Night</code> and
    <code class="literal">Area</code>, are returned and each property is declared and
    associated to a column name, actually the column name retrieved by the
    query. </p>

    <p>In <a class="xref" href="#example-implicit-result-set-mapping" title="Example&nbsp;15.8.&nbsp;Implicit result set mapping">Example&nbsp;15.8, “Implicit result set mapping”</a> the result
    set mapping is implicit. We only describe the entity class of the result
    set mapping. The property / column mappings is done using the entity
    mapping values. In this case the model property is bound to the model_txt
    column. </p>

    <p>Finally, if the association to a related entity involve a composite
    primary key, a <code class="literal">@FieldResult</code> element should be used for
    each foreign key column. The <code class="literal">@FieldResult</code> name is
    composed of the property name for the relationship, followed by a dot
    ("."), followed by the name or the field or property of the primary key.
    This can be seen in <a class="xref" href="#example-field-result-annotation-with-associations" title="Example&nbsp;15.9.&nbsp;Using dot notation in @FieldResult for specifying associations">Example&nbsp;15.9, “Using dot notation in @FieldResult for specifying associations
      ”</a>.</p>

    <div class="example"><a id="example-named-native-query-annotation-with-result-set-mapping"><p class="title"><strong>Example&nbsp;15.7.&nbsp;Named SQL query using <code class="classname">@NamedNativeQuery</code>
      together with <code class="classname">@SqlResultSetMapping</code></strong></p><div class="example-contents">
      

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">NamedNativeQuery</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">name</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_literal">"night&amp;area"</span><!-- <br/> --><span class="java_separator">,</span><!-- <br/> --><span class="java_plain">&nbsp;query</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_literal">"select&nbsp;night.id&nbsp;nid,&nbsp;night.night_duration,&nbsp;"</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">+</span><span class="java_plain">&nbsp;</span><span class="java_literal">"&nbsp;night.night_date,&nbsp;area.id&nbsp;aid,&nbsp;night.area_id,&nbsp;area.name&nbsp;"</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">+</span><span class="java_plain">&nbsp;</span><span class="java_literal">"from&nbsp;Night&nbsp;night,&nbsp;Area&nbsp;area&nbsp;where&nbsp;night.area_id&nbsp;=&nbsp;area.id"</span><span class="java_separator">,</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resultSetMapping</span><span class="java_operator">=</span><span class="java_literal">"joinMapping"</span><span class="java_separator">)</span>
<!--  --><br><span class="java_plain">@</span><span class="java_type">SqlResultSetMapping</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">"joinMapping"</span><span class="java_separator">,</span><span class="java_plain">&nbsp;entities</span><span class="java_operator">=</span><span class="java_separator">{</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">EntityResult</span><span class="java_separator">(</span><span class="java_plain">entityClass</span><span class="java_operator">=</span><span class="java_type">Night</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">,</span><span class="java_plain">&nbsp;fields&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">FieldResult</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">"id"</span><span class="java_separator">,</span><span class="java_plain">&nbsp;column</span><span class="java_operator">=</span><span class="java_literal">"nid"</span><span class="java_separator">),</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">FieldResult</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">"duration"</span><span class="java_separator">,</span><span class="java_plain">&nbsp;column</span><span class="java_operator">=</span><span class="java_literal">"night_duration"</span><span class="java_separator">),</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">FieldResult</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">"date"</span><span class="java_separator">,</span><span class="java_plain">&nbsp;column</span><span class="java_operator">=</span><span class="java_literal">"night_date"</span><span class="java_separator">),</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">FieldResult</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">"area"</span><span class="java_separator">,</span><span class="java_plain">&nbsp;column</span><span class="java_operator">=</span><span class="java_literal">"area_id"</span><span class="java_separator">),</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;discriminatorColumn</span><span class="java_operator">=</span><span class="java_literal">"disc"</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}),</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">EntityResult</span><span class="java_separator">(</span><span class="java_plain">entityClass</span><span class="java_operator">=</span><span class="java_plain">org</span><span class="java_separator">.</span><span class="java_plain">hibernate</span><span class="java_separator">.</span><span class="java_plain">test</span><span class="java_separator">.</span><span class="java_plain">annotations</span><span class="java_separator">.</span><span class="java_plain">query</span><span class="java_separator">.</span><span class="java_type">Area</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">,</span><span class="java_plain">&nbsp;fields&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">FieldResult</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">"id"</span><span class="java_separator">,</span><span class="java_plain">&nbsp;column</span><span class="java_operator">=</span><span class="java_literal">"aid"</span><span class="java_separator">),</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">FieldResult</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">"name"</span><span class="java_separator">,</span><span class="java_plain">&nbsp;column</span><span class="java_operator">=</span><span class="java_literal">"name"</span><span class="java_separator">)</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">})</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br><span class="java_separator">)</span></pre>
    </div></a></div><a id="example-named-native-query-annotation-with-result-set-mapping"><br class="example-break">

    </a><div class="example"><a id="example-named-native-query-annotation-with-result-set-mapping"></a><a id="example-implicit-result-set-mapping"><p class="title"><strong>Example&nbsp;15.8.&nbsp;Implicit result set mapping</strong></p><div class="example-contents">
      

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">Entity</span>
<!--  --><br><span class="java_plain">@</span><span class="java_type">SqlResultSetMapping</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">"implicit"</span><span class="java_separator">,</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entities</span><span class="java_operator">=</span><span class="java_plain">@</span><span class="java_type">EntityResult</span><span class="java_separator">(</span><span class="java_plain">entityClass</span><span class="java_operator">=</span><span class="java_type">SpaceShip</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">))</span>
<!--  --><br><span class="java_plain">@</span><span class="java_type">NamedNativeQuery</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">"implicitSample"</span><span class="java_separator">,</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;query</span><span class="java_operator">=</span><span class="java_literal">"select&nbsp;*&nbsp;from&nbsp;SpaceShip"</span><span class="java_separator">,</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resultSetMapping</span><span class="java_operator">=</span><span class="java_literal">"implicit"</span><span class="java_separator">)</span>
<!--  --><br><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">SpaceShip</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;name</span><span class="java_separator">;</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;model</span><span class="java_separator">;</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">double</span><span class="java_plain">&nbsp;speed</span><span class="java_separator">;</span>

<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Id</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;getName</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;name</span><span class="java_separator">;</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>

<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;setName</span><span class="java_separator">(</span><span class="java_type">String</span><span class="java_plain">&nbsp;name</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">this</span><span class="java_separator">.</span><span class="java_plain">name&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;name</span><span class="java_separator">;</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>

<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Column</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">"model_txt"</span><span class="java_separator">)</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;getModel</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;model</span><span class="java_separator">;</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>

<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;setModel</span><span class="java_separator">(</span><span class="java_type">String</span><span class="java_plain">&nbsp;model</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">this</span><span class="java_separator">.</span><span class="java_plain">model&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;model</span><span class="java_separator">;</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>

<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">double</span><span class="java_plain">&nbsp;getSpeed</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;speed</span><span class="java_separator">;</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>

<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;setSpeed</span><span class="java_separator">(</span><span class="java_type">double</span><span class="java_plain">&nbsp;speed</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">this</span><span class="java_separator">.</span><span class="java_plain">speed&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;speed</span><span class="java_separator">;</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br><span class="java_separator">}</span></pre>
    </div></a></div><a id="example-implicit-result-set-mapping"><br class="example-break">

    </a><div class="example"><a id="example-implicit-result-set-mapping"></a><a id="example-field-result-annotation-with-associations"><p class="title"><strong>Example&nbsp;15.9.&nbsp;Using dot notation in @FieldResult for specifying associations
      </strong></p><div class="example-contents">
      

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">Entity</span>
<!--  --><br><span class="java_plain">@</span><span class="java_type">SqlResultSetMapping</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">"compositekey"</span><span class="java_separator">,</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entities</span><span class="java_operator">=</span><span class="java_plain">@</span><span class="java_type">EntityResult</span><span class="java_separator">(</span><span class="java_plain">entityClass</span><span class="java_operator">=</span><span class="java_type">SpaceShip</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">,</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fields&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">FieldResult</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">"name"</span><span class="java_separator">,</span><span class="java_plain">&nbsp;column&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">"name"</span><span class="java_separator">),</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">FieldResult</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">"model"</span><span class="java_separator">,</span><span class="java_plain">&nbsp;column&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">"model"</span><span class="java_separator">),</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">FieldResult</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">"speed"</span><span class="java_separator">,</span><span class="java_plain">&nbsp;column&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">"speed"</span><span class="java_separator">),</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">FieldResult</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">"captain.firstname"</span><span class="java_separator">,</span><span class="java_plain">&nbsp;column&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">"firstn"</span><span class="java_separator">),</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">FieldResult</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">"captain.lastname"</span><span class="java_separator">,</span><span class="java_plain">&nbsp;column&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">"lastn"</span><span class="java_separator">),</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">FieldResult</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">"dimensions.length"</span><span class="java_separator">,</span><span class="java_plain">&nbsp;column&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">"length"</span><span class="java_separator">),</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">FieldResult</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">"dimensions.width"</span><span class="java_separator">,</span><span class="java_plain">&nbsp;column&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">"width"</span><span class="java_separator">)</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}),</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;columns&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;@</span><span class="java_type">ColumnResult</span><span class="java_separator">(</span><span class="java_plain">name&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">"surface"</span><span class="java_separator">),</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">ColumnResult</span><span class="java_separator">(</span><span class="java_plain">name&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">"volume"</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">}</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span>

<!--  --><br><span class="java_plain">@</span><span class="java_type">NamedNativeQuery</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">"compositekey"</span><span class="java_separator">,</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;query</span><span class="java_operator">=</span><span class="java_literal">"select&nbsp;name,&nbsp;model,&nbsp;speed,&nbsp;lname&nbsp;as&nbsp;lastn,&nbsp;fname&nbsp;as&nbsp;firstn,&nbsp;length,&nbsp;width,&nbsp;length&nbsp;*&nbsp;width&nbsp;as&nbsp;surface&nbsp;from&nbsp;SpaceShip"</span><span class="java_separator">,</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;resultSetMapping</span><span class="java_operator">=</span><span class="java_literal">"compositekey"</span><span class="java_separator">)</span>
<!--  --><br><span class="java_separator">}</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span>
<!--  --><br><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">SpaceShip</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;name</span><span class="java_separator">;</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;model</span><span class="java_separator">;</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">double</span><span class="java_plain">&nbsp;speed</span><span class="java_separator">;</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">Captain</span><span class="java_plain">&nbsp;captain</span><span class="java_separator">;</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">Dimensions</span><span class="java_plain">&nbsp;dimensions</span><span class="java_separator">;</span>

<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Id</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;getName</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;name</span><span class="java_separator">;</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>

<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;setName</span><span class="java_separator">(</span><span class="java_type">String</span><span class="java_plain">&nbsp;name</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">this</span><span class="java_separator">.</span><span class="java_plain">name&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;name</span><span class="java_separator">;</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>

<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">ManyToOne</span><span class="java_separator">(</span><span class="java_plain">fetch</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">FetchType</span><span class="java_separator">.</span><span class="java_plain">LAZY</span><span class="java_separator">)</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">JoinColumns</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">JoinColumn</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">"fname"</span><span class="java_separator">,</span><span class="java_plain">&nbsp;referencedColumnName&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">"firstname"</span><span class="java_separator">),</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">JoinColumn</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">"lname"</span><span class="java_separator">,</span><span class="java_plain">&nbsp;referencedColumnName&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">"lastname"</span><span class="java_separator">)</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">Captain</span><span class="java_plain">&nbsp;getCaptain</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;captain</span><span class="java_separator">;</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>

<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;setCaptain</span><span class="java_separator">(</span><span class="java_type">Captain</span><span class="java_plain">&nbsp;captain</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">this</span><span class="java_separator">.</span><span class="java_plain">captain&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;captain</span><span class="java_separator">;</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>

<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;getModel</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;model</span><span class="java_separator">;</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>

<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;setModel</span><span class="java_separator">(</span><span class="java_type">String</span><span class="java_plain">&nbsp;model</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">this</span><span class="java_separator">.</span><span class="java_plain">model&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;model</span><span class="java_separator">;</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>

<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">double</span><span class="java_plain">&nbsp;getSpeed</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;speed</span><span class="java_separator">;</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>

<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;setSpeed</span><span class="java_separator">(</span><span class="java_type">double</span><span class="java_plain">&nbsp;speed</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">this</span><span class="java_separator">.</span><span class="java_plain">speed&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;speed</span><span class="java_separator">;</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>

<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">Dimensions</span><span class="java_plain">&nbsp;getDimensions</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;dimensions</span><span class="java_separator">;</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>

<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;setDimensions</span><span class="java_separator">(</span><span class="java_type">Dimensions</span><span class="java_plain">&nbsp;dimensions</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">this</span><span class="java_separator">.</span><span class="java_plain">dimensions&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;dimensions</span><span class="java_separator">;</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br><span class="java_separator">}</span>

<!--  --><br><span class="java_plain">@</span><span class="java_type">Entity</span>
<!--  --><br><span class="java_plain">@</span><span class="java_type">IdClass</span><span class="java_separator">(</span><span class="java_type">Identity</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">)</span>
<!--  --><br><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">Captain</span><span class="java_plain">&nbsp;</span><span class="java_keyword">implements</span><span class="java_plain">&nbsp;</span><span class="java_type">Serializable</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;firstname</span><span class="java_separator">;</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;lastname</span><span class="java_separator">;</span>

<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Id</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;getFirstname</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;firstname</span><span class="java_separator">;</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>

<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;setFirstname</span><span class="java_separator">(</span><span class="java_type">String</span><span class="java_plain">&nbsp;firstname</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">this</span><span class="java_separator">.</span><span class="java_plain">firstname&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;firstname</span><span class="java_separator">;</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>

<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Id</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;getLastname</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;lastname</span><span class="java_separator">;</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>

<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;setLastname</span><span class="java_separator">(</span><span class="java_type">String</span><span class="java_plain">&nbsp;lastname</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">this</span><span class="java_separator">.</span><span class="java_plain">lastname&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;lastname</span><span class="java_separator">;</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br><span class="java_separator">}</span>
</pre>
    </div></a></div><a id="example-field-result-annotation-with-associations"><br class="example-break">

    <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Tip</h2>
      <p>If you retrieve a single entity using the default mapping, you can
      specify the <code class="literal">resultClass</code> attribute instead of
      <code class="literal">resultSetMapping</code>:</p>

      <pre xmlns="" class="JAVA"><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">NamedNativeQuery</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">name</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_literal">"implicitSample"</span><!-- <br/> --><span class="java_separator">,</span><!-- <br/> --><span class="java_plain">&nbsp;query</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_literal">"select&nbsp;*&nbsp;from&nbsp;SpaceShip"</span><!-- <br/> --><span class="java_separator">,</span><!-- <br/> --><span class="java_plain">&nbsp;resultClass</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_type">SpaceShip</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_keyword">class</span><!-- <br/> --><span class="java_separator">)</span>
<!--  --><br><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">SpaceShip</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span></pre>
    </div>

    <p>In some of your native queries, you'll have to return scalar values,
    for example when building report queries. You can map them in the
    <code class="literal">@SqlResultsetMapping</code> through
    <code class="literal">@ColumnResult</code>. You actually can even mix, entities and
    scalar returns in the same native query (this is probably not that common
    though).</p>

    </a><div class="example"><a id="example-field-result-annotation-with-associations"></a><a id="d5e3072"><p class="title"><strong>Example&nbsp;15.10.&nbsp;Scalar values via <code class="classname">@ColumnResult</code></strong></p><div class="example-contents">
      

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">SqlResultSetMapping</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">name</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_literal">"scalar"</span><!-- <br/> --><span class="java_separator">,</span><!-- <br/> --><span class="java_plain">&nbsp;columns</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">ColumnResult</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">name</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_literal">"dimension"</span><!-- <br/> --><span class="java_separator">))</span>
<!--  --><br><span class="java_plain">@</span><span class="java_type">NamedNativeQuery</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">"scalar"</span><span class="java_separator">,</span><span class="java_plain">&nbsp;query</span><span class="java_operator">=</span><span class="java_literal">"select&nbsp;length*width&nbsp;as&nbsp;dimension&nbsp;from&nbsp;SpaceShip"</span><span class="java_separator">,</span><span class="java_plain">&nbsp;resultSetMapping</span><span class="java_operator">=</span><span class="java_literal">"scalar"</span><span class="java_separator">)</span></pre>
    </div></a></div><a id="d5e3072"><br class="example-break">

    <p>An other query hint specific to native queries has been introduced:
    <code class="literal">org.hibernate.callable</code> which can be true or false
    depending on whether the query is a stored procedure or not.</p>

    </a><div class="section" title="15.2.1.&nbsp;Using return-property to explicitly specify column/alias names"><a id="d5e3072"></a><div class="titlepage"><a id="d5e3072"></a><div><a id="d5e3072"></a><div><a id="d5e3072"></a><h3 class="title"><a id="d5e3072"></a><a id="propertyresults">15.2.1.&nbsp;Using return-property to explicitly specify column/alias
      names</a></h3></div></div></div><a id="propertyresults">
      

      <p>You can explicitly tell Hibernate what column aliases to use with
      <code class="literal">&lt;return-property&gt;</code>, instead of using the
      <code class="literal">{}</code>-syntax to let Hibernate inject its own aliases.For
      example:</p>

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&lt;sql-query name="mySqlQuery"&gt;
    &lt;return alias="person" class="eg.Person"&gt;
        &lt;return-property name="name" column="myName"/&gt;
        &lt;return-property name="age" column="myAge"/&gt;
        &lt;return-property name="sex" column="mySex"/&gt;
    &lt;/return&gt;
    SELECT person.NAME AS myName,
           person.AGE AS myAge,
           person.SEX AS mySex,
    FROM PERSON person WHERE person.NAME LIKE :name
&lt;/sql-query&gt;
</pre>

      <p><code class="literal">&lt;return-property&gt;</code> also works with
      multiple columns. This solves a limitation with the
      <code class="literal">{}</code>-syntax which cannot allow fine grained control of
      multi-column properties.</p>

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&lt;sql-query name="organizationCurrentEmployments"&gt;
    &lt;return alias="emp" class="Employment"&gt;
        &lt;return-property name="salary"&gt;
            &lt;return-column name="VALUE"/&gt;
            &lt;return-column name="CURRENCY"/&gt;
        &lt;/return-property&gt;
        &lt;return-property name="endDate" column="myEndDate"/&gt;
    &lt;/return&gt;
        SELECT EMPLOYEE AS {emp.employee}, EMPLOYER AS {emp.employer},
        STARTDATE AS {emp.startDate}, ENDDATE AS {emp.endDate},
        REGIONCODE as {emp.regionCode}, EID AS {emp.id}, VALUE, CURRENCY
        FROM EMPLOYMENT
        WHERE EMPLOYER = :id AND ENDDATE IS NULL
        ORDER BY STARTDATE ASC
&lt;/sql-query&gt;</pre>

      <p>In this example <code class="literal">&lt;return-property&gt;</code> was
      used in combination with the <code class="literal">{}</code>-syntax for injection.
      This allows users to choose how they want to refer column and
      properties.</p>

      <p>If your mapping has a discriminator you must use
      <code class="literal">&lt;return-discriminator&gt;</code> to specify the
      discriminator column.</p>
    </a></div><a id="propertyresults">

    </a><div class="section" title="15.2.2.&nbsp;Using stored procedures for querying"><a id="propertyresults"></a><div class="titlepage"><a id="propertyresults"></a><div><a id="propertyresults"></a><div><a id="propertyresults"></a><h3 class="title"><a id="propertyresults"></a><a id="sp_query">15.2.2.&nbsp;Using stored procedures for querying</a></h3></div></div></div><a id="sp_query">
      

      <p>Hibernate provides support for queries via stored procedures and
      functions. Most of the following documentation is equivalent for both.
      The stored procedure/function must return a resultset as the first
      out-parameter to be able to work with Hibernate. An example of such a
      stored function in Oracle 9 and higher is as follows:</p>

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">CREATE OR REPLACE FUNCTION selectAllEmployments
    RETURN SYS_REFCURSOR
AS
    st_cursor SYS_REFCURSOR;
BEGIN
    OPEN st_cursor FOR
 SELECT EMPLOYEE, EMPLOYER,
 STARTDATE, ENDDATE,
 REGIONCODE, EID, VALUE, CURRENCY
 FROM EMPLOYMENT;
      RETURN  st_cursor;
 END;</pre>

      <p>To use this query in Hibernate you need to map it via a named
      query.</p>

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&lt;sql-query name="selectAllEmployees_SP" callable="true"&gt;
    &lt;return alias="emp" class="Employment"&gt;
        &lt;return-property name="employee" column="EMPLOYEE"/&gt;
        &lt;return-property name="employer" column="EMPLOYER"/&gt;
        &lt;return-property name="startDate" column="STARTDATE"/&gt;
        &lt;return-property name="endDate" column="ENDDATE"/&gt;
        &lt;return-property name="regionCode" column="REGIONCODE"/&gt;
        &lt;return-property name="id" column="EID"/&gt;
        &lt;return-property name="salary"&gt;
            &lt;return-column name="VALUE"/&gt;
            &lt;return-column name="CURRENCY"/&gt;
        &lt;/return-property&gt;
    &lt;/return&gt;
    { ? = call selectAllEmployments() }
&lt;/sql-query&gt;</pre>

      <p>Stored procedures currently only return scalars and entities.
      <code class="literal">&lt;return-join&gt;</code> and
      <code class="literal">&lt;load-collection&gt;</code> are not supported.</p>

      </a><div class="section" title="15.2.2.1.&nbsp;Rules/limitations for using stored procedures"><a id="sp_query"></a><div class="titlepage"><a id="sp_query"></a><div><a id="sp_query"></a><div><a id="sp_query"></a><h4 class="title"><a id="sp_query"></a><a id="querysql-limits-storedprocedures">15.2.2.1.&nbsp;Rules/limitations for using stored procedures</a></h4></div></div></div><a id="querysql-limits-storedprocedures">
        

        <p>You cannot use stored procedures with Hibernate unless you
        follow some procedure/function rules. If they do not follow those
        rules they are not usable with Hibernate. If you still want to use
        these procedures you have to execute them via
        <code class="literal">session.connection()</code>. The rules are different for
        each database, since database vendors have different stored procedure
        semantics/syntax.</p>

        <p>Stored procedure queries cannot be paged with
        <code class="literal">setFirstResult()/setMaxResults()</code>.</p>

        <p>The recommended call form is standard SQL92: <code class="literal">{ ? = call
        functionName(&lt;parameters&gt;) }</code> or <code class="literal">{ ? = call
        procedureName(&lt;parameters&gt;}</code>. Native call syntax is not
        supported.</p>

        <p>For Oracle the following rules apply:</p>

        <div class="itemizedlist"><ul class="itemizedlist" compact="compact"><li class="listitem">
            <p>A function must return a result set. The first parameter of
            a procedure must be an <code class="literal">OUT</code> that returns a
            result set. This is done by using a
            <code class="literal">SYS_REFCURSOR</code> type in Oracle 9 or 10. In Oracle
            you need to define a <code class="literal">REF CURSOR</code> type. See
            Oracle literature for further information.</p>
          </li></ul></div>

        <p>For Sybase or MS SQL server the following rules apply:</p>

        <div class="itemizedlist"><ul class="itemizedlist" compact="compact"><li class="listitem">
            <p>The procedure must return a result set. Note that since
            these servers can return multiple result sets and update counts,
            Hibernate will iterate the results and take the first result that
            is a result set as its return value. Everything else will be
            discarded.</p>
          </li><li class="listitem">
            <p>If you can enable <code class="literal">SET NOCOUNT ON</code> in your
            procedure it will probably be more efficient, but this is not a
            requirement.</p>
          </li></ul></div>
      </a></div><a id="querysql-limits-storedprocedures">
    </a></div><a id="querysql-limits-storedprocedures">
  </a></div><a id="querysql-limits-storedprocedures">

  </a><div class="section" title="15.3.&nbsp;Custom SQL for create, update and delete"><a id="querysql-limits-storedprocedures"></a><div class="titlepage"><a id="querysql-limits-storedprocedures"></a><div><a id="querysql-limits-storedprocedures"></a><div><a id="querysql-limits-storedprocedures"></a><h2 class="title"><a id="querysql-limits-storedprocedures"></a><a id="querysql-cud">15.3.&nbsp;Custom SQL for create, update and delete</a></h2></div></div></div><a id="querysql-cud">
    

    </a><p><a id="querysql-cud">Hibernate can use custom SQL for create, update, and delete
    operations. The SQL can be overridden at the statement level or
    inidividual column level. This section describes statement overrides. For
    columns, see </a><a class="xref" href="#">???</a>. <a class="xref" href="#example-custom-crdu-via-annotations" title="Example&nbsp;15.11.&nbsp;Custom CRUD via annotations">Example&nbsp;15.11, “Custom CRUD via annotations”</a> shows how to define
    custom SQL operatons using annotations.</p>

    <div class="example"><a id="example-custom-crdu-via-annotations"><p class="title"><strong>Example&nbsp;15.11.&nbsp;Custom CRUD via annotations</strong></p><div class="example-contents">
      

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">Entity</span>
<!--  --><br><span class="java_plain">@</span><span class="java_type">Table</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">"CHAOS"</span><span class="java_separator">)</span>
<!--  --><br><span class="java_plain">@</span><span class="java_type">SQLInsert</span><span class="java_separator">(</span><span class="java_plain">&nbsp;sql</span><span class="java_operator">=</span><span class="java_literal">"INSERT&nbsp;INTO&nbsp;CHAOS(size,&nbsp;name,&nbsp;nickname,&nbsp;id)&nbsp;VALUES(?,upper(?),?,?)"</span><span class="java_separator">)</span>
<!--  --><br><span class="java_plain">@</span><span class="java_type">SQLUpdate</span><span class="java_separator">(</span><span class="java_plain">&nbsp;sql</span><span class="java_operator">=</span><span class="java_literal">"UPDATE&nbsp;CHAOS&nbsp;SET&nbsp;size&nbsp;=&nbsp;?,&nbsp;name&nbsp;=&nbsp;upper(?),&nbsp;nickname&nbsp;=&nbsp;?&nbsp;WHERE&nbsp;id&nbsp;=&nbsp;?"</span><span class="java_separator">)</span>
<!--  --><br><span class="java_plain">@</span><span class="java_type">SQLDelete</span><span class="java_separator">(</span><span class="java_plain">&nbsp;sql</span><span class="java_operator">=</span><span class="java_literal">"DELETE&nbsp;CHAOS&nbsp;WHERE&nbsp;id&nbsp;=&nbsp;?"</span><span class="java_separator">)</span>
<!--  --><br><span class="java_plain">@</span><span class="java_type">SQLDeleteAll</span><span class="java_separator">(</span><span class="java_plain">&nbsp;sql</span><span class="java_operator">=</span><span class="java_literal">"DELETE&nbsp;CHAOS"</span><span class="java_separator">)</span>
<!--  --><br><span class="java_plain">@</span><span class="java_type">Loader</span><span class="java_separator">(</span><span class="java_plain">namedQuery&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">"chaos"</span><span class="java_separator">)</span>
<!--  --><br><span class="java_plain">@</span><span class="java_type">NamedNativeQuery</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">"chaos"</span><span class="java_separator">,</span><span class="java_plain">&nbsp;query</span><span class="java_operator">=</span><span class="java_literal">"select&nbsp;id,&nbsp;size,&nbsp;name,&nbsp;lower(&nbsp;nickname&nbsp;)&nbsp;as&nbsp;nickname&nbsp;from&nbsp;CHAOS&nbsp;where&nbsp;id=&nbsp;?"</span><span class="java_separator">,</span><span class="java_plain">&nbsp;resultClass&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">Chaos</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">)</span>
<!--  --><br><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">Chaos</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Id</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">Long</span><span class="java_plain">&nbsp;id</span><span class="java_separator">;</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">Long</span><span class="java_plain">&nbsp;size</span><span class="java_separator">;</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;name</span><span class="java_separator">;</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;nickname</span><span class="java_separator">;</span></pre>
    </div></a></div><a id="example-custom-crdu-via-annotations"><br class="example-break">

    </a><p><a id="example-custom-crdu-via-annotations"><code class="literal">@SQLInsert</code>, <code class="literal">@SQLUpdate</code>,
    <code class="literal">@SQLDelete</code>, <code class="literal">@SQLDeleteAll</code>
    respectively override the INSERT, UPDATE, DELETE, and DELETE all
    statement. The same can be achieved using Hibernate mapping files and the
    <code class="literal">&lt;sql-insert&gt;</code>,
    <code class="literal">&lt;sql-update&gt;</code> and
    <code class="literal">&lt;sql-delete&gt;</code> nodes. This can be seen in </a><a class="xref" href="#example-custom-crdu-via-xml" title="Example&nbsp;15.12.&nbsp;Custom CRUD XML">Example&nbsp;15.12, “Custom CRUD XML”</a>.</p>

    <div class="example"><a id="example-custom-crdu-via-xml"><p class="title"><strong>Example&nbsp;15.12.&nbsp;Custom CRUD XML</strong></p><div class="example-contents">
      

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&lt;class name="Person"&gt;
    &lt;id name="id"&gt;
        &lt;generator class="increment"/&gt;
    &lt;/id&gt;
    &lt;property name="name" not-null="true"/&gt;
    &lt;sql-insert&gt;INSERT INTO PERSON (NAME, ID) VALUES ( UPPER(?), ? )&lt;/sql-insert&gt;
    &lt;sql-update&gt;UPDATE PERSON SET NAME=UPPER(?) WHERE ID=?&lt;/sql-update&gt;
    &lt;sql-delete&gt;DELETE FROM PERSON WHERE ID=?&lt;/sql-delete&gt;
&lt;/class&gt;</pre>
    </div></a></div><a id="example-custom-crdu-via-xml"><br class="example-break">

    <p>If you expect to call a store procedure, be sure to set the
    <code class="literal">callable</code> attribute to <code class="constant">true</code>. In
    annotations as well as in xml. </p>

    <p>To check that the execution happens correctly, Hibernate allows you
    to define one of those three strategies:</p>

    <div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
        <p>none: no check is performed: the store procedure is expected to
        fail upon issues</p>
      </li><li class="listitem">
        <p>count: use of rowcount to check that the update is
        successful</p>
      </li><li class="listitem">
        <p>param: like COUNT but using an output parameter rather that the
        standard mechanism</p>
      </li></ul></div>

    <p>To define the result check style, use the <code class="literal">check</code>
    parameter which is again available in annoations as well as in xml.</p>

    </a><p><a id="example-custom-crdu-via-xml">You can use the exact same set of annotations respectively xml nodes
    to override the collection related statements -see </a><a class="xref" href="#example-overriding-sql-collections-annotations" title="Example&nbsp;15.13.&nbsp;Overriding SQL statements for collections using annotations">Example&nbsp;15.13, “Overriding SQL statements for collections using
      annotations”</a>.</p>

    <div class="example"><a id="example-overriding-sql-collections-annotations"><p class="title"><strong>Example&nbsp;15.13.&nbsp;Overriding SQL statements for collections using
      annotations</strong></p><div class="example-contents">
      

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">OneToMany</span>
<!--  --><br><span class="java_plain">@</span><span class="java_type">JoinColumn</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">"chaos_fk"</span><span class="java_separator">)</span>
<!--  --><br><span class="java_plain">@</span><span class="java_type">SQLInsert</span><span class="java_separator">(</span><span class="java_plain">&nbsp;sql</span><span class="java_operator">=</span><span class="java_literal">"UPDATE&nbsp;CASIMIR_PARTICULE&nbsp;SET&nbsp;chaos_fk&nbsp;=&nbsp;?&nbsp;where&nbsp;id&nbsp;=&nbsp;?"</span><span class="java_separator">)</span>
<!--  --><br><span class="java_plain">@</span><span class="java_type">SQLDelete</span><span class="java_separator">(</span><span class="java_plain">&nbsp;sql</span><span class="java_operator">=</span><span class="java_literal">"UPDATE&nbsp;CASIMIR_PARTICULE&nbsp;SET&nbsp;chaos_fk&nbsp;=&nbsp;null&nbsp;where&nbsp;id&nbsp;=&nbsp;?"</span><span class="java_separator">)</span>
<!--  --><br><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">Set</span><span class="java_operator">&lt;</span><span class="java_type">CasimirParticle</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;particles&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">HashSet</span><span class="java_operator">&lt;</span><span class="java_type">CasimirParticle</span><span class="java_operator">&gt;</span><span class="java_separator">();</span></pre>
    </div></a></div><a id="example-overriding-sql-collections-annotations"><br class="example-break">

    <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Tip</h2>
      <p>The parameter order is important and is defined by the order
      Hibernate handles properties. You can see the expected order by enabling
      debug logging for the <code class="literal">org.hibernate.persister.entity</code>
      level. With this level enabled Hibernate will print out the static SQL
      that is used to create, update, delete etc. entities. (To see the
      expected sequence, remember to not include your custom SQL through
      annotations or mapping files as that will override the Hibernate
      generated static sql)</p>
    </div>

    <p>Overriding SQL statements for secondary tables is also possible
    using <code class="literal">@org.hibernate.annotations.Table</code> and either (or
    all) attributes <code class="literal">sqlInsert</code>,
    <code class="literal">sqlUpdate</code>, <code class="literal">sqlDelete</code>:</p>

    </a><div class="example"><a id="example-overriding-sql-collections-annotations"></a><a id="d5e3171"><p class="title"><strong>Example&nbsp;15.14.&nbsp;Overriding SQL statements for secondary tables</strong></p><div class="example-contents">
      

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">Entity</span>
<!--  --><br><span class="java_plain">@</span><span class="java_type">SecondaryTables</span><span class="java_separator">({</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">SecondaryTable</span><span class="java_separator">(</span><span class="java_plain">name&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">"`Cat&nbsp;nbr1`"</span><span class="java_separator">),</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">SecondaryTable</span><span class="java_separator">(</span><span class="java_plain">name&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">"Cat2"</span><span class="java_separator">})</span>
<!--  --><br><span class="java_plain">@org</span><span class="java_separator">.</span><span class="java_plain">hibernate</span><span class="java_separator">.</span><span class="java_plain">annotations</span><span class="java_separator">.</span><span class="java_type">Tables</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Table</span><span class="java_separator">(</span><span class="java_plain">appliesTo&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">"Cat"</span><span class="java_separator">,</span><span class="java_plain">&nbsp;comment&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">"My&nbsp;cat&nbsp;table"</span><span class="java_plain">&nbsp;</span><span class="java_separator">),</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Table</span><span class="java_separator">(</span><span class="java_plain">appliesTo&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">"Cat2"</span><span class="java_separator">,</span><span class="java_plain">&nbsp;foreignKey&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;@</span><span class="java_type">ForeignKey</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">"FK_CAT2_CAT"</span><span class="java_separator">),</span><span class="java_plain">&nbsp;fetch&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">FetchMode</span><span class="java_separator">.</span><span class="java_plain">SELECT</span><span class="java_separator">,</span>
<!--  --><br><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sqlInsert</span><span class="java_operator">=</span><span class="java_plain">@</span><span class="java_type">SQLInsert</span><span class="java_separator">(</span><span class="java_plain">sql</span><span class="java_operator">=</span><span class="java_literal">"insert&nbsp;into&nbsp;Cat2(storyPart2,&nbsp;id)&nbsp;values(upper(?),&nbsp;?)"</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span>
<!--  --><br><span class="java_separator">}</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span>
<!--  --><br><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">Cat</span><span class="java_plain">&nbsp;</span><span class="java_keyword">implements</span><span class="java_plain">&nbsp;</span><span class="java_type">Serializable</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span></pre>
    </div></a></div><a id="d5e3171"><br class="example-break">

    <p>The previous example also shows that you can give a comment to a
    given table (primary or secondary): This comment will be used for DDL
    generation.</p>

    <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Tip</h2>
      <p>The SQL is directly executed in your database, so you can use any
      dialect you like. This will, however, reduce the portability of your
      mapping if you use database specific SQL.</p>
    </div>

    <p>Last but not least, stored procedures are in most cases required to
    return the number of rows inserted, updated and deleted. Hibernate always
    registers the first statement parameter as a numeric output parameter for
    the CUD operations:</p>

    </a><div class="example"><a id="d5e3171"></a><a id="d5e3178"><p class="title"><strong>Example&nbsp;15.15.&nbsp;Stored procedures and their return value</strong></p><div class="example-contents">
      

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">CREATE OR REPLACE FUNCTION updatePerson (uid IN NUMBER, uname IN VARCHAR2)
    RETURN NUMBER IS
BEGIN

    update PERSON
    set
        NAME = uname,
    where
        ID = uid;

    return SQL%ROWCOUNT;

END updatePerson;</pre>
    </div></a></div><a id="d5e3178"><br class="example-break">
  </a></div><a id="d5e3178">

  </a><div class="section" title="15.4.&nbsp;Custom SQL for loading"><a id="d5e3178"></a><div class="titlepage"><a id="d5e3178"></a><div><a id="d5e3178"></a><div><a id="d5e3178"></a><h2 class="title"><a id="d5e3178"></a><a id="querysql-load">15.4.&nbsp;Custom SQL for loading</a></h2></div></div></div><a id="querysql-load">
    

    </a><p><a id="querysql-load">You can also declare your own SQL (or HQL) queries for entity
    loading. As with inserts, updates, and deletes, this can be done at the
    individual column level as described in </a><a class="xref" href="#">???</a> or at the statement level. Here
    is an example of a statement level override:</p>

    <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&lt;sql-query name="person"&gt;
    &lt;return alias="pers" class="Person" lock-mode="upgrade"/&gt;
    SELECT NAME AS {pers.name}, ID AS {pers.id}
    FROM PERSON
    WHERE ID=?
    FOR UPDATE
&lt;/sql-query&gt;</pre>

    <p>This is just a named query declaration, as discussed earlier. You
    can reference this named query in a class mapping:</p>

    <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&lt;class name="Person"&gt;
    &lt;id name="id"&gt;
        &lt;generator class="increment"/&gt;
    &lt;/id&gt;
    &lt;property name="name" not-null="true"/&gt;
    &lt;loader query-ref="person"/&gt;
&lt;/class&gt;</pre>

    <p>This even works with stored procedures.</p>

    <p>You can even define a query for collection loading:</p>

    <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&lt;set name="employments" inverse="true"&gt;
    &lt;key/&gt;
    &lt;one-to-many class="Employment"/&gt;
    &lt;loader query-ref="employments"/&gt;
&lt;/set&gt;</pre>

    <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&lt;sql-query name="employments"&gt;
    &lt;load-collection alias="emp" role="Person.employments"/&gt;
    SELECT {emp.*}
    FROM EMPLOYMENT emp
    WHERE EMPLOYER = :id
    ORDER BY STARTDATE ASC, EMPLOYEE ASC
&lt;/sql-query&gt;</pre>

    <p>You can also define an entity loader that loads a collection by join
    fetching:</p>

    <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&lt;sql-query name="person"&gt;
    &lt;return alias="pers" class="Person"/&gt;
    &lt;return-join alias="emp" property="pers.employments"/&gt;
    SELECT NAME AS {pers.*}, {emp.*}
    FROM PERSON pers
    LEFT OUTER JOIN EMPLOYMENT emp
        ON pers.ID = emp.PERSON_ID
    WHERE ID=?
&lt;/sql-query&gt;</pre>

    <p>The annotation equivalent <code class="literal">&lt;loader&gt;</code> is the
    @Loader annotation as seen in <a class="xref" href="#example-custom-crdu-via-annotations" title="Example&nbsp;15.11.&nbsp;Custom CRUD via annotations">Example&nbsp;15.11, “Custom CRUD via annotations”</a>.</p>
  </div>

</div>

    <div class="chapter" title="Chapter&nbsp;16.&nbsp;Multi-tenancy"><div class="titlepage"><div><div><h2 class="title"><a id="d5e3197">Chapter&nbsp;16.&nbsp;Multi-tenancy</a></h2></div></div></div><div class="toc"><p><a id="d5e3197"><strong>Table of Contents</strong></a></p><dl><dt><a id="d5e3197"><span class="section"></span></a><a href="#d5e3199">16.1. What is multi-tenancy?</a></dt><dt><span class="section"><a href="#d5e3202">16.2. Multi-tenant data approaches</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e3208">16.2.1. Separate database</a></span></dt><dt><span class="section"><a href="#d5e3217">16.2.2. Separate schema</a></span></dt><dt><span class="section"><a href="#d5e3234">16.2.3. Partitioned (discriminator) data</a></span></dt></dl></dd><dt><span class="section"><a href="#d5e3243">16.3. Multi-tenancy in Hibernate</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e3272">16.3.1. <code class="interfacename">MultiTenantConnectionProvider</code></a></span></dt><dt><span class="section"><a href="#d5e3297">16.3.2. <code class="interfacename">CurrentTenantIdentifierResolver</code></a></span></dt><dt><span class="section"><a href="#d5e3322">16.3.3. Caching</a></span></dt><dt><span class="section"><a href="#d5e3325">16.3.4. Odds and ends</a></span></dt></dl></dd><dt><span class="section"><a href="#d5e3329">16.4. Strategies for <code class="interfacename">MultiTenantConnectionProvider</code> implementors</a></span></dt></dl></div>

    

    <div class="section" title="16.1.&nbsp;What is multi-tenancy?"><div class="titlepage"><div><div><h2 class="title"><a id="d5e3199">16.1.&nbsp;What is multi-tenancy?</a></h2></div></div></div><a id="d5e3199">
        
        <p>
            The term multi-tenancy in general is applied to software development to indicate an architecture in which
            a single running instance of an application simultaneously serves multiple clients (tenants).  This is
            highly common in SaaS solutions.  Isolating information (data, customizations, etc) pertaining to the
            various tenants is a particular challenge in these systems.  This includes the data owned by each tenant
            stored in the database.  It is this last piece, sometimes called multi-tenant data, on which we will focus.
        </p>
    </a></div><a id="d5e3199">

    </a><div class="section" title="16.2.&nbsp;Multi-tenant data approaches"><a id="d5e3199"></a><div class="titlepage"><a id="d5e3199"></a><div><a id="d5e3199"></a><div><a id="d5e3199"></a><h2 class="title"><a id="d5e3199"></a><a id="d5e3202">16.2.&nbsp;Multi-tenant data approaches</a></h2></div></div></div><a id="d5e3202">
        
        <p>
            There are 3 main approaches to isolating information in these multi-tenant systems which goes hand-in-hand
            with different database schema definitions and JDBC setups.
        </p>

        </a><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><a id="d5e3202"><h2>Note</h2>
            </a><p><a id="d5e3202">
                Each approach has pros and cons as well as specific techniques and considerations.  Such
                topics are beyond the scope of this documentation.  Many resources exist which delve into these
                other topics.  One example is </a><a class="ulink" href="http://msdn.microsoft.com/en-us/library/aa479086.aspx">http://msdn.microsoft.com/en-us/library/aa479086.aspx</a>
                which does a great job of covering these topics.
            </p>
        </div>

        <div class="section" title="16.2.1.&nbsp;Separate database"><div class="titlepage"><div><div><h3 class="title"><a id="d5e3208">16.2.1.&nbsp;Separate database</a></h3></div></div></div><a id="d5e3208">
            

            <div class="mediaobject" align="center"><img src="Hibernate%20User%20Guide_files/multitenacy_database.png" align="middle"></div>

            <p>
                Each tenant's data is kept in a physically separate database instance.  JDBC Connections would point
                specifically to each database, so any pooling would be per-tenant.  A general application approach
                here would be to define a JDBC Connection pool per-tenant and to select the pool to use based on the
                <span class="quote">“<span class="quote">tenant identifier</span>”</span> associated with the currently logged in user.
            </p>
        </a></div><a id="d5e3208">

        </a><div class="section" title="16.2.2.&nbsp;Separate schema"><a id="d5e3208"></a><div class="titlepage"><a id="d5e3208"></a><div><a id="d5e3208"></a><div><a id="d5e3208"></a><h3 class="title"><a id="d5e3208"></a><a id="d5e3217">16.2.2.&nbsp;Separate schema</a></h3></div></div></div><a id="d5e3217">
            

            <div class="mediaobject" align="center"><img src="Hibernate%20User%20Guide_files/multitenacy_schema.png" align="middle"></div>

            <p>
                Each tenant's data is kept in a distinct database schema on a single database instance.  There are 2
                different ways to define JDBC Connections here:
                </p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
                        <p>
                            Connections could point specifically to each schema, as we saw with the
                            <code class="literal">Separate database</code> approach.  This is an option provided that
                            the driver supports naming the default schema in the connection URL or if the
                            pooling mechanism supports naming a schema to use for its Connections.  Using this
                            approach, we would have a distinct JDBC Connection pool per-tenant where the pool to use
                            would be selected based on the <span class="quote">“<span class="quote">tenant identifier</span>”</span> associated with the
                            currently logged in user.
                        </p>
                    </li><li class="listitem">
                        <p>
                            Connections could point to the database itself (using some default schema) but
                            the Connections would be altered using the SQL <code class="literal">SET SCHEMA</code> (or similar)
                            command.  Using this approach, we would have a single JDBC Connection pool for use to
                            service all tenants, but before using the Connection it would be altered to reference
                            the schema named by the <span class="quote">“<span class="quote">tenant identifier</span>”</span> associated with the currently
                            logged in user.
                        </p>
                    </li></ul></div><p>
            </p>
        </a></div><a id="d5e3217">

        </a><div class="section" title="16.2.3.&nbsp;Partitioned (discriminator) data"><a id="d5e3217"></a><div class="titlepage"><a id="d5e3217"></a><div><a id="d5e3217"></a><div><a id="d5e3217"></a><h3 class="title"><a id="d5e3217"></a><a id="d5e3234">16.2.3.&nbsp;Partitioned (discriminator) data</a></h3></div></div></div><a id="d5e3234">
            

            <div class="mediaobject" align="center"><img src="Hibernate%20User%20Guide_files/multitenacy_discriminator.png" align="middle"></div>

            <p>
                All data is kept in a single database schema.  The data for each tenant is partitioned by the use of
                partition value or discriminator.  The complexity of this discriminator might range from a simple
                column value to a complex SQL formula.  Again, this approach would use a single Connection pool
                to service all tenants.  However, in this approach the application needs to alter each and every
                SQL statement sent to the database to reference the <span class="quote">“<span class="quote">tenant identifier</span>”</span> discriminator.
            </p>
        </a></div><a id="d5e3234">
    </a></div><a id="d5e3234">

    </a><div class="section" title="16.3.&nbsp;Multi-tenancy in Hibernate"><a id="d5e3234"></a><div class="titlepage"><a id="d5e3234"></a><div><a id="d5e3234"></a><div><a id="d5e3234"></a><h2 class="title"><a id="d5e3234"></a><a id="d5e3243">16.3.&nbsp;Multi-tenancy in Hibernate</a></h2></div></div></div><a id="d5e3243">
        
        <p>
            Using Hibernate with multi-tenant data comes down to both an API and then integration piece(s).  As
            usual Hibernate strives to keep the API simple and isolated from any underlying integration complexities.
            The API is really just defined by passing the tenant identifier as part of opening any session.
        </p>
        </a><div class="example"><a id="d5e3243"></a><a id="specifying-tenant-ex"><p class="title"><strong>Example&nbsp;16.1.&nbsp;Specifying tenant identifier from <code class="interfacename">SessionFactory</code></strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Session session = sessionFactory.withOptions()
        .tenantIdentifier( yourTenantIdentifier )
        ...
        .openSession();</pre>
        </div></a></div><a id="specifying-tenant-ex"><br class="example-break">
        <p>
            Additionally, when specifying configuration, a <code class="classname">org.hibernate.MultiTenancyStrategy</code>
            should be named using the <span class="property">hibernate.multiTenancy</span> setting.  Hibernate will perform
            validations based on the type of strategy you specify.  The strategy here correlates to the isolation
            approach discussed above.
        </p>
        <div class="variablelist"><dl><dt><span class="term">NONE</span></dt><dd>
                    <p>
                        (the default) No multi-tenancy is expected.  In fact, it is considered an error if a tenant
                        identifier is specified when opening a session using this strategy.
                    </p>
                </dd><dt><span class="term">SCHEMA</span></dt><dd>
                    <p>
                        Correlates to the separate schema approach.  It is an error to attempt to open a session without
                        a tenant identifier using this strategy.  Additionally, a
                        <code class="interfacename">MultiTenantConnectionProvider</code>
                        must be specified.
                    </p>
                </dd><dt><span class="term">DATABASE</span></dt><dd>
                    <p>
                        Correlates to the separate database approach.  It is an error to attempt to open a session without
                        a tenant identifier using this strategy.  Additionally, a
                        <code class="interfacename">MultiTenantConnectionProvider</code>
                        must be specified.
                    </p>
                </dd><dt><span class="term">DISCRIMINATOR</span></dt><dd>
                    <p>
                        Correlates to the partitioned (discriminator) approach.  It is an error to attempt to open a
                        session without a tenant identifier using this strategy.  This strategy is not yet implemented
                        in Hibernate as of 4.0 and 4.1.  Its support is planned for 5.0.
                    </p>
                </dd></dl></div>

        </a><div class="section" title="16.3.1.&nbsp;MultiTenantConnectionProvider"><a id="specifying-tenant-ex"></a><div class="titlepage"><a id="specifying-tenant-ex"></a><div><a id="specifying-tenant-ex"></a><div><a id="specifying-tenant-ex"></a><h3 class="title"><a id="specifying-tenant-ex"></a><a id="d5e3272">16.3.1.&nbsp;<code class="interfacename">MultiTenantConnectionProvider</code></a></h3></div></div></div><a id="d5e3272">
            
            <p>
                When using either the DATABASE or SCHEMA approach, Hibernate needs to be able to obtain Connections
                in a tenant specific manner.  That is the role of the
                <code class="interfacename">MultiTenantConnectionProvider</code>
                contract.  Application developers will need to provide an implementation of this
                contract.  Most of its methods are extremely self-explanatory.  The only ones which might not be are
                <code class="methodname">getAnyConnection</code> and <code class="methodname">releaseAnyConnection</code>.  It is
                important to note also that these methods do not accept the tenant identifier.  Hibernate uses these
                methods during startup to perform various configuration, mainly via the
                <code class="classname">java.sql.DatabaseMetaData</code> object.
            </p>
            <p>
                The <code class="interfacename">MultiTenantConnectionProvider</code> to use can be specified in a number of
                ways:
            </p>
            <div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
                    <p>
                        Use the <span class="property">hibernate.multi_tenant_connection_provider</span> setting.  It could
                        name a <code class="interfacename">MultiTenantConnectionProvider</code> instance, a
                        <code class="interfacename">MultiTenantConnectionProvider</code> implementation class reference or
                        a <code class="interfacename">MultiTenantConnectionProvider</code> implementation class name.
                    </p>
                </li><li class="listitem">
                    <p>
                        Passed directly to the <code class="classname">org.hibernate.boot.registry.StandardServiceRegistryBuilder</code>.
                    </p>
                </li><li class="listitem">
                    <p>
                        If none of the above options match, but the settings do specify a
                        <span class="property">hibernate.connection.datasource</span> value, Hibernate will assume it should
                        use the specific
                        <code class="classname">DataSourceBasedMultiTenantConnectionProviderImpl</code>
                        implementation which works on a number of pretty reasonable assumptions when running inside of
                        an app server and using one <code class="interfacename">javax.sql.DataSource</code> per tenant.
                        See its javadocs for more details.
                    </p>
                </li></ul></div>
        </a></div><a id="d5e3272">

        </a><div class="section" title="16.3.2.&nbsp;CurrentTenantIdentifierResolver"><a id="d5e3272"></a><div class="titlepage"><a id="d5e3272"></a><div><a id="d5e3272"></a><div><a id="d5e3272"></a><h3 class="title"><a id="d5e3272"></a><a id="d5e3297">16.3.2.&nbsp;<code class="interfacename">CurrentTenantIdentifierResolver</code></a></h3></div></div></div><a id="d5e3297">
            
            <p>
                <code class="interfacename">org.hibernate.context.spi.CurrentTenantIdentifierResolver</code> is a contract
                for Hibernate to be able to resolve what the application considers the current tenant identifier.
                The implementation to use is either passed directly to <code class="classname">Configuration</code> via its
                <code class="methodname">setCurrentTenantIdentifierResolver</code> method.  It can also be specified via
                the <span class="property">hibernate.tenant_identifier_resolver</span> setting.
            </p>
            <p>
                There are 2 situations where <code class="interfacename">CurrentTenantIdentifierResolver</code> is used:
            </p>
            </a><div class="itemizedlist"><a id="d5e3297"></a><ul class="itemizedlist"><a id="d5e3297"><li class="listitem">
                    <p>
                        The first situation is when the application is using the
                        <code class="interfacename">org.hibernate.context.spi.CurrentSessionContext</code> feature in
                        conjunction with multi-tenancy.  In the case of the current-session feature,  Hibernate will
                        need to open a session if it cannot find an existing one in scope.  However, when a session
                        is opened in a multi-tenant environment the tenant identifier has to be specified.  This is
                        where the <code class="interfacename">CurrentTenantIdentifierResolver</code> comes into play;
                        Hibernate will consult the implementation you provide to determine the tenant identifier to use
                        when opening the session.  In this case, it is required that a
                        <code class="interfacename">CurrentTenantIdentifierResolver</code> be supplied.
                    </p>
                </li></a><li class="listitem"><a id="d5e3297">
                    </a><p><a id="d5e3297">
                        The other situation is when you do not want to have to explicitly specify the tenant
                        identifier all the time as we saw in </a><a class="xref" href="#specifying-tenant-ex" title="Example&nbsp;16.1.&nbsp;Specifying tenant identifier from SessionFactory">Example&nbsp;16.1, “Specifying tenant identifier from <code class="interfacename">SessionFactory</code>”</a>.  If a
                        <code class="interfacename">CurrentTenantIdentifierResolver</code> has been specified, Hibernate
                        will use it to determine the default tenant identifier to use when opening the session.
                    </p>
                </li></ul></div>
            <p>
                Additionally, if the <code class="interfacename">CurrentTenantIdentifierResolver</code> implementation
                returns <code class="literal">true</code> for its <code class="methodname">validateExistingCurrentSessions</code>
                method, Hibernate will make sure any existing sessions that are found in scope have a matching
                tenant identifier.  This capability is only pertinent when the
                <code class="interfacename">CurrentTenantIdentifierResolver</code> is used in current-session settings.
            </p>
        </div>

        <div class="section" title="16.3.3.&nbsp;Caching"><div class="titlepage"><div><div><h3 class="title"><a id="d5e3322">16.3.3.&nbsp;Caching</a></h3></div></div></div><a id="d5e3322">
            
            <p>
                Multi-tenancy support in Hibernate works seamlessly with the Hibernate second level cache.  The key
                used to cache data encodes the tenant identifier.
            </p>
        </a></div><a id="d5e3322">

        </a><div class="section" title="16.3.4.&nbsp;Odds and ends"><a id="d5e3322"></a><div class="titlepage"><a id="d5e3322"></a><div><a id="d5e3322"></a><div><a id="d5e3322"></a><h3 class="title"><a id="d5e3322"></a><a id="d5e3325">16.3.4.&nbsp;Odds and ends</a></h3></div></div></div><a id="d5e3325">
            
            <p>
                Currently schema export will not really work with multi-tenancy.  That may not change.
            </p>
            <p>
                The JPA expert group is in the process of defining multi-tenancy support for the upcoming 2.1
                version of the specification.
            </p>
        </a></div><a id="d5e3325">
    </a></div><a id="d5e3325">

    </a><div class="section" title="16.4.&nbsp;Strategies for MultiTenantConnectionProvider implementors"><a id="d5e3325"></a><div class="titlepage"><a id="d5e3325"></a><div><a id="d5e3325"></a><div><a id="d5e3325"></a><h2 class="title"><a id="d5e3325"></a><a id="d5e3329">16.4.&nbsp;Strategies for <code class="interfacename">MultiTenantConnectionProvider</code> implementors</a></h2></div></div></div><a id="d5e3329">
        
        </a><div class="example"><a id="d5e3329"></a><a id="d5e3332"><p class="title"><strong>Example&nbsp;16.2.&nbsp;Implementing MultiTenantConnectionProvider using different connection pools</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">/**
 * Simplisitc implementation for illustration purposes supporting 2 hard coded providers (pools) and leveraging
 * the support class {@link org.hibernate.service.jdbc.connections.spi.AbstractMultiTenantConnectionProvider}
 */
public class MultiTenantConnectionProviderImpl extends AbstractMultiTenantConnectionProvider {
	private final ConnectionProvider acmeProvider = ConnectionProviderUtils.buildConnectionProvider( "acme" );
	private final ConnectionProvider jbossProvider = ConnectionProviderUtils.buildConnectionProvider( "jboss" );

	@Override
	protected ConnectionProvider getAnyConnectionProvider() {
		return acmeProvider;
	}

	@Override
	protected ConnectionProvider selectConnectionProvider(String tenantIdentifier) {
		if ( "acme".equals( tenantIdentifier ) ) {
			return acmeProvider;
		}
		else if ( "jboss".equals( tenantIdentifier ) ) {
			return jbossProvider;
		}
		throw new HibernateException( "Unknown tenant identifier" );
	}
}</pre>
        </div></a></div><a id="d5e3332"><br class="example-break">
        <p>
            The approach above is valid for the DATABASE approach.  It is also valid for the SCHEMA approach
            provided the underlying database allows naming the schema to which to connect in the connection URL.
        </p>
        </a><div class="example"><a id="d5e3332"></a><a id="d5e3336"><p class="title"><strong>Example&nbsp;16.3.&nbsp;Implementing MultiTenantConnectionProvider using single connection pool</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">/**
 * Simplisitc implementation for illustration purposes showing a single connection pool used to serve
 * multiple schemas using "connection altering".  Here we use the T-SQL specific USE command; Oracle
 * users might use the ALTER SESSION SET SCHEMA command; etc.
 */
public class MultiTenantConnectionProviderImpl
		implements MultiTenantConnectionProvider, Stoppable {
	private final ConnectionProvider connectionProvider = ConnectionProviderUtils.buildConnectionProvider( "master" );

	@Override
	public Connection getAnyConnection() throws SQLException {
		return connectionProvider.getConnection();
	}

	@Override
	public void releaseAnyConnection(Connection connection) throws SQLException {
		connectionProvider.closeConnection( connection );
	}

	@Override
	public Connection getConnection(String tenantIdentifier) throws SQLException {
		final Connection connection = getAnyConnection();
		try {
			connection.createStatement().execute( "USE " + tenanantIdentifier );
		}
		catch ( SQLException e ) {
			throw new HibernateException(
					"Could not alter JDBC connection to specified schema [" +
							tenantIdentifier + "]",
					e
			);
		}
		return connection;
	}

	@Override
	public void releaseConnection(String tenantIdentifier, Connection connection) throws SQLException {
		try {
			connection.createStatement().execute( "USE master" );
		}
		catch ( SQLException e ) {
			// on error, throw an exception to make sure the connection is not returned to the pool.
			// your requirements may differ
			throw new HibernateException(
					"Could not alter JDBC connection to specified schema [" +
							tenantIdentifier + "]",
					e
			);
		}
		connectionProvider.closeConnection( connection );
	}

	...
}</pre>
        </div></a></div><a id="d5e3336"><br class="example-break">
        <p>
            This approach is only relevant to the SCHEMA approach.
        </p>
    </a></div><a id="d5e3336">
</a></div><a id="d5e3336">
    </a><div class="chapter" title="Chapter&nbsp;17.&nbsp;OSGi"><a id="d5e3336"></a><div class="titlepage"><a id="d5e3336"></a><div><a id="d5e3336"></a><div><a id="d5e3336"></a><h2 class="title"><a id="d5e3336"></a><a id="d5e3340">Chapter&nbsp;17.&nbsp;OSGi</a></h2></div><div><div class="abstract" title="Abstract"><p class="title"><a id="d5e3340"><strong>Abstract</strong></a></p><a id="d5e3340">
            <p>
                The Open Services Gateway initiative (OSGi) specification describes a dynamic, modularized system.  "Bundles"
                (components) can be installed, activated, deactivated, and uninstalled during runtime, without requiring
                a system restart.  OSGi frameworks manage bundles' dependencies, packages, and classes.  The framework
                is also in charge of ClassLoading, managing visibility of packages between bundles.  Further, service
                registry and discovery is provided through a "whiteboard" pattern.
            </p>
            
            <p>
                OSGi environments present numerous, unique challenges.  Most notably, the dynamic nature of available
                bundles during runtime can require significant architectural considerations.  Also,
                architectures must allow the OSGi-specific ClassLoading and service registration/discovery.
            </p>
        </a></div></div></div></div><div class="toc"><p><a id="d5e3340"><strong>Table of Contents</strong></a></p><dl><dt><a id="d5e3340"><span class="section"></span></a><a href="#d5e3347">17.1. OSGi Specification and Environment</a></dt><dt><span class="section"><a href="#d5e3362">17.2. hibernate-osgi</a></span></dt><dt><span class="section"><a href="#d5e3365">17.3. features.xml</a></span></dt><dt><span class="section"><a href="#d5e3376">17.4. QuickStarts/Demos</a></span></dt><dt><span class="section"><a href="#osgi-managed-jpa">17.5. Container-Managed JPA</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e3385">17.5.1. Enterprise OSGi JPA Container</a></span></dt><dt><span class="section"><a href="#d5e3393">17.5.2. persistence.xml</a></span></dt><dt><span class="section"><a href="#d5e3398">17.5.3. DataSource</a></span></dt><dt><span class="section"><a href="#d5e3412">17.5.4. Bundle Package Imports</a></span></dt><dt><span class="section"><a href="#d5e3422">17.5.5. Obtaining an EntityManger</a></span></dt></dl></dd><dt><span class="section"><a href="#osgi-unmanaged-jpa">17.6. Unmanaged JPA</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e3434">17.6.1. persistence.xml</a></span></dt><dt><span class="section"><a href="#d5e3439">17.6.2. Bundle Package Imports</a></span></dt><dt><span class="section"><a href="#d5e3455">17.6.3. Obtaining an EntityMangerFactory</a></span></dt></dl></dd><dt><span class="section"><a href="#osgi-unmanaged-native">17.7. Unmanaged Native</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e3468">17.7.1. Bundle Package Imports</a></span></dt><dt><span class="section"><a href="#d5e3487">17.7.2. Obtaining an SessionFactory</a></span></dt></dl></dd><dt><span class="section"><a href="#d5e3497">17.8. Optional Modules</a></span></dt><dt><span class="section"><a href="#d5e3501">17.9. Extension Points</a></span></dt><dt><span class="section"><a href="#d5e3525">17.10. Caveats</a></span></dt></dl></div>
    

    <div class="section" title="17.1.&nbsp;OSGi Specification and Environment"><div class="titlepage"><div><div><h2 class="title"><a id="d5e3347">17.1.&nbsp;OSGi Specification and Environment</a></h2></div></div></div><a id="d5e3347">
        

        <p>
            Hibernate targets the OSGi 4.3 spec or later.  It was necessary to start with 4.3, over 4.2, due to our
            dependency on OSGi's <code class="literal">BundleWiring</code> for entity/mapping scanning.
        </p>

        <p>
        	Hibernate supports three types of configurations within OSGi.
        	
        	 </p></a><div class="orderedlist"><a id="d5e3347"></a><ol class="orderedlist" type="1"><a id="d5e3347"></a><li class="listitem"><a id="d5e3347">
	                <em class="firstterm">Container-Managed JPA</em>: </a><a class="xref" href="#osgi-managed-jpa" title="17.5.&nbsp;Container-Managed JPA">Section&nbsp;17.5, “Container-Managed JPA”</a>
	            </li><li class="listitem">
	                <em class="firstterm">Unmanaged JPA</em>: <a class="xref" href="#osgi-unmanaged-jpa" title="17.6.&nbsp;Unmanaged JPA">Section&nbsp;17.6, “Unmanaged JPA”</a>
	            </li><li class="listitem">
	                <em class="firstterm">Unmanaged Native</em>: <a class="xref" href="#osgi-unmanaged-native" title="17.7.&nbsp;Unmanaged Native">Section&nbsp;17.7, “Unmanaged Native”</a>
	            </li></ol></div><p>
        </p>
    </div>

    <div class="section" title="17.2.&nbsp;hibernate-osgi"><div class="titlepage"><div><div><h2 class="title"><a id="d5e3362">17.2.&nbsp;hibernate-osgi</a></h2></div></div></div><a id="d5e3362">
        
        <p>
            Rather than embed OSGi capabilities into hibernate-core, hibernate-entitymanager, and sub-modules,
            hibernate-osgi was created.  It's purposefully separated, isolating all OSGi dependencies.  It provides an
            OSGi-specific ClassLoader (aggregates the container's CL with core and entitymanager CLs), JPA persistence
            provider, SF/EMF bootstrapping, entities/mappings scanner, and service management.
        </p>
    </a></div><a id="d5e3362">

    </a><div class="section" title="17.3.&nbsp;features.xml"><a id="d5e3362"></a><div class="titlepage"><a id="d5e3362"></a><div><a id="d5e3362"></a><div><a id="d5e3362"></a><h2 class="title"><a id="d5e3362"></a><a id="d5e3365">17.3.&nbsp;features.xml</a></h2></div></div></div><a id="d5e3365">
      
      <p>
        Apache Karaf environments tend to make heavy use of its "features" concept, where a feature is a set of order-specific
        bundles focused on a concise capability.  These features are typically defined in a <code class="literal">features.xml</code> file.
        Hibernate produces and releases its own <code class="literal">features.xml</code> that defines a core <code class="literal">hibernate-orm</code>,
        as well as additional features for optional functionality (caching, Envers, etc.).
        This is included in the binary distribution, as well as deployed to the JBoss Nexus repository
        (using the <code class="literal">org.hibernate</code> groupId and <code class="literal">hibernate-osgi</code> with the <code class="literal">karaf.xml</code> classifier).
      </p>

      <p>
        Note that our features are versioned using the same ORM artifact versions they wrap.  Also note that the features are
        heavily tested against Karaf 3.0.3 as a part of our PaxExam-based integration tests.  However, they'll likely work
        on other versions as well.
      </p>

      <p>
        hibernate-osgi, theoretically, supports a variety of OSGi containers, such as Equinox.  In that case,
        please use features.xml as a reference for necessary bundles to activate and their correct ordering.  However,
        note that Karaf starts a number of bundles automatically, several of which would need to be installed manually
        on alternatives.
      </p>
    </a></div><a id="d5e3365">

    </a><div class="section" title="17.4.&nbsp;QuickStarts/Demos"><a id="d5e3365"></a><div class="titlepage"><a id="d5e3365"></a><div><a id="d5e3365"></a><div><a id="d5e3365"></a><h2 class="title"><a id="d5e3365"></a><a id="d5e3376">17.4.&nbsp;QuickStarts/Demos</a></h2></div></div></div><a id="d5e3376">
      
      </a><p><a id="d5e3376">
        All three configurations have a QuickStart/Demo available in the
        </a><a class="ulink" href="https://github.com/hibernate/hibernate-demos">hibernate-demos</a> project:
      </p>
    </div>

    <div class="section" title="17.5.&nbsp;Container-Managed JPA"><div class="titlepage"><div><div><h2 class="title"><a id="osgi-managed-jpa">17.5.&nbsp;Container-Managed JPA</a></h2></div></div></div><a id="osgi-managed-jpa">
        
        
        <p>
            The Enterprise OSGi specification includes container-managed JPA.  The container is responsible for
            discovering persistence units in bundles and automatically creating the <code class="literal">EntityManagerFactory</code> (one EMF per PU).
            It uses the JPA provider (hibernate-osgi) that has registered itself with the OSGi
            <code class="literal">PersistenceProvider</code> service.
        </p>

        </a><div class="section" title="17.5.1.&nbsp;Enterprise OSGi JPA Container"><a id="osgi-managed-jpa"></a><div class="titlepage"><a id="osgi-managed-jpa"></a><div><a id="osgi-managed-jpa"></a><div><a id="osgi-managed-jpa"></a><h3 class="title"><a id="osgi-managed-jpa"></a><a id="d5e3385">17.5.1.&nbsp;Enterprise OSGi JPA Container</a></h3></div></div></div><a id="d5e3385">
          
          <p>
            In order to utilize container-managed JPA, an Enterprise OSGi JPA container must be active in the runtime.
            In Karaf, this means Aries JPA, which is included out-of-the-box (simply activate the <code class="literal">jpa</code>
            and <code class="literal">transaction</code> features).  Originally, we intended to include those dependencies within our own
            <code class="literal">features.xml</code>.  However, after guidance from the Karaf and Aries teams, it was pulled out.
            This allows Hibernate OSGi to be portable and not be directly tied to Aries versions, instead having
            the user choose which to use.
          </p>
          </a><p><a id="d5e3385">
            That being said, the QuickStart/Demo projects include a sample
            </a><a class="ulink" href="https://github.com/hibernate/hibernate-demos/tree/master/hibernate-orm/osgi/managed-jpa/features.xml">features.xml</a>
            showing which features need activated in Karaf in order to support this environment.  As mentioned, use this
            purely as a reference!
          </p>
        </div>

        <div class="section" title="17.5.2.&nbsp;persistence.xml"><div class="titlepage"><div><div><h3 class="title"><a id="d5e3393">17.5.2.&nbsp;persistence.xml</a></h3></div></div></div><a id="d5e3393">
          
          <p>
            Similar to any other JPA setup, your bundle must include a <code class="literal">persistence.xml</code> file.
            This is typically located in <code class="literal">META-INF</code>.
          </p>
        </a></div><a id="d5e3393">

        </a><div class="section" title="17.5.3.&nbsp;DataSource"><a id="d5e3393"></a><div class="titlepage"><a id="d5e3393"></a><div><a id="d5e3393"></a><div><a id="d5e3393"></a><h3 class="title"><a id="d5e3393"></a><a id="d5e3398">17.5.3.&nbsp;DataSource</a></h3></div></div></div><a id="d5e3398">
          
          <p>
            Typical Enterprise OSGi JPA usage includes a DataSource installed in the container.  Your
            bundle's <code class="literal">persistence.xml</code> calls out the DataSource through JNDI.  For example, you could
            install the following H2 DS.  You can deploy the DS manually (Karaf has a <code class="literal">deploy</code> dir), or
            through a "blueprint bundle" (<code class="literal">blueprint:file:/[PATH]/datasource-h2.xml</code>).
          </p>

          </a><div class="example"><a id="d5e3398"></a><a id="d5e3404"><p class="title"><strong>Example&nbsp;17.1.&nbsp;datasource-h2.xml</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!--
First install the H2 driver using:
&gt; install -s mvn:com.h2database/h2/1.3.163

Then copy this file to the deploy folder
--&gt;
&lt;blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0"&gt;

  &lt;bean id="dataSource" class="org.h2.jdbcx.JdbcDataSource"&gt;
    &lt;property name="URL" value="jdbc:h2:mem:db1;DB_CLOSE_DELAY=-1;MVCC=TRUE"/&gt;
    &lt;property name="user" value="sa"/&gt;
    &lt;property name="password" value=""/&gt;
  &lt;/bean&gt;

  &lt;service interface="javax.sql.DataSource" ref="dataSource"&gt;
    &lt;service-properties&gt;
      &lt;entry key="osgi.jndi.service.name" value="jdbc/h2ds"/&gt;
    &lt;/service-properties&gt;
  &lt;/service&gt;
&lt;/blueprint&gt;</pre>
          </div></a></div><a id="d5e3404"><br class="example-break">

          <p>
            That DS is then used by your <code class="literal">persistence.xml</code> persistence-unit.  The following works
            in Karaf, but the names may need tweaked in alternative containers.
          </p>

          </a><div class="example"><a id="d5e3404"></a><a id="d5e3409"><p class="title"><strong>Example&nbsp;17.2.&nbsp;META-INF/persistence.xml</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&lt;jta-data-source&gt;osgi:service/javax.sql.DataSource/(osgi.jndi.service.name=jdbc/h2ds)&lt;/jta-data-source&gt;</pre>
          </div></a></div><a id="d5e3409"><br class="example-break">
        </a></div><a id="d5e3409">
        
        </a><div class="section" title="17.5.4.&nbsp;Bundle Package Imports"><a id="d5e3409"></a><div class="titlepage"><a id="d5e3409"></a><div><a id="d5e3409"></a><div><a id="d5e3409"></a><h3 class="title"><a id="d5e3409"></a><a id="d5e3412">17.5.4.&nbsp;Bundle Package Imports</a></h3></div></div></div><a id="d5e3412">
        	
        	<p>
        		Your bundle's manifest will need to import, at a minimum,
        		</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
		                <code class="literal">javax.persistence</code>
		            </li><li class="listitem">
		                <p>
		                    <code class="literal">org.hibernate.proxy</code> and <code class="literal">javassist.util.proxy</code>, due to
		                    Hibernate's ability to return proxies for lazy initialization (Javassist enhancement
		                    occurs on the entity's ClassLoader during runtime).
		                </p>
		            </li></ul></div><p>
        	</p>
        </a></div><a id="d5e3412">
        
        </a><div class="section" title="17.5.5.&nbsp;Obtaining an EntityManger"><a id="d5e3412"></a><div class="titlepage"><a id="d5e3412"></a><div><a id="d5e3412"></a><div><a id="d5e3412"></a><h3 class="title"><a id="d5e3412"></a><a id="d5e3422">17.5.5.&nbsp;Obtaining an EntityManger</a></h3></div></div></div><a id="d5e3422">
        	
        	<p>
        		The easiest, and most supported, method of obtaining an <code class="literal">EntityManager</code> utilizes OSGi's
        		<code class="literal">OSGI-INF/blueprint/blueprint.xml</code> in your bundle.  The container takes the name of your
            persistence unit, then automatically injects
        		an <code class="literal">EntityManager</code> instance into your given bean attribute.
        	</p>

          </a><div class="example"><a id="d5e3422"></a><a id="d5e3428"><p class="title"><strong>Example&nbsp;17.3.&nbsp;OSGI-INF/blueprint/blueprint.xml</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;blueprint  default-activation="eager"
            xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0"
            xmlns:jpa="http://aries.apache.org/xmlns/jpa/v1.0.0"
            xmlns:tx="http://aries.apache.org/xmlns/transactions/v1.0.0"&gt;

  &lt;!-- This gets the container-managed EntityManager and injects it into the DataPointServiceImpl bean.
  Assumes DataPointServiceImpl has an "entityManager" field with a getter and setter. --&gt;
  &lt;bean id="dpService" class="org.hibernate.osgitest.DataPointServiceImpl"&gt; 
      &lt;jpa:context unitname="managed-jpa" property="entityManager"/&gt;
      &lt;tx:transaction method="*" value="Required"/&gt;
  &lt;/bean&gt;
  &lt;service ref="dpService" interface="org.hibernate.osgitest.DataPointService" /&gt;
&lt;/blueprint&gt;
</pre>
          </div></a></div><a id="d5e3428"><br class="example-break">
        </a></div><a id="d5e3428">
    </a></div><a id="d5e3428">

    </a><div class="section" title="17.6.&nbsp;Unmanaged JPA"><a id="d5e3428"></a><div class="titlepage"><a id="d5e3428"></a><div><a id="d5e3428"></a><div><a id="d5e3428"></a><h2 class="title"><a id="d5e3428"></a><a id="osgi-unmanaged-jpa">17.6.&nbsp;Unmanaged JPA</a></h2></div></div></div><a id="osgi-unmanaged-jpa">
        
        
        <p>
            Hibernate also supports the use of JPA through hibernate-entitymanager, unmanaged by the OSGi
            container.  The client bundle is responsible for managing the EntityManagerFactory and EntityManagers.
        </p>

        </a><div class="section" title="17.6.1.&nbsp;persistence.xml"><a id="osgi-unmanaged-jpa"></a><div class="titlepage"><a id="osgi-unmanaged-jpa"></a><div><a id="osgi-unmanaged-jpa"></a><div><a id="osgi-unmanaged-jpa"></a><h3 class="title"><a id="osgi-unmanaged-jpa"></a><a id="d5e3434">17.6.1.&nbsp;persistence.xml</a></h3></div></div></div><a id="d5e3434">
          
          <p>
            Similar to any other JPA setup, your bundle must include a <code class="literal">persistence.xml</code> file.
            This is typically located in <code class="literal">META-INF</code>.
          </p>
        </a></div><a id="d5e3434">
        
        </a><div class="section" title="17.6.2.&nbsp;Bundle Package Imports"><a id="d5e3434"></a><div class="titlepage"><a id="d5e3434"></a><div><a id="d5e3434"></a><div><a id="d5e3434"></a><h3 class="title"><a id="d5e3434"></a><a id="d5e3439">17.6.2.&nbsp;Bundle Package Imports</a></h3></div></div></div><a id="d5e3439">
        	
        	<p>
        		Your bundle's manifest will need to import, at a minimum,
        		</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
		                <code class="literal">javax.persistence</code>
		            </li><li class="listitem">
		                <p>
		                    <code class="literal">org.hibernate.proxy</code> and <code class="literal">javassist.util.proxy</code>, due to
		                    Hibernate's ability to return proxies for lazy initialization (Javassist enhancement
		                    occurs on the entity's ClassLoader during runtime)
		                </p>
		            </li><li class="listitem">
		                <p>
		                    JDBC driver package (example: <code class="literal">org.h2</code>)
		                </p>
		            </li><li class="listitem">
		                <p>
		                    <code class="literal">org.osgi.framework</code>, necessary to discover the EMF (described below)
		                </p>
		            </li></ul></div><p>
        	</p>
        </a></div><a id="d5e3439">
        
        </a><div class="section" title="17.6.3.&nbsp;Obtaining an EntityMangerFactory"><a id="d5e3439"></a><div class="titlepage"><a id="d5e3439"></a><div><a id="d5e3439"></a><div><a id="d5e3439"></a><h3 class="title"><a id="d5e3439"></a><a id="d5e3455">17.6.3.&nbsp;Obtaining an EntityMangerFactory</a></h3></div></div></div><a id="d5e3455">
        	
        	<p>
        		<code class="literal">hibernate-osgi</code> registers an OSGi service, using the JPA <code class="literal">PersistenceProvider</code> interface
        		name, that bootstraps and creates an <code class="literal">EntityManagerFactory</code> specific for OSGi
        		environments.  It is VITAL that your EMF be obtained through the service, rather than creating it
        		manually.  The service handles the OSGi ClassLoader, discovered extension points, scanning, etc.  Manually
        		creating an <code class="literal">EntityManagerFactory</code> is guaranteed to NOT work during runtime!
        	</p>
        	</a><div class="example"><a id="d5e3455"></a><a id="d5e3462"><p class="title"><strong>Example&nbsp;17.4.&nbsp;Discover/Use EntityManagerFactory</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">public class HibernateUtil {

    private EntityManagerFactory emf;

    public EntityManager getEntityManager() {
        return getEntityManagerFactory().createEntityManager();
    }

    private EntityManagerFactory getEntityManagerFactory() {
        if ( emf == null ) {
            Bundle thisBundle = FrameworkUtil.getBundle( HibernateUtil.class );
            BundleContext context = thisBundle.getBundleContext();

            ServiceReference serviceReference = context.getServiceReference( PersistenceProvider.class.getName() );
            PersistenceProvider persistenceProvider = (PersistenceProvider) context.getService( serviceReference );

            emf = persistenceProvider.createEntityManagerFactory( "YourPersistenceUnitName", null );
        }
        return emf;
    }
}</pre>
          </div></a></div><a id="d5e3462"><br class="example-break">
        </a></div><a id="d5e3462">
    </a></div><a id="d5e3462">

    </a><div class="section" title="17.7.&nbsp;Unmanaged Native"><a id="d5e3462"></a><div class="titlepage"><a id="d5e3462"></a><div><a id="d5e3462"></a><div><a id="d5e3462"></a><h2 class="title"><a id="d5e3462"></a><a id="osgi-unmanaged-native">17.7.&nbsp;Unmanaged Native</a></h2></div></div></div><a id="osgi-unmanaged-native">
        
        
        <p>
            Native Hibernate use is also supported.  The client bundle is responsible for managing the
            SessionFactory and Sessions.
        </p>
        
        </a><div class="section" title="17.7.1.&nbsp;Bundle Package Imports"><a id="osgi-unmanaged-native"></a><div class="titlepage"><a id="osgi-unmanaged-native"></a><div><a id="osgi-unmanaged-native"></a><div><a id="osgi-unmanaged-native"></a><h3 class="title"><a id="osgi-unmanaged-native"></a><a id="d5e3468">17.7.1.&nbsp;Bundle Package Imports</a></h3></div></div></div><a id="d5e3468">
        	
        	<p>
        		Your bundle's manifest will need to import, at a minimum,
        		</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
		                <code class="literal">javax.persistence</code>
		            </li><li class="listitem">
		                <p>
		                    <code class="literal">org.hibernate.proxy</code> and <code class="literal">javassist.util.proxy</code>, due to
		                    Hibernate's ability to return proxies for lazy initialization (Javassist enhancement
		                    occurs on the entity's ClassLoader during runtime)
		                </p>
		            </li><li class="listitem">
		                <p>
		                    JDBC driver package (example: <code class="literal">org.h2</code>)
		                </p>
		            </li><li class="listitem">
		                <p>
		                    <code class="literal">org.osgi.framework</code>, necessary to discover the SF (described below)
		                </p>
		            </li><li class="listitem">
		                <p>
		                    <code class="literal">org.hibernate.*</code> packages, as necessary (ex: cfg, criterion, service, etc.)
		                </p>
		            </li></ul></div><p>
        	</p>
        </a></div><a id="d5e3468">
        
        </a><div class="section" title="17.7.2.&nbsp;Obtaining an SessionFactory"><a id="d5e3468"></a><div class="titlepage"><a id="d5e3468"></a><div><a id="d5e3468"></a><div><a id="d5e3468"></a><h3 class="title"><a id="d5e3468"></a><a id="d5e3487">17.7.2.&nbsp;Obtaining an SessionFactory</a></h3></div></div></div><a id="d5e3487">
        	
        	<p>
            <code class="literal">hibernate-osgi</code> registers an OSGi service, using the <code class="literal">SessionFactory</code> interface
        		name, that bootstraps and creates an <code class="literal">SessionFactory</code> specific for OSGi
        		environments.  It is VITAL that your SF be obtained through the service, rather than creating it
        		manually.  The service handles the OSGi ClassLoader, discovered extension points, scanning, etc.  Manually
        		creating an <code class="literal">SessionFactory</code> is guaranteed to NOT work during runtime!
        	</p>
          </a><div class="example"><a id="d5e3487"></a><a id="d5e3494"><p class="title"><strong>Example&nbsp;17.5.&nbsp;Discover/Use EntityManagerFactory</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">public class HibernateUtil {

    private SessionFactory sf;

    public Session getSession() {
        return getSessionFactory().openSession();
    }

    private SessionFactory getSessionFactory() {
        if ( sf == null ) {
            Bundle thisBundle = FrameworkUtil.getBundle( HibernateUtil.class );
            BundleContext context = thisBundle.getBundleContext();

            ServiceReference sr = context.getServiceReference( SessionFactory.class.getName() );
            sf = (SessionFactory) context.getService( sr );
        }
        return sf;
    }
}</pre>
          </div></a></div><a id="d5e3494"><br class="example-break">
        </a></div><a id="d5e3494">
    </a></div><a id="d5e3494">
    
    </a><div class="section" title="17.8.&nbsp;Optional Modules"><a id="d5e3494"></a><div class="titlepage"><a id="d5e3494"></a><div><a id="d5e3494"></a><div><a id="d5e3494"></a><h2 class="title"><a id="d5e3494"></a><a id="d5e3497">17.8.&nbsp;Optional Modules</a></h2></div></div></div><a id="d5e3497">
    	
    	
    	</a><p><a id="d5e3497">
    		The </a><a class="ulink" href="https://github.com/hibernate/hibernate-demos/tree/master/hibernate-orm/osgi/unmanaged-native">unmanaged-native</a>
    		demo project displays the use of optional Hibernate modules.  Each module adds additional
    		dependency bundles that must first be activated, either manually or through an additional feature.
    		As of ORM 4.2, Envers is fully supported.  Support for C3P0, Proxool, EhCache, and Infinispan were added in
    		4.3, however none of their 3rd party libraries currently work in OSGi (lots of ClassLoader problems, etc.).
    		We're tracking the issues in JIRA.
    	</p>
    </div>
    
    <div class="section" title="17.9.&nbsp;Extension Points"><div class="titlepage"><div><div><h2 class="title"><a id="d5e3501">17.9.&nbsp;Extension Points</a></h2></div></div></div><a id="d5e3501">
    	
    	
    	<p>
    		Multiple contracts exist to allow applications to integrate with and extend Hibernate capabilities.  Most
    		apps utilize JDK services to provide their implementations.  <code class="literal">hibernate-osgi</code> supports the same
    		extensions through OSGi services.  Implement and register them in any of the three configurations.
        <code class="literal">hibernate-osgi</code> will discover and integrate them during EMF/SF bootstrapping.  Supported extension points
    		are as follows.  The specified interface should be used during service registration.
    		
    		</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
	                <code class="literal">org.hibernate.integrator.spi.Integrator</code> (as of 4.2)
	            </li><li class="listitem">
	                <code class="literal">org.hibernate.boot.registry.selector.StrategyRegistrationProvider</code> (as of 4.3)
	            </li><li class="listitem">
	                <code class="literal">org.hibernate.boot.model.TypeContributor</code> (as of 4.3)
	            </li><li class="listitem">
	                JTA's <code class="literal">javax.transaction.TransactionManager</code> and
	                <code class="literal">javax.transaction.UserTransaction</code> (as of 4.2), however these are typically
	                provided by the OSGi container.
	            </li></ul></div><p>
    	</p>
    	
    	<p>
    		The easiest way to register extension point implementations is through a <code class="literal">blueprint.xml</code>
    		file.  Add <code class="literal">OSGI-INF/blueprint/blueprint.xml</code> to your classpath.  Envers' blueprint
    		is a great example:
    	</p>
    	
    	</a><div class="example"><a id="d5e3501"></a><a id="d5e3519"><p class="title"><strong>Example&nbsp;17.6.&nbsp;Example extension point registrations in blueprint.xml</strong></p><div class="example-contents">
          
          <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&lt;!--
  ~ Hibernate, Relational Persistence for Idiomatic Java
  ~
  ~ License: GNU Lesser General Public License (LGPL), version 2.1 or later.
  ~ See the lgpl.txt file in the root directory or &lt;http://www.gnu.org/licenses/lgpl-2.1.html&gt;.
  --&gt;
&lt;blueprint default-activation="eager"
		   xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0"&gt;

	&lt;bean id="integrator" class="org.hibernate.envers.boot.internal.EnversIntegrator" /&gt;
	&lt;service ref="integrator" interface="org.hibernate.integrator.spi.Integrator" /&gt;

	&lt;bean id="typeContributor"
		class="org.hibernate.envers.boot.internal.TypeContributorImpl" /&gt;
	&lt;service ref="typeContributor" interface="org.hibernate.boot.model.TypeContributor" /&gt;

&lt;/blueprint&gt;</pre>
      </div></a></div><a id="d5e3519"><br class="example-break">

      <p>
        Extension points can also be registered programmatically with
        <code class="literal">BundleContext#registerService</code>, typically within your
        <code class="literal">BundleActivator#start</code>.
      </p>
    </a></div><a id="d5e3519">
    
    </a><div class="section" title="17.10.&nbsp;Caveats"><a id="d5e3519"></a><div class="titlepage"><a id="d5e3519"></a><div><a id="d5e3519"></a><div><a id="d5e3519"></a><h2 class="title"><a id="d5e3519"></a><a id="d5e3525">17.10.&nbsp;Caveats</a></h2></div></div></div><a id="d5e3525">
    	
    	
    	<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
                <p>
                	Technically, multiple persistence units are supported by Enterprise OSGi JPA and unmanaged
                	Hibernate JPA use.  However, we cannot currently support this in OSGi.  In Hibernate 4, only one
                	instance of the OSGi-specific ClassLoader is used per Hibernate bundle, mainly due to heavy use of
                	static TCCL utilities.  We hope to support one OSGi ClassLoader per persistence unit in
                	Hibernate 5.
                </p>
            </li><li class="listitem">
                <p>
                	Scanning is supported to find non-explicitly listed entities and mappings.  However, they MUST be
                	in the same bundle as your persistence unit (fairly typical anyway).  Our OSGi ClassLoader only
                	considers the "requesting bundle" (hence the requirement on using services to create EMF/SF),
                	rather than attempting to scan all available bundles.  This is primarily for versioning
                	considerations, collision protections, etc.
                </p>
            </li><li class="listitem">
                <p>
                	Some containers (ex: Aries) always return true for
                	<code class="literal">PersistenceUnitInfo#excludeUnlistedClasses</code>,
                	even if your persistence.xml explicitly has <code class="literal">exclude-unlisted-classes</code> set
                	to <code class="literal">false</code>.  They claim it's to protect JPA providers from having to implement
                	scanning ("we handle it for you"), even though we still want to support it in many cases.  The work
                	around is to set <code class="literal">hibernate.archive.autodetection</code> to, for example,
                	<code class="literal">hbm,class</code>.  This tells hibernate to ignore the excludeUnlistedClasses value and
                	scan for <code class="literal">*.hbm.xml</code> and entities regardless.
                </p>
            </li><li class="listitem">
                <p>
                	Scanning does not currently support annotated packages on <code class="literal">package-info.java</code>.
                </p>
            </li><li class="listitem">
                <p>
                	Currently, Hibernate OSGi is primarily tested using Apache Karaf and Apache Aries JPA.  Additional
                	testing is needed with Equinox, Gemini, and other container providers.
                </p>
            </li><li class="listitem">
                <p>
                	Hibernate ORM has many dependencies that do not currently provide OSGi manifests.
                	The QuickStart tutorials make heavy use of 3rd party bundles (SpringSource, ServiceMix) or the
                	<code class="literal">wrap:...</code> operator.
                </p>
            </li></ul></div>
    </a></div><a id="d5e3525">

</a></div><a id="d5e3525">
    </a><div class="chapter" title="Chapter&nbsp;18.&nbsp;Envers"><a id="d5e3525"></a><div class="titlepage"><a id="d5e3525"></a><div><a id="d5e3525"></a><div><a id="d5e3525"></a><h2 class="title"><a id="d5e3525"></a><a id="d5e3548">Chapter&nbsp;18.&nbsp;Envers</a></h2></div><div><div class="abstract" title="Abstract"><p class="title"><a id="d5e3548"><strong>Abstract</strong></a></p><a id="d5e3548">
            <p>
                The aim of Hibernate Envers is to provide historical 
versioning of your application's entity data.  Much
                like source control management tools such as Subversion 
or Git, Hibernate Envers manages a notion of revisions
                if your application data through the use of audit 
tables.  Each transaction relates to one global revision number
                which can be used to identify groups of changes (much 
like a change set in source control).  As the revisions
                are global, having a revision number, you can query for 
various entities at that revision, retrieving a
                (partial) view of the database at that revision. You can
 find a revision number having a date, and the other
                way round, you can get the date at which a revision was 
committed.
            </p>
        </a></div></div></div></div><div class="toc"><p><a id="d5e3548"><strong>Table of Contents</strong></a></p><dl><dt><a id="d5e3548"><span class="section"></span></a><a href="#d5e3554">18.1. Basics</a></dt><dt><span class="section"><a href="#envers-configuration">18.2. Configuration</a></span></dt><dt><span class="section"><a href="#d5e3717">18.3. Additional mapping annotations</a></span></dt><dt><span class="section"><a href="#d5e3741">18.4. Choosing an audit strategy</a></span></dt><dt><span class="section"><a href="#envers-revisionlog">18.5. Revision Log</a></span></dt><dd><dl><dt><span class="section"><a href="#envers-tracking-modified-entities-revchanges">18.5.1. Tracking entity names modified during revisions</a></span></dt></dl></dd><dt><span class="section"><a href="#envers-tracking-properties-changes">18.6. Tracking entity changes at property level</a></span></dt><dt><span class="section"><a href="#envers-queries">18.7. Queries</a></span></dt><dd><dl><dt><span class="section"><a href="#entities-at-revision">18.7.1. Querying for entities of a class at a given revision</a></span></dt><dt><span class="section"><a href="#revisions-of-entity">18.7.2. Querying for revisions, at which entities of a given class changed</a></span></dt><dt><span class="section"><a href="#envers-tracking-properties-changes-queries">18.7.3. Querying for revisions of entity that modified given property</a></span></dt><dt><span class="section"><a href="#envers-tracking-modified-entities-queries">18.7.4. Querying for entities modified in a given revision</a></span></dt></dl></dd><dt><span class="section"><a href="#d5e3959">18.8. Conditional auditing</a></span></dt><dt><span class="section"><a href="#d5e3979">18.9. Understanding the Envers Schema</a></span></dt><dt><span class="section"><a href="#envers-generateschema">18.10. Generating schema with Ant</a></span></dt><dt><span class="section"><a href="#envers-mappingexceptions">18.11. Mapping exceptions</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e4014">18.11.1. What isn't and will not be supported</a></span></dt><dt><span class="section"><a href="#d5e4025">18.11.2. What isn't and <span class="emphasis"><em>will</em></span> be supported</a></span></dt><dt><span class="section"><a href="#d5e4032">18.11.3. <code class="literal">@OneToMany</code>+<code class="literal">@JoinColumn</code></a></span></dt></dl></dd><dt><span class="section"><a href="#envers-partitioning">18.12. Advanced: Audit table partitioning</a></span></dt><dd><dl><dt><span class="section"><a href="#envers-partitioning-benefits">18.12.1. Benefits of audit table partitioning</a></span></dt><dt><span class="section"><a href="#envers-partitioning-columns">18.12.2. Suitable columns for audit table partitioning</a></span></dt><dt><span class="section"><a href="#envers-partitioning-example">18.12.3. Audit table partitioning example</a></span></dt></dl></dd><dt><span class="section"><a href="#envers-links">18.13. Envers links</a></span></dt></dl></div>
    

    <div class="section" title="18.1.&nbsp;Basics"><div class="titlepage"><div><div><h2 class="title"><a id="d5e3554">18.1.&nbsp;Basics</a></h2></div></div></div><a id="d5e3554">
        

        <p>
            To audit changes that are performed on an entity, you only need two things: the
            <code class="literal">hibernate-envers</code> jar on the classpath and an <code class="literal">@Audited</code> annotation
            on the entity.
        </p>

        <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Important</h2>
            <p>
                Unlike in previous versions, you no longer need to specify listeners in the Hibernate configuration
                file. Just putting the Envers jar on the classpath is enough - listeners will be registered
                automatically.
            </p>
        </div>

        <p>
            And that's all - you can create, modify and delete the entities as always. If you look at the generated
            schema for your entities, or at the data persisted by Hibernate, you will notice that there are no changes.
            However, for each audited entity, a new table is introduced - <code class="literal">entity_table_AUD</code>,
            which stores the historical data, whenever you commit a transaction. Envers automatically creates audit
            tables if <code class="literal">hibernate.hbm2ddl.auto</code> option is set to <code class="literal">create</code>,
            <code class="literal">create-drop</code> or <code class="literal">update</code>. Otherwise, to export complete database schema
            programatically, use <code class="literal">org.hibernate.envers.tools.hbm2ddl.EnversSchemaGenerator</code>. Appropriate DDL
            statements can be also generated with Ant task described later in this manual.
        </p>

        <p>
            Instead of annotating the whole class and auditing all properties, you can annotate
            only some persistent properties with <code class="literal">@Audited</code>. This will cause only
            these properties to be audited.
        </p>

        <p>
            The audit (history) of an entity can be accessed using the <code class="literal">AuditReader</code> interface, which
            can be obtained having an open <code class="literal">EntityManager</code> or <code class="literal">Session</code> via
            the <code class="literal">AuditReaderFactory</code>. See the javadocs for these classes for details on the
            functionality offered.
        </p>
    </a></div><a id="d5e3554">

    </a><div class="section" title="18.2.&nbsp;Configuration"><a id="d5e3554"></a><div class="titlepage"><a id="d5e3554"></a><div><a id="d5e3554"></a><div><a id="d5e3554"></a><h2 class="title"><a id="d5e3554"></a><a id="envers-configuration">18.2.&nbsp;Configuration</a></h2></div></div></div><a id="envers-configuration">
        
        <p>
            It is possible to configure various aspects of Hibernate Envers behavior, such as table names, etc.
        </p>

        </a><div class="table"><a id="envers-configuration"></a><a id="d5e3578"><p class="title"><strong>Table&nbsp;18.1.&nbsp;Envers Configuration Properties</strong></p><div class="table-contents">
            
            <table summary="Envers Configuration Properties" border="1"><colgroup><col class="c1" width="1*"><col class="c2" width="1*"><col class="c2" width="1*"></colgroup><thead><tr><th>Property name</th><th>Default value</th><th>Description</th></tr></thead><tbody><tr><td>
                            <span class="property">org.hibernate.envers.audit_table_prefix</span>
                        </td><td>
                        </td><td>
                            String that will be prepended to the name of an audited entity to create the name of the
                            entity, that will hold audit information.
                        </td></tr><tr><td>
                            <span class="property">org.hibernate.envers.audit_table_suffix</span>
                        </td><td>
                            _AUD
                        </td><td>
                            String that will be appended to the name of an audited entity to create the name of the
                            entity, that will hold audit information. If you audit an entity with a table name Person,
                            in the default setting Envers will generate a <code class="literal">Person_AUD</code> table to store
                            historical data.
                        </td></tr><tr><td>
                            <span class="property">org.hibernate.envers.revision_field_name</span>
                        </td><td>
                            REV
                        </td><td>
                            Name of a field in the audit entity that will hold the revision number.
                        </td></tr><tr><td>
                            <span class="property">org.hibernate.envers.revision_type_field_name</span>
                        </td><td>
                            REVTYPE
                        </td><td>
                            Name of a field in the audit entity that will hold the type of the revision (currently,
                            this can be: add, mod, del).
                        </td></tr><tr><td>
                            <span class="property">org.hibernate.envers.revision_on_collection_change</span>
                        </td><td>
                            true
                        </td><td>
                            Should a revision be generated when a not-owned relation field changes (this can be either
                            a collection in a one-to-many relation, or the field using "mappedBy" attribute in a
                            one-to-one relation).
                        </td></tr><tr><td>
                            <span class="property">org.hibernate.envers.do_not_audit_optimistic_locking_field</span>
                        </td><td>
                            true
                        </td><td>
                            When true, properties to be used for optimistic locking, annotated with
                            <code class="literal">@Version</code>, will be automatically not audited (their history won't be
                            stored; it normally doesn't make sense to store it).
                        </td></tr><tr><td>
                            <span class="property">org.hibernate.envers.store_data_at_delete</span>
                        </td><td>
                            false
                        </td><td>
                            Should the entity data be stored in the revision when the entity is deleted (instead of only
                            storing the id and all other properties as null). This is not normally needed, as the data is
                            present in the last-but-one revision. Sometimes, however, it is easier and more efficient to
                            access it in the last revision (then the data that the entity contained before deletion is
                            stored twice).
                        </td></tr><tr><td>
                            <span class="property">org.hibernate.envers.default_schema</span>
                        </td><td>
                            null (same schema as table being audited)
                        </td><td>
                            The default schema name that should be used for audit tables. Can be overridden using the
                            <code class="literal">@AuditTable(schema="...")</code> annotation. If not present, the schema will
                            be the same as the schema of the table being audited.
                        </td></tr><tr><td>
                            <span class="property">org.hibernate.envers.default_catalog</span>
                        </td><td>
                            null (same catalog as table being audited)
                        </td><td>
                            The default catalog name that should be used for audit tables. Can be overridden using the
                            <code class="literal">@AuditTable(catalog="...")</code> annotation. If not present, the catalog will
                            be the same as the catalog of the normal tables.
                        </td></tr><tr><td>
                            <span class="property">org.hibernate.envers.audit_strategy</span>
                        </td><td>
                            org.hibernate.envers.strategy.DefaultAuditStrategy
                        </td><td>
                            The audit strategy that should be used when persisting audit data. The default stores only
                            the revision, at which an entity was modified. An alternative, the
                            <code class="literal">org.hibernate.envers.strategy.ValidityAuditStrategy</code> stores both the
                            start revision and the end revision. Together these define when an audit row was valid,
                            hence the name ValidityAuditStrategy.
                        </td></tr><tr><td>
                            <span class="property">org.hibernate.envers.audit_strategy_validity_end_rev_field_name</span>
                        </td><td>
                            REVEND
                        </td><td>
                            The column name that will hold the end revision number in audit entities. This property is
                            only valid if the validity audit strategy is used.
                        </td></tr><tr><td>
                            <span class="property">org.hibernate.envers.audit_strategy_validity_store_revend_timestamp</span>
                        </td><td>
                            false
                        </td><td>
                            Should the timestamp of the end revision be stored, until which the data was valid, in
                            addition to the end revision itself.  This is useful to be able to purge old Audit records
                            out of a relational database by using table partitioning.  Partitioning requires a column
                            that exists within the table.  This property is only evaluated if the ValidityAuditStrategy
                            is used.
                        </td></tr><tr><td>
                            <span class="property">org.hibernate.envers.audit_strategy_validity_revend_timestamp_field_name</span>
                        </td><td>
                            REVEND_TSTMP
                        </td><td>
                            Column name of the timestamp of the end revision until which the data was valid.  Only used
                            if the ValidityAuditStrategy is used, and
                            <span class="property">org.hibernate.envers.audit_strategy_validity_store_revend_timestamp</span>
                            evaluates to true
                        </td></tr><tr><td>
                            <span class="property">org.hibernate.envers.use_revision_entity_with_native_id</span>
                        </td><td>
                            true
                        </td><td>
                            Boolean flag that determines the strategy of revision number generation. Default
                            implementation of revision entity uses native identifier generator. If current database
                            engine does not support identity columns, users are advised to set this property to false.
                            In this case revision numbers are created by preconfigured
                            <code class="classname">org.hibernate.id.enhanced.SequenceStyleGenerator</code>. See:
                            <div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><code class="classname">org.hibernate.envers.DefaultRevisionEntity</code></li><li class="listitem"><code class="classname">org.hibernate.envers.enhanced.SequenceIdRevisionEntity</code></li></ol></div>
                        </td></tr><tr><td>
                            <span class="property">org.hibernate.envers.track_entities_changed_in_revision</span>
                        </td><td>
                            false
                        </td><td>
                            Should entity types, that have been modified during each revision, be tracked. The default
                            implementation creates <code class="literal">REVCHANGES</code> table that stores entity names
                            of modified persistent objects. Single record encapsulates the revision identifier
                            (foreign key to <code class="literal">REVINFO</code> table) and a string value. For more
                            information refer to <a class="xref" href="#envers-tracking-modified-entities-revchanges" title="18.5.1.&nbsp;Tracking entity names modified during revisions">Section&nbsp;18.5.1, “Tracking entity names modified during revisions”</a>
                            and <a class="xref" href="#envers-tracking-modified-entities-queries" title="18.7.4.&nbsp;Querying for entities modified in a given revision">Section&nbsp;18.7.4, “Querying for entities modified in a given revision”</a>.
                        </td></tr><tr><td>
                            <span class="property">org.hibernate.envers.global_with_modified_flag</span>
                        </td><td>
                            false, can be individually overriden with <code class="literal">@Audited(withModifiedFlag=true)</code>
                        </td><td>
                            Should property modification flags be stored for all audited entities and all properties.
                            When set to true, for all properties an additional boolean column in the audit tables will
                            be created, filled with information if the given property changed in the given revision.
                            When set to false, such column can be added to selected entities or properties using the
                            <code class="literal">@Audited</code> annotation.
                            For more information refer to <a class="xref" href="#envers-tracking-properties-changes" title="18.6.&nbsp;Tracking entity changes at property level">Section&nbsp;18.6, “Tracking entity changes at property level”</a>
                            and <a class="xref" href="#envers-tracking-properties-changes-queries" title="18.7.3.&nbsp;Querying for revisions of entity that modified given property">Section&nbsp;18.7.3, “Querying for revisions of entity that modified given property”</a>.
                        </td></tr><tr><td>
                            <span class="property">org.hibernate.envers.modified_flag_suffix</span>
                        </td><td>
                            _MOD
                        </td><td>
                            The suffix for columns storing "Modified Flags".
                            For example: a property called "age", will by default get modified flag with column name "age_MOD".
                        </td></tr><tr><td>
                            <span class="property">org.hibernate.envers.embeddable_set_ordinal_field_name</span>
                        </td><td>
                            SETORDINAL
                        </td><td>
                            Name of column used for storing ordinal of the change in sets of embeddable elements.
                        </td></tr><tr><td>
                            <span class="property">org.hibernate.envers.cascade_delete_revision</span>
                        </td><td>
                            false
                        </td><td>
                            While deleting revision entry, remove data of associated audited entities.
                            Requires database support for cascade row removal. 
                        </td></tr><tr><td>
                            <span class="property">org.hibernate.envers.allow_identifier_reuse</span>
                        </td><td>
                            false
                        </td><td>
                            Guarantees proper validity audit strategy behavior when application reuses identifiers
                            of deleted entities. Exactly one row with <code class="literal">null</code> end date exists
                            for each identifier.
                        </td></tr></tbody></table>
        </div></a></div><a id="d5e3578"><br class="table-break">

        <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Important</h2>
            <p>
                The following configuration options have been added recently and should be regarded as experimental:
                </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
                        org.hibernate.envers.track_entities_changed_in_revision
                    </li><li class="listitem">
                        org.hibernate.envers.using_modified_flag
                    </li><li class="listitem">
                        org.hibernate.envers.modified_flag_suffix
                    </li></ol></div><p>
            </p>
        </div>
    </a></div><a id="d5e3578">

    </a><div class="section" title="18.3.&nbsp;Additional mapping annotations"><a id="d5e3578"></a><div class="titlepage"><a id="d5e3578"></a><div><a id="d5e3578"></a><div><a id="d5e3578"></a><h2 class="title"><a id="d5e3578"></a><a id="d5e3717">18.3.&nbsp;Additional mapping annotations</a></h2></div></div></div><a id="d5e3717">
        

        <p>
            The name of the audit table can be set on a per-entity basis, using the
            <code class="literal">@AuditTable</code> annotation. It may be tedious to add this
            annotation to every audited entity, so if possible, it's better to use a prefix/suffix.
        </p>

        <p>
            If you have a mapping with secondary tables, audit tables for them will be generated in
            the same way (by adding the prefix and suffix). If you wish to overwrite this behaviour,
            you can use the <code class="literal">@SecondaryAuditTable</code> and
            <code class="literal">@SecondaryAuditTables</code> annotations.
        </p>

        <p>
            If you'd like to override auditing behaviour of some fields/properties inherited from
            <code class="interfacename">@Mappedsuperclass</code> or in an embedded component, you can
            apply the <code class="literal">@AuditOverride(s)</code> annotation on the subtype or usage site
            of the component.
        </p>

        </a><p><a id="d5e3717">
            If you want to audit a relation mapped with <code class="literal">@OneToMany+@JoinColumn</code>,
            please see </a><a class="xref" href="#envers-mappingexceptions" title="18.11.&nbsp;Mapping exceptions">Section&nbsp;18.11, “Mapping exceptions”</a> for a description of the additional
            <code class="literal">@AuditJoinTable</code> annotation that you'll probably want to use.
        </p>

        <p>
            If you want to audit a relation, where the target entity is not audited (that is the case for example with
            dictionary-like entities, which don't change and don't have to be audited), just annotate it with
            <code class="literal">@Audited(targetAuditMode = RelationTargetAuditMode.NOT_AUDITED)</code>. Then, while reading historic
            versions of your entity, the relation will always point to the "current" related entity. By default Envers
            throws <code class="classname">javax.persistence.EntityNotFoundException</code> when "current" entity does not
            exist in the database. Apply <code class="literal">@NotFound(action = NotFoundAction.IGNORE)</code> annotation
            to silence the exception and assign null value instead. Hereby solution causes implicit eager loading
            of to-one relations.
        </p>

        <p>
            If you'd like to audit properties of a superclass of an entity, which are not explicitly audited (which
            don't have the <code class="literal">@Audited</code> annotation on any properties or on the class), you can list the
            superclasses in the <code class="literal">auditParents</code> attribute of the <code class="interfacename">@Audited</code>
            annotation. Please note that <code class="literal">auditParents</code> feature has been deprecated. Use
            <code class="literal">@AuditOverride(forClass = SomeEntity.class, isAudited = true/false)</code> instead.
        </p>
    </div>

    <div class="section" title="18.4.&nbsp;Choosing an audit strategy"><div class="titlepage"><div><div><h2 class="title"><a id="d5e3741">18.4.&nbsp;Choosing an audit strategy</a></h2></div></div></div><a id="d5e3741">
        
        <p>
            After the basic configuration it is important to choose the audit strategy that will be used to persist
            and retrieve audit information. There is a trade-off between the performance of persisting and the
            performance of querying the audit information. Currently there two audit strategies.
        </p>
        <div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
                <p>
                    The default audit strategy persists the audit data together with a start revision. For each row
                    inserted, updated or deleted in an audited table, one or more rows are inserted in the audit
                    tables, together with the start revision of its validity. Rows in the audit tables are never
                    updated after insertion.  Queries of audit information use subqueries to select the applicable
                    rows in the audit tables.  These subqueries are notoriously slow and difficult to index.
                </p>
            </li><li class="listitem">
                <p>
                    The alternative is a validity audit strategy. This strategy stores the start-revision and the
                    end-revision of audit information. For each row inserted, updated or deleted in an audited table,
                    one or more rows are inserted in the audit tables, together with the start revision of its
                    validity. But at the same time the end-revision field of the previous audit rows (if available)
                    are set to this revision.  Queries on the audit information can then use 'between start and end
                    revision' instead of subqueries as used by the default audit strategy.
                </p>
                <p>
                    The consequence of this strategy is that persisting audit information will be a bit slower,
                    because of the extra updates involved, but retrieving audit information will be a lot faster.
                    This can be improved by adding extra indexes.
                </p>
            </li></ol></div>
    </a></div><a id="d5e3741">

    </a><div class="section" title="18.5.&nbsp;Revision Log"><a id="d5e3741"></a><div class="titlepage"><a id="d5e3741"></a><div><a id="d5e3741"></a><div><a id="d5e3741"></a><h2 class="title"><a id="d5e3741"></a><a id="envers-revisionlog">18.5.&nbsp;Revision Log</a></h2></div><div><h3 class="subtitle"><a id="envers-revisionlog">Logging data for revisions</a></h3></div></div></div><a id="envers-revisionlog">
        
        

        <p>
            When Envers starts a new revision, it creates a new <em class="firstterm">revision entity</em> which stores
            information about the revision.  By default, that includes just
        </p>
        <div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
                <p>
                    <em class="firstterm">revision number</em> - An integral value (<code class="literal">int/Integer</code> or
                    <code class="literal">long/Long</code>).  Essentially the primary key of the revision
                </p>
            </li><li class="listitem">
                <p>
                    <em class="firstterm">revision timestamp</em> - either a <code class="literal">long/Long</code> or
                    <code class="classname">java.util.Date</code> value representing the instant at which the revision was made.
                    When using a <code class="classname">java.util.Date</code>, instead of a <code class="literal">long/Long</code> for
                    the revision timestamp, take care not to store it to a column data type which will loose precision.
                </p>
            </li></ol></div>

        <p>
            Envers handles this information as an entity.  By default it uses its own internal class to act as the
            entity, mapped to the <code class="literal">REVINFO</code> table.
            You can, however, supply your own approach to collecting this information which might be useful to
            capture additional details such as who made a change or the ip address from which the request came.  There
            are 2 things you need to make this work.
        </p>
        <div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
                <p>
                    First, you will need to tell Envers about the entity you wish to use.  Your entity must use the
                    <code class="interfacename">@org.hibernate.envers.RevisionEntity</code> annotation.  It must
                    define the 2 attributes described above annotated with
                    <code class="interfacename">@org.hibernate.envers.RevisionNumber</code> and
                    <code class="interfacename">@org.hibernate.envers.RevisionTimestamp</code>, respectively.  You can extend
                    from <code class="classname">org.hibernate.envers.DefaultRevisionEntity</code>, if you wish, to inherit all
                    these required behaviors.
                </p>
                <p>
                    Simply add the custom revision entity as you do your normal entities.  Envers will "find it".  Note
                    that it is an error for there to be multiple entities marked as
                    <code class="interfacename">@org.hibernate.envers.RevisionEntity</code>
                </p>
            </li><li class="listitem">
                <p>
                    Second, you need to tell Envers how to create instances of your revision entity which is handled
                    by the <code class="methodname">newRevision</code> method of the
                    <code class="interfacename">org.jboss.envers.RevisionListener</code> interface.
                </p>
                <p>
                    You tell Envers your custom <code class="interfacename">org.hibernate.envers.RevisionListener</code>
                    implementation to use by specifying it on the
                    <code class="interfacename">@org.hibernate.envers.RevisionEntity</code> annotation, using the
                    <code class="methodname">value</code> attribute. If your <code class="interfacename">RevisionListener</code>
                    class is inaccessible from <code class="interfacename">@RevisionEntity</code> (e.g. exists in a different
                    module), set <span class="property">org.hibernate.envers.revision_listener</span> property to it's fully
                    qualified name. Class name defined by the configuration parameter overrides revision entity's
                    <code class="methodname">value</code> attribute.
                </p>
            </li></ol></div>
        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">@Entity
@RevisionEntity( MyCustomRevisionListener.class )
public class MyCustomRevisionEntity {
    ...
}

public class MyCustomRevisionListener implements RevisionListener {
    public void newRevision(Object revisionEntity) {
        ( (MyCustomRevisionEntity) revisionEntity )...;
    }
}
</pre>

        <p>
            An alternative method to using the <code class="interfacename">org.hibernate.envers.RevisionListener</code>
            is to instead call the <code class="methodname">getCurrentRevision</code> method of the
            <code class="interfacename">org.hibernate.envers.AuditReader</code> interface to obtain the current revision,
            and fill it with desired information.  The method accepts a <code class="literal">persist</code> parameter indicating
            whether the revision entity should be persisted prior to returning from this method. <code class="literal">true</code>
            ensures that the returned entity has access to its identifier value (revision number), but the revision
            entity will be persisted regardless of whether there are any audited entities changed. <code class="literal">false</code>
            means that the revision number will be <code class="literal">null</code>, but the revision entity will be persisted
            only if some audited entities have changed.
        </p>


        </a><div class="example"><a id="envers-revisionlog"></a><a id="d5e3800"><p class="title"><strong>Example&nbsp;18.1.&nbsp;Example of storing username with revision</strong></p><div class="example-contents">
            

            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">                <code xmlns="http://www.w3.org/1999/xhtml" class="filename">ExampleRevEntity.java</code>

package org.hibernate.envers.example;

import org.hibernate.envers.RevisionEntity;
import org.hibernate.envers.DefaultRevisionEntity;

import javax.persistence.Entity;

@Entity
@RevisionEntity(ExampleListener.class)
public class ExampleRevEntity extends DefaultRevisionEntity {
    private String username;

    public String getUsername() { return username; }
    public void setUsername(String username) { this.username = username; }
}</pre>

            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">                <code xmlns="http://www.w3.org/1999/xhtml" class="filename">ExampleListener.java</code>

package org.hibernate.envers.example;

import org.hibernate.envers.RevisionListener;
import org.jboss.seam.security.Identity;
import org.jboss.seam.Component;

public class ExampleListener implements RevisionListener {
    public void newRevision(Object revisionEntity) {
        ExampleRevEntity exampleRevEntity = (ExampleRevEntity) revisionEntity;
        Identity identity =
            (Identity) Component.getInstance("org.jboss.seam.security.identity");

        exampleRevEntity.setUsername(identity.getUsername());
    }
}</pre>

        </div></a></div><a id="d5e3800"><br class="example-break">

        </a><div class="section" title="18.5.1.&nbsp;Tracking entity names modified during revisions"><a id="d5e3800"></a><div class="titlepage"><a id="d5e3800"></a><div><a id="d5e3800"></a><div><a id="d5e3800"></a><h3 class="title"><a id="d5e3800"></a><a id="envers-tracking-modified-entities-revchanges">18.5.1.&nbsp;Tracking entity names modified during revisions</a></h3></div></div></div><a id="envers-tracking-modified-entities-revchanges">
            
            <p>
                By default entity types that have been changed in each revision are not being tracked. This implies the
                necessity to query all tables storing audited data in order to retrieve changes made during
                specified revision. Envers provides a simple mechanism that creates <code class="literal">REVCHANGES</code>
                table which stores entity names of modified persistent objects. Single record encapsulates the revision
                identifier (foreign key to <code class="literal">REVINFO</code> table) and a string value.
            </p>
            <p>
                Tracking of modified entity names can be enabled in three different ways:
            </p>
            <div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
                    <p>
                        Set <span class="property">org.hibernate.envers.track_entities_changed_in_revision</span> parameter to
                        <code class="literal">true</code>. In this case
                        <code class="classname">org.hibernate.envers.DefaultTrackingModifiedEntitiesRevisionEntity</code> will
                        be implicitly used as the revision log entity.
                    </p>
                </li><li class="listitem">
                    <p>
                        Create a custom revision entity that extends
                        <code class="classname">org.hibernate.envers.DefaultTrackingModifiedEntitiesRevisionEntity</code> class.
                    </p>
                    <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">@Entity
@RevisionEntity
public class ExtendedRevisionEntity
             extends DefaultTrackingModifiedEntitiesRevisionEntity {
    ...
}</pre>
                </li><li class="listitem">
                    <p>
                        Mark an appropriate field of a custom revision entity with
                        <code class="interfacename">@org.hibernate.envers.ModifiedEntityNames</code> annotation. The property is
                        required to be of <code class="literal">Set&lt;String&gt;</code> type.
                    </p>
                    <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">@Entity
@RevisionEntity
public class AnnotatedTrackingRevisionEntity {
    ...

    @ElementCollection
    @JoinTable(name = "REVCHANGES", joinColumns = @JoinColumn(name = "REV"))
    @Column(name = "ENTITYNAME")
    @ModifiedEntityNames
    private Set&lt;String&gt; modifiedEntityNames;
    
    ...
}</pre>
                </li></ol></div>
            </a><p><a id="envers-tracking-modified-entities-revchanges">
                Users, that have chosen one of the approaches listed above, can retrieve all entities modified in a
                specified revision by utilizing API described in </a><a class="xref" href="#envers-tracking-modified-entities-queries" title="18.7.4.&nbsp;Querying for entities modified in a given revision">Section&nbsp;18.7.4, “Querying for entities modified in a given revision”</a>.
            </p>
            <p>
                Users are also allowed to implement custom mechanism of tracking modified entity types. In this case, they
                shall pass their own implementation of
                <code class="interfacename">org.hibernate.envers.EntityTrackingRevisionListener</code> interface as the value
                of <code class="interfacename">@org.hibernate.envers.RevisionEntity</code> annotation.
                <code class="interfacename">EntityTrackingRevisionListener</code> interface exposes one method that notifies
                whenever audited entity instance has been added, modified or removed within current revision boundaries.
            </p>

            <div class="example"><a id="d5e3833"><p class="title"><strong>Example&nbsp;18.2.&nbsp;Custom implementation of tracking entity classes modified during revisions</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">                    <code xmlns="http://www.w3.org/1999/xhtml" class="filename">CustomEntityTrackingRevisionListener.java</code>

public class CustomEntityTrackingRevisionListener
             implements EntityTrackingRevisionListener {
    @Override
    public void entityChanged(Class entityClass, String entityName,
                              Serializable entityId, RevisionType revisionType,
                              Object revisionEntity) {
        String type = entityClass.getName();
        ((CustomTrackingRevisionEntity)revisionEntity).addModifiedEntityType(type);
    }

    @Override
    public void newRevision(Object revisionEntity) {
    }
}</pre>
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">                    <code xmlns="http://www.w3.org/1999/xhtml" class="filename">CustomTrackingRevisionEntity.java</code>

@Entity
@RevisionEntity(CustomEntityTrackingRevisionListener.class)
public class CustomTrackingRevisionEntity {
    @Id
    @GeneratedValue
    @RevisionNumber
    private int customId;

    @RevisionTimestamp
    private long customTimestamp;

    @OneToMany(mappedBy="revision", cascade={CascadeType.PERSIST, CascadeType.REMOVE})
    private Set&lt;ModifiedEntityTypeEntity&gt; modifiedEntityTypes =
                                              new HashSet&lt;ModifiedEntityTypeEntity&gt;();
    
    public void addModifiedEntityType(String entityClassName) {
        modifiedEntityTypes.add(new ModifiedEntityTypeEntity(this, entityClassName));
    }
    
    ...
}
</pre>
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">                    <code xmlns="http://www.w3.org/1999/xhtml" class="filename">ModifiedEntityTypeEntity.java</code>

@Entity
public class ModifiedEntityTypeEntity {
    @Id
    @GeneratedValue
    private Integer id;

    @ManyToOne
    private CustomTrackingRevisionEntity revision;
    
    private String entityClassName;
    
    ...
}
</pre>
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">CustomTrackingRevisionEntity revEntity =
    getAuditReader().findRevision(CustomTrackingRevisionEntity.class, revisionNumber);
Set&lt;ModifiedEntityTypeEntity&gt; modifiedEntityTypes = revEntity.getModifiedEntityTypes()</pre>
            </div></a></div><a id="d5e3833"><br class="example-break">
        </a></div><a id="d5e3833">

    </a></div><a id="d5e3833">

    </a><div class="section" title="18.6.&nbsp;Tracking entity changes at property level"><a id="d5e3833"></a><div class="titlepage"><a id="d5e3833"></a><div><a id="d5e3833"></a><div><a id="d5e3833"></a><h2 class="title"><a id="d5e3833"></a><a id="envers-tracking-properties-changes">18.6.&nbsp;Tracking entity changes at property level</a></h2></div></div></div><a id="envers-tracking-properties-changes">
        
        </a><p><a id="envers-tracking-properties-changes">
            By default the only information stored by Envers are revisions of modified entities.
            This approach lets user create audit queries based on historical values of entity's properties.

            Sometimes it is useful to store additional metadata for each revision, when you are interested also in
            the type of changes, not only about the resulting values. The feature described in
            </a><a class="xref" href="#envers-tracking-modified-entities-revchanges" title="18.5.1.&nbsp;Tracking entity names modified during revisions">Section&nbsp;18.5.1, “Tracking entity names modified during revisions”</a>
            makes it possible to tell which entities were modified in given revision.

            Feature described here takes it one step further. "Modification Flags" enable Envers to track which
            properties of audited entities were modified in a given revision.
        </p>
        <p>
            Tracking entity changes at property level can be enabled by:
        </p>
        <div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
                <p>
                    setting <span class="property">org.hibernate.envers.global_with_modified_flag</span> configuration
                    property to <code class="literal">true</code>.  This global switch will cause adding modification flags
                    for all audited properties in all audited entities.
                </p>
            </li><li class="listitem">
                <p>
                    using <code class="literal">@Audited(withModifiedFlag=true)</code> on a property or on an entity.
                </p>
            </li></ol></div>
        <p>
            The trade-off coming with this functionality is an increased size of
            audit tables and a very little, almost negligible, performance drop
            during audit writes. This is due to the fact that every tracked
            property has to have an accompanying boolean column in the
            schema that stores information about the property's modifications. Of
            course it is Envers' job to fill these columns accordingly - no additional work by the
            developer is required. Because of costs mentioned, it is recommended
            to enable the feature selectively, when needed with use of the
            granular configuration means described above.
        </p>
        <p>
            To see how "Modified Flags" can be utilized, check out the very
            simple query API that uses them: <a class="xref" href="#envers-tracking-properties-changes-queries" title="18.7.3.&nbsp;Querying for revisions of entity that modified given property">Section&nbsp;18.7.3, “Querying for revisions of entity that modified given property”</a>.
        </p>
    </div>

    <div class="section" title="18.7.&nbsp;Queries"><div class="titlepage"><div><div><h2 class="title"><a id="envers-queries">18.7.&nbsp;Queries</a></h2></div></div></div><a id="envers-queries">

        

        <p>
            You can think of historic data as having two dimension. The first - horizontal -
            is the state of the database at a given revision. Thus, you can
            query for entities as they were at revision N. The second - vertical - are the
            revisions, at which entities changed. Hence, you can query for revisions,
            in which a given entity changed.
        </p>

        <p>
            The queries in Envers are similar to Hibernate Criteria queries, so if you are common with them,
            using Envers queries will be much easier.
        </p>

        <p>
            The main limitation of the current queries implementation is that you cannot
            traverse relations. You can only specify constraints on the ids of the
            related entities, and only on the "owning" side of the relation. This however
            will be changed in future releases.
        </p>

        <p>
            Please note, that queries on the audited data will be in many cases much slower
            than corresponding queries on "live" data, as they involve correlated subselects.
        </p>

        </a><p><a id="envers-queries">
            In the future, queries will be improved both in terms of speed and possibilities, when using the valid-time
            audit strategy, that is when storing both start and end revisions for entities. See
            </a><a class="xref" href="#envers-configuration" title="18.2.&nbsp;Configuration">Section&nbsp;18.2, “Configuration”</a>.
        </p>

        <div class="section" title="18.7.1.&nbsp;Querying for entities of a class at a given revision"><div class="titlepage"><div><div><h3 class="title"><a id="entities-at-revision">18.7.1.&nbsp;Querying for entities of a class at a given revision</a></h3></div></div></div><a id="entities-at-revision">

            

            <p>
                The entry point for this type of queries is:
            </p>

            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">AuditQuery query = getAuditReader()
    .createQuery()
    .forEntitiesAtRevision(MyEntity.class, revisionNumber);</pre>

            <p>
                You can then specify constraints, which should be met by the entities returned, by
                adding restrictions, which can be obtained using the <code class="literal">AuditEntity</code>
                factory class. For example, to select only entities, where the "name" property
                is equal to "John":
            </p>

            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">query.add(AuditEntity.property("name").eq("John"));</pre>

            <p>
                And to select only entites that are related to a given entity:
            </p>

            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">query.add(AuditEntity.property("address").eq(relatedEntityInstance));
// or
query.add(AuditEntity.relatedId("address").eq(relatedEntityId));</pre>

            <p>
                You can limit the number of results, order them, and set aggregations and projections
                (except grouping) in the usual way.
                When your query is complete, you can obtain the results by calling the
                <code class="literal">getSingleResult()</code> or <code class="literal">getResultList()</code> methods.
            </p>

            <p>
                A full query, can look for example like this:
            </p>

            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">List personsAtAddress = getAuditReader().createQuery()
    .forEntitiesAtRevision(Person.class, 12)
    .addOrder(AuditEntity.property("surname").desc())
    .add(AuditEntity.relatedId("address").eq(addressId))
    .setFirstResult(4)
    .setMaxResults(2)
    .getResultList();</pre>

        </a></div><a id="entities-at-revision">

        </a><div class="section" title="18.7.2.&nbsp;Querying for revisions, at which entities of a given class changed"><a id="entities-at-revision"></a><div class="titlepage"><a id="entities-at-revision"></a><div><a id="entities-at-revision"></a><div><a id="entities-at-revision"></a><h3 class="title"><a id="entities-at-revision"></a><a id="revisions-of-entity">18.7.2.&nbsp;Querying for revisions, at which entities of a given class changed</a></h3></div></div></div><a id="revisions-of-entity">

            

            <p>
                The entry point for this type of queries is:
            </p>

            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">AuditQuery query = getAuditReader().createQuery()
    .forRevisionsOfEntity(MyEntity.class, false, true);</pre>

            <p>
                You can add constraints to this query in the same way as to the previous one.
                There are some additional possibilities:
            </p>

            <div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
                    <p>
                        using <code class="literal">AuditEntity.revisionNumber()</code> you can specify constraints, projections
                        and order on the revision number, in which the audited entity was modified
                    </p>
                </li><li class="listitem">
                    <p>
                        similarly, using <code class="literal">AuditEntity.revisionProperty(propertyName)</code> you can specify constraints,
                        projections and order on a property of the revision entity, corresponding to the revision
                        in which the audited entity was modified
                    </p>
                </li><li class="listitem">
                    <p>
                        <code class="literal">AuditEntity.revisionType()</code> gives you access as above to the type of
                        the revision (ADD, MOD, DEL).
                    </p>
                </li></ol></div>

            <p>
                Using these methods,
                you can order the query results by revision number, set projection or constraint
                the revision number to be greater or less than a specified value, etc. For example, the
                following query will select the smallest revision number, at which entity of class
                <code class="literal">MyEntity</code> with id <code class="literal">entityId</code> has changed, after revision
                number 42:
            </p>

            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Number revision = (Number) getAuditReader().createQuery()
    .forRevisionsOfEntity(MyEntity.class, false, true)
    .setProjection(AuditEntity.revisionNumber().min())
    .add(AuditEntity.id().eq(entityId))
    .add(AuditEntity.revisionNumber().gt(42))
    .getSingleResult();</pre>

            <p>
                The second additional feature you can use in queries for revisions is the ability
                to maximalize/minimize a property. For example, if you want to select the
                revision, at which the value of the <code class="literal">actualDate</code> for a given entity
                was larger then a given value, but as small as possible:
            </p>

            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Number revision = (Number) getAuditReader().createQuery()
    .forRevisionsOfEntity(MyEntity.class, false, true)
    // We are only interested in the first revision
    .setProjection(AuditEntity.revisionNumber().min())
    .add(AuditEntity.property("actualDate").minimize()
        .add(AuditEntity.property("actualDate").ge(givenDate))
        .add(AuditEntity.id().eq(givenEntityId)))
    .getSingleResult();
</pre>

            <p>
                The <code class="literal">minimize()</code> and <code class="literal">maximize()</code> methods return a criteria,
                to which you can add constraints, which must be met by the entities with the
                maximized/minimized properties. <code class="literal">AggregatedAuditExpression#computeAggregationInInstanceContext()</code>
                enables the possibility to compute aggregated expression in the context of each entity instance
                separately. It turns out useful when querying for latest revisions of all entities of a particular type.
            </p>

            <p>
                You probably also noticed that there are two boolean parameters, passed when
                creating the query. The first one, <code class="literal">selectEntitiesOnly</code>, is only valid when
                you don't set an explicit projection. If true, the result of the query will be
                a list of entities (which changed at revisions satisfying the specified
                constraints).
            </p>

            <p>
                If false, the result will be a list of three element arrays. The
                first element will be the changed entity instance. The second will be an entity
                containing revision data (if no custom entity is used, this will be an instance
                of <code class="literal">DefaultRevisionEntity</code>). The third will be the type of the
                revision (one of the values of the <code class="literal">RevisionType</code> enumeration:
                ADD, MOD, DEL).
            </p>

            <p>
                The second parameter, <code class="literal">selectDeletedEntities</code>, specifies if revisions,
                in which the entity was deleted should be included in the results. If yes, such entities
                will have the revision type DEL and all fields, except the id,
                <code class="literal">null</code>.
            </p>

        </a></div><a id="revisions-of-entity">

        </a><div class="section" title="18.7.3.&nbsp;Querying for revisions of entity that modified given property"><a id="revisions-of-entity"></a><div class="titlepage"><a id="revisions-of-entity"></a><div><a id="revisions-of-entity"></a><div><a id="revisions-of-entity"></a><h3 class="title"><a id="revisions-of-entity"></a><a id="envers-tracking-properties-changes-queries">18.7.3.&nbsp;Querying for revisions of entity that modified given property</a></h3></div></div></div><a id="envers-tracking-properties-changes-queries">

            

            </a><p><a id="envers-tracking-properties-changes-queries">
                For the two types of queries described above it's possible to use
                special Audit criteria called
                <code class="literal">hasChanged()</code>
                and
                <code class="literal">hasNotChanged()</code>
                that makes use of the functionality
                described in </a><a class="xref" href="#envers-tracking-properties-changes" title="18.6.&nbsp;Tracking entity changes at property level">Section&nbsp;18.6, “Tracking entity changes at property level”</a>.
                They're best suited for vertical queries,
                however existing API doesn't restrict their usage for horizontal
                ones.

                Let's have a look at following examples:
            </p>

            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">AuditQuery query = getAuditReader().createQuery()
    .forRevisionsOfEntity(MyEntity.class, false, true)
    .add(AuditEntity.id().eq(id));
    .add(AuditEntity.property("actualDate").hasChanged())
            </pre>

            <p>
                This query will return all revisions of MyEntity with given id,
                where the
                <span class="property">actualDate</span>
                property has been changed.
                Using this query we won't get all other revisions in which
                <span class="property">actualDate</span>
                wasn't touched. Of course nothing prevents user from combining
                hasChanged condition with some additional criteria - add method
                can be used here in a normal way.
            </p>

            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">AuditQuery query = getAuditReader().createQuery()
    .forEntitiesAtRevision(MyEntity.class, revisionNumber)
    .add(AuditEntity.property("prop1").hasChanged())
    .add(AuditEntity.property("prop2").hasNotChanged());
            </pre>

            <p>
                This query will return horizontal slice for MyEntity at the time
                revisionNumber was generated. It will be limited to revisions
                that modified
                <span class="property">prop1</span>
                but not <span class="property">prop2</span>.
                Note that the result set will usually also contain revisions
                with numbers lower than the revisionNumber, so we cannot read
                this query as "Give me all MyEntities changed in revisionNumber
                with
                <span class="property">prop1</span>
                modified and
                <span class="property">prop2</span>
                untouched". To get such result we have to use the
                <code class="literal">forEntitiesModifiedAtRevision</code> query:
            </p>

            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">AuditQuery query = getAuditReader().createQuery()
    .forEntitiesModifiedAtRevision(MyEntity.class, revisionNumber)
    .add(AuditEntity.property("prop1").hasChanged())
    .add(AuditEntity.property("prop2").hasNotChanged());
            </pre>

        </div>


        <div class="section" title="18.7.4.&nbsp;Querying for entities modified in a given revision"><div class="titlepage"><div><div><h3 class="title"><a id="envers-tracking-modified-entities-queries">18.7.4.&nbsp;Querying for entities modified in a given revision</a></h3></div></div></div><a id="envers-tracking-modified-entities-queries">
            
            <p>
                The basic query allows retrieving entity names and corresponding Java classes changed in a specified revision:
            </p>
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Set&lt;Pair&lt;String, Class&gt;&gt; modifiedEntityTypes = getAuditReader()
    .getCrossTypeRevisionChangesReader().findEntityTypes(revisionNumber);</pre>
            <p>
                Other queries (also accessible from <code class="interfacename">org.hibernate.envers.CrossTypeRevisionChangesReader</code>):
            </p>
            <div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
                    <p>
                        <em class="firstterm"><code class="methodname">List&lt;Object&gt; findEntities(Number)</code></em>
                        - Returns snapshots of all audited entities changed (added, updated and removed) in a given revision.
                        Executes <code class="literal">n+1</code> SQL queries, where <code class="literal">n</code> is a number of different entity
                        classes modified within specified revision.
                    </p>
                </li><li class="listitem">
                    <p>
                        <em class="firstterm"><code class="methodname">List&lt;Object&gt; findEntities(Number, RevisionType)</code></em>
                        - Returns snapshots of all audited entities changed (added, updated or removed) in a given revision
                        filtered by modification type. Executes <code class="literal">n+1</code> SQL queries, where <code class="literal">n</code>
                        is a number of different entity classes modified within specified revision.
                    </p>
                </li><li class="listitem">
                    <p>
                        <em class="firstterm"><code class="methodname">Map&lt;RevisionType, List&lt;Object&gt;&gt; findEntitiesGroupByRevisionType(Number)</code></em>
                        - Returns a map containing lists of entity snapshots grouped by modification operation (e.g.
                        addition, update and removal). Executes <code class="literal">3n+1</code> SQL queries, where <code class="literal">n</code>
                        is a number of different entity classes modified within specified revision.
                    </p>
                </li></ol></div>
            </a><p><a id="envers-tracking-modified-entities-queries">
                Note that methods described above can be legally used only when default mechanism of
                tracking changed entity names is enabled (see </a><a class="xref" href="#envers-tracking-modified-entities-revchanges" title="18.5.1.&nbsp;Tracking entity names modified during revisions">Section&nbsp;18.5.1, “Tracking entity names modified during revisions”</a>).
            </p>
        </div>

    </div>

    <div class="section" title="18.8.&nbsp;Conditional auditing"><div class="titlepage"><div><div><h2 class="title"><a id="d5e3959">18.8.&nbsp;Conditional auditing</a></h2></div></div></div><a id="d5e3959">
        
        <p>
            Envers persists audit data in reaction to various Hibernate events (e.g. post update, post insert, and
            so on), using a series of even listeners from the <code class="literal">org.hibernate.envers.event.spi</code>
            package. By default, if the Envers jar is in the classpath, the event listeners are auto-registered with
            Hibernate.
        </p>
        <p>
            Conditional auditing can be implemented by overriding some of the Envers event listeners.
            To use customized Envers event listeners, the following steps are needed:
            </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
                    <p>
                        Turn off automatic Envers event listeners registration by setting the
                        <code class="literal">hibernate.listeners.envers.autoRegister</code> Hibernate property to
                        <code class="literal">false</code>.
                    </p>
                </li><li class="listitem">
                    <p>
                        Create subclasses for appropriate event listeners. For example, if you want to
                        conditionally audit entity insertions, extend the
                        <code class="literal">org.hibernate.envers.event.spi.EnversPostInsertEventListenerImpl</code>
                        class. Place the conditional-auditing logic in the subclasses, call the super method if
                        auditing should be performed.
                    </p>
                </li><li class="listitem">
                    <p>
                        Create your own implementation of <code class="literal">org.hibernate.integrator.spi.Integrator</code>,
                        similar to <code class="literal">org.hibernate.envers.boot.internal.EnversIntegrator</code>. Use your event
                        listener classes instead of the default ones.
                    </p>
                </li><li class="listitem">
                    <p>
                        For the integrator to be automatically used when Hibernate starts up, you will need to add a
                        <code class="literal">META-INF/services/org.hibernate.integrator.spi.Integrator</code> file to your jar.
                        The file should contain the fully qualified name of the class implementing the interface.
                    </p>
                </li></ol></div><p>
        </p>
    </a></div><a id="d5e3959">

    </a><div class="section" title="18.9.&nbsp;Understanding the Envers Schema"><a id="d5e3959"></a><div class="titlepage"><a id="d5e3959"></a><div><a id="d5e3959"></a><div><a id="d5e3959"></a><h2 class="title"><a id="d5e3959"></a><a id="d5e3979">18.9.&nbsp;Understanding the Envers Schema</a></h2></div></div></div><a id="d5e3979">
        

        <p>
            For each audited entity (that is, for each entity containing at least one audited field), an audit table is
            created.  By default, the audit table's name is created by adding a "_AUD" suffix to the original table name,
            but this can be overridden by specifying a different suffix/prefix in the configuration or per-entity using
            the <code class="interfacename">@org.hibernate.envers.AuditTable</code> annotation.
        </p>

        <div class="orderedlist" title="Audit table columns"><p class="title"><strong>Audit table columns</strong></p><ol class="orderedlist" type="1"><li class="listitem">
                <p>
                    id of the original entity (this can be more then one column in the case of composite primary keys)
                </p>
            </li><li class="listitem">
                <p>
                    revision number - an integer.  Matches to the revision number in the revision entity table.
                </p>
            </li><li class="listitem">
                <p>
                    revision type - a small integer
                </p>
            </li><li class="listitem">
                <p>
                    audited fields from the original entity
                </p>
            </li></ol></div>

        <p>
            The primary key of the audit table is the combination of the original id of the entity and the revision
            number - there can be at most one historic entry for a given entity instance at a given revision.
        </p>

        <p>
            The current entity data is stored in the original table and in the audit table.  This is a duplication of
            data, however as this solution makes the query system much more powerful, and as memory is cheap, hopefully
            this won't be a major drawback for the users.  A row in the audit table with entity id ID, revision N and
            data D means: entity with id ID has data D from revision N upwards.  Hence, if we want to find an entity at
            revision M, we have to search for a row in the audit table, which has the revision number smaller or equal
            to M, but as large as possible. If no such row is found, or a row with a "deleted" marker is found, it means
            that the entity didn't exist at that revision.
        </p>

        <p>
            The "revision type" field can currently have three values: 0, 1, 2, which means ADD, MOD and DEL,
            respectively. A row with a revision of type DEL will only contain the id of the entity and no data (all
            fields NULL), as it only serves as a marker saying "this entity was deleted at that revision".
        </p>

        </a><p><a id="d5e3979">
            Additionally, there is a revision entity table which contains the information about the
            global revision.  By default the generated table is named <span class="database">REVINFO</span> and
            contains just 2 columns: <span class="database">ID</span> and <span class="database">TIMESTAMP</span>.
            A row is inserted into this table on each new revision, that is, on each commit of a transaction, which
            changes audited data.  The name of this table can be configured, the name of its columns as well as adding
            additional columns can be achieved as discussed in </a><a class="xref" href="#envers-revisionlog" title="18.5.&nbsp;Revision Log">Section&nbsp;18.5, “Revision Log”</a>.
        </p>

        <p>
            While global revisions are a good way to provide correct auditing of relations, some people have pointed out
            that this may be a bottleneck in systems, where data is very often modified.  One viable solution is to
            introduce an option to have an entity "locally revisioned", that is revisions would be created for it
            independently.  This wouldn't enable correct versioning of relations, but wouldn't also require the
            <span class="database">REVINFO</span> table.  Another possibility is to introduce a notion of
            "revisioning groups": groups of entities which share revision numbering.  Each such group would have to
            consist of one or more strongly connected component of the graph induced by relations between entities.
            Your opinions on the subject are very welcome on the forum! :)
        </p>

    </div>

    <div class="section" title="18.10.&nbsp;Generating schema with Ant"><div class="titlepage"><div><div><h2 class="title"><a id="envers-generateschema">18.10.&nbsp;Generating schema with Ant</a></h2></div></div></div><a id="envers-generateschema">
        

        <p>
            If you'd like to generate the database schema file with the Hibernate Tools Ant task,
            you'll probably notice that the generated file doesn't contain definitions of audit
            tables. To generate also the audit tables, you simply need to use
            <code class="literal">org.hibernate.tool.ant.EnversHibernateToolTask</code> instead of the usual
            <code class="literal">org.hibernate.tool.ant.HibernateToolTask</code>. The former class extends
            the latter, and only adds generation of the version entities. So you can use the task
            just as you used to.
        </p>

        <p>
            For example:
        </p>

        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&lt;target name="schemaexport" depends="build-demo"
  description="Exports a generated schema to DB and file"&gt;
  &lt;taskdef name="hibernatetool"
    classname="org.hibernate.tool.ant.EnversHibernateToolTask"
    classpathref="build.demo.classpath"/&gt;

  &lt;hibernatetool destdir="."&gt;
    &lt;classpath&gt;
      &lt;fileset refid="lib.hibernate" /&gt;
      &lt;path location="${build.demo.dir}" /&gt;
      &lt;path location="${build.main.dir}" /&gt;
    &lt;/classpath&gt;
    &lt;jpaconfiguration persistenceunit="ConsolePU" /&gt;
    &lt;hbm2ddl
      drop="false"
      create="true"
      export="false"
      outputfilename="versioning-ddl.sql"
      delimiter=";"
      format="true"/&gt;
  &lt;/hibernatetool&gt;
&lt;/target&gt;</pre>

        <p>
            Will generate the following schema:
        </p>

        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">    create table Address (
        id integer generated by default as identity (start with 1),
        flatNumber integer,
        houseNumber integer,
        streetName varchar(255),
        primary key (id)
    );

    create table Address_AUD (
        id integer not null,
        REV integer not null,
        flatNumber integer,
        houseNumber integer,
        streetName varchar(255),
        REVTYPE tinyint,
        primary key (id, REV)
    );

    create table Person (
        id integer generated by default as identity (start with 1),
        name varchar(255),
        surname varchar(255),
        address_id integer,
        primary key (id)
    );

    create table Person_AUD (
        id integer not null,
        REV integer not null,
        name varchar(255),
        surname varchar(255),
        REVTYPE tinyint,
        address_id integer,
        primary key (id, REV)
    );

    create table REVINFO (
        REV integer generated by default as identity (start with 1),
        REVTSTMP bigint,
        primary key (REV)
    );

    alter table Person
        add constraint FK8E488775E4C3EA63
        foreign key (address_id)
        references Address;
    </pre>
    </a></div><a id="envers-generateschema">


    </a><div class="section" title="18.11.&nbsp;Mapping exceptions"><a id="envers-generateschema"></a><div class="titlepage"><a id="envers-generateschema"></a><div><a id="envers-generateschema"></a><div><a id="envers-generateschema"></a><h2 class="title"><a id="envers-generateschema"></a><a id="envers-mappingexceptions">18.11.&nbsp;Mapping exceptions</a></h2></div></div></div><a id="envers-mappingexceptions">
        

        </a><div class="section" title="18.11.1.&nbsp;What isn't and will not be supported"><a id="envers-mappingexceptions"></a><div class="titlepage"><a id="envers-mappingexceptions"></a><div><a id="envers-mappingexceptions"></a><div><a id="envers-mappingexceptions"></a><h3 class="title"><a id="envers-mappingexceptions"></a><a id="d5e4014">18.11.1.&nbsp;What isn't and will not be supported</a></h3></div></div></div><a id="d5e4014">

            

            <p>
                Bags, as they can contain non-unique elements.
                The reason is that persisting, for example a bag of String-s, violates a principle
                of relational databases: that each table is a set of tuples. In case of bags,
                however (which require a join table), if there is a duplicate element, the two
                tuples corresponding to the elements will be the same. Hibernate allows this,
                however Envers (or more precisely: the database connector) will throw an exception
                when trying to persist two identical elements, because of a unique constraint violation.
            </p>

            <p>
                There are at least two ways out if you need bag semantics:
            </p>

            <div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
                    <p>
                        use an indexed collection, with the <code class="literal">@IndexColumn</code> annotation, or
                    </p>
                </li><li class="listitem">
                    <p>
                        provide a unique id for your elements with the <code class="literal">@CollectionId</code> annotation.
                    </p>
                </li></ol></div>

        </a></div><a id="d5e4014">

        </a><div class="section" title="18.11.2.&nbsp;What isn't and will be supported"><a id="d5e4014"></a><div class="titlepage"><a id="d5e4014"></a><div><a id="d5e4014"></a><div><a id="d5e4014"></a><h3 class="title"><a id="d5e4014"></a><a id="d5e4025">18.11.2.&nbsp;What isn't and <span class="emphasis"><em>will</em></span> be supported</a></h3></div></div></div><a id="d5e4025">

            

            <div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
                    <p>
                        Bag style collection which identifier column has been defined using
                        <code class="interfacename">@CollectionId</code> annotation (JIRA ticket HHH-3950).
                    </p>
                </li></ol></div>

        </a></div><a id="d5e4025">

        </a><div class="section" title="18.11.3.&nbsp;@OneToMany+@JoinColumn"><a id="d5e4025"></a><div class="titlepage"><a id="d5e4025"></a><div><a id="d5e4025"></a><div><a id="d5e4025"></a><h3 class="title"><a id="d5e4025"></a><a id="d5e4032">18.11.3.&nbsp;<code class="literal">@OneToMany</code>+<code class="literal">@JoinColumn</code></a></h3></div></div></div><a id="d5e4032">

            

            <p>
                When a collection is mapped using these two annotations, Hibernate doesn't
                generate a join table. Envers, however, has to do this, so that when you read the
                revisions in which the related entity has changed, you don't get false results.
            </p>
            <p>
                To be able to name the additional join table, there is a special annotation:
                <code class="literal">@AuditJoinTable</code>, which has similar semantics to JPA's
                <code class="literal">@JoinTable</code>.
            </p>

            <p>
                One special case are relations mapped with <code class="literal">@OneToMany</code>+<code class="literal">@JoinColumn</code> on
                the one side, and <code class="literal">@ManyToOne</code>+<code class="literal">@JoinColumn(insertable=false, updatable=false</code>)
                on the many side.  Such relations are in fact bidirectional, but the owning side is the collection.
            </p>
            <p>
                To properly audit such relations with Envers, you can use the <code class="literal">@AuditMappedBy</code> annotation.
                It enables you to specify the reverse property (using the <code class="literal">mappedBy</code> element). In case
                of indexed collections, the index column must also be mapped in the referenced entity (using
                <code class="literal">@Column(insertable=false, updatable=false)</code>, and specified using
                <code class="literal">positionMappedBy</code>. This annotation will affect only the way
                Envers works. Please note that the annotation is experimental and may change in the future.
            </p>

        </a></div><a id="d5e4032">
    </a></div><a id="d5e4032">

    </a><div class="section" title="18.12.&nbsp;Advanced: Audit table partitioning"><a id="d5e4032"></a><div class="titlepage"><a id="d5e4032"></a><div><a id="d5e4032"></a><div><a id="d5e4032"></a><h2 class="title"><a id="d5e4032"></a><a id="envers-partitioning">18.12.&nbsp;Advanced: Audit table partitioning</a></h2></div></div></div><a id="envers-partitioning">
        

        </a><div class="section" title="18.12.1.&nbsp;Benefits of audit table partitioning"><a id="envers-partitioning"></a><div class="titlepage"><a id="envers-partitioning"></a><div><a id="envers-partitioning"></a><div><a id="envers-partitioning"></a><h3 class="title"><a id="envers-partitioning"></a><a id="envers-partitioning-benefits">18.12.1.&nbsp;Benefits of audit table partitioning</a></h3></div></div></div><a id="envers-partitioning-benefits">

            

            <p>
                Because audit tables tend to grow indefinitely they can 
quickly become really large. When the audit tables have grown
                to a certain limit (varying per RDBMS and/or operating 
system) it makes sense to start using table partitioning.
                SQL table partitioning offers a lot of advantages 
including, but certainly not limited to:
                </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
                        <p>
                            Improved query performance by selectively 
moving rows to various partitions (or even purging old rows)
                        </p>
                    </li><li class="listitem">
                        <p>
                            Faster data loads, index creation, etc.
                        </p>
                    </li></ol></div><p>
            </p>

        </a></div><a id="envers-partitioning-benefits">

        </a><div class="section" title="18.12.2.&nbsp;Suitable columns for audit table partitioning"><a id="envers-partitioning-benefits"></a><div class="titlepage"><a id="envers-partitioning-benefits"></a><div><a id="envers-partitioning-benefits"></a><div><a id="envers-partitioning-benefits"></a><h3 class="title"><a id="envers-partitioning-benefits"></a><a id="envers-partitioning-columns">18.12.2.&nbsp;Suitable columns for audit table partitioning</a></h3></div></div></div><a id="envers-partitioning-columns">

            
            <p>
                Generally SQL tables must be partitioned on a column 
that exists within the table. As a rule it makes sense to use
                either the <span class="emphasis"><em>end revision</em></span> or the <span class="emphasis"><em>end revision timestamp</em></span> column for
                partioning of audit tables.
                </p></a><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><a id="envers-partitioning-columns"><h2>Note</h2>
                    <p>
                        End revision information is not available for the default AuditStrategy.
                    </p>

                    <p>
                        Therefore the following Envers configuration options are required:
                    </p>
                    <p>
                        <code class="literal">org.hibernate.envers.audit_strategy</code> =
                        <code class="literal">org.hibernate.envers.strategy.ValidityAuditStrategy</code>
                    </p>
                    <p>
                        <code class="literal">org.hibernate.envers.audit_strategy_validity_store_revend_timestamp</code> =
                        <code class="literal">true</code>
                    </p>

                    <p>
                        Optionally, you can also override the default values using following properties:
                    </p>
                    <p>
                        <code class="literal">org.hibernate.envers.audit_strategy_validity_end_rev_field_name</code>
                    </p>
                    <p>
                        <code class="literal">org.hibernate.envers.audit_strategy_validity_revend_timestamp_field_name</code>
                    </p>

                    </a><p><a id="envers-partitioning-columns">
                        For more information, see </a><a class="xref" href="#envers-configuration" title="18.2.&nbsp;Configuration">Section&nbsp;18.2, “Configuration”</a>.
                    </p>
                </div><p>
            </p>

            <p>
                The reason why the end revision information should be 
used for audit table partioning is based on the assumption that
                audit tables should be partionioned on an 'increasing 
level of interestingness', like so:
            </p>

            <p>
                </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
                        <p>
                            A couple of partitions with audit data that is not very (or no longer) interesting.
                            This can be stored on slow media, and perhaps even be purged eventually.
                        </p>
                    </li><li class="listitem">
                        <p>
                            Some partitions for audit data that is potentially interesting.
                        </p>
                    </li><li class="listitem">
                        <p>
                            One partition for audit data that is most likely to be interesting.
                            This should be stored on the fastest media, both for reading and writing.
                        </p>
                    </li></ol></div><p>
            </p>


        </div>

        <div class="section" title="18.12.3.&nbsp;Audit table partitioning example"><div class="titlepage"><div><div><h3 class="title"><a id="envers-partitioning-example">18.12.3.&nbsp;Audit table partitioning example</a></h3></div></div></div><a id="envers-partitioning-example">

            
            <p>
                In order to determine a suitable column for the 'increasing level of interestingness',
                consider a simplified example of a salary registration for an unnamed agency.
            </p>

            <p>
                Currently, the salary table contains the following rows for a certain person X:

                </p></a><div class="table"><a id="envers-partitioning-example"></a><a id="d5e4094"><p class="title"><strong>Table&nbsp;18.2.&nbsp;Salaries table</strong></p><div class="table-contents">
                    
                    <table summary="Salaries table" border="1"><colgroup><col class="c1" width="1*"><col class="c2" width="1*"></colgroup><thead><tr><th>Year</th><th>Salary (USD)</th></tr></thead><tbody><tr><td>2006</td><td>3300</td></tr><tr><td>2007</td><td>3500</td></tr><tr><td>2008</td><td>4000</td></tr><tr><td>2009</td><td>4500</td></tr></tbody></table>
                </div></a></div><p><a id="d5e4094"><br class="table-break">
            </a></p><a id="d5e4094">

            <p>
                The salary for the current fiscal year (2010) is unknown. The agency requires that all changes in registered
                salaries for a fiscal year are recorded (i.e. an audit trail). The rationale behind this is that decisions
                made at a certain date are based on the registered salary at that time. And at any time it must be possible
                reproduce the reason why a certain decision was made at a certain date.
            </p>

            <p>
                The following audit information is available, sorted on in order of occurrence:

                </p></a><div class="table"><a id="d5e4094"></a><a id="d5e4118"><p class="title"><strong>Table&nbsp;18.3.&nbsp;Salaries - audit table</strong></p><div class="table-contents">
                    
                    <table summary="Salaries - audit table" border="1"><colgroup><col class="c1" width="1*"><col class="c2" width="1*"><col class="c3" width="1*"><col class="c4" width="1*"><col class="c5" width="1*"></colgroup><thead><tr><th>Year</th><th>Revision type</th><th>Revision timestamp</th><th>Salary (USD)</th><th>End revision timestamp</th></tr></thead><tbody><tr><td>2006</td><td>ADD</td><td>2007-04-01</td><td>3300</td><td>null</td></tr><tr><td>2007</td><td>ADD</td><td>2008-04-01</td><td>35</td><td>2008-04-02</td></tr><tr><td>2007</td><td>MOD</td><td>2008-04-02</td><td>3500</td><td>null</td></tr><tr><td>2008</td><td>ADD</td><td>2009-04-01</td><td>3700</td><td>2009-07-01</td></tr><tr><td>2008</td><td>MOD</td><td>2009-07-01</td><td>4100</td><td>2010-02-01</td></tr><tr><td>2008</td><td>MOD</td><td>2010-02-01</td><td>4000</td><td>null</td></tr><tr><td>2009</td><td>ADD</td><td>2010-04-01</td><td>4500</td><td>null</td></tr></tbody></table>
                </div></a></div><p><a id="d5e4118"><br class="table-break">
            </a></p><a id="d5e4118">

            </a><div class="section" title="18.12.3.1.&nbsp;Determining a suitable partitioning column"><a id="d5e4118"></a><div class="titlepage"><a id="d5e4118"></a><div><a id="d5e4118"></a><div><a id="d5e4118"></a><h4 class="title"><a id="d5e4118"></a><a id="envers-partitioning-example-column">18.12.3.1.&nbsp;Determining a suitable partitioning column</a></h4></div></div></div><a id="envers-partitioning-example-column">

                
                <p>
                    To partition this data, the 'level of interestingness' must be defined.
                    Consider the following:
                    </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
                            <p>
                                For fiscal year 2006 there is only one revision. It has the oldest <span class="emphasis"><em>revision timestamp</em></span>
                                of all audit rows, but should still be 
regarded as interesting because it is the latest modification
                                for this fiscal year in the salary 
table; its <span class="emphasis"><em>end revision timestamp</em></span> is null.
                            </p>
                            <p>
                                Also note that it would be very 
unfortunate if in 2011 there would be an update of the salary for fiscal
                                year 2006 (which is possible in until at
 least 10 years after the fiscal year) and the audit
                                information would have been moved to a 
slow disk (based on the age of the
                                <span class="emphasis"><em>revision timestamp</em></span>). Remember that in this case Envers will have to update
                                the <span class="emphasis"><em>end revision timestamp</em></span> of the most recent audit row.
                            </p>
                        </li><li class="listitem">
                            <p>
                                There are two revisions in the salary of fiscal year 2007 which both have nearly the same
                                <span class="emphasis"><em>revision timestamp</em></span> and a different <span class="emphasis"><em>end revision timestamp</em></span>.
                                On first sight it is evident that the first revision was a mistake and probably uninteresting.
                                The only interesting revision for 2007 is the one with <span class="emphasis"><em>end revision timestamp</em></span> null.
                            </p>
                        </li></ol></div><p>

                    Based on the above, it is evident that only the <span class="emphasis"><em>end revision timestamp</em></span> is suitable for
                    audit table partitioning. The <span class="emphasis"><em>revision timestamp</em></span> is not suitable.
                </p>

            </a></div><a id="envers-partitioning-example-column">

            </a><div class="section" title="18.12.3.2.&nbsp;Determining a suitable partitioning scheme"><a id="envers-partitioning-example-column"></a><div class="titlepage"><a id="envers-partitioning-example-column"></a><div><a id="envers-partitioning-example-column"></a><div><a id="envers-partitioning-example-column"></a><h4 class="title"><a id="envers-partitioning-example-column"></a><a id="envers-partitioning-example-scheme">18.12.3.2.&nbsp;Determining a suitable partitioning scheme</a></h4></div></div></div><a id="envers-partitioning-example-scheme">

                
                <p>
                    A possible partitioning scheme for the salary table would be as follows:
                    </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
                            <p>
                                <span class="emphasis"><em>end revision timestamp</em></span> year = 2008
                            </p>
                            <p>
                                This partition contains audit data that is not very (or no longer) interesting.
                            </p>
                        </li><li class="listitem">
                            <p>
                                <span class="emphasis"><em>end revision timestamp</em></span> year = 2009
                            </p>
                            <p>
                                This partition contains audit data that is potentially interesting.
                            </p>
                        </li><li class="listitem">
                            <p>
                                <span class="emphasis"><em>end revision timestamp</em></span> year &gt;= 2010 or null
                            </p>
                            <p>
                                This partition contains the most interesting audit data.
                            </p>
                        </li></ol></div><p>
                </p>

                <p>
                    This partitioning scheme also covers the potential problem of the update of the
                    <span class="emphasis"><em>end revision timestamp</em></span>, which occurs if a row in the audited table is modified.
                    Even though Envers will update the <span class="emphasis"><em>end revision timestamp</em></span> of the audit row to
                    the system date at the instant of modification, the audit row will remain in the same partition
                    (the 'extension bucket').
                </p>

                <p>
                    And sometime in 2011, the last partition (or 'extension bucket') is split into two new partitions:
                    </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
                            <p>
                                <span class="emphasis"><em>end revision timestamp</em></span> year = 2010
                            </p>
                            <p>
                                This partition contains audit data that is potentially interesting (in 2011).
                            </p>
                        </li><li class="listitem">
                            <p>
                                <span class="emphasis"><em>end revision timestamp</em></span> year &gt;= 2011 or null
                            </p>
                            <p>
                                This partition contains the most interesting audit data and is the new 'extension bucket'.
                            </p>
                        </li></ol></div><p>
                </p>

            </a></div><a id="envers-partitioning-example-scheme">

        </a></div><a id="envers-partitioning-example-scheme">
    </a></div><a id="envers-partitioning-example-scheme">

    </a><div class="section" title="18.13.&nbsp;Envers links"><a id="envers-partitioning-example-scheme"></a><div class="titlepage"><a id="envers-partitioning-example-scheme"></a><div><a id="envers-partitioning-example-scheme"></a><div><a id="envers-partitioning-example-scheme"></a><h2 class="title"><a id="envers-partitioning-example-scheme"></a><a id="envers-links">18.13.&nbsp;Envers links</a></h2></div></div></div><a id="envers-links">
        

        </a><div class="orderedlist"><a id="envers-links"></a><ol class="orderedlist" type="1"><a id="envers-links"></a><li class="listitem"><a id="envers-links">
                </a><p><a id="envers-links">
                    </a><a class="ulink" href="http://hibernate.org/">Hibernate main page</a>
                </p>
            </li><li class="listitem">
                <p>
                    <a class="ulink" href="http://community.jboss.org/en/envers?view=discussions">Forum</a>
                </p>
            </li><li class="listitem">
                <p>
                    <a class="ulink" href="http://opensource.atlassian.com/projects/hibernate/browse/HHH">JIRA issue tracker</a>
                    (when adding issues concerning Envers, be sure to select the "envers" component!)
                </p>
            </li><li class="listitem">
                <p>
                    <a class="ulink" href="irc://irc.freenode.net:6667/envers">IRC channel</a>
                </p>
            </li><li class="listitem">
                <p>
                    <a class="ulink" href="http://www.jboss.org/feeds/view/envers">Envers Blog</a>
                </p>
            </li><li class="listitem">
                <p>
                    <a class="ulink" href="https://community.jboss.org/wiki/EnversFAQ">FAQ</a>
                </p>
            </li></ol></div>

    </div>

</div>
    <div class="chapter" title="Chapter&nbsp;19.&nbsp;Database Portability Considerations"><div class="titlepage"><div><div><h2 class="title"><a id="portability">Chapter&nbsp;19.&nbsp;Database Portability Considerations</a></h2></div></div></div><div class="toc"><p><a id="portability"><strong>Table of Contents</strong></a></p><dl><dt><a id="portability"><span class="section"></span></a><a href="#portability-basics">19.1. Portability Basics</a></dt><dt><span class="section"><a href="#portability-dialect">19.2. Dialect</a></span></dt><dt><span class="section"><a href="#portability-dialectresolver">19.3. Dialect resolution</a></span></dt><dt><span class="section"><a href="#portability-idgen">19.4. Identifier generation</a></span></dt><dt><span class="section"><a href="#portability-functions">19.5. Database functions</a></span></dt><dt><span class="section"><a href="#portability-types">19.6. Type mappings</a></span></dt></dl></div>
    

    <div class="section" title="19.1.&nbsp;Portability Basics"><div class="titlepage"><div><div><h2 class="title"><a id="portability-basics">19.1.&nbsp;Portability Basics</a></h2></div></div></div><a id="portability-basics">
        

        <p>
            One of the selling points of Hibernate (and really Object/Relational Mapping as a whole) is
            the notion of database portability.  This could mean an internal IT user migrating from one
            database vendor to another, or it could mean a framework or deployable application consuming
            Hibernate to simultaneously target multiple database products by their users.  Regardless of
            the exact scenario, the basic idea is that you want Hibernate to help you run against any number
            of databases without changes to your code, and ideally without any changes to the mapping metadata.
        </p>
    </a></div><a id="portability-basics">

    </a><div class="section" title="19.2.&nbsp;Dialect"><a id="portability-basics"></a><div class="titlepage"><a id="portability-basics"></a><div><a id="portability-basics"></a><div><a id="portability-basics"></a><h2 class="title"><a id="portability-basics"></a><a id="portability-dialect">19.2.&nbsp;Dialect</a></h2></div></div></div><a id="portability-dialect">
        

        <p>
            The first line of portability for Hibernate is the dialect, which is a specialization of the
            <code class="classname">org.hibernate.dialect.Dialect</code> contract.  A dialect encapsulates all
            the differences in how Hibernate must communicate with a particular database to accomplish some
            task like getting a sequence value or structuring a SELECT query.  Hibernate bundles a wide range
            of dialects for many of the most popular databases.  If you find that your particular database is
            not among them, it is not terribly difficult to write your own.
        </p>
    </a></div><a id="portability-dialect">

    </a><div class="section" title="19.3.&nbsp;Dialect resolution"><a id="portability-dialect"></a><div class="titlepage"><a id="portability-dialect"></a><div><a id="portability-dialect"></a><div><a id="portability-dialect"></a><h2 class="title"><a id="portability-dialect"></a><a id="portability-dialectresolver">19.3.&nbsp;Dialect resolution</a></h2></div></div></div><a id="portability-dialectresolver">
        

        <p>
            Originally, Hibernate would always require that users specify which dialect to use.  In the case
            of users looking to simultaneously target multiple databases with their build that was problematic.
            Generally this required their users to configure the Hibernate dialect or defining their own method
            of setting that value.
        </p>

        <p>
            Starting with version 3.2, Hibernate introduced the notion of automatically detecting the dialect
            to use based on the <code class="interfacename">java.sql.DatabaseMetaData</code> obtained from a
            <code class="interfacename">java.sql.Connection</code> to that database.  This was much better, expect
            that this resolution was limited to databases Hibernate know about ahead of time and was in no way
            configurable or overrideable.
        </p>

        <p>
            Starting with version 3.3, Hibernate has a fare more powerful way to automatically determine
            which dialect to should be used by relying on a series of delegates which implement the
            <code class="interfacename">org.hibernate.dialect.resolver.DialectResolver</code> which defines only a
            single method:
        </p>
        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">public Dialect resolveDialect(DatabaseMetaData metaData) throws JDBCConnectionException</pre>
        <p>
            The basic contract here is that if the resolver 'understands' the given database metadata then
            it returns the corresponding Dialect; if not it returns null and the process continues to the next
            resolver.  The signature also identifies <code class="exceptionname">org.hibernate.exception.JDBCConnectionException</code>
            as possibly being thrown.  A JDBCConnectionException here is interpreted to imply a "non transient"
            (aka non-recoverable) connection problem and is used to indicate an immediate stop to resolution
            attempts.  All other exceptions result in a warning and continuing on to the next resolver.
        </p>

        <p>
            The cool part about these resolvers is that users can also register their own custom resolvers
            which will be processed ahead of the built-in Hibernate ones.  This might be useful in a number of
            different situations: it allows easy integration for auto-detection of dialects beyond those
            shipped with HIbernate itself; it allows you to specify to use a custom dialect when a particular
            database is recognized; etc.  To register one or more resolvers, simply specify them (seperated by
            commas, tabs or spaces) using the 'hibernate.dialect_resolvers' configuration setting (see the
            <code class="constant">DIALECT_RESOLVERS</code> constant on
            <code class="classname">org.hibernate.cfg.Environment</code>).
        </p>
    </a></div><a id="portability-dialectresolver">

    </a><div class="section" title="19.4.&nbsp;Identifier generation"><a id="portability-dialectresolver"></a><div class="titlepage"><a id="portability-dialectresolver"></a><div><a id="portability-dialectresolver"></a><div><a id="portability-dialectresolver"></a><h2 class="title"><a id="portability-dialectresolver"></a><a id="portability-idgen">19.4.&nbsp;Identifier generation</a></h2></div></div></div><a id="portability-idgen">
        

        <p>
            When considering portability between databases, another important decision is selecting the
            identifier generation stratagy you want to use.  Originally Hibernate provided the
            <span class="emphasis"><em>native</em></span> generator for this purpose, which was intended to select between
            a <span class="emphasis"><em>sequence</em></span>, <span class="emphasis"><em>identity</em></span>, or <span class="emphasis"><em>table</em></span>
            strategy depending on the capability of the underlying database.  However, an insidious implication
            of this approach comes about when targtetting some databases which support <span class="emphasis"><em>identity</em></span>
            generation and some which do not.  <span class="emphasis"><em>identity</em></span> generation relies on the SQL
            definition of an IDENTITY (or auto-increment) column to manage the identifier value; it is what is
            known as a post-insert generation strategy becauase the insert must actually happen before we can
            know the identifier value.  Because Hibernate relies on this identifier value to uniquely reference
            entities within a persistence context it must then issue the insert
            immediately when the users requests the entitiy be associated with the session (like via
            save() e.g.) regardless of current transactional semantics.

            </p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2>
                <p>
                    Hibernate was changed slightly once the implication of this was better understood so that
                    the insert is delayed in cases where that is feasible.
                </p>
            </div><p>

            The underlying issue is that the actual semanctics of the application itself changes in these cases.
        </p>

        </a><p><a id="portability-idgen">
            Starting with version 3.2.3, Hibernate comes with a set of
            </a><a class="ulink" href="http://in.relation.to/2082.lace">enhanced</a>
            identifier generators targetting
            portability in a much different way.
            </p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2>
                <p>
                    There are specifically 2 bundled <span class="emphasis"><em>enhanced</em></span>generators:
                    </p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
                            <p>
                                <code class="classname">org.hibernate.id.enhanced.SequenceStyleGenerator</code>
                            </p>
                        </li><li class="listitem">
                            <p>
                                <code class="classname">org.hibernate.id.enhanced.TableGenerator</code>
                            </p>
                        </li></ul></div><p>
                </p>
            </div><p>
            The idea behind these generators is to port the actual semantics of the identifer value
            generation to the different databases.  For example, the
            <code class="classname">org.hibernate.id.enhanced.SequenceStyleGenerator</code> mimics the behavior of
            a sequence on databases which do not support sequences by using a table.
        </p>
    </div>

    <div class="section" title="19.5.&nbsp;Database functions"><div class="titlepage"><div><div><h2 class="title"><a id="portability-functions">19.5.&nbsp;Database functions</a></h2></div></div></div><a id="portability-functions">
        

        <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Warning</h2>
            <p>
                This is an area in Hibernate in need of improvement.  In terms of portability concerns,
                this function handling currently works pretty well from HQL; however, it is quite lacking
                in all other aspects.
            </p>
        </div>

        <p>
            SQL functions can be referenced in many ways by users.  However, not all databases
            support the same set of functions.  Hibernate, provides a means of mapping a
            <span class="emphasis"><em>logical</em></span> function name to a delegate which knows how to render
            that particular function, perhaps even using a totally different physical function call.
            </p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Important</h2>
                <p>
                    Technically this function registration is handled through the
                    <code class="classname">org.hibernate.dialect.function.SQLFunctionRegistry</code> class
                    which is intended to allow users to provide custom function definitions without
                    having to provide a custom dialect.  This specific behavior is not fully completed
                    as of yet.
                </p>
                <p>
                    It is sort of implemented such that users can programatically register functions
                    with the <code class="classname">org.hibernate.cfg.Configuration</code> and those functions
                    will be recognized for HQL.
                </p>
            </div><p>
        </p>
    </a></div><a id="portability-functions">

    </a><div class="section" title="19.6.&nbsp;Type mappings"><a id="portability-functions"></a><div class="titlepage"><a id="portability-functions"></a><div><a id="portability-functions"></a><div><a id="portability-functions"></a><h2 class="title"><a id="portability-functions"></a><a id="portability-types">19.6.&nbsp;Type mappings</a></h2></div></div></div><a id="portability-types">
        

        <p>
            This section scheduled for completion at a later date...
        </p>

        
    </a></div><a id="portability-types">

    JPA portability
    * HQL/JPQL differences
    * naming strategies
    * basic types
    * simple id types
    * generated id types
    * composite ids and many-to-one
    * "embedded composite identifiers"
</a></div><a id="portability-types">

    </a><div class="appendix" title="Appendix&nbsp;A.&nbsp;Legacy Bootstrapping"><a id="portability-types"></a><div class="titlepage"><a id="portability-types"></a><div><a id="portability-types"></a><div><a id="portability-types"></a><h2 class="title"><a id="portability-types"></a><a id="appendix-legacy-bootstrap">Appendix&nbsp;A.&nbsp;Legacy Bootstrapping</a></h2></div></div></div><div class="toc"><p><a id="appendix-legacy-bootstrap"><strong>Table of Contents</strong></a></p><dl><dt><a id="appendix-legacy-bootstrap"><span class="section"></span></a><a href="#d5e4322">A.1. Migration</a></dt></dl></div>
    

    <p>
        The legacy way to bootstrap a SessionFactory is via the <code class="classname">org.hibernate.cfg.Configuration</code>
        object.  Configuration represents, essentially, a single point for specifying all aspects of building
        the SessionFactory: everything from settings, to mappings, to strategies, etc.  I like to think of
        Configuration as a big pot to which we add a bunch of stuff (mappings, settings, etc) and from which
        we eventually get a SessionFactory.
    </p>

    <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2>
        <p>
            There are some significant draw backs to this approach which led to its deprecation and the development
            of the new approach, which is discussed in <a class="xref" href="#bootstrap-native" title="3.1.&nbsp;Native Bootstrapping">Section&nbsp;3.1, “Native Bootstrapping”</a>.  Configuration is
            semi-deprecated but still available for use, in a limited form that eliminates these draw backs.
            "Under the covers", Configuration uses the new bootstrapping code, so the things available there as also
            available here in terms of auto-discovery.
        </p>
    </div>

    <p>
        You can obtain the Configuration by instantiating it directly.  You then specify mapping metadata (XML
        mapping documents, annotated classes) that describe your applications object model and its mapping to a
        SQL database.
    </p>

    <div class="example"><a id="d5e4313"><p class="title"><strong>Example&nbsp;A.1.&nbsp;Configuration usage</strong></p><div class="example-contents">
        
        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Configuration cfg = new Configuration()
            // addResource does a classpath resource lookup
            .addResource("Item.hbm.xml")
            .addResource("Bid.hbm.xml")

            // calls addResource using "/org/hibernate/auction/User.hbm.xml"
            .addClass(org.hibernate.auction.User.class)

            // parses Address class for mapping annotations
            .addAnnotatedClass( Address.class )

            // reads package-level (package-info.class) annotations in the named package
            .addPackage( "org.hibernate.auction" )

            .setProperty("hibernate.dialect", "org.hibernate.dialect.H2Dialect")
            .setProperty("hibernate.connection.datasource", "java:comp/env/jdbc/test")
            .setProperty("hibernate.order_updates", "true");</pre>
    </div></a></div><a id="d5e4313"><br class="example-break">

    <p>
        There are other ways to specify Configuration information, including:
        </p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
                Place a file named hibernate.properties in a root directory of the classpath
            </li><li class="listitem">
                Pass an instance of java.util.Properties to Configuration#setProperties
            </li><li class="listitem">
                Via a Hibernate cfg.xml file
            </li><li class="listitem">
                System properties using java `-Dproperty=value`
            </li></ul></div><p>
    </p>

    </a><div class="section" title="A.1.&nbsp;Migration"><a id="d5e4313"></a><div class="titlepage"><a id="d5e4313"></a><div><a id="d5e4313"></a><div><a id="d5e4313"></a><h2 class="title"><a id="d5e4313"></a><a id="d5e4322">A.1.&nbsp;Migration</a></h2></div></div></div><a id="d5e4322">
        

        <p>
            Mapping Configuration methods to the corresponding methods in the new APIs..
        </p>

        <div class="variablelist" title="Mapping metadata"><p class="title"><strong>Mapping metadata</strong></p><dl><dt><span class="term">Configuration#addFile</span></dt><dd>MetadataSources#addFile</dd><dt><span class="term">Configuration#add(XmlDocument)</span></dt><dd>No replacement</dd><dt><span class="term">Configuration#addXML</span></dt><dd>No replacement</dd><dt><span class="term">Configuration#addCacheableFile</span></dt><dd>MetadataSources#addCacheableFile</dd><dt><span class="term">Configuration#addURL</span></dt><dd>MetadataSources#addURL</dd><dt><span class="term">Configuration#addInputStream</span></dt><dd>MetadataSources#addInputStream</dd><dt><span class="term">Configuration#addResource</span></dt><dd>MetadataSources#addResource</dd><dt><span class="term">Configuration#addClass</span></dt><dd>MetadataSources#addClass</dd><dt><span class="term">Configuration#addAnnotatedClass</span></dt><dd>MetadataSources#addAnnotatedClass</dd><dt><span class="term">Configuration#addPackage</span></dt><dd>MetadataSources#addPackage</dd><dt><span class="term">Configuration#addJar</span></dt><dd>MetadataSources#addJar</dd><dt><span class="term">Configuration#addDirectory</span></dt><dd>MetadataSources#addDirectory</dd><dt><span class="term">Configuration#registerTypeContributor</span></dt><dd>MetadataBuilder#applyTypes</dd><dt><span class="term">Configuration#registerTypeOverride</span></dt><dd>MetadataBuilder#applyBasicType</dd></dl></div>

        <div class="variablelist" title="Settings"><p class="title"><strong>Settings</strong></p><dl><dt><span class="term">Configuration#setProperty</span></dt><dd>StandardServiceRegistryBuilder#applySetting</dd><dt><span class="term">Configuration#setProperties</span></dt><dd>No replacement</dd><dt><span class="term">Configuration#addProperties</span></dt><dd>StandardServiceRegistryBuilder#applySettings</dd><dt><span class="term">Configuration#setNamingStrategy</span></dt><dd>No replacement.  NamingStrategy split into implicit/physical strategies</dd><dt><span class="term">Configuration#setImplicitNamingStrategy</span></dt><dd>MetadataBuilder#setImplicitNamingStrategy</dd><dt><span class="term">Configuration#setPhysicalNamingStrategy</span></dt><dd>MetadataBuilder#setPhysicalNamingStrategy</dd><dt><span class="term">Configuration#configure</span></dt><dd>StandardServiceRegistryBuilder#configure</dd><dt><span class="term">Configuration#setInterceptor</span></dt><dd>SessionFactoryBuilder#applyInterceptor</dd><dt><span class="term">Configuration#setEntityNotFoundDelegate</span></dt><dd>SessionFactoryBuilder#applyEntityNotFoundDelegate</dd><dt><span class="term">Configuration#setSessionFactoryObserver</span></dt><dd>SessionFactoryBuilder#addSessionFactoryObservers</dd><dt><span class="term">Configuration#setCurrentTenantIdentifierResolver</span></dt><dd>SessionFactoryBuilder#applyCurrentTenantIdentifierResolver</dd></dl></div>
    </a></div><a id="d5e4322">
</a></div><a id="d5e4322">
    </a><div class="appendix" title="Appendix&nbsp;B.&nbsp;Legacy Hibernate Criteria Queries"><a id="d5e4322"></a><div class="titlepage"><a id="d5e4322"></a><div><a id="d5e4322"></a><div><a id="d5e4322"></a><h2 class="title"><a id="d5e4322"></a><a id="appendix-legacy-criteria">Appendix&nbsp;B.&nbsp;Legacy Hibernate Criteria Queries</a></h2></div></div></div><div class="toc"><p><a id="appendix-legacy-criteria"><strong>Table of Contents</strong></a></p><dl><dt><a id="appendix-legacy-criteria"><span class="section"></span></a><a href="#querycriteria-creating">B.1. Creating a <code class="literal">Criteria</code> instance</a></dt><dt><span class="section"><a href="#querycriteria-narrowing">B.2. Narrowing the result set</a></span></dt><dt><span class="section"><a href="#querycriteria-ordering">B.3. Ordering the results</a></span></dt><dt><span class="section"><a href="#querycriteria-associations">B.4. Associations</a></span></dt><dt><span class="section"><a href="#querycriteria-dynamicfetching">B.5. Dynamic association fetching</a></span></dt><dt><span class="section"><a href="#querycriteria-components">B.6. Components</a></span></dt><dt><span class="section"><a href="#querycriteria-collections">B.7. Collections</a></span></dt><dt><span class="section"><a href="#querycriteria-examples">B.8. Example queries</a></span></dt><dt><span class="section"><a href="#querycriteria-projection">B.9. Projections, aggregation and grouping</a></span></dt><dt><span class="section"><a href="#querycriteria-detachedqueries">B.10. Detached queries and subqueries</a></span></dt><dt><span class="section"><a href="#query-criteria-naturalid">B.11. Queries by natural identifier</a></span></dt></dl></div>
    

    <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2>
        <p>
            This appendix covers the legacy Hibernate <code class="interfacename">org.hibernate.Criteria</code> API, which
            should be considered deprecated.  New development should focus on the JPA
            <code class="interfacename">javax.persistence.criteria.CriteriaQuery</code> API.  Eventually,
            Hibernate-specific criteria features will be ported as extensions to the JPA
            <code class="interfacename">javax.persistence.criteria.CriteriaQuery</code>.  For details on the JPA APIs, see
            <a class="xref" href="#criteria" title="Chapter&nbsp;14.&nbsp;Criteria">Chapter&nbsp;14, <em>Criteria</em></a>.
        </p>
        <p>
            This information is copied as-is from the older Hibernate documentation.
        </p>
    </div>

    <p>
        Hibernate features an intuitive, extensible criteria query API.
    </p>
    
    <div class="section" title="B.1.&nbsp;Creating a Criteria instance"><div class="titlepage"><div><div><h2 class="title"><a id="querycriteria-creating">B.1.&nbsp;Creating a <code class="literal">Criteria</code> instance</a></h2></div></div></div><a id="querycriteria-creating">
        

        <p>
            The interface <code class="literal">org.hibernate.Criteria</code> represents a query against
            a particular persistent class. The <code class="literal">Session</code> is a factory for
            <code class="literal">Criteria</code> instances.
        </p>

        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Criteria crit = sess.createCriteria(Cat.class);
crit.setMaxResults(50);
List cats = crit.list();</pre>

    </a></div><a id="querycriteria-creating">
     
    </a><div class="section" title="B.2.&nbsp;Narrowing the result set"><a id="querycriteria-creating"></a><div class="titlepage"><a id="querycriteria-creating"></a><div><a id="querycriteria-creating"></a><div><a id="querycriteria-creating"></a><h2 class="title"><a id="querycriteria-creating"></a><a id="querycriteria-narrowing">B.2.&nbsp;Narrowing the result set</a></h2></div></div></div><a id="querycriteria-narrowing">
        

        <p>
            An individual query criterion is an instance of the interface
            <code class="literal">org.hibernate.criterion.Criterion</code>. The class
            <code class="literal">org.hibernate.criterion.Restrictions</code> defines
            factory methods for obtaining certain built-in
            <code class="literal">Criterion</code> types.
        </p>

        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">List cats = sess.createCriteria(Cat.class)
    .add( Restrictions.like("name", "Fritz%") )
    .add( Restrictions.between("weight", minWeight, maxWeight) )
    .list();</pre>
    
        <p>
            Restrictions can be grouped logically.
        </p>

        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">List cats = sess.createCriteria(Cat.class)
    .add( Restrictions.like("name", "Fritz%") )
    .add( Restrictions.or(
        Restrictions.eq( "age", new Integer(0) ),
        Restrictions.isNull("age")
    ) )
    .list();</pre>
    
       <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">List cats = sess.createCriteria(Cat.class)
    .add( Restrictions.in( "name", new String[] { "Fritz", "Izi", "Pk" } ) )
    .add( Restrictions.disjunction()
        .add( Restrictions.isNull("age") )
        .add( Restrictions.eq("age", new Integer(0) ) )
        .add( Restrictions.eq("age", new Integer(1) ) )
        .add( Restrictions.eq("age", new Integer(2) ) )
    ) )
    .list();</pre>
    
        <p>
            There are a range of built-in criterion types (<code class="literal">Restrictions</code>
            subclasses). One of the most useful allows you to specify SQL directly.
        </p>

        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">List cats = sess.createCriteria(Cat.class)
    .add( Restrictions.sqlRestriction("lower({alias}.name) like lower(?)", "Fritz%", Hibernate.STRING) )
    .list();</pre>
    
        <p>
            The <code class="literal">{alias}</code> placeholder will be replaced by the row alias
            of the queried entity.
        </p>
        
        <p>
            You can also obtain a criterion from a 
            <code class="literal">Property</code> instance. You can create a <code class="literal">Property</code>
            by calling <code class="literal">Property.forName()</code>:
        </p>
    
        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Property age = Property.forName("age");
List cats = sess.createCriteria(Cat.class)
    .add( Restrictions.disjunction()
        .add( age.isNull() )
        .add( age.eq( new Integer(0) ) )
        .add( age.eq( new Integer(1) ) )
        .add( age.eq( new Integer(2) ) )
    ) )
    .add( Property.forName("name").in( new String[] { "Fritz", "Izi", "Pk" } ) )
    .list();</pre>
    
   </a></div><a id="querycriteria-narrowing">
     
    </a><div class="section" title="B.3.&nbsp;Ordering the results"><a id="querycriteria-narrowing"></a><div class="titlepage"><a id="querycriteria-narrowing"></a><div><a id="querycriteria-narrowing"></a><div><a id="querycriteria-narrowing"></a><h2 class="title"><a id="querycriteria-narrowing"></a><a id="querycriteria-ordering">B.3.&nbsp;Ordering the results</a></h2></div></div></div><a id="querycriteria-ordering">
        

        <p>
            You can order the results using <code class="literal">org.hibernate.criterion.Order</code>.
        </p>

        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">List cats = sess.createCriteria(Cat.class)
    .add( Restrictions.like("name", "F%")
    .addOrder( Order.asc("name").nulls(NullPrecedence.LAST) )
    .addOrder( Order.desc("age") )
    .setMaxResults(50)
    .list();</pre>
    
        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">List cats = sess.createCriteria(Cat.class)
    .add( Property.forName("name").like("F%") )
    .addOrder( Property.forName("name").asc() )
    .addOrder( Property.forName("age").desc() )
    .setMaxResults(50)
    .list();</pre>
    
    </a></div><a id="querycriteria-ordering">
    
    </a><div class="section" title="B.4.&nbsp;Associations"><a id="querycriteria-ordering"></a><div class="titlepage"><a id="querycriteria-ordering"></a><div><a id="querycriteria-ordering"></a><div><a id="querycriteria-ordering"></a><h2 class="title"><a id="querycriteria-ordering"></a><a id="querycriteria-associations">B.4.&nbsp;Associations</a></h2></div></div></div><a id="querycriteria-associations">
        

        <p>
            By navigating
            associations using <code class="literal">createCriteria()</code> you can specify constraints upon related entities:
        </p>

        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">List cats = sess.createCriteria(Cat.class)
    .add( Restrictions.like("name", "F%") )
    .createCriteria("kittens")
        .add( Restrictions.like("name", "F%") )
    .list();</pre>

        <p>
            The second <code class="literal">createCriteria()</code> returns a new
            instance of <code class="literal">Criteria</code> that refers to the elements of
            the <code class="literal">kittens</code> collection.
        </p>

        <p>
            There is also an alternate form that is useful in certain circumstances:
        </p>

        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">List cats = sess.createCriteria(Cat.class)
    .createAlias("kittens", "kt")
    .createAlias("mate", "mt")
    .add( Restrictions.eqProperty("kt.name", "mt.name") )
    .list();</pre>

        <p>
            (<code class="literal">createAlias()</code> does not create a new instance of
            <code class="literal">Criteria</code>.)
        </p>

        <p>
            The kittens collections held by the <code class="literal">Cat</code> instances
            returned by the previous two queries are <span class="emphasis"><em>not</em></span> pre-filtered
            by the criteria. If you want to retrieve just the kittens that match the
            criteria, you must use a <code class="literal">ResultTransformer</code>.
        </p>

        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">List cats = sess.createCriteria(Cat.class)
    .createCriteria("kittens", "kt")
        .add( Restrictions.eq("name", "F%") )
    .setResultTransformer(Criteria.ALIAS_TO_ENTITY_MAP)
    .list();
Iterator iter = cats.iterator();
while ( iter.hasNext() ) {
    Map map = (Map) iter.next();
    Cat cat = (Cat) map.get(Criteria.ROOT_ALIAS);
    Cat kitten = (Cat) map.get("kt");
}</pre>

	<p>
		Additionally you may manipulate the result set using a left outer join:
	</p>
	<pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">		List cats = session.createCriteria( Cat.class )
                       .createAlias("mate", "mt", Criteria.LEFT_JOIN, Restrictions.like("mt.name", "good%") )
                       .addOrder(Order.asc("mt.age"))
                       .list();
	
	</pre>

	<p>
		This will return all of the <code class="literal">Cat</code>s with a mate whose name starts with "good"
		ordered by their mate's age, and all cats who do not have a mate.  
		 This is useful when there is a need to order or limit in the database
		 prior to returning complex/large result sets, and removes many instances where
		 multiple queries would have to be performed and the results unioned 
		 by java in memory.  
	</p>
	<p>
		Without this feature, first all of the cats without a mate would need to be loaded in one query. 
	</p>
	<p>
		A second query would need to retreive the cats with mates who's name started with "good" sorted by the mates age.
	</p>
	<p>
		Thirdly, in memory; the lists would need to be joined manually.
	</p>
    </a></div><a id="querycriteria-associations">
    
    </a><div class="section" title="B.5.&nbsp;Dynamic association fetching"><a id="querycriteria-associations"></a><div class="titlepage"><a id="querycriteria-associations"></a><div><a id="querycriteria-associations"></a><div><a id="querycriteria-associations"></a><h2 class="title"><a id="querycriteria-associations"></a><a id="querycriteria-dynamicfetching">B.5.&nbsp;Dynamic association fetching</a></h2></div></div></div><a id="querycriteria-dynamicfetching">
        

        <p>
            You can specify association fetching semantics at runtime using
            <code class="literal">setFetchMode()</code>.
        </p>

        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">List cats = sess.createCriteria(Cat.class)
    .add( Restrictions.like("name", "Fritz%") )
    .setFetchMode("mate", FetchMode.EAGER)
    .setFetchMode("kittens", FetchMode.EAGER)
    .list();</pre>
    
        <p>
            This query will fetch both <code class="literal">mate</code> and <code class="literal">kittens</code>
            by outer join.
        </p>
    
    </a></div><a id="querycriteria-dynamicfetching">

    </a><div class="section" title="B.6.&nbsp;Components"><a id="querycriteria-dynamicfetching"></a><div class="titlepage"><a id="querycriteria-dynamicfetching"></a><div><a id="querycriteria-dynamicfetching"></a><div><a id="querycriteria-dynamicfetching"></a><h2 class="title"><a id="querycriteria-dynamicfetching"></a><a id="querycriteria-components">B.6.&nbsp;Components</a></h2></div></div></div><a id="querycriteria-components">
        

        <p>
               To add a restriction against a property of an embedded component, the component property
               name should be prepended to the property name when creating the <code class="literal">Restriction</code>.
               The criteria object should be created on the owning entity, and cannot be created on the component 
               itself.  For example, suppose the <code class="literal">Cat</code> has a component property <code class="literal">fullName</code>
               with sub-properties <code class="literal">firstName</code> and <code class="literal">lastName</code>:
	</p>

	<pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">		List cats = session.createCriteria(Cat.class)
			.add(Restrictions.eq("fullName.lastName", "Cattington"))
			.list();
	</pre>
	
	</a><p><a id="querycriteria-components">
		Note: this does not apply when querying collections of components, for that see below 
		</a><a class="xref" href="#querycriteria-collections" title="B.7.&nbsp;Collections">Section&nbsp;B.7, “Collections”</a>
	</p>

    </div>

    <div class="section" title="B.7.&nbsp;Collections"><div class="titlepage"><div><div><h2 class="title"><a id="querycriteria-collections">B.7.&nbsp;Collections</a></h2></div></div></div><a id="querycriteria-collections">
	
	</a><p><a id="querycriteria-collections">
		When using criteria against collections, there are two distinct cases.  One is if
		the collection contains entities (eg. <code class="literal">&lt;one-to-many/&gt;</code> 
		or <code class="literal">&lt;many-to-many/&gt;</code>) or components 
		(<code class="literal">&lt;composite-element/&gt;</code> ),
		and the second is if the collection contains scalar values 
		(<code class="literal">&lt;element/&gt;</code>).
		In the first case, the syntax is as given above in the section 
		</a><a class="xref" href="#querycriteria-associations" title="B.4.&nbsp;Associations">Section&nbsp;B.4, “Associations”</a> where we restrict the <code class="literal">kittens</code>
		collection. Essentially we create a <code class="literal">Criteria</code> object against the collection
		property and restrict the entity or component properties using that instance.
	</p>
	<p>
		For queryng a collection of basic values, we still create the <code class="literal">Criteria</code>
		object against the collection, but to reference the value, we use the special property 
		"elements".  For an indexed collection, we can also reference the index property using
		the special property "indices".
	</p>
	<pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">		List cats = session.createCriteria(Cat.class)
			.createCriteria("nickNames")
				.add(Restrictions.eq("elements", "BadBoy"))
			.list();
	</pre>
    </div>

    <div class="section" title="B.8.&nbsp;Example queries"><div class="titlepage"><div><div><h2 class="title"><a id="querycriteria-examples">B.8.&nbsp;Example queries</a></h2></div></div></div><a id="querycriteria-examples">
        

        <p>
            The class <code class="literal">org.hibernate.criterion.Example</code> allows
            you to construct a query criterion from a given instance.
        </p>

        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Cat cat = new Cat();
cat.setSex('F');
cat.setColor(Color.BLACK);
List results = session.createCriteria(Cat.class)
    .add( Example.create(cat) )
    .list();</pre>
    
        <p>
           Version properties, identifiers and associations are ignored. By default,
           null valued properties are excluded.
        </p>

        <p>
           You can adjust how the <code class="literal">Example</code> is applied.
        </p>

        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Example example = Example.create(cat)
    .excludeZeroes()           //exclude zero valued properties
    .excludeProperty("color")  //exclude the property named "color"
    .ignoreCase()              //perform case insensitive string comparisons
    .enableLike();             //use like for string comparisons
List results = session.createCriteria(Cat.class)
    .add(example)
    .list();</pre>
    
        <p>
            You can even use examples to place criteria upon associated objects.
        </p>

        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">List results = session.createCriteria(Cat.class)
    .add( Example.create(cat) )
    .createCriteria("mate")
        .add( Example.create( cat.getMate() ) )
    .list();</pre>
    
    </a></div><a id="querycriteria-examples">
    
    </a><div class="section" title="B.9.&nbsp;Projections, aggregation and grouping"><a id="querycriteria-examples"></a><div class="titlepage"><a id="querycriteria-examples"></a><div><a id="querycriteria-examples"></a><div><a id="querycriteria-examples"></a><h2 class="title"><a id="querycriteria-examples"></a><a id="querycriteria-projection">B.9.&nbsp;Projections, aggregation and grouping</a></h2></div></div></div><a id="querycriteria-projection">
        
        <p>
            The class <code class="literal">org.hibernate.criterion.Projections</code> is a
            factory for <code class="literal">Projection</code> instances. You can apply a
            projection to a query by calling <code class="literal">setProjection()</code>.
        </p>
        
        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">List results = session.createCriteria(Cat.class)
    .setProjection( Projections.rowCount() )
    .add( Restrictions.eq("color", Color.BLACK) )
    .list();</pre>
    
        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">List results = session.createCriteria(Cat.class)
    .setProjection( Projections.projectionList()
        .add( Projections.rowCount() )
        .add( Projections.avg("weight") )
        .add( Projections.max("weight") )
        .add( Projections.groupProperty("color") )
    )
    .list();</pre>
    
        <p>
            There is no explicit "group by" necessary in a criteria query. Certain
            projection types are defined to be <span class="emphasis"><em>grouping projections</em></span>,
            which also appear in the SQL <code class="literal">group by</code> clause.
        </p>
    
        <p>
            An alias can be assigned to a projection so that the projected value
            can be referred to in restrictions or orderings. Here are two different ways to
            do this:
        </p>

        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">List results = session.createCriteria(Cat.class)
    .setProjection( Projections.alias( Projections.groupProperty("color"), "colr" ) )
    .addOrder( Order.asc("colr") )
    .list();</pre>
    
        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">List results = session.createCriteria(Cat.class)
    .setProjection( Projections.groupProperty("color").as("colr") )
    .addOrder( Order.asc("colr") )
    .list();</pre>
    
        <p>
            The <code class="literal">alias()</code> and <code class="literal">as()</code> methods simply wrap a
            projection instance in another, aliased, instance of <code class="literal">Projection</code>.
            As a shortcut, you can assign an alias when you add the projection to a 
            projection list:
        </p>

       <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">List results = session.createCriteria(Cat.class)
    .setProjection( Projections.projectionList()
        .add( Projections.rowCount(), "catCountByColor" )
        .add( Projections.avg("weight"), "avgWeight" )
        .add( Projections.max("weight"), "maxWeight" )
        .add( Projections.groupProperty("color"), "color" )
    )
    .addOrder( Order.desc("catCountByColor") )
    .addOrder( Order.desc("avgWeight") )
    .list();</pre>
    
        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">List results = session.createCriteria(Domestic.class, "cat")
    .createAlias("kittens", "kit")
    .setProjection( Projections.projectionList()
        .add( Projections.property("cat.name"), "catName" )
        .add( Projections.property("kit.name"), "kitName" )
    )
    .addOrder( Order.asc("catName") )
    .addOrder( Order.asc("kitName") )
    .list();</pre>
    
        <p>
            You can also use <code class="literal">Property.forName()</code> to express projections:
        </p>
    
        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">List results = session.createCriteria(Cat.class)
    .setProjection( Property.forName("name") )
    .add( Property.forName("color").eq(Color.BLACK) )
    .list();</pre>
    
        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">List results = session.createCriteria(Cat.class)
    .setProjection( Projections.projectionList()
        .add( Projections.rowCount().as("catCountByColor") )
        .add( Property.forName("weight").avg().as("avgWeight") )
        .add( Property.forName("weight").max().as("maxWeight") )
        .add( Property.forName("color").group().as("color" )
    )
    .addOrder( Order.desc("catCountByColor") )
    .addOrder( Order.desc("avgWeight") )
    .list();</pre>
    
    </a></div><a id="querycriteria-projection">
    
    </a><div class="section" title="B.10.&nbsp;Detached queries and subqueries"><a id="querycriteria-projection"></a><div class="titlepage"><a id="querycriteria-projection"></a><div><a id="querycriteria-projection"></a><div><a id="querycriteria-projection"></a><h2 class="title"><a id="querycriteria-projection"></a><a id="querycriteria-detachedqueries">B.10.&nbsp;Detached queries and subqueries</a></h2></div></div></div><a id="querycriteria-detachedqueries">
        
        <p>
            The <code class="literal">DetachedCriteria</code> class allows you to create a query outside the scope 
            of a session and then execute it using an arbitrary <code class="literal">Session</code>.
        </p>
        
        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">DetachedCriteria query = DetachedCriteria.forClass(Cat.class)
    .add( Property.forName("sex").eq('F') );
    
Session session = ....;
Transaction txn = session.beginTransaction();
List results = query.getExecutableCriteria(session).setMaxResults(100).list();
txn.commit();
session.close();</pre>

        <p>
            A <code class="literal">DetachedCriteria</code> can also be used to express a subquery. Criterion
            instances involving subqueries can be obtained via <code class="literal">Subqueries</code> or
            <code class="literal">Property</code>.            
        </p>
        
        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">DetachedCriteria avgWeight = DetachedCriteria.forClass(Cat.class)
    .setProjection( Property.forName("weight").avg() );
session.createCriteria(Cat.class)
    .add( Property.forName("weight").gt(avgWeight) )
    .list();</pre>
    
        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">DetachedCriteria weights = DetachedCriteria.forClass(Cat.class)
    .setProjection( Property.forName("weight") );
session.createCriteria(Cat.class)
    .add( Subqueries.geAll("weight", weights) )
    .list();</pre>
    
        <p>
            Correlated subqueries are also possible:
        </p>
        
        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">DetachedCriteria avgWeightForSex = DetachedCriteria.forClass(Cat.class, "cat2")
    .setProjection( Property.forName("weight").avg() )
    .add( Property.forName("cat2.sex").eqProperty("cat.sex") );
session.createCriteria(Cat.class, "cat")
    .add( Property.forName("weight").gt(avgWeightForSex) )
    .list();</pre>

        <p>
            Example of multi-column restriction based on a subquery:
        </p>

        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">DetachedCriteria sizeQuery = DetachedCriteria.forClass( Man.class )
    .setProjection( Projections.projectionList().add( Projections.property( "weight" ) )
                                                .add( Projections.property( "height" ) ) )
    .add( Restrictions.eq( "name", "John" ) );
session.createCriteria( Woman.class )
    .add( Subqueries.propertiesEq( new String[] { "weight", "height" }, sizeQuery ) )
    .list();</pre>

    </a></div><a id="querycriteria-detachedqueries">

        
               
    </a><div class="section" title="B.11.&nbsp;Queries by natural identifier"><a id="querycriteria-detachedqueries"></a><div class="titlepage"><a id="querycriteria-detachedqueries"></a><div><a id="querycriteria-detachedqueries"></a><div><a id="querycriteria-detachedqueries"></a><h2 class="title"><a id="querycriteria-detachedqueries"></a><a id="query-criteria-naturalid">B.11.&nbsp;Queries by natural identifier</a></h2></div></div></div><a id="query-criteria-naturalid">
        
        
        <p>
            For most queries, including criteria queries, the query cache is not efficient
            because query cache invalidation occurs too frequently. However, there is a special
            kind of query where you can optimize the cache invalidation algorithm: lookups by a 
            constant natural key. In some applications, this kind of query occurs frequently.
            The criteria API provides special provision for this use case.
        </p>
        
        <p>
            First, map the natural key of your entity using 
            <code class="literal">&lt;natural-id&gt;</code> and enable use of the second-level cache.
        </p>

        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&lt;class name="User"&gt;
    &lt;cache usage="read-write"/&gt;
    &lt;id name="id"&gt;
        &lt;generator class="increment"/&gt;
    &lt;/id&gt;
    &lt;natural-id&gt;
        &lt;property name="name"/&gt;
        &lt;property name="org"/&gt;
    &lt;/natural-id&gt;
    &lt;property name="password"/&gt;
&lt;/class&gt;</pre>
    
        <p>
            This functionality is not intended for use with entities with 
            <span class="emphasis"><em>mutable</em></span> natural keys.
        </p>
        
        <p>
            Once you have enabled the Hibernate query cache, 
            the <code class="literal">Restrictions.naturalId()</code> allows you to make use of
            the more efficient cache algorithm.
        </p>
       
        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">session.createCriteria(User.class)
    .add( Restrictions.naturalId()
        .set("name", "gavin")
        .set("org", "hb") 
    ).setCacheable(true)
    .uniqueResult();</pre>
            
    </a></div><a id="query-criteria-naturalid">
    
</a></div><a id="query-criteria-naturalid">

    </a><div class="bibliography" title="References"><a id="query-criteria-naturalid"></a><div class="titlepage"><a id="query-criteria-naturalid"></a><div><a id="query-criteria-naturalid"></a><div><a id="query-criteria-naturalid"></a><h2 class="title"><a id="query-criteria-naturalid"></a><a id="d5e4570">References</a></h2></div></div></div><a id="d5e4570">
    

    </a><div class="biblioentry" title="Patterns of Enterprise Application Architecture"><a id="d5e4570"></a><a id="biblio-PoEAA"><p>[<abbr class="abbrev">PoEAA</abbr>] 
        
        <span class="title"><em>Patterns of Enterprise Application Architecture</em>. </span>
        <span class="biblioid">0-321-12742-0. </span>
        <span class="authorgroup"><span class="firstname">Martin</span> <span class="surname">Fowler</span>. </span>
        <span class="copyright">Copyright © 2003 Pearson Education, Inc.. </span>
        <span class="publisher">
            <span class="publishername">Addison-Wesley Publishing Company. </span>
        </span>
    </p></a></div><a id="biblio-PoEAA">

    </a><div class="biblioentry" title="Java Persistence with Hibernate"><a id="biblio-PoEAA"></a><a id="biblio-JPwH"></a><p><a id="biblio-JPwH">[<abbr class="abbrev">JPwH</abbr>] 
        
        <span class="title"><em>Java Persistence with Hibernate</em>. </span>
        <span class="subtitle">Second Edition of Hibernate in Action. </span>
        <span class="biblioid">1-932394-88-5. </span>
        <span class="bibliomisc">
            </span></a><a class="ulink" href="http://www.manning.com/bauer2">http://www.manning.com/bauer2</a>
        . 
        <span class="authorgroup"><span class="firstname">Christian</span> <span class="surname">Bauer</span> and <span class="firstname">Gavin</span> <span class="surname">King</span>. </span>
        <span class="copyright">Copyright © 2007 Manning Publications Co.. </span>
        <span class="publisher">
            <span class="publishername">Manning Publications Co.. </span>
        </span>
    </p></div>

</div>

</div><hr xmlns="" xmlns:d="http://docbook.org/ns/docbook"><a xmlns="" xmlns:d="http://docbook.org/ns/docbook" href="http://docs.jboss.org/hibernate/orm/5.0/userGuide/en-US/html_single/legalnotice.html"></a></div></body></html>